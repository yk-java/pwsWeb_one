<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.glens.pwCloudOs.pm.schedulePlan.scheduleDaily.dao.PmDayKpiMapper" >
  <resultMap id="BaseResultMap" type="com.glens.pwCloudOs.pm.schedulePlan.scheduleDaily.vo.PmDayKpi" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="rowid" property="rowid" jdbcType="BIGINT" />
    <result column="COMPANY_CODE" property="companyCode" jdbcType="VARCHAR" />
    <result column="PRO_NO" property="proNo" jdbcType="VARCHAR" />
    <result column="PRO_NAME" property="proName" jdbcType="VARCHAR" />
    <result column="KPI_CODE" property="kpiCode" jdbcType="VARCHAR" />
    <result column="KPI_NAME" property="kpiName" jdbcType="VARCHAR" />
    <result column="KPI_VALUE" property="kpiValue" jdbcType="REAL" />
    <result column="ATTACHED_VALUE" property="attachedValue" jdbcType="REAL" />
    <result column="REPORT_DATE" property="reportDate" jdbcType="DATE" />
    <result column="SYS_CREATE_TIME" property="sysCreateTime" jdbcType="TIMESTAMP" />
    <result column="SYS_UPDATE_TIME" property="sysUpdateTime" jdbcType="TIMESTAMP" />
    <result column="SYS_DELETE_TIME" property="sysDeleteTime" jdbcType="TIMESTAMP" />
    <result column="SYS_PROCESS_FLAG" property="sysProcessFlag" jdbcType="CHAR" />
    <result column="REMARKS" property="remarks" jdbcType="VARCHAR" />
    <result column="ALL_KPI_VALUE" property="allKpiValue" jdbcType="REAL" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    rowid, COMPANY_CODE, PRO_NO, PRO_NAME, KPI_CODE, KPI_VALUE, ATTACHED_VALUE, REPORT_DATE, 
    SYS_CREATE_TIME, SYS_UPDATE_TIME, SYS_DELETE_TIME, SYS_PROCESS_FLAG, REMARKS,KPI_NAME,ALL_KPI_VALUE
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from pm_day_kpi
    where rowid = #{rowid,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from pm_day_kpi
    where rowid = #{rowid,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.glens.pwCloudOs.pm.schedulePlan.scheduleDaily.vo.PmDayKpi" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into pm_day_kpi (COMPANY_CODE, PRO_NO, 
      PRO_NAME, KPI_CODE, KPI_VALUE, 
      ATTACHED_VALUE, REPORT_DATE, SYS_CREATE_TIME, 
      SYS_UPDATE_TIME, SYS_DELETE_TIME, SYS_PROCESS_FLAG, 
      REMARKS,ALL_KPI_VALUE)
    values (#{companyCode,jdbcType=VARCHAR}, #{proNo,jdbcType=VARCHAR}, 
      #{proName,jdbcType=VARCHAR}, #{kpiCode,jdbcType=VARCHAR}, #{kpiValue,jdbcType=REAL}, 
      #{attachedValue,jdbcType=REAL}, #{reportDate,jdbcType=DATE}, now(), 
      null, null, 1, 
      #{remarks,jdbcType=VARCHAR},#{allKpiValue,jdbcType=REAL})
  </insert>
  <insert id="insertSelective" parameterType="com.glens.pwCloudOs.pm.schedulePlan.scheduleDaily.vo.PmDayKpi" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into pm_day_kpi
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="rowid != null" >
        rowid,
      </if>
      <if test="companyCode != null" >
        COMPANY_CODE,
      </if>
      <if test="proNo != null" >
        PRO_NO,
      </if>
      <if test="proName != null" >
        PRO_NAME,
      </if>
      <if test="kpiCode != null" >
        KPI_CODE,
      </if>
      <if test="kpiValue != null" >
        KPI_VALUE,
      </if>
      <if test="attachedValue != null" >
        ATTACHED_VALUE,
      </if>
      <if test="reportDate != null" >
        REPORT_DATE,
      </if>
      <if test="sysCreateTime != null" >
        SYS_CREATE_TIME,
      </if>
      <if test="sysUpdateTime != null" >
        SYS_UPDATE_TIME,
      </if>
      <if test="sysDeleteTime != null" >
        SYS_DELETE_TIME,
      </if>
      <if test="sysProcessFlag != null" >
        SYS_PROCESS_FLAG,
      </if>
      <if test="remarks != null" >
        REMARKS,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="rowid != null" >
        #{rowid,jdbcType=BIGINT},
      </if>
      <if test="companyCode != null" >
        #{companyCode,jdbcType=VARCHAR},
      </if>
      <if test="proNo != null" >
        #{proNo,jdbcType=VARCHAR},
      </if>
      <if test="proName != null" >
        #{proName,jdbcType=VARCHAR},
      </if>
      <if test="kpiCode != null" >
        #{kpiCode,jdbcType=VARCHAR},
      </if>
      <if test="kpiValue != null" >
        #{kpiValue,jdbcType=REAL},
      </if>
      <if test="attachedValue != null" >
        #{attachedValue,jdbcType=REAL},
      </if>
      <if test="reportDate != null" >
        #{reportDate,jdbcType=DATE},
      </if>
      <if test="sysCreateTime != null" >
        #{sysCreateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="sysUpdateTime != null" >
        #{sysUpdateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="sysDeleteTime != null" >
        #{sysDeleteTime,jdbcType=TIMESTAMP},
      </if>
      <if test="sysProcessFlag != null" >
        #{sysProcessFlag,jdbcType=CHAR},
      </if>
      <if test="remarks != null" >
        #{remarks,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.glens.pwCloudOs.pm.schedulePlan.scheduleDaily.vo.PmDayKpi" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update pm_day_kpi
    <set >
      <if test="companyCode != null" >
        COMPANY_CODE = #{companyCode,jdbcType=VARCHAR},
      </if>
      <if test="proNo != null" >
        PRO_NO = #{proNo,jdbcType=VARCHAR},
      </if>
      <if test="proName != null" >
        PRO_NAME = #{proName,jdbcType=VARCHAR},
      </if>
      <if test="kpiCode != null" >
        KPI_CODE = #{kpiCode,jdbcType=VARCHAR},
      </if>
      <if test="kpiValue != null" >
        KPI_VALUE = #{kpiValue,jdbcType=REAL},
      </if>
      <if test="attachedValue != null" >
        ATTACHED_VALUE = #{attachedValue,jdbcType=REAL},
      </if>
      <if test="reportDate != null" >
        REPORT_DATE = #{reportDate,jdbcType=DATE},
      </if>
      <if test="sysCreateTime != null" >
        SYS_CREATE_TIME = #{sysCreateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="sysUpdateTime != null" >
        SYS_UPDATE_TIME = #{sysUpdateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="sysDeleteTime != null" >
        SYS_DELETE_TIME = #{sysDeleteTime,jdbcType=TIMESTAMP},
      </if>
      <if test="sysProcessFlag != null" >
        SYS_PROCESS_FLAG = #{sysProcessFlag,jdbcType=CHAR},
      </if>
      <if test="remarks != null" >
        REMARKS = #{remarks,jdbcType=VARCHAR},
      </if>
    </set>
    where rowid = #{rowid,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.glens.pwCloudOs.pm.schedulePlan.scheduleDaily.vo.PmDayKpi" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update pm_day_kpi
    set COMPANY_CODE = #{companyCode,jdbcType=VARCHAR},
      PRO_NO = #{proNo,jdbcType=VARCHAR},
      PRO_NAME = #{proName,jdbcType=VARCHAR},
      KPI_CODE = #{kpiCode,jdbcType=VARCHAR},
      KPI_VALUE = #{kpiValue,jdbcType=REAL},
      ATTACHED_VALUE = #{attachedValue,jdbcType=REAL},
      REPORT_DATE = #{reportDate,jdbcType=DATE},
      SYS_CREATE_TIME = #{sysCreateTime,jdbcType=TIMESTAMP},
      SYS_UPDATE_TIME = #{sysUpdateTime,jdbcType=TIMESTAMP},
      SYS_DELETE_TIME = #{sysDeleteTime,jdbcType=TIMESTAMP},
      SYS_PROCESS_FLAG = #{sysProcessFlag,jdbcType=CHAR},
      REMARKS = #{remarks,jdbcType=VARCHAR}
    where rowid = #{rowid,jdbcType=BIGINT}
  </update>
  
  <select id="queryForList" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from pm_day_kpi
  </select>
  
  <select id="queryForCount" resultType="int" parameterType="map">
    select 
    count(*)
    from pm_day_kpi
  </select>
  
  <select id="queryForPage" resultMap="BaseResultMap" parameterType="map">
    select 
    <include refid="Base_Column_List" />
    from pm_day_kpi
    limit #{firstResult},#{maxResult} 
  </select>
  
  <select id="queryByProNoAndReportDate" resultType="map">
    select 
    	t1.pro_no as proNo,
    	t1.pro_name as proName,
    	t1.kpi_code as kpiCode,
    	t1.kpi_value as kpiValue,
    	t1.all_kpi_value as allKpiValue,
    	t1.ATTACHED_VALUE as attachedValue,
    	t1.REPORT_DATE as reportDate,
    	t2.KPI_TYPE as kpiType, 
    	t2.kpi_name as kpiName, 
    	t2.kpi_unit as kpiUnit,
    	t2.MERGE_FLAG as mergeFlag,
    	t2.ITEM_LABEL as itemLabel,
    	t2.IS_PER_CNT as isPerCnt,
    	ROUND(t2.KPI_WEIGHT*100, 2) as kpiWeight
    from pm_day_kpi t1
    left join pm_pro_kpi t2 on t2.kpi_code = t1.kpi_code
    where t1.pro_no = #{proNo}
    and t1.report_date = #{reportDate}
  </select>
  
  <insert id="batchInsert" parameterType="list" >
    insert into pm_day_kpi (COMPANY_CODE, PRO_NO, PRO_NAME, KPI_CODE, KPI_VALUE, ATTACHED_VALUE, REPORT_DATE, 
    SYS_CREATE_TIME, SYS_UPDATE_TIME, SYS_DELETE_TIME, SYS_PROCESS_FLAG, REMARKS, ALL_KPI_VALUE)
    values 
    <foreach collection="list" item="item" separator="," close="" open="">
  		(#{item.companyCode,jdbcType=VARCHAR}, #{item.proNo,jdbcType=VARCHAR}, 
      #{item.proName,jdbcType=VARCHAR}, #{item.kpiCode,jdbcType=VARCHAR}, #{item.kpiValue,jdbcType=REAL}, 
      #{item.attachedValue,jdbcType=REAL}, #{item.reportDate,jdbcType=DATE}, now(), 
      null, null, 1, 
      #{item.remarks,jdbcType=VARCHAR}, #{item.allKpiValue,jdbcType=REAL})
	</foreach>
  </insert>
  
  <delete id="deleteByProNoAndDate" parameterType="map" >
    delete from pm_day_kpi
    where pro_no = #{proNo,jdbcType=VARCHAR} and REPORT_DATE = #{reportDate,jdbcType=DATE} 
  </delete>
  <select id="findKpiByDate" parameterType="map" resultType="map">
  	select 
		kpi_code as kpiCode,
		sum(kpi_value) as kpiValue
	from pm_day_kpi where pro_no=#{proNo} and report_date &gt;= #{sdate} and report_date &lt;= #{edate}
	group by kpi_code
  </select>
  <select id="queryProKpiProgress" parameterType="map" resultType="map">
  	select 
		t1.pro_no as proNo, 
		t1.pro_name as proName, 
		t3.pro_manager as proManager, 
		t1.kpi_code as kpiCode, 
		t2.kpi_name as kpiName, 
		t2.IS_PER_CNT as isPerCnt,
		t4.KPI_VALUE as totalVal, 
		round(max(t1.kpi_value), 1) as completedVal,
		round(max(t1.kpi_value)/t4.KPI_VALUE*100, 1) as percentVal, 
		min(t1.report_date) as fromDate, 
		max(t1.report_date) as endDate  
	from pm_day_kpi t1
	left join pm_pro_kpi t2 on t2.kpi_code = t1.kpi_code
	left join pm_plan_kpi t4 on t4.pro_no=t1.pro_no and t4.kpi_code = t1.kpi_code and t4.plan_no='-1'
	join pm_base t3 on t3.pro_no=t1.pro_no and t3.category_code=#{categoryCode}
	where 1=1
	<if test="beginDate != null and beginDate != ''">
	and t1.report_date &gt;= #{beginDate}
	</if>
	<if test="endDate != null and endDate != ''">
	and t1.report_date &lt;= #{endDate}
	</if>
	<if test="proNos != null and proNos != ''">
	and instr(#{proNos},t1.pro_no) &gt; 0
	</if>
	<if test="deptCode != null and deptCode != ''">
		and t3.MANAGE_DEPT=#{deptCode}
    </if>
	group by t1.pro_no, t1.kpi_code;
  </select>
  <select id="queryKpiSum" parameterType="map" resultType="map">
  	SELECT kpi_code as kpiCode, SUM(kpi_value) as kpiSum FROM pm_day_kpi WHERE pro_no = #{proNo} AND REPORT_DATE &lt; #{workDate} GROUP BY kpi_code 
  </select>
</mapper>