<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.glens.pwCloudOs.pm.schedulePlan.weekJobSchedule.dao.weekJobScheduleMapper" >
  
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
   IFNULL(b.ROW_ID,0) rowId,a.COMPANY_CODE companyCode, a.PRO_NO proNo, a.PRO_NAME proName,IFNULL(a.PROVINCE,'') province,a.CITY city,a.DISTRICT district,a.PRO_MANAGER proManager,
	IFNULL(b.TOTAL_WORKLOAD,0) totalWorkload,IFNULL(b.IW_WEEK_ACCUMULATIVE_WORKLOAD,0) iwWeekAccumulativeWorkload,IFNULL(b.OW_WEEK_ACCUMULATIVE_WORKLOAD,0) owWeekAccumulativeWorkload,
	IFNULL(b.WEEK_ACCUMULATIVE_WORKLOAD,0) weekAccumulativeWorkload,CONCAT(ROUND(IFNULL(b.COMPLETION_STAGE,0) * 100,2),'%') completionStage,
	IFNULL(c.TREND_NAME,'') trendName,IFNULL(DATE_FORMAT(b.START_DATE,'%Y-%m-%d'), '-') startDate,ifnull(CUR_YEAR, "") curYear,
	IFNULL(DATE_FORMAT(b.END_DATE,'%Y-%m-%d'), '-') endDate,IFNULL(b.WEEK,'') WEEK,IFNULL(b.WORKLOAD_DESC,'') workloadDesc, 
	case when b.ROW_ID is null then '0' else '1' end submitStatus,a.PRO_YEAR proYear,d.CATEGORY_NAME categoryName
  </sql>
  
  <select id="queryForList" parameterType="java.util.HashMap" resultType="map">
  	select
  	<include refid="Base_Column_List" />
  	from PM_BASE a
  	LEFT JOIN pm_week_workload b ON a.pro_no=b.pro_no
  	<if test="week != null and week != ''">
  		and b.WEEK=#{week}
  	</if>
  	<if test="curYear != null">
  	and b.CUR_YEAR=#{curYear}
  	</if>
	LEFT JOIN pm_week_progress_trend c ON b.trend=c.trend_code
	join PM_CATEGORY d on a.CATEGORY_CODE=d.CATEGORY_CODE
	where a.PRO_STATUS='2' and a.SYS_PROCESS_FLAG='1' and a.COMPANY_CODE=#{companyCode}
	<if test="proNo != null and proNo != ''">
  	and FIND_IN_SET(a.PRO_NO, #{proNo})
  	</if>
  	<if test="categoryCode != null and categoryCode != ''">
  	and a.CATEGORY_CODE=#{categoryCode}
  	</if>
	<if test="deptCode != null and deptCode != ''">
		and a.MANAGE_DEPT=#{deptCode}
    </if>
	
  </select>
  
  <select id="selectProWeekWorkload" parameterType="java.util.HashMap" resultType="map">
  	select
  	<include refid="Base_Column_List" />
  	from PM_BASE a
  	LEFT JOIN pm_week_workload b ON a.pro_no=b.pro_no
  	<if test="week != null and week != ''">
  		and b.WEEK=#{week}
  	</if>
  	<if test="curYear != null">
  	and b.CUR_YEAR=#{curYear}
  	</if>
	LEFT JOIN pm_week_progress_trend c ON b.trend=c.trend_code
	join PM_CATEGORY d on a.CATEGORY_CODE=d.CATEGORY_CODE
	where a.PRO_NO=#{proNo} and a.COMPANY_CODE=#{companyCode}
  </select>

  <insert id="insert" parameterType="java.util.HashMap" >
    insert into pm_week_workload (COMPANY_CODE, PRO_NO, 
      TOTAL_WORKLOAD, IW_WEEK_ACCUMULATIVE_WORKLOAD, OW_WEEK_ACCUMULATIVE_WORKLOAD, 
      WEEK_ACCUMULATIVE_WORKLOAD, COMPLETION_STAGE, TREND, CUR_YEAR,
      START_DATE, END_DATE, WEEK,WORKLOAD_DESC, SYS_CREATE_TIME, SYS_PROCESS_FLAG, REMARKS
      )
    values (#{companyCode,jdbcType=VARCHAR}, #{proNo,jdbcType=VARCHAR}, 
      #{totalWorkload}, #{iwWeekAccumulativeWorkload}, #{owWeekAccumulativeWorkload}, 
      #{weekAccumulativeWorkload}, #{completionStage}, #{trendCode}, #{curYear},
      #{startDate}, #{endDate}, #{week}, #{workloadDesc}, 
      now(), '1', #{remarks,jdbcType=VARCHAR}
      )
  </insert>
   <update id="update" parameterType="java.util.HashMap" >
    update pm_week_workload
    <set >
      <if test="totalWorkload != null">
      TOTAL_WORKLOAD = #{totalWorkload},
      </if>
      <if test="iwWeekAccumulativeWorkload != null">
      IW_WEEK_ACCUMULATIVE_WORKLOAD = #{iwWeekAccumulativeWorkload}, 
      </if>
      <if test="owWeekAccumulativeWorkload != null">
      OW_WEEK_ACCUMULATIVE_WORKLOAD = #{owWeekAccumulativeWorkload},
      </if>
      <if test="weekAccumulativeWorkload != null"> 
      WEEK_ACCUMULATIVE_WORKLOAD = #{weekAccumulativeWorkload},
      </if>
      <if test="completionStage != null"> 
      COMPLETION_STAGE = #{completionStage},
      </if>
      <if test="trendCode != null"> 
      TREND = #{trendCode},
      </if>
      <if test="workloadDesc != null"> 
      WORKLOAD_DESC = #{workloadDesc},
      </if>
      <if test="remarks != null"> 
      REMARKS = #{remarks,jdbcType=VARCHAR},
      </if>
      <if test="curYear != null">
      CUR_YEAR=#{curYear},
      </if>
      SYS_UPDATE_TIME = NOW()
    </set>
   where ROW_ID=#{rowId}
  </update>
  
  <select id="getFormulaByProNo" parameterType="java.lang.String" resultType="java.lang.String">
  	SELECT IFNULL(a.WORKLOAD_FORMULA,'') formula
	FROM PM_CATEGORY a
	JOIN pm_base b ON a.category_code=b.category_code
	WHERE b.pro_no=#{proNo}
  </select>
  
  <select id="selectWorkloadTrend" resultType="map">
  	SELECT TREND_CODE trendCode,TREND_NAME trendName 
	FROM PM_WEEK_PROGRESS_TREND
	WHERE SYS_PROCESS_FLAG='1'
  </select>
  
</mapper>