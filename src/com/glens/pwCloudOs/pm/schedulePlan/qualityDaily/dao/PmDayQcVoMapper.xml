<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.glens.pwCloudOs.pm.schedulePlan.qualityDaily.dao.PmDayQcVoMapper" >
  <resultMap id="BaseResultMap" type="com.glens.pwCloudOs.pm.schedulePlan.qualityDaily.vo.PmDayQcVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <result column="COMPANY_CODE" property="companyCode" jdbcType="VARCHAR" />
    <result column="PRO_NO" property="proNo" jdbcType="VARCHAR" />
    <result column="PRO_NAME" property="proName" jdbcType="VARCHAR" />
    <result column="REPORT_DATE" property="reportDate" />
    <result column="REMARKS" property="remarks" jdbcType="VARCHAR" />
    <result column="DAY_QC_STATUS" property="reportStatus"/>
    <result column="STATION" property="station"/>
    <result column="LINE" property="line"/>
    <result column="CABLEPIT" property="cablepit"/>
    <result column="UNIT_WORKLOAD" property="unitWorkload"/>
    <result column="CHECK_TYPENAME" property="checkTypeName"/>
    <result column="CHECK_TYPECODE" property="checkTypeCode"/>
    <result column="DEVICE_LPERSON" property="deviceLperson"/>
    <result column="CHECK_NAME" property="checkName"/>
    <result column="CHECK_DATE" property="checkDate"/>
    <result column="CHECK_RESULT" property="checkResult"/>
    <result column="PROBLEM_TYPECODE" property="problemTypeCode"/>
    <result column="PROBLEM_TYPENAME" property="problemTypeName"/>
    <result column="PROBLEM_DESC" property="problemDesc"/>
    <result column="RECTIFY_STATUS" property="rectifyStatus"/>
    <result column="RECTIFY_DATE" property="rectifyDate"/>
    <result column="RECTIFY_DESC" property="rectifyDesc"/>
    <result column="CATEGORY_NAME" property="categoryName"/>
    <result column="CATEGORY_CODE" property="categoryCode"/>
    <result column="qcNum" property="qcNum"/>
    <result column="PRO_MANAGER" property="proManager"/>
    <result column="PRO_PHASE" property="proPhase"/>
    <result column="NEIYE" property="neiye"/>
    <result column="WAIYE" property="waiye"/>
    
    
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    a.COMPANY_CODE, 
    a.PRO_NO, 
    a.PRO_NAME, 
    ifnull(DATE_FORMAT(b.REPORT_DATE,'%Y-%m-%d'),'-') REPORT_DATE, 
    ifnull(b.REMARKS,'') REMARKS,
    case when b.PRO_NO is null then '0' else '1' end DAY_QC_STATUS,
    b.STATION,
    b.LINE,
    b.CABLEPIT,
    a.UNIT_WORKLOAD,
    c.CHECK_TYPENAME,
    b.CHECK_TYPECODE,
    b.DEVICE_LPERSON,
    b.CHECK_NAME,
    b.CHECK_DATE,
    b.CHECK_RESULT,
    b.PROBLEM_TYPECODE,
    d.PROBLEM_TYPENAME,
    b.PROBLEM_DESC,
    b.RECTIFY_STATUS,
    b.RECTIFY_DATE,
    b.RECTIFY_DESC,
    p.CATEGORY_NAME,
    p.CATEGORY_CODE,
    a.PRO_MANAGER,
    count(b.pro_no) qcNum,
    sum(case b.check_typecode when 1 then 1 else 0 end) NEIYE,
    sum(case b.check_typecode when 2 then 1 else 0 end) WAIYE,
    case a.PRO_PHASE  
    when '1' then '前期'  
    when '2' then '中期'
    when '3' then '后期'
    when '4' then '更新类'
    when '5' then '维护类'
    when '6' then '已竣工'
    when '7' then '项目暂停'
    else '其他' end as PRO_PHASE
  </sql>
  
  <select id="selectProDayQc" parameterType="java.util.HashMap" resultMap="BaseResultMap">
  
  	select
  	<include refid="Base_Column_List" />
  	from PM_BASE a
	left join PM_DAY_QC b on a.PRO_NO=b.PRO_NO and b.CHECK_DATE=#{date}
	left join PM_QC_CHECKTYPE c on c.CHECK_TYPECODE=b.CHECK_TYPECODE
	left join PM_QC_PROBLEMTYPE d on d.PROBLEM_TYPECODE=b.PROBLEM_TYPECODE
	left join PM_CATEGORY p on p.CATEGORY_CODE=a.CATEGORY_CODE
	where a.SYS_PROCESS_FLAG='1'
	and a.PRO_NO=#{proNo}
	<if test="deptCode != null and deptCode != ''">
		and a.MANAGE_DEPT=#{deptCode}
    </if>	
	group by a.pro_no
  </select>
  
  
  <select id="getDetailList" parameterType="map" resultType="map">
  			select   a.COMPANY_CODE companyCode, 
    a.PRO_NO proNo, 
    a.PRO_NAME proName, 
   b.REPORT_DATE reportDate, 
    ifnull(b.REMARKS,'')  remarks,

    b.STATION station,
    b.LINE line,
    b.CABLEPIT cablepit,
    
    c.CHECK_TYPENAME checkTypeName,
    b.CHECK_TYPECODE checkTypeCode,
    b.DEVICE_LPERSON deviceLperson,
    b.CHECK_NAME checkName,
    ifnull(DATE_FORMAT(b.CHECK_DATE,'%Y-%m-%d'),'-')  checkDate,
    
    b.CHECK_RESULT checkResult,
    b.PROBLEM_TYPECODE problemTypeCode,
d.PROBLEM_TYPENAME problemTypeName,
b.PROBLEM_DESC problemDesc,
b.RECTIFY_STATUS rectifyStatus,
b.RECTIFY_DATE rectifyDate,
b.RECTIFY_DESC rectifyDesc,
p.CATEGORY_NAME categoryName,
a.PRO_PHASE proPhase,
s.CHECKCLASSNAME checkClassName,
s.CHECKCLASSCODE checkClassCode,
case a.PRO_PHASE  
    when '1' then '前期'  
    when '2' then '中期'
    when '3' then '后期'
    when '4' then '更新类'
    when '5' then '维护类'
    when '6' then '已竣工'
    when '7' then '项目暂停'
    else '其他' end as proPhase
from PM_BASE a
left join PM_DAY_QC b on a.PRO_NO=b.PRO_NO and b.CHECK_DATE=#{reportDate}
left join PM_QC_CHECKTYPE c on c.CHECK_TYPECODE=b.CHECK_TYPECODE
left join PM_QC_PROBLEMTYPE d on d.PROBLEM_TYPECODE=b.PROBLEM_TYPECODE
left join PM_CATEGORY p on p.CATEGORY_CODE=a.CATEGORY_CODE
left join PM_QC_CHECKCLASS s on s.CHECKCLASSCODE=b.CHECKCLASSCODE
where a.PRO_STATUS='2' and a.SYS_PROCESS_FLAG='1'
and a.PRO_NO=#{proNo} and b.pro_no is not null

	<if test="deptCode != null and deptCode != ''">
		and a.MANAGE_DEPT=#{deptCode}
    </if> 
  			
  </select>
  
  <delete id="deleteDetalList" parameterType="com.glens.pwCloudOs.pm.schedulePlan.qualityDaily.vo.PmDayQcVo">
  		delete from pm_day_qc where pro_No=#{proNo} and CHECK_DATE=#{checkDate}
  </delete>
  

  <insert id="insert" parameterType="com.glens.pwCloudOs.pm.schedulePlan.qualityDaily.vo.PmDayQcVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
   insert into pm_day_qc
	(COMPANY_CODE, PRO_NO, PRO_NAME, REPORT_DATE, SYS_CREATE_TIME,SYS_PROCESS_FLAG, 
	REMARKS, STATION, LINE, CABLEPIT, CHECK_TYPECODE, DEVICE_LPERSON, CHECK_NAME, CHECK_DATE, 
	CHECK_RESULT, PROBLEM_TYPECODE, PROBLEM_DESC, RECTIFY_STATUS, 
	RECTIFY_DATE, RECTIFY_DESC,CHECKCLASSCODE)
	values
	(#{companyCode}, #{proNo}, #{proName}, #{reportDate}, now(),1, 
	#{remarks}, #{station}, #{line},#{cablepit}, #{checkTypeCode}, #{deviceLperson},#{checkName}, #{checkDate}, 
	#{checkResult}, #{problemTypeCode}, #{problemDesc}, #{rectifyStatus}, 
	#{rectifyDate}, #{rectifyDesc},#{checkClassCode})
	
  </insert>
  
  <update id="update" parameterType="com.glens.pwCloudOs.pm.schedulePlan.qualityDaily.vo.PmDayQcVo" >
  		update pm_day_qc 
  		<set>
  			<if test="remarks != null">
  				REMARKS=#{remarks},
  			</if>
  			<if test="station != null">
  				STATION=#{station},
  			</if>
  			<if test="line != null">
  				LINE=#{line},
  			</if>
  			<if test="cablepit != null">
  				CABLEPIT=#{cablepit},
  			</if>
  			<if test="checkTypeCode != null">
  				CHECK_TYPECODE=#{checkTypeCode},
  			</if>
  			<if test="deviceLperson != null">
  				DEVICE_LPERSON=#{deviceLperson},
  			</if>
  			<if test="checkName != null">
  				CHECK_NAME=#{checkName},
  			</if>
  			<if test="checkDate != null">
  				CHECK_DATE=#{checkDate},
  			</if>
  			<if test="checkResult != null">
  				CHECK_RESULT=#{checkResult},
  			</if>
  			<if test="problemTypeCode != null">
  				PROBLEM_TYPECODE=#{problemTypeCode},
  			</if>
  			<if test="problemDesc != null">
  				PROBLEM_DESC=#{problemDesc},
  			</if>
  			<if test="rectifyStatus != null">
  				RECTIFY_STATUS=#{rectifyStatus},
  			</if>
  			<if test="rectifyDate != null">
  				RECTIFY_DATE=#{rectifyDate},
  			</if>
  			<if test="rectifyDesc != null">
  				RECTIFY_DESC=#{rectifyDesc},
  			</if>
  			<if test="checkClassCode != null">
  				CHECKCLASSCODE=#{checkClassCode},
  			</if>
  			
  		</set>
		where COMPANY_CODE=#{companyCode} and PRO_NO=#{proNo} and REPORT_DATE=#{reportDate}
  </update>
  
  <select id="problemType"  resultType="map">
	select PROBLEM_TYPECODE problemtypecode,PROBLEM_TYPENAME problemtypename
	from PM_QC_PROBLEMTYPE
	where CATEGORY_CODE=#{categoryCode}
  </select>
  
  <select id="checkType"  resultType="map">
	select CHECK_TYPECODE checktypecode,CHECK_TYPENAME checktypename 
	from pm_qc_checktype
  </select>
  
   <select id="checkClass"  resultType="map">
	select CHECKCLASSCODE checkClassCode,CHECKCLASSNAME checkClassName from  PM_QC_CHECKCLASS
  </select>
  
  
  <select id="qualityAnalysis"  resultType="map" parameterType="map">
	select b.PRO_NO prono,b.PRO_MANAGER promanager,b.PRO_NAME proname,ifnull(b.QC_MIN,0) qcmin ,b.CATEGORY_CODE,p.CATEGORY_NAME categoryname,
        ifnull(sum(d.check_result),0) qualifiednum,
        
        sum(case d.check_typecode when 1 then d.check_result else 0 end) inqualifiednum,
        sum(case d.check_typecode when 2 then d.check_result else 0 end) outqualifiednum,


case when sum(case d.check_typecode when 1 then 1 else 0 end)=0 then 0 else ifnull(sum(case d.check_typecode when 1 then d.check_result else 0 end),0)/sum(case d.check_typecode when 1 then 1 else 0 end)*100 end inrate,
case when sum(case d.check_typecode when 2 then 1 else 0 end)=0 then 0 else ifnull(sum(case d.check_typecode when 2 then d.check_result else 0 end),0)/sum(case d.check_typecode when 2 then 1 else 0 end)*100 end outrate,
sum(case d.check_typecode when 1 then 1 else 0 end) innum,
        sum(case d.check_typecode when 2 then 1 else 0 end) outnum,
      

        count(d.PRO_NO) sumnum,
        
        

	case when count(d.PRO_NO)=0 then 0 else ifnull(sum(d.check_result),0)/count(d.PRO_NO)*100 end rate,
	case when count(d.PRO_NO)>=ifnull(b.QC_MIN,0) then '1' else '0' end isDabiao
	from pm_base b
	left join PM_CATEGORY p on p.CATEGORY_CODE=b.CATEGORY_CODE 
	left join pm_day_qc d on d.PRO_NO=b.PRO_NO
	WHERE 1=1
	
	<if test="companyCode != null and companyCode != ''">
		and b.COMPANY_CODE=#{companyCode}
	</if>
	<if test="categoryCode != null and categoryCode != ''">
		and b.CATEGORY_CODE =#{categoryCode}
	</if>
	<if test="employeeCode != null and employeeCode != ''">
		and b.employeecode=#{employeeCode}
	</if>
	
	<if test="fromDate != null and fromDate != ''">
		and d.CHECK_DATE &gt;= #{fromDate}
	</if>
	
	<if test="toDate != null and toDate != ''">
		and d.CHECK_DATE &lt;= #{toDate}
	</if>
	
	<if test="proNo != null and proNo != ''">
		and b.PRO_NO = #{proNo}
	</if>
	<if test="proStatus != null and proStatus != ''">
		and b.PRO_STATUS = #{proStatus}
	</if>
	<if test="deptCode != null and deptCode != ''">
		and b.MANAGE_DEPT=#{deptCode}
    </if>
	
	group by b.PRO_NO
	
  </select>
  
</mapper>