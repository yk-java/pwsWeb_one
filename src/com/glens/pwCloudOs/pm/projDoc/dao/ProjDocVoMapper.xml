<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.glens.pwCloudOs.pm.projDoc.dao.ProjDocVoMapper" >
  <resultMap id="BaseResultMap" type="com.glens.pwCloudOs.pm.projDoc.vo.ProjDocVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="rowid" property="rowid" jdbcType="BIGINT" />
    <result column="COMPANY_CODE" property="companyCode" jdbcType="VARCHAR" />
    <result column="PRO_NO" property="proNo" jdbcType="VARCHAR" />
    <result column="DOC_NO" property="docNo" jdbcType="VARCHAR" />
    <result column="DOC_TYPELIB_CODE" property="docTypelibCode" jdbcType="VARCHAR" />
    <result column="TITLE" property="title" jdbcType="VARCHAR" />
    <result column="FILE_NAME" property="fileName" jdbcType="VARCHAR" />
    <result column="SUFFIX_NAME" property="suffixName" jdbcType="VARCHAR" />
    <result column="RE_VISITID" property="reVisitid" jdbcType="VARCHAR" />
    <result column="DL_VISITID" property="dlVisitid" jdbcType="VARCHAR" />
    <result column="UPLOAD_DATE" property="uploadDate" />
    <result column="FILE_SIZE" property="fileSize" jdbcType="REAL" />
    <result column="RE_COUNT" property="reCount" jdbcType="INTEGER" />
    <result column="DL_COUNT" property="dlCount" jdbcType="INTEGER" />
    <result column="REMARKS" property="remarks" jdbcType="VARCHAR" />
    <result column="DOC_TYPELIB_NAME" property="docTypelibName" jdbcType="VARCHAR" />
    <result column="DOC_CLASS_NAME" property="docClassName" />
    <result column="PRO_NAME" property="proName" />
    <result column="PRO_MANAGER" property="proManager" />
    <result column="SYS_CREATE_TIME" property="createTime" />
    <result column="ISCHECKED" property="isChecked" />
    <result column="CHECK_VAL" property="checkVal" />
    <result column="CHECK_DESC" property="checkDesc" />
    <result column="REMARKS1" property="remarks1" />
     <result column="CHECK_FLAG" property="checkFlag" />
    
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    a.rowid, a.COMPANY_CODE,c.PRO_MANAGER PRO_MANAGER,a.PRO_NO,a.DOC_NO,a.DOC_TYPELIB_CODE, a.TITLE, a.FILE_NAME, a.SUFFIX_NAME, a.RE_VISITID, 
    a.DL_VISITID, ifnull(DATE_FORMAT(a.UPLOAD_DATE,'%Y-%m-%d'),'') UPLOAD_DATE, a.FILE_SIZE, ifnull(a.RE_COUNT,0) RE_COUNT, ifnull(a.DL_COUNT,0) DL_COUNT, a.REMARKS,
    b.DOC_TYPELIB_NAME,case b.DOC_CLASS when 1 then '项目规范' when 2 then '过程文档' when 3 then '项目立项' when 4 then '投标' 
    when 5 then '合同' when 6 then '工作量报告' when 7 then '项目结算' when 8 then '决算文件' end DOC_CLASS_NAME,c.PRO_NAME,a.SYS_CREATE_TIME , 
    CASE   WHEN ck.doc_no IS NULL THEN 0 ELSE 1 END ISCHECKED,ifnull(ck.CHECK_VAL,'') CHECK_VAL,ifnull(ck.CHECK_DESC,'') CHECK_DESC,ifnull(ck.REMARKS,'') REMARKS1,ifnull(ck.CHECK_FLAG,0) CHECK_FLAG
  </sql>
  
  <select id="queryForCount" parameterType="java.util.HashMap" resultType="int">
  	select count(*) from(
  	select * from (
  	 select 
     <include refid="Base_Column_List" />
     from pm_document_lib a
    join PM_DOCUMENT_TYPELIB b on a.DOC_TYPELIB_CODE=b.DOC_TYPELIB_CODE
    join pm_base c on a.PRO_NO=c.PRO_NO
     left join PM_DOCUMENT_CHECK ck on ck.doc_no=a.doc_no
    
    where a.SYS_PROCESS_FLAG='1'
     <if test="accountCode != null and accountCode != ''">
    	and c.ACCOUNT_CODE=#{accountCode}
    </if>
    <if test="docClass != null and docClass != 0">
    and b.DOC_CLASS=#{docClass}
    </if>
    
    <if test="docTypelibCode != null and docTypelibCode !=''">
    and a.DOC_TYPELIB_CODE=#{docTypelibCode}
    </if>
    
    <if test="proNo != null and proNo != ''">
    and a.PRO_NO=#{proNo}
    </if>
    <if test="proStatus != null and proStatus != ''">
    and c.PRO_STATUS=#{proStatus}
    </if>
    <if test="fromDate != null and fromDate != ''">
    	and a.UPLOAD_DATE &gt;=#{fromDate}
    </if>
   <if test="toDate != null and toDate != ''">
    	and a.UPLOAD_DATE &lt;=#{toDate}
    </if>
    
    <if test="searchName!=null and searchName !=''">
    	and (c.pro_name like  "%"#{searchName}"%" or a.title like "%"#{searchName}"%" or c.PRO_MANAGER like "%"#{searchName}"%" )
    </if>
    <if test="districtManager != null and districtManager != ''">
    and c.DISTRICT_MANAGER=#{districtManager}
    </if>
    <if test="deptCode != null and deptCode != ''">
    and c.MANAGE_DEPT=#{deptCode}
    </if>
    order by a.UPLOAD_DATE desc
    ) temp where 1=1
    
    <if test="isChecked != null and isChecked != ''">
    	and ISCHECKED=#{isChecked}
    </if>
    ) temp1
    
  </select>
  
  <select id="queryForPage" parameterType="java.util.HashMap" resultMap="BaseResultMap">
  	select * from (
  	 select 
     <include refid="Base_Column_List" />
     from pm_document_lib a
    join PM_DOCUMENT_TYPELIB b on a.DOC_TYPELIB_CODE=b.DOC_TYPELIB_CODE
    join pm_base c on a.PRO_NO=c.PRO_NO
     left join PM_DOCUMENT_CHECK ck on ck.doc_no=a.doc_no
    
    where a.SYS_PROCESS_FLAG='1'
     <if test="accountCode != null and accountCode != ''">
    	and c.ACCOUNT_CODE=#{accountCode}
    </if>
    <if test="docClass != null and docClass != 0">
    and b.DOC_CLASS=#{docClass}
    </if>
    
    <if test="docTypelibCode != null and docTypelibCode !=''">
    and a.DOC_TYPELIB_CODE=#{docTypelibCode}
    </if>
    
    <if test="proNo != null and proNo != ''">
    and a.PRO_NO=#{proNo}
    </if>
    <if test="proStatus != null and proStatus != ''">
    and c.PRO_STATUS=#{proStatus}
    </if>
    <if test="fromDate != null and fromDate != ''">
    	and a.UPLOAD_DATE &gt;=#{fromDate}
    </if>
   <if test="toDate != null and toDate != ''">
    	and a.UPLOAD_DATE &lt;=#{toDate}
    </if>
    
    <if test="searchName!=null and searchName !=''">
    	and (c.pro_name like  "%"#{searchName}"%" or a.title like "%"#{searchName}"%" or c.PRO_MANAGER like "%"#{searchName}"%")
    </if>
    <if test="districtManager != null and districtManager != ''">
    and c.DISTRICT_MANAGER=#{districtManager}
    </if>
     <if test="deptCode != null and deptCode != ''">
    and c.MANAGE_DEPT=#{deptCode}
    </if>
    order by a.UPLOAD_DATE desc
    ) temp where 1=1
    
    <if test="isChecked != null and isChecked != ''">
    	and ISCHECKED=#{isChecked}
    </if>
    
    limit #{firstResult},#{maxResult}
  </select>
  
  
  <select id="getAllFileByProNo" parameterType="java.util.HashMap" resultMap="BaseResultMap">
  	select * from (
  	 select 
     <include refid="Base_Column_List" />
     from pm_document_lib a
    join PM_DOCUMENT_TYPELIB b on a.DOC_TYPELIB_CODE=b.DOC_TYPELIB_CODE
    join pm_base c on a.PRO_NO=c.PRO_NO
     left join PM_DOCUMENT_CHECK ck on ck.doc_no=a.doc_no
    
    where a.SYS_PROCESS_FLAG='1'  and b.DOC_TYPELIB_CODE in('21','1','2','3','4','5','6')
     <if test="accountCode != null and accountCode != ''">
    	and c.ACCOUNT_CODE=#{accountCode}
    </if>
    <if test="docClass != null and docClass != 0">
    and b.DOC_CLASS=#{docClass}
    </if>
    
    <if test="docTypelibCode != null and docTypelibCode !=''">
    and a.DOC_TYPELIB_CODE=#{docTypelibCode}
    </if>
    
    <if test="proNo != null and proNo != ''">
    and a.PRO_NO=#{proNo}
    </if>
   <!--  <if test="proStatus != null and proStatus != ''">
    and c.PRO_STATUS=#{proStatus}
    </if> -->
    
   <!--  <if test="fromDate != null and fromDate != ''">
    	and a.UPLOAD_DATE &gt;=#{fromDate}
    </if>
   <if test="toDate != null and toDate != ''">
    	and a.UPLOAD_DATE &lt;=#{toDate}
    </if> -->
    
    
    
    <if test="searchName!=null and searchName !=''">
    	and (c.pro_name like  "%"#{searchName}"%" or a.title like "%"#{searchName}"%")
    </if>
    <if test="districtManager != null and districtManager != ''">
    and c.DISTRICT_MANAGER=#{districtManager}
    </if>
     <if test="deptCode != null and deptCode != ''">
    and c.MANAGE_DEPT=#{deptCode}
    </if>
    order by a.UPLOAD_DATE desc
    ) temp where 1=1
    
    <if test="isChecked != null and isChecked != ''">
    	and ISCHECKED=#{isChecked}
    </if>
    
    
  </select>
  
  <select id="findById" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from pm_document_lib a
    join PM_DOCUMENT_TYPELIB b on a.DOC_TYPELIB_CODE=b.DOC_TYPELIB_CODE
     left join PM_DOCUMENT_CHECK ck on ck.doc_no=a.doc_no
    where rowid = #{rowid,jdbcType=BIGINT}
  </select>

  <insert id="insert" parameterType="com.glens.pwCloudOs.pm.projDoc.vo.ProjDocVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into pm_document_lib (rowid, COMPANY_CODE, PRO_NO,DOC_NO, 
      DOC_TYPELIB_CODE, TITLE, FILE_NAME, 
      SUFFIX_NAME, RE_VISITID, DL_VISITID, 
      UPLOAD_DATE, FILE_SIZE, SYS_CREATE_TIME, SYS_PROCESS_FLAG, REMARKS
      )
    values (#{rowid,jdbcType=BIGINT}, #{companyCode,jdbcType=VARCHAR}, #{proNo,jdbcType=VARCHAR}, #{docNo,jdbcType=VARCHAR},
      #{docTypelibCode,jdbcType=VARCHAR}, #{title,jdbcType=VARCHAR}, #{fileName,jdbcType=VARCHAR}, 
      #{suffixName,jdbcType=VARCHAR}, #{reVisitid,jdbcType=VARCHAR}, #{dlVisitid,jdbcType=VARCHAR}, 
      #{uploadDate}, #{fileSize,jdbcType=REAL}, now(), '1', #{remarks,jdbcType=VARCHAR}
      )
  </insert>
  
  <insert id="insertProj" parameterType="list">

	insert into pm_document_lib (COMPANY_CODE, PRO_NO,DOC_NO, 
      DOC_TYPELIB_CODE, TITLE, FILE_NAME, 
      SUFFIX_NAME, RE_VISITID, DL_VISITID, 
      UPLOAD_DATE, FILE_SIZE, SYS_CREATE_TIME, SYS_PROCESS_FLAG, REMARKS
      )
    values 
    <foreach collection="list" item="item" separator="," close="" open="">
      (#{item.companyCode,jdbcType=VARCHAR}, #{item.proNo,jdbcType=VARCHAR}, #{item.docNo,jdbcType=VARCHAR},
      #{item.docTypelibCode,jdbcType=VARCHAR}, #{item.title,jdbcType=VARCHAR}, #{item.fileName,jdbcType=VARCHAR}, 
      #{item.suffixName,jdbcType=VARCHAR}, #{item.reVisitid,jdbcType=VARCHAR}, #{item.dlVisitid,jdbcType=VARCHAR}, 
      #{item.uploadDate}, #{item.fileSize,jdbcType=REAL}, now(), '1', #{item.remarks,jdbcType=VARCHAR}
      )
     </foreach>
	
  </insert>
  
  <delete id="delete" parameterType="com.glens.pwCloudOs.pm.projDoc.vo.ProjDocVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from pm_document_lib
    where rowid = #{rowid}
  </delete>
  
  <select id="listall" parameterType="java.util.HashMap" resultType="java.util.HashMap">
 	select p.PRO_NO prono,p.PRO_NAME proname,p.pro_Manager promanager,p.T_PRICE tprice,p.CONTRACT_DATE contractdate,p.CONTRACT_NO contractno,d.DOC_TYPELIB_CODE doctypelibcode,t.DOC_CLASS docclass,
	sum(case t.DOC_CLASS WHEN 3 THEN 1 ELSE 0 END) lixiang,
	sum(case t.DOC_CLASS WHEN 4 THEN 1 ELSE 0 END) toubiao,
	sum(case t.DOC_CLASS WHEN 5 THEN 1 ELSE 0 END) hetong,
	sum(case t.DOC_CLASS WHEN 6 THEN 1 ELSE 0 END) gongzuol, 
	sum(case t.DOC_CLASS WHEN 7 THEN 1 ELSE 0 END) jiesuan, 
	sum(case t.DOC_CLASS WHEN 8 THEN 1 ELSE 0 END) juesuan 
	from  pm_base p 
	left join pm_document_lib d on d.PRO_NO=p.PRO_NO
	left join pm_document_typelib t on t.doc_typelib_code=d.doc_typelib_code
	where 1=1 
	
	<if test="proNo != null and proNo != ''">
   		and p.PRO_NO=#{proNo}
    </if>
    <if test="proStatus != null and proStatus != ''">
   		and p.PRO_STATUS=#{proStatus}
    </if>
    
    <if test="price1 != null and price1 != ''">
   		and p.T_PRICE &gt;=#{price1}
    </if>
    
    <if test="price2 != null and price2 != ''">
   		and p.T_PRICE &lt;=#{price2}
    </if>
    
    <if test="fromDate != null and fromDate != ''">
   		and p.CONTRACT_DATE &gt;=#{fromDate}
    </if>
	<if test="toDate != null and toDate != ''">
   		and p.CONTRACT_DATE &lt;=#{toDate}
    </if>
    <if test="contractNo != null and contractNo != ''">
   		and p.CONTRACT_NO  like   "%"#{contractNo}"%"
    </if>
	<if test="deptCode != null and deptCode != ''">
		and p.MANAGE_DEPT=#{deptCode}
    </if>
	group by p.PRO_NO
  </select>
  
   <select id="selectDocType" parameterType="java.util.HashMap" resultType="map">
	select DOC_TYPELIB_CODE docTypeCode,DOC_TYPELIB_NAME docTypeName 
	from  PM_DOCUMENT_TYPELIB  
	where 1=1
	<if test="docClass != null and docClass != ''">
	and FIND_IN_SET(DOC_CLASS, #{docClass})
	</if>
	<if test="docTypelibCode != null and docTypelibCode != ''">
	and FIND_IN_SET(DOC_TYPELIB_CODE, #{docTypelibCode})
	</if>
	order by docTypeCode
  </select>
  
  <select id="queryProDoc" parameterType="java.util.HashMap" resultType="map">
  	SELECT a.pro_no proNo,b.pro_name, b.pro_Manager proManager,b.TOTAL_WORKLOAD totalWorkload,
  	b.PRO_PHASE proPhase,b.PRO_STATUS proStatus,
  	SUM(CASE WHEN c.DOC_CLASS='3' then 1 else 0 end) t1,
  	SUM(CASE WHEN c.DOC_CLASS='4' then 1 else 0 end) t2,
  	SUM(CASE WHEN c.DOC_CLASS='5' then 1 else 0 end) t3,
  	SUM(CASE WHEN c.DOC_CLASS='6' then 1 else 0 end) t4,
  	SUM(CASE WHEN c.DOC_CLASS='7' then 1 else 0 end) t5,
  	SUM(CASE WHEN c.DOC_CLASS='8' then 1 else 0 end) t6,
  	SUM(CASE WHEN a.DOC_TYPELIB_CODE='15' then 1 else 0 end) t7,
  	SUM(CASE WHEN a.DOC_TYPELIB_CODE='18' then 1 else 0 end) t8,
  	SUM(CASE WHEN a.DOC_TYPELIB_CODE='19' then 1 else 0 end) t9,
  	SUM(CASE WHEN a.DOC_TYPELIB_CODE='20' then 1 else 0 end) t10,
  	SUM(CASE WHEN a.DOC_TYPELIB_CODE='21' then 1 else 0 end) t11,
  	SUM(CASE WHEN a.DOC_TYPELIB_CODE='22' then 1 else 0 end) t12
	FROM pm_document_lib a
	JOIN pm_base b ON a.pro_no=b.pro_no
	join PM_DOCUMENT_TYPELIB c on a.DOC_TYPELIB_CODE=c.DOC_TYPELIB_CODE
	where 1=1
	<if test="categoryCode != null and categoryCode != ''">
	and FIND_IN_SET(b.CATEGORY_CODE,#{categoryCode})
	</if>
	<if test="proNo != null and proNo != ''">
	and FIND_IN_SET(b.PRO_NO,#{proNo})
	</if>
	<if test="proStatus != null">
	and b.PRO_STATUS=#{proStatus}
	</if>
	<if test="deptCode != null and deptCode != ''">
		and b.MANAGE_DEPT=#{deptCode}
    </if>
	GROUP BY a.pro_no
  </select>
  
</mapper>