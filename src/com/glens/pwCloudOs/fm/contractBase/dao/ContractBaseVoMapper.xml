<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.glens.pwCloudOs.fm.contractBase.dao.ContractBaseVoMapper" >
				   
  <resultMap id="BaseResultMap" type="com.glens.pwCloudOs.fm.contractBase.vo.ContractBaseVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <result column="rowid" property="rowid"  />
    <result column="PRO_NO" property="proNo" jdbcType="VARCHAR" />
    <result column="PRO_CODE" property="proCode" jdbcType="VARCHAR" />
    <result column="PRO_NAME" property="proName" jdbcType="VARCHAR" />
    <result column="DISTRICT" property="district" jdbcType="VARCHAR" />
    <result column="CONTRACT_NO" property="contractNo" jdbcType="VARCHAR" />
    <result column="CONTRACT_NAME" property="contractName" jdbcType="VARCHAR" />
    <result column="CONTRACT_DATE" property="contractDate" jdbcType="VARCHAR" />
    <result column="FP_UNIT" property="fpUnit" jdbcType="VARCHAR" />
    <result column="CONTACTOR" property="contractor" jdbcType="VARCHAR" />
    <result column="AMOUNT" property="amount" jdbcType="REAL" />
    <result column="INVOICE_AMOUNT" property="invoiceAmount" jdbcType="REAL" />
    <result column="REMARKS" property="remarks" jdbcType="VARCHAR" />
    
    
     <result column="PROVINCE" property="province" jdbcType="VARCHAR" />
     <result column="CITY" property="city" jdbcType="VARCHAR" />
     <result column="BUSINESS_UNIT" property="businessUnit" jdbcType="VARCHAR" />
     <result column="CONTRACT_PROJ_TYPE" property="contractProjType" jdbcType="INTEGER" />
     <result column="CONTRACT_TYPE" property="contractType" jdbcType="INTEGER" />
     <result column="WRITTEN_PRICE" property="writtenPrice" jdbcType="REAL" />
     <result column="DEVICE_UNIVALENT" property="deviceUnivalent" jdbcType="VARCHAR" />
     <result column="ACTUAL_VALUE" property="actualValue" jdbcType="REAL" />
     <result column="PRICE_IS_IN_TAX" property="priceIsTax" jdbcType="INTEGER" />
     <result column="TAX_POINT" property="taxPoint" jdbcType="INTEGER" />
     <result column="SP_UNIT" property="spUnit" jdbcType="VARCHAR" />
     <result column="SP_UNIT_CHARGER" property="spUnitCharger" jdbcType="VARCHAR"   />
     <result column="BILLING_STATUS" property="billingStatus"  jdbcType="VARCHAR" />
     <result column="EXPECT_BILLING_TIME" property="expectBillingTime"  jdbcType="VARCHAR" />
     <result column="NON_INVOICE_AMOUT" property="nonInvoiceAmount"  jdbcType="REAL" />
     <result column="PAYMENT_STATUS" property="paymentStatus"  jdbcType="VARCHAR" />
     <result column="EXPECT_PAYMENT_TIME" property="expectPaymentTime"  jdbcType="VARCHAR" />
     
  </resultMap>
 <!--  <sql id="Base_Column_List" >
    
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
   
     a.rowid,a.PRO_NO,a.PRO_NAME,a.INVOICE_DATE,a.INVOICE_CLASS_CODE,
     a.INVOICE_NO,a.CG_UNIT,a.CONTRACT_NO,a.INVOICE_CONTENT,a.AMOUNT1,
     a.TAX_RATE,a.TAX_AMOUNT,a.AMOUNT2,a.REMARKS,b.INVOICE_CLASS_NAME 
	
  </sql> -->
  



<select id="queryList" parameterType="map" resultType="map">
SELECT
	b.CONTRACT_NO contractNo,
	b.CONTRACT_NAME contractName
FROM
	fm_contract_base b
WHERE
	b.SYS_PROCESS_FLAG = '1'
AND b.PRO_NO = #{proNo}

</select> 

<select id="queryForList" parameterType="map" resultType="map">
	SELECT
	p.pro_name proName,
	p.pro_no proNo,
	p.pro_Code proCode,
	g.CATEGORY_NAME categoryName,
	p.PRO_YEAR proYear,
	p.PROVINCE province,
	p.CITY city,
	p.DISTRICT district,
	p.TOTAL_WORKLOAD totalWorkload,
	p.UNIT_WORKLOAD unitWorkload,
	p.S_DATE sDate,
	p.E_DATE eDate,
	p.PRO_MANAGER proManager,
	format(t1.contractAmount, 2) contractAmount,
	format(t2.invoiceAmount, 2) invoiceAmount,
	format(t3.repayAcount, 2) repayAcount,
	format(
		CASE
		WHEN t2.invoiceAmount IS NOT NULL
		AND t3.repayAcount IS NOT NULL THEN
			t2.invoiceAmount - t3.repayAcount
		END,
		2
	) leftMoney,
	cd.UNIT_NAME unitName
	FROM
		pm_base p
	LEFT JOIN md_org_unit cd ON p.MANAGE_DEPT = cd.UNIT_CODE
	LEFT JOIN (
		SELECT
			pro_no pro_no1,
			group_concat(c.CONTRACT_NAME) contractName,
			group_concat(c.CONTRACT_NO) contractNo,
			group_concat(c.AMOUNT) amount,
			sum(c.amount) contractAmount,
			group_concat(c.CONTRACT_DATE) contractDate
		FROM
			fm_contract_base c
		GROUP BY
			pro_no
	) t1 ON p.pro_no = t1.pro_no1
	LEFT JOIN (
		SELECT
			pro_no pro_no2,
			group_concat(b.INVOICE_NO) invoiceNo,
			group_concat(b.AMOUNT2) amount1,
			sum(b.AMOUNT2) invoiceAmount,
			group_concat(b.INVOICE_DATE) invoiceDate
		FROM
			fm_invoice_base b
		GROUP BY
			pro_no
	) t2 ON p.pro_no = t2.pro_no2
	JOIN pm_category g ON g.CATEGORY_CODE = p.CATEGORY_CODE
	<if test="categoryCode!=null and categoryCode!=''">
			and g.CATEGORY_CODE=#{categoryCode}
	</if>
	LEFT JOIN (
		SELECT
			pro_no pro_no3,
			group_concat(d.CONTRACT_NO) conNo,
			group_concat(d.RPAYMENT_DATE) repaymentDate,
			group_concat(d.AMOUNT) amount2,
			sum(d.AMOUNT) repayAcount
		FROM
			fm_rpayment_base d
		GROUP BY
			pro_no
	) t3 ON p.pro_no = t3.pro_no3
	WHERE
		1 = 1
	
		<if test="compayCode != null and compayCode !=''">
		and p.COMPANY_CODE=#{compayCode} 
		</if>
		<if test="proNo != null and proNo !=''">
			and p.pro_no=#{proNo}
		</if>
		<if test="proStatus != null and proStatus !=''">
			and p.pro_status=#{proStatus}
		</if>
		<if test="proName != null and proName !=''">
			and (p.PRO_NAME like "%"#{proName}"%"
			or p.PRO_NO like "%"#{proName}"%"
			or p.PROVINCE like "%"#{proName}"%"
			or p.CITY like "%"#{proName}"%"
			or p.PRO_MANAGER like "%"#{proName}"%"
			or p.PRO_YEAR like "%"#{proName}"%"
			)
		</if>
		<if test="fromDate != null and fromDate != ''">
		  	and p.S_DATE &gt;= #{fromDate}
		</if>
		<if test="toDate != null and toDate != ''">
		  	and p.E_DATE &lt;= #{toDate}
		</if>
		order by p.pro_no	
</select>
 
 <select id="queryForCount1" parameterType="java.util.HashMap" resultType="int">
SELECT
	count(*)
FROM
	(
		SELECT
			p.pro_name proName,
			p.pro_no proNo,
			g.CATEGORY_NAME categoryName,
			p.PRO_YEAR proYear,
			p.PROVINCE province,
			p.CITY city,
			p.DISTRICT district,
			p.TOTAL_WORKLOAD totalWorkload,
			p.UNIT_WORKLOAD unitWorkload,
			p.S_DATE sDate,
			p.E_DATE eDate,
			p.PRO_MANAGER proManager,
			cd.UNIT_NAME unitName,
			t1.*, t2.*, t3.*
		FROM
			pm_base p
		LEFT JOIN md_org_unit cd ON p.MANAGE_DEPT = cd.UNIT_CODE
		LEFT JOIN (
			SELECT
				pro_no pro_no1,
				group_concat(c.CONTRACT_NAME) contractName,
				group_concat(c.CONTRACT_NO) contractNo,
				group_concat(c.AMOUNT) amount,
				sum(c.amount) contractAmount,
				group_concat(c.CONTRACT_DATE) contractDate
			FROM
				fm_contract_base c
			GROUP BY
				pro_no
		) t1 ON p.pro_no = t1.pro_no1
		LEFT JOIN (
			SELECT
				pro_no pro_no2,
				group_concat(b.INVOICE_NO) invoiceNo,
				group_concat(b.AMOUNT2) amount1,
				sum(b.AMOUNT2) invoiceAmount,
				group_concat(b.INVOICE_DATE) invoiceDate
			FROM
				fm_invoice_base b
			GROUP BY
				pro_no
		) t2 ON p.pro_no = t2.pro_no2
		LEFT JOIN pm_category g ON g.CATEGORY_CODE = p.CATEGORY_CODE
		<if test="categoryCode!=null and categoryCode!=''">
			and g.CATEGORY_CODE=#{categoryCode}
		</if>
		LEFT JOIN (
			SELECT
				pro_no pro_no3,
				group_concat(d.CONTRACT_NO) conNo,
				group_concat(d.RPAYMENT_DATE) repaymentDate,
				group_concat(d.AMOUNT) amount2,
				sum(d.AMOUNT) repayAcount
			FROM
				fm_rpayment_base d
			GROUP BY
				pro_no
		) t3 ON p.pro_no = t3.pro_no3
			
	where 1=1
		<if test="compayCode != null and compayCode !=''">
		and p.COMPANY_CODE=#{compayCode} 
		</if>
		<if test="proNo != null and proNo !=''">
			and p.pro_no=#{proNo}
		</if>
		<if test="proStatus != null and proStatus !=''">
			and p.pro_status=#{proStatus}
		</if>
		<if test="proName != null and proName !=''">
			and (p.PRO_NAME like "%"#{proName}"%"
			or p.PRO_NO like "%"#{proName}"%"
			or p.PROVINCE like "%"#{proName}"%"
			or p.CITY like "%"#{proName}"%"
			or p.PRO_MANAGER like "%"#{proName}"%"
			or p.PRO_YEAR like "%"#{proName}"%"
			)
		</if>
		<if test="fromDate != null and fromDate != ''">
		  	and p.S_DATE &gt;= #{fromDate}
		</if>
		<if test="toDate != null and toDate != ''">
		  	and p.E_DATE &lt;= #{toDate}
		</if>
 	) a
 </select>
 <select id="queryForPage1" parameterType="java.util.HashMap" resultType="map">
SELECT
	p.pro_name proName,
	p.pro_no proNo,
	p.pro_Code proCode,
	g.CATEGORY_NAME categoryName,
	p.PRO_YEAR proYear,
	p.PROVINCE province,
	p.CITY city,
	p.DISTRICT district,
	p.TOTAL_WORKLOAD totalWorkload,
	p.UNIT_WORKLOAD unitWorkload,
	p.S_DATE sDate,
	p.E_DATE eDate,
	p.PRO_MANAGER proManager,
	t1.*, t2.amount1,
	IFNULL(t2.invoiceAmount, 0) invoiceAmount,
	t2.invoiceDate,
	t2.invoiceNo,
	t3.amount2,
	t3.conNo,
	IFNULL(t3.repayAcount, 0) repayAcount,
cd.UNIT_NAME unitName,
	t3.repaymentDate
FROM
	pm_base p
LEFT JOIN md_org_unit cd ON p.MANAGE_DEPT = cd.UNIT_CODE
LEFT JOIN (
	SELECT
		pro_no pro_no1,
		group_concat(c.CONTRACT_NAME) contractName,
		group_concat(c.CONTRACT_NO) contractNo,
		group_concat(c.AMOUNT) amount,
		sum(c.amount) contractAmount,
		group_concat(c.CONTRACT_DATE) contractDate
	FROM
		fm_contract_base c
	GROUP BY
		pro_no
) t1 ON p.pro_no = t1.pro_no1
LEFT JOIN (
	SELECT
		pro_no pro_no2,
		group_concat(b.INVOICE_NO) invoiceNo,
		group_concat(b.AMOUNT2) amount1,
		sum(b.AMOUNT2) invoiceAmount,
		group_concat(b.INVOICE_DATE) invoiceDate
	FROM
		fm_invoice_base b
	GROUP BY
		pro_no
) t2 ON p.pro_no = t2.pro_no2
 JOIN pm_category g ON g.CATEGORY_CODE = p.CATEGORY_CODE
	<if test="categoryCode!=null and categoryCode!=''">
			and g.CATEGORY_CODE=#{categoryCode}
		</if>
LEFT JOIN (
	SELECT
		pro_no pro_no3,
		group_concat(d.CONTRACT_NO) conNo,
		group_concat(d.RPAYMENT_DATE) repaymentDate,
		group_concat(d.AMOUNT) amount2,
		IFNULL(sum(d.AMOUNT), 0) repayAcount
	FROM
		fm_rpayment_base d
	GROUP BY
		pro_no
) t3 ON p.pro_no = t3.pro_no3

WHERE
	1 = 1

	
		
		
		<if test="compayCode != null and compayCode !=''">
		and p.COMPANY_CODE=#{compayCode} 
		</if>
		<if test="proNo != null and proNo !=''">
			and p.pro_no=#{proNo}
		</if>
		<if test="proStatus != null and proStatus !=''">
			and p.pro_status=#{proStatus}
		</if>
		<if test="proName != null and proName !=''">
			and (p.PRO_NAME like "%"#{proName}"%"
			or p.PRO_NO like "%"#{proName}"%"
			or p.PROVINCE like "%"#{proName}"%"
			or p.CITY like "%"#{proName}"%"
			or p.PRO_MANAGER like "%"#{proName}"%"
			or p.PRO_YEAR like "%"#{proName}"%"
			)
		</if>
		<if test="fromDate != null and fromDate != ''">
		  	and p.S_DATE &gt;= #{fromDate}
		</if>
		<if test="toDate != null and toDate != ''">
		  	and p.E_DATE &lt;= #{toDate}
		</if>
		
		limit #{firstResult},#{maxResult}
 
 </select>
 
 
 <select id="queryForPage" parameterType="java.util.HashMap" resultMap="BaseResultMap">
 	select 
 		a.*,
 		p.pro_code as proCode  
    from FM_CONTRACT_BASE a 
    left join pm_base p on a.pro_no = p.pro_no
    where a.sys_process_flag='1'
    <if test="proNo != null and proNo !=''">
 		and a.PRO_NO=#{proNo}
 	</if>
 	<if test="contractNo != null and contractNo !=''">
 		and CONTRACT_NO like   "%"#{contractNo}"%"
 	</if>
 	<if test="fromDate != null and fromDate != ''">
	  	and a.CONTRACT_DATE &gt;= #{fromDate}
	</if>
	<if test="toDate != null and toDate != ''">
	  	and a.CONTRACT_DATE &lt;= #{toDate}
	</if>
	<if test="searchName!=null and searchName!=''">
		and (a.PROVINCE like "%"#{searchName}"%" or a.CITY like "%"#{searchName}"%" or a.DISTRICT like "%"#{searchName}"%" or a.CONTRACT_NO like "%"#{searchName}"%" or a.CONTRACT_NAME like "%"#{searchName}"%"
			or a.BUSINESS_UNIT like "%"#{searchName}"%" or a.FP_UNIT like "%"#{searchName}"%" or a.SP_UNIT like "%"#{searchName}"%" or a.CONTACTOR like "%"#{searchName}"%" or a.SP_UNIT_CHARGER like "%"#{searchName}"%")
	</if>
	<if test="contractProjType!=null and contractProjType!=0">
		and a.CONTRACT_PROJ_TYPE=#{contractProjType}
	</if>
	
	<if test="billingStatus!=null and billingStatus!=''">
		and a.BILLING_STATUS=#{billingStatus}
	</if>
	<if test="paymentStatus!=null and paymentStatus!=''">
		and a.PAYMENT_STATUS=#{paymentStatus}
	</if>
	
	<if test="queryDate!=null and queryDate!=''">
		and a.CONTRACT_DATE like "%"#{queryDate}"%"
	</if>
	
 	
 	order by a.CONTRACT_DATE desc
 	limit #{firstResult},#{maxResult}
 </select>
 
 
  <select id="queryForCount" parameterType="java.util.HashMap" resultType="int">
 	select count(*) from FM_CONTRACT_BASE a
 	 where a.sys_process_flag='1'
 	<if test="proNo != null and proNo !=''">
 		and a.PRO_NO=#{proNo}
 	</if>
 	<if test="contractNo != null and contractNo !=''">
 		and a.CONTRACT_NO like   "%"#{contractNo}"%"
 	</if>
 	<if test="fromDate != null and fromDate != ''">
	  	and a.CONTRACT_DATE &gt;= #{fromDate}
	</if>
	<if test="toDate != null and toDate != ''">
	  	and a.CONTRACT_DATE &lt;= #{toDate}
	</if>
	<if test="searchName!=null and searchName!=''">
		and (a.PROVINCE like "%"#{searchName}"%" or a.CITY like "%"#{searchName}"%" or a.DISTRICT like "%"#{searchName}"%" or a.CONTRACT_NO like "%"#{searchName}"%" or a.CONTRACT_NAME like "%"#{searchName}"%"
			or a.BUSINESS_UNIT like "%"#{searchName}"%" or a.FP_UNIT like "%"#{searchName}"%" or a.SP_UNIT like "%"#{searchName}"%" or a.CONTACTOR like "%"#{searchName}"%" or a.SP_UNIT_CHARGER like "%"#{searchName}"%")
	</if>
	<if test="contractProjType!=null and contractProjType!=0">
		and a.CONTRACT_PROJ_TYPE=#{contractProjType}
	</if>
	
	<if test="billingStatus!=null and billingStatus!=''">
		and a.BILLING_STATUS=#{billingStatus}
	</if>
	<if test="paymentStatus!=null and paymentStatus!=''">
		and a.PAYMENT_STATUS=#{paymentStatus}
	</if>
	<if test="queryDate!=null and queryDate!=''">
		and a.CONTRACT_DATE like "%"#{queryDate}"%"
	</if>
	
	
 </select>
  
  <select id="getDetail" resultType="map" parameterType="com.glens.pwCloudOs.fm.contractBase.vo.ContractBaseVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select * from FM_CONTRACT_BASE a
    where a.rowid = #{rowid}
  </select>
  
  
  <select id="getLinksByContractNo" parameterType="map" resultType="map">
  	select f.PROJ_NO proNo,f.PRICE price,p.PRO_NAME proName,c.CATEGORY_NAME proTypeName,c.CATEGORY_CODE proType  from fm_contract_proj_link  f
	join pm_base p on f.PROJ_NO=p.PRO_NO
	join pm_category c on c.CATEGORY_CODE=p.CATEGORY_CODE
	where f.CONTRACT_NO=#{contractNo}

  </select>
  
  <delete id="delete" parameterType="com.glens.pwCloudOs.fm.contractBase.vo.ContractBaseVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from FM_CONTRACT_BASE
    where rowid = #{rowid}
  </delete>
  <insert id="insert" parameterType="com.glens.pwCloudOs.fm.contractBase.vo.ContractBaseVo" >
	INSERT INTO FM_CONTRACT_BASE(PRO_NO,PRO_NAME,PROVINCE,CITY,DISTRICT,CONTRACT_NO,CONTRACT_NAME,CONTRACT_DATE,
	BUSINESS_UNIT,CONTRACT_PROJ_TYPE,CONTRACT_TYPE,WRITTEN_PRICE,DEVICE_UNIVALENT,ACTUAL_VALUE,PRICE_IS_IN_TAX,TAX_POINT,
	FP_UNIT,SP_UNIT,CONTACTOR,SP_UNIT_CHARGER,BILLING_STATUS,EXPECT_BILLING_TIME,NON_INVOICE_AMOUT,PAYMENT_STATUS,
	AMOUNT,EXPECT_PAYMENT_TIME,INVOICE_AMOUNT,SYS_CREATE_TIME,SYS_PROCESS_FLAG,REMARKS)
	VALUES(#{proNo},#{proName},#{province},#{city},#{district},#{contractNo},#{contractName},#{contractDate},
	#{businessUnit},#{contractProjType},#{contractType},#{writtenPrice},#{deviceUnivalent},#{actualValue},#{priceIsTax},#{taxPoint},
	#{fpUnit},#{spUnit},#{contractor},#{spUnitCharger},#{billingStatus},#{expectBillingTime},#{nonInvoiceAmount},#{paymentStatus},
	#{amount},#{expectPaymentTime},#{invoiceAmount},now(),'1',#{remarks})
  </insert>
  <insert id="insertProjLink" parameterType="map">
  	insert into FM_CONTRACT_PROJ_LINK(CONTRACT_NO,PROJ_NO,PRICE,SYS_CREATE_TIME,SYS_PROCESS_FLAG) values(#{contractNo},#{proNo},#{price},now(),'1')
  </insert>
  
  <update id="update" parameterType="com.glens.pwCloudOs.fm.contractBase.vo.ContractBaseVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
   update FM_CONTRACT_BASE set 
 
 	<if test="proNo != null">
 		PRO_NO=#{proNo},
 	</if>
	<if test="proName != null">
 		PRO_NAME=#{proName},
 	</if>
 	<if test="district != null">
 		DISTRICT=#{district},
 	</if>
	<if test="contractNo != null">
 		CONTRACT_NO=#{contractNo},
 	</if>
 	<if test="contractName != null">
 		CONTRACT_NAME=#{contractName},
 	</if>
	<if test="contractDate != null">
 		CONTRACT_DATE=#{contractDate},
 	</if>
	
	<if test="fpUnit != null">
 		FP_UNIT=#{fpUnit},
 	</if>
	<if test="contractor != null">
 		CONTACTOR=#{contractor},
 	</if>
	<if test="amount != null">
 		AMOUNT=#{amount},
 	</if>
	<if test="invoiceAmount != null">
 		INVOICE_AMOUNT=#{invoiceAmount},
 	</if>
	<if test="remarks != null">
 		REMARKS=#{remarks},
 	</if>
 	<if test="province!=null and province!=''">
 		PROVINCE=#{province},
 	</if>
 	<if test="city!=null and city!=''">
 		CITY=#{city},
 	</if>
 	<if test="businessUnit!=null and businessUnit!=''">
 		BUSINESS_UNIT=#{businessUnit},
 	</if>
 	<if test="contractProjType!=null and contractProjType!=''">
 		CONTRACT_PROJ_TYPE=#{contractProjType},
 	</if>
 	<if test="contractType!=null and contractType!=''">
 		CONTRACT_TYPE=#{contractType},
 	</if>
 	
 	<if test="writtenPrice!=null and writtenPrice!=''">
 		WRITTEN_PRICE=#{writtenPrice},
 	</if>
 	
 	<if test="deviceUnivalent!=null and deviceUnivalent!=''">
 		DEVICE_UNIVALENT=#{deviceUnivalent},
 	</if>
 	
 	<if test="actualValue!=null and actualValue!=''">
 		ACTUAL_VALUE=#{actualValue},
 	</if>
 	<if test="priceIsTax!=null and priceIsTax!=''">
 		PRICE_IS_IN_TAX=#{priceIsTax},
 	</if>
 	<if test="taxPoint!=null and taxPoint!=''">
 		TAX_POINT=#{taxPoint},
 	</if>
 	<if test="spUnit!=null and spUnit!=''">
 		SP_UNIT=#{spUnit},
 	</if>
 	<if test="spUnitCharger!=null and spUnitCharger!=''">
 		SP_UNIT_CHARGER=#{spUnitCharger},
 	</if>
 	
 	<if test="billingStatus!=null and billingStatus!=''">
 		BILLING_STATUS=#{billingStatus},
 	</if>
 	
 	<if test="expectBillingTime!=null and expectBillingTime!=''">
 		EXPECT_BILLING_TIME=#{expectBillingTime},
 	</if>
 	
 	<if test="nonInvoiceAmount!=null and nonInvoiceAmount!=''">
 		NON_INVOICE_AMOUT=#{nonInvoiceAmount},
 	</if>
 	
 	<if test="paymentStatus!=null and paymentStatus!=''">
 		PAYMENT_STATUS=#{paymentStatus},
 	</if>
 	
 	<if test="expectPaymentTime!=null and expectPaymentTime!=''">
 		EXPECT_PAYMENT_TIME=#{expectPaymentTime},
 	</if>
 	
 	SYS_UPDATE_TIME=NOW()
	where rowid=#{rowid}

  </update>
  
  <select id="selectProOutputYears" resultType="map">
  	SELECT DISTINCT years FROM PM_ANNUAL_OUTPUT ORDER BY years
  </select>
  
  <select id="selectProOutput" parameterType="java.lang.String" resultType="map">
  	SELECT PRO_NO proNo,WORKLOAD workload,AMOUNT amount,years
	FROM PM_ANNUAL_OUTPUT WHERE FIND_IN_SET(PRO_NO,#{proNos}) ORDER BY years
  </select>
  
  
  <select id="getProContractLinks" parameterType="map" resultType="map">
  		select f.CONTRACT_NO,f.PROJ_NO,f.PRICE,p.PRO_NAME from fm_contract_proj_link  f 
		join pm_base p on p.PRO_NO=f.PROJ_NO
		where f.CONTRACT_NO=#{contractNo}
  </select>
  <select id="getProContractLinks1" parameterType="map" resultType="map">
  		select f.CONTRACT_NO,f.PROJ_NO,f.PRICE,p.PRO_NAME from fm_contract_proj_link  f 
		join pm_base p on p.PRO_NO=f.PROJ_NO
		where f.CONTRACT_NO=#{contractNo} and  FIND_IN_SET(p.PRO_NO,#{pt})
  </select>
  
  <select id="getContractProLinks" parameterType="map" resultType="map">
	  select DISTINCT f.CONTRACT_NO,f.PROJ_NO,f.PRICE,c.CONTRACT_NAME,p.PRO_NAME from fm_contract_proj_link  f
	join fm_contract_base c on f.CONTRACT_NO=c.CONTRACT_NO
	join pm_base p on p.PRO_NO=f.PROJ_NO
	
	where  f.PROJ_NO=#{proNo} and f.CONTRACT_NO !=#{contractNo}
  </select>
  
  <delete id="deleteProContractLinks" parameterType="map" >
  	
		delete from fm_contract_proj_link where contract_no=#{contractNo}
  	
  </delete>
  
  
  <select id="getStatistics1" parameterType="map" resultType="map">
    select tpa.*,tpa.kaipiaomoney-tpa.huikuan qiankuan from(
  	select count(*) totalNum,(select count(*)  from fm_contract_base where CONTRACT_DATE like "%"#{searchName}"%" and BILLING_STATUS =1) kaipiao,
	(select count(*)  from fm_contract_base where CONTRACT_DATE like "%"#{searchName}"%" and BILLING_STATUS =0) notkaipiao,
	(select sum(AMOUNT)  from fm_contract_base where CONTRACT_DATE like "%"#{searchName}"%" and PAYMENT_STATUS =1) huikuan,
	(select sum(INVOICE_AMOUNT)  from fm_contract_base where CONTRACT_DATE like "%"#{searchName}"%" and BILLING_STATUS =1) kaipiaomoney
	from (
		select  *  from fm_contract_base where CONTRACT_DATE like "%"#{searchName}"%"
	) t) tpa
  </select>
  
  <select id="getContractPlan" parameterType="map" resultType="map">
  	select * from fm_contract_plan where YEAR=#{searchName}
  </select>
  
  <select id="getStatistics2" parameterType="map" resultType="map">
  
  	 	select count(*) totalNum,
	
	(select sum(WRITTEN_PRICE)  from fm_contract_base where CONTRACT_DATE like "%"#{searchName}"%") hetongmoney,
	(select sum(INVOICE_AMOUNT)  from fm_contract_base where CONTRACT_DATE like "%"#{searchName}"%" and BILLING_STATUS =1) kaipiaomoney,
	(select sum(AMOUNT)  from fm_contract_base where CONTRACT_DATE like "%"#{searchName}"%" and PAYMENT_STATUS =1) huikuan
	from (
		select  *  from fm_contract_base where CONTRACT_DATE like "%"#{searchName}"%"
	) t
  
  </select>
  
  
  
  
  
</mapper>