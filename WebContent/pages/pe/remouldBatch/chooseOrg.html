<!DOCTYPE HTML>
<html>
<head>
<title> 首页 </title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">

<script type="text/javascript" src="../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../js/jquery.ztree.core-3.5.js"></script>
<script type="text/javascript" src="../../../js/config.js"></script>
<script type="text/javascript" src="../../../js/util.js"></script>
<script type="text/javascript" src="../../../js/time.js"></script>
<script type="text/javascript" src="../../../js/Calendar.js"></script>
<link rel="stylesheet" type="text/css" href="../../../css/list.css" />

<script type="text/javascript" src="../../../js/showDlog/showDlog.js"></script>
	<link rel="stylesheet" type="text/css" href="../../../js/showDlog/showDlog-blue.css" />

<link rel="stylesheet" href="../../../css/zTreeStyle/zTreeStyle.css" type="text/css"/>
<style type="text/css">
body{padding:0;margin:0;background:#fff;}
.all{font-size:12px;font-family:微软雅黑;text-decoration:none;color:#666;padding-left:12px;}
.all a{text-decoration:none;color:#666;}
.all a:hover{text-decoration:none;color:#666;}
.ztree span{font-size:12px;font-family:微软雅黑;}

 .btn{display:inline-block;height:30px;line-height:30px;margin:3px 4px;padding:0 15px 0 15px;background:#f4f4f4;color:#666;font-weight:bold;cursor:pointer;border:solid 1px #89C6FF; border-radius:4px;}
 .blue{background:#3385FF;color:#fff;}
 .blue:hover{background:#186CE7;}
.btn_box{position:absolute;left:0;right:0;bottom:0;height:36px;background:#f4f4f4;text-align:right;}
</style>
</head>

<body ng-app="orgTree" ng-controller="orgTreeCtrl">
	<div style="width:100%; text-align: left; border-bottom:1px #ccc solid;margin-top:10px; margin-bottom:10px;height:35px;">
		&nbsp;&nbsp;计划改造时间：<input type="text"  name="planRebuildTime" style="font-family:'微软雅黑'; width:180px;height:25px;border:1px #ccc solid;" class="date dateComponent" placeholder="计划改造时间" onclick="new Calendar().show(this)">
	
	</div>
	
	<div class="all" ng-if="required!='true'">
		<a href="javascript:" ng-click="onChooseBlank()">(全部)</a>
	</div>
	<div id="treeDemo" class="ztree">
	</div>
	<script type="text/javascript">
	
	var time=getCurrentDate();
	
	$("input[name=planRebuildTime]").val(time);
	
	var setting = {
			data:{
				key:{
					name:"unitName"
				},
				simpleData:{
					enable:true,
					idKey:"unitCode",
					pIdKey:"parentUnit",
					rootPid:-1
				}
			},
			callback:{
				onClick:function(){
					var selectedNodes = orgZTree.getSelectedNodes();
					selectedItem = selectedNodes[0];
				}
			}
		};
	var orgZTree;
	var ngScope;
	var app = angular.module("orgTree", []);
	var selectedItem={};
	app.controller("orgTreeCtrl", function($scope, $http){
		/* init */
		ngScope = $scope;
		$scope.treeNodes={};
		var userDataStr = $.cookie("pmsWeb_user_data");
		if(!userDataStr){
			
			noLogin(location.href);
			return;
		}
		$scope.userData = jQuery.parseJSON(userDataStr);
		var ticket = $.cookie("pmsWeb_ticket");
		
		var params = getUrlParams();
		$scope.required = params.required;
		
		/* 加载数据 */
		$.ajax({
			url:serviceBasePath+"eap/pmsServices/sys/orgEmployee/org/orgTree",
			method:"GET",
			cache:false,
			data:{"companyCode":$scope.userData.companyCode, "ticket":ticket},
			success:function(res){
				if(res.statusCode==200){
					$scope.treeNodes=res.tree;
					var zNode={};
					zNode.unitName=$scope.userData.companyName;
					zNode.unitCode="0";
					zNode.parentUnit="-1";
// 					zNode.children=res.tree;
					zNode.open=true;
					zNode.icon="../../../img/comp.png";
					for(var i in res.tree){
						var node = res.tree[i];
						node.icon="../../../img/dept.png";
					}
					$scope.treeNodes.push(zNode);
					orgZTree = $.fn.zTree.init($("#treeDemo"), setting, $scope.treeNodes);
				}else if(res.statusCode==401){
					window.noLogin(location.href);
				}else{
					alert("服务器访问出错！");
				}
			},
			error:function(){
				alert("服务器访问失败！");
			}
		});
		
		/* 选择空白 */
		$scope.onChooseBlank=function(){
			var obj=new Object();
			obj.unitCode="";
			obj.unitName="";
			selectedItem = obj;
			
		};
		
		$scope.onOk=function(){
			
			
			var plantime=$("input[name=planRebuildTime]").val();
			
			if(plantime==""){
				var waittingDlog = new ShowDlog();

				waittingDlog.prompt({
						icon:"warning",
						msg:"请选择计划改造时间",
						done:function(){
							
						},
						t:2000
				});
			}else{
				selectedItem.plantime=plantime;
				parent.$dlog.data=selectedItem;
				parent.$dlog.close();
			}
			
		};
		$scope.onClear=function(){
			var obj=new Object();
			obj.unitCode="";
			obj.unitName="";
			parent.$dlog.data=obj;
			parent.$dlog.close();
		}
		$scope.onClose=function(){
			parent.$dlog.close();
		};
	});
	</script>
	<div class="btn_box">
		<input type="button" value="清空" class="btn blue" ng-click="onClear()"/>
		<input type="button" value="确定" class="btn blue" ng-click="onOk()"/>
		<input type="button" value="关闭" class="btn" ng-click="onClose()"/>
	</div>
</body>
</html>
