<!DOCTYPE HTML>
<html ng-app="statistic">
<head>
<title>费用报销</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<script type="text/javascript" src="../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../js/PageBar.js"></script>
<script type="text/javascript" src="../../../js/Calendar.js"></script>
<script type="text/javascript" src="../../../js/SimpleDateFormat.js"></script>
<script type="text/javascript" src="../../../js/config.js"></script>
<script type="text/javascript" src="../../../js/util.js"></script>
<script type="text/javascript" src="../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../../js/DropDownList-1.2/DropDownList.css" />
<script type="text/javascript" src="../../../js/showDlog/showDlog.js"></script>
<link rel="stylesheet" type="text/css" href="../../../js/showDlog/showDlog-blue.css" />
<link rel="stylesheet" type="text/css" href="../../../css/list.css" />
 <link type="text/css" rel="stylesheet" href="../../../css/jquery.nstSlider.css">
<script src="../../../js/jquery.nstSlider.min.js"></script>
<style type="text/css">
.dlog-showPic{width:1000px;height:500px;}
.feeReturnGet{width:500px;height:350px;}

.owWordLoad{text-decoration:underline;color:#0099ff;}
.owWordload-detail{word-wrap: break-word; border:solid 1px #666;background:#ffee99;color:#666;padding:4px 6px 4px 6px;position:absolute;display:none;margin-left:-300px;width:580px;}
	
.switch_btn_group{border:solid 1px #3385FF;min-height:30px;float:left;border-radius:15px; position:absolute;right:10px;top:0px;}
	.switch_btn_group a{display:inline-block;float:left;background:#fff;color:#3385FF;text-decoration:none;font-size:13px;
		line-height:30px;text-align:center;margin:0 1px 0 0;min-width:60px;}
	.switch_btn_group a.selected{background:#3385FF;color:#fff;}
	.switch_btn_group a:first-of-type{border-top-left-radius:15px;border-bottom-left-radius:15px;}
	.switch_btn_group a:last-of-type{border-top-right-radius:15px;border-bottom-right-radius:15px;margin:0;}
	
</style>
</head>

<body ng-controller="statistic">

<div class="list">
	<div class="list_content">
		<div class="title_div">
			<div class="title_left">
				<input type="text" name="orgUnit" class="dropDownTree dropDownList" style="width:200px;" placeholder="请选择部门"/>
				<input type="text"  name="project" class="dropDownTree dropDownList" style="width:180px;" placeholder="请选择项目"/>
				<input type="text" name="employeeName" viewstate="employeeName" placeholder="请输入搜索内容"/>
				<input type="text" name="beginTime" id="beginTime" placeholder="请选择启始日期" onclick="new Calendar().show(this)" class="dateComponent"/>
				<input type="text" name="endTime" id="endTime" placeholder="请选择结束日期" onclick="new Calendar().show(this)" class="dateComponent"/>
				<span style="float: left;color: #5f4747">费用范围:</span>
				<div style="float:left">
					<div class="leftLabel" style="float:left;width:50px;text-align:center"></div>
					<div class="nstSlider" 
			            data-range_min="1" data-range_max="20000"   
			            data-cur_min="1"  data-cur_max="20000" style="float:left;width:200px;margin-top: 12px;background:#60b2ff;">   
			            <div class="highlightPanel"></div>       
			            <div class="bar" style="background:#4CA9FF"></div>                 
			            <div class="leftGrip" style="background:#3385FF;border: 1px solid #d9e9ff;"></div>              
			            <div class="rightGrip" style="background:#3385FF;border: 1px solid #d9e9ff;"></div>             
			        </div>
			        
			        <div class="rightLabel" style="float:left;width:50px;text-align:center"></div>
				</div>
				
				<div class="query_div" onclick="doQuery()">
					查询
				</div>
			</div>
			<img src="../../../img/list_Header2-.png">
			
			<div class="switch_btn_group">
				<a href="#" datatype="" class="selected">全部</a>
				<a href="#" datatype="0">未认领</a>
				<a href="#" datatype="1">已办结</a>
			</div>
			
		</div>
		
		<div class="table_div">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="table">
			   <tr class="tr1">
				<th width="5%"><div align="center">序号</div></th>
				<th width="15%"><div align="center">标题</div></th>
				<th width="5%"><div align="center">姓名</div></th>
				<th width="10%"><div align="center">项目</div></th>
				<th width="10%"><div align="center">申请日期</div></th>
				<th width="10%"><div align="center">费用类型</div></th>
				<th width="25%"><div align="center">事由</div></th>
				<th width="5%"><div align="center">费用合计</div></th>
				<th width="5%"><div align="center">状态</div></th>
				<th  width="10%"><div align="center">操作</div></th>
			  </tr>
			  <tr ng-repeat="item in infoList" class="tr2">
				<td><div align="center">{{$index+1}}</div></th>
				<td width="15%"><div align="center">{{item.TITLE}}</div></td>
				<td width="5%"><div align="center">{{item.EMPLOYEE_NAME}}</div></td>
				<td width="10%"><div align="center">{{item.PRO_NAME}}</div></td>
				<td width="10%"><div align="center">{{item.APPLY_DATE}}</div></td>
				<td width="10%"><div align="center">{{item.FEE_NAME}}</div></td>
				<td width="25%">
					{{sub(item.APPLY_CONTENT)}}
					<div align="center" ng-if="item.APPLY_CONTENT.length>50" style="display:inline-block;">
				       <a href="javascript:" onmouseover="$(this).next().show();" onmouseout="$(this).next().hide();" class="owWordLoad">[查看全文]</a>
				       <div class="owWordload-detail">
							{{item.APPLY_CONTENT}}
						</div>
				  </div>
				</td>
				<td width="5%"><div align="center" >{{item.TOTAL_MONEY}}</div></td>
				<td width="5%" ng-if="item.STATUS==0" style="background: yellow;"><div align="center" >未认领</div></td>
				<td width="5%" ng-if="item.STATUS==1"><div align="center" >已归结</div></td>
				<td align="center">
			    	<img class="operationImg" ng-click="doShow(item)" src="../../../img/list_see-icon.png" title="查看 ">
			    	<img class="operationImg" ng-click="toCheck(item, $index)" src="../../../img/claim.png" title="认领">
				</td>
			  </tr>
			</table>
		</div>

		<div id="page_bar" class="list_bottom" align="center">
		</div>

	</div>
</div>
<script type="text/javascript">
$('.nstSlider').nstSlider({
    "rounding": {
        "100": "1000",
    },
    "left_grip_selector": ".leftGrip",
    "right_grip_selector": ".rightGrip",
    "value_bar_selector": ".bar",
    "value_changed_callback": function(cause, leftValue, rightValue) {
        var $container = $(this).parent();
        $container.find('.leftLabel').text(leftValue);
        $container.find('.rightLabel').text(rightValue);
    }
});



var pStatus="";
var _currentPage="";
var minMoney=0;
var maxMoney=0;
var employeeName="";
var beginTime="";
var endTime="";
var unitCode="";
var unitName="";
var status="";
var proNo="";
var proName="";

	
function createPageBar(totalPage, curPage,totalRecord){
	new PageBar().init({
		renderTo:"#page_bar",
		totalPage:totalPage,
		curPage:curPage,
		totalRecord: totalRecord,
		showPageInfo:true,
		prevPageText:"上一页",
		nextPageText:"下一页",
		onPage:function(pageNum){
			_currentPage=pageNum;
			gotoPage(pageNum);
		}
	});
}

function gotoPage(pageNum){
	 employeeName=$("input[name=employeeName]").val();
	 beginTime=$("input[name=beginTime]").val();
	 endTime=$("input[name=endTime]").val();
	 unitCode=ngScope.selectedUnitCode;
	 unitName=ngScope.selectedUnitName;
	 if(unitName==undefined)
		unitName="";
	if(unitCode==undefined)
		unitCode="";
		
	 minMoney=$(".leftLabel").text();
	maxMoney=$(".rightLabel").text();
	 status=pStatus;
	 proNo=ngScope.selectProNo;
	 proName=ngScope.selectProName;
	if(proNo==undefined)
	proNo="";
	if(proName==undefined)
	proName="";
	//fromTime, toTime,unitCode, employeeName,minMoney,maxMoney,status,proNo,pageNum
	ngScope.loadStatistic(beginTime,endTime,unitCode,employeeName,minMoney,maxMoney,status,proNo,pageNum);
}

function doQuery(){
	 employeeName=$("input[name=employeeName]").val();
	 beginTime=$("input[name=beginTime]").val();
	 endTime=$("input[name=endTime]").val();
	 unitCode=ngScope.selectedUnitCode;
	 unitName=ngScope.selectedUnitName;
	 if(unitName==undefined)
		unitName="";
		
	if(unitCode==undefined)
	unitCode="";
	 minMoney=$(".leftLabel").text();
	 maxMoney=$(".rightLabel").text();
	 status=pStatus;
	 proNo=ngScope.selectProNo;
	if(proNo==undefined)
		proNo="";
	 proName=ngScope.selectProName;
	 if(proName==undefined)
		proName="";	
	//fromTime, toTime,unitCode, employeeName,minMoney,maxMoney,status,proNo,pageNum
	ngScope.loadStatistic(beginTime,endTime,unitCode,employeeName,minMoney,maxMoney,status,proNo,1);
}

		
var ngScope;
var userData;
var app = angular.module("statistic", []);

//初始化时间
	var day1 = new SimpleDateFormat({formatString:"yyyy-MM-dd"}).format(new Date());
	
	$("#endTime").val(day1);
	
	var t=new Date(day1);
	var tm=new Date(t.getFullYear(),t.getMonth(),t.getDate()-6);
	
	var  day2= new SimpleDateFormat({formatString:"yyyy-MM-dd"}).format(tm);
	$("#beginTime").val(day2);
	
	
app.controller("statistic", function($scope, $http){
	/* init */
	ngScope = $scope;
	$scope.infoList=[];
	
	var userDataStr = $.cookie("pmsWeb_user_data");
	if(!userDataStr){
		
		noLogin(location.href);
		return;
	}
	userData = jQuery.parseJSON(userDataStr);
	ticket = $.cookie("pmsWeb_ticket");
	
	var params = getUrlParams();
	console.log(params);
	if(params){
		if(params.currentPage){
			_currentPage=params.currentPage;
		}
		
		if(params.minMoney){
			minMoney=params.minMoney;
		}else
		{
			minMoney=$(".leftLabel").text();
		}
		
		if(params.maxMoney){
			maxMoney=params.maxMoney;
		}
		else
		{
			maxMoney=$(".rightLabel").text();
		}
		
		if(params.minMoney && params.maxMoney)
		{
			$(".nstSlider").nstSlider("set_position", minMoney , maxMoney);
		}
		
		
		if(params.employeeName){
			employeeName=params.employeeName;
			$("input[name=employeeName]").val(employeeName);
		}
		
		if(params.beginTime){
			beginTime=params.beginTime;
			$("input[name=beginTime]").val(beginTime);
		}
		else
		{
			beginTime=$("input[name=beginTime]").val();
		}
		
		
		if(params.endTime){
			endTime=params.endTime;
			$("input[name=endTime]").val(endTime);
		}
		else
		{
			endTime=$("input[name=endTime]").val();
		}
		
		if(params.unitCode){
			unitCode=params.unitCode;
			ngScope.selectedUnitCode=unitCode;
		}
		
		if(params.status){
			status=params.status;
			//datatype="0"
			pStatus=status;
			
			$("a[datatype='"+status+"']").addClass("selected");
			$("a[datatype='"+status+"']").siblings().removeClass("selected");
		}
		
		if(params.proNo){
			proNo=params.proNo;
			ngScope.selectProNo=proNo;
		}
		
		if(params.proName){
			proName=params.proName;
			ngScope.selectProName=proName;
			$("input[name=project]").val(proName);
		}
		
		if(params.unitName){
			unitName=params.unitName;
			ngScope.selectedUnitName=unitName;
			$("input[name=orgUnit]").val(unitName);
		}
		
	}
	
	
	$(".switch_btn_group>a").each(function(){
		$(this).click(function(){
			$(this).addClass("selected");
			$(this).siblings().removeClass("selected");
			pStatus = $(this).attr("datatype");
			//$scope.doQuery();
			gotoPage(1);
		});
	});
	
	new DropDownList().init({
			mode:"page",
			renderTo:"input[name=orgUnit]",
			url:"../../component/orgTree.html?ticket="+$scope.ticket,
			height:"200px",
			onSelected:function(result){
				$scope.selectedUnitCode=result.unitCode;
				$("input[name='orgUnit']").val(result.unitName);
				$scope.selectedUnitName=result.unitName;
			}
		});
		
	/* 项目列表 */
	var projectList = new DropDownList();
	projectList.init({
		renderTo:"input[name=project]",
		url:"../../component/projectList.html?required=false&ticket="+ticket,
		height:"200px",
		onSelected:function(result){
			$("input[name=project]").val(result.proName);
			$scope.selectProNo=result.proNo;
			$scope.selectProName=result.proName
		}
	});
	
	//employeeName 搜索内容，不仅仅是姓名
	$scope.loadStatistic=function(fromTime, toTime,unitCode, employeeName,minMoney,maxMoney,status,proNo,pageNum){
		$http.get(serviceBasePath+"eap/pmsServices/fm/expense/feeReturn/list?fromTime="+fromTime+"&toTime="+toTime+"&currentPage="+pageNum+"&employeeName="+employeeName+"&unitCode="+unitCode+"&minMoney="+minMoney+"&maxMoney="+maxMoney+"&status="+status+"&proNo="+proNo+"&ticket="+ticket).success(function(response){
			if(response.statusCode!=200){
				alert("请求服务器失败！");
				return;
			}
			console.log(response);
			$scope.infoList = response.list;
			createPageBar(response.totalPage,response.currentPage,response.totalRecord);
		});
	};
	
	
	$scope.doShow=function(item){
		hrefTo({
			url:"feeReturnDetail.html?rowid="+item.rowid,
			data:{
				pStatus:pStatus,
				minMoney:minMoney,
				maxMoney:maxMoney,
				employeeName:employeeName,
				beginTime:beginTime,
				endTime:endTime,
				unitCode:unitCode,
				status:status,
				proNo:proNo,
				proName:proName,
				unitName:unitName,
				currentPage:_currentPage
			}
		});
		
	};
	
	$scope.toCheck=function(item, index){
		var itemStr = toUrlParams(item);
		new ShowDlog().showFrame("feeReturnGet.html?"+itemStr, "认领", function(res){
			if("SUCCESS"==res){
				new ShowDlog().prompt({
					icon:"success",
					msg:"已认领！",
					done:function(){
						$scope.loadStatistic(beginTime, endTime,unitCode,employeeName,minMoney,maxMoney,pStatus,proNo,_currentPage);
					},
					t:1500
				});
			}else if("FAIL"==res){
				new ShowDlog().prompt({
					msg:"认领失败！",
					done:function(){
					},
					t:1500
				});
			}
		}, "feeReturnGet");
	};
	
	$scope.sub=function(content){
		
		    if(content.length>50){
		    	var str=content.substring(0,50);
		    	return str;
		    }else{
		    	return content;
		    }
			
	};
		
	//fromTime, toTime,unitCode, employeeName,minMoney,maxMoney,status,proNo,pageNum
	$scope.loadStatistic(beginTime, endTime,unitCode,employeeName,minMoney,maxMoney,pStatus,proNo,_currentPage);
	
});


</script>
</body>
</html>
