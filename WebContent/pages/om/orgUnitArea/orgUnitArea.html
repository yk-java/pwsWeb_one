<!DOCTYPE HTML>
<html ng-app="orgMgr">
<head>
<title> 组织架构管理</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">



<link rel="stylesheet" href="../../../css/zTreeStyle/zTreeStyle.css" type="text/css">
<script type="text/javascript" src="../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../js/jquery.ztree.core-3.5.js"></script>
<script type="text/javascript" src="../../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script></head>
<script type="text/javascript" src="../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../js/PageBar.js"></script>
<script type="text/javascript" src="../../../js/config.js"></script>
<script type="text/javascript" src="../../../js/util.js"></script>
<script type="text/javascript" src="../../../js/ng-base.js"></script>
<script type="text/javascript" src="../../../js/GeoUtils.js"></script>

<script type="text/javascript" src="../../../js/showDlog/showDlog.js"></script>


<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=PL4wfqVofjrMVz7FMaPs8Dts"></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
<link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />
<link rel="stylesheet" type="text/css" href="../../../js/showDlog/showDlog-blue.css" />

<link rel="stylesheet" type="text/css" href="../../../css/list.css"/>
<style type="text/css">

	.list .list_left{position: absolute;left:0px;top:0px;bottom:0px;width:220px;background:#E5F0FF;}
	.list .list_left .left_title{width:100%;height:35px;background:#3385FF;line-height:35px;color:#fff;border-bottom:solid 1px #4CA9FF; text-align: center}
	.list .list_left .left_operation{width:100%;height:30px;background:#3385FF;line-height:30px;color:#fff;}
	.list .list_left .left_operation .operation1{height:30px;width:120px;border-right:solid 1px #4CA9FF;line-height:28px;text-align: center;color:#fff;float:left;cursor: pointer;}
	.list .list_left .left_operation .operation1 > a{color:#fff;vertical-align: middle;}
	.list .list_left .left_operation .operation2{height:30px;width:100px;line-height:28px;text-align: center;color:#fff;float:left;cursor: pointer;}
	.list .list_left .left_operation .operation2 > a{color:#fff;vertical-align: middle;}
	.list .list_left .left_tree{position: absolute;left:0px;right:0px;bottom:0px;top:40px;border:solid 0px;overflow: auto;}
	.list .list_content{position: absolute;left:230px;right:0px;top:0px;bottom:0px;border:solid 0px;}
	.list .list_content .title_div{width:100%;height:39px;border-bottom:solid 3px #3385FF;}
	.list .list_content .title_div .title_left{min-width:250px;height:39px;background:#3385FF;line-height:42px;color:#fff;font-size:14px;font-weight: bold;float:left;}
	.list .list_content .title_div > img{float:left;margin-top:1px;}
	.list .list_content .title_div .title_add{float:left;width:70px;height:28px;background: url(../../../img/bnt_newly-added.png) repeat;line-height:28px;text-align:center;margin-left:30px;margin-top:5px;color:#fff;cursor: pointer;}
	.list .list_content .table_div{left:0px;right:0px;bottom:32px;top:42px;border:solid 0px;}

	.ztree span{font-family:微软雅黑;}
	
	

.edit-deptment{width:800px;height:450px;}


.map_div{position: absolute;left:0px;top:0px;bottom:0px;right:0px;border:solid 1px #cccccc;}

.showmess{height:30px; width:600px; background:red; z-index: 9999; position: absolute;left:5px; top:5px; background-color:rgba(255, 255, 255, 0.9);padding-top:10px; font-size:14px;padding-left:10px; }


.btnedit{width:100px; height:25px;background-color:#C1FF7F;border-radius:10px;padding-top:6px;margin-left:5px;border:1px #428000 solid;color:#428000;
	float:left;z-index: 9999;text-align: center;cursor: pointer;display: none
}
.btndelete{width:100px; height:25px;background-color:#FF9A7F;border-radius:10px;padding-top:6px;margin-left:5px;border:1px #FF734C solid;color:black;
	float:left;z-index: 9999;text-align: center;cursor: pointer;display: none
}
.btnsave{width:100px; height:25px;background-color:#7FB2FF;border-radius:10px;padding-top:6px;margin-left:5px;border:1px #4C94FF solid;color:#fff;
	float:left;z-index: 9999;text-align: center;cursor: pointer;display: none
}
.btnback{width:70px; height:25px;background-color:#FBFFF7;border-radius:10px;padding-top:6px;margin-left:5px;border:1px #71be35 solid;color:#71be35;
	float:left; z-index: 9999;text-align: center;cursor: pointer;display: none
}
.allbtn{
width:400px;position: absolute;left:620px;top:10px;
}
</style>

<body ng-controller="orgMgr">

<div class="list">
	<div class="list_left">
		<div class="left_title">
			&nbsp;&nbsp;组织架构树
		</div>
		
		<div class="left_tree">
				<ul id="treeDemo" class="ztree"></ul>
		</div>
	</div>
	<div class="list_content">
		<div class="map_div" id="allmap">
		</div>
		
        <div class="showmess">
        	当前选择：<span id="currentUnit"></span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        	<span id="warning" style="color:red; display: none">该组织还没有划分区域范围！</span>
        	<span id="zhouchang">
        		面积：<span id="area">0</span>平方公里&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        		周长：<span id="perimeter">0</span>公里
        	</span>
        	
        </div>
        <div class="allbtn">
	        <div class="btnedit"  onclick = "editArea()">
	        	编辑区域
	        </div>
	        <div class="btndelete" onclick="deleteArea()">
	        	删除区域
	        </div>
	        <div class="btnsave" onclick = "save()">
	        	保存区域
	        </div>
	        <div class="btnback" onclick = "btncancel()">
	        	取消
	        </div>
        </div>
	</div>
</div>

<script type="text/javascript">


var selPolygon;
var unitCode="";
var unitName="";
var ngScope;
var centerx;
var centery;
var total=0;
var app = simpleController({
	moduleName:"orgMgr",
	controllerName:"orgMgr",
	init:function($scope, $http){
		ngScope=$scope;
		var setting = {
			data:{
				key:{
					name:"unitName"
				},
				simpleData:{
					enable:true,
					idKey:"unitCode",
					pIdKey:"parentUnit",
					rootPid:-1
				}
			},
			callback:{
				onClick:function(){
					
					
					for(var i = 0; i < overlays.length; i++){
				        map.removeOverlay(overlays[i]);
				    }
					var selectedNodes = orgTree.getSelectedNodes();
					unitCode = selectedNodes[0].unitCode;
					unitName = selectedNodes[0].unitName;
					//app.ngScope.selectedUnit=selectedNodes[0];
					//alert(polygon)
					if(total>0){
						map.removeOverlay(selPolygon);
					}
					
					
					total=total+1;
					//map.centerAndZoom(new BMap.Point(116.404, 39.915), 15);
					if(selectedNodes[0].xs){
						var xsArray=selectedNodes[0].xs.split(",");
						var ysArray=selectedNodes[0].ys.split(",");
						
						var tempArray=[];
						for(var i=0;i<xsArray.length;i++){
							var point=new BMap.Point(xsArray[i],ysArray[i]);  
							tempArray.push(point);
						}
						map.setViewport(tempArray);
						selPolygon = new BMap.Polygon(tempArray, {strokeColor:"red", strokeWeight:2, strokeOpacity:0.5,strokeStyle:"dashed",fillColor:"#97BFF9"});  //创建多边形
						map.addOverlay(selPolygon);
						
						
						var cp=selPolygon.getBounds();
						var pt=cp.getCenter();
						
						
						centerx=pt.lng;
						centery=pt.lat;
						$("#currentUnit").html(selectedNodes[0].unitName);
						$(".btnedit").show();
						$(".btndelete").show();
						$("#warning").hide();
						$("#zhouchang").show();
						if(selectedNodes[0].area){
							$("#area").html(selectedNodes[0].area);
							$("#perimeter").html(selectedNodes[0].perimeter);
						}else{
							$("#area").html("0");
							$("#perimeter").html("0");
						}
						
						
					}else{
						
						//unitCode
						var tempArray=[];
						for(var i in $scope.array){
							var node = $scope.array[i];
							if(node.parentUnit==unitCode && node.xs && node.xs!=""){
								tempArray.push(node);
							}
						}
						
						var pointArray=[];
						for(var j=0;j<tempArray.length;j++){
							var xsArray=tempArray[j].xs.split(",");
							var ysArray=tempArray[j].ys.split(",");
							for(var k=0;k<xsArray.length;k++){
								var polypoint=new BMap.Point(xsArray[k],ysArray[k]);  
								pointArray.push(polypoint);
							}
						}
						map.setViewport(pointArray);
						//alert(1)
						$("#currentUnit").html(selectedNodes[0].unitName);
						
						$("#warning").show();
						$("#zhouchang").hide();
						
						$(".btnedit").hide();
						$(".btndelete").hide();
						
					}                      	
				}
			}
		};
		var zNodes ={};
		var orgTree={};
		
		$scope.selectedUnit={};
		
		/* 查询部门数据 */
		
		$scope.colors=["blue","red","orange","green","black","pink"];
		
		$scope.loadTree=function(){
			$scope.httpGet({
				url:"eap/pmsServices/sys/orgEmployee/org/orgTree",
				data:{"companyCode":$scope.userData.companyCode},
				success:function(res){
					if(res.statusCode==200){//alert(res.tree);
					
						map.removeOverlay(selPolygon);
					    map.clearOverlays(); 
					    
					    $("#area").html("0");
						$("#perimeter").html("0");
						
						total=0;
						zNodes.unitName=$scope.userData.companyName;
						zNodes.unitCode="0";
						zNodes.parentUnit="-1";
//	 					zNodes.children=res.tree;
						zNodes.open=true;
						zNodes.icon="../../../img/comp.png";
						
						$scope.array=res.tree;
						
						for(var i in res.tree){
							var node = res.tree[i];
							node.icon="../../../img/dept.png";
							//alert(node.xs)
							var xsArray=[];
							if(node.xs){
								xsArray=node.xs.split(",");
							}else{
								continue;
							}
							
							var ysArray=node.ys.split(",");
							
							var tempArray=[];
							for(var j=0;j<xsArray.length;j++){
								var point=new BMap.Point(xsArray[j],ysArray[j]);  
								tempArray.push(point);
							}
							//map.setViewport(tempArray);
						
							var polygon = new BMap.Polygon(tempArray, {strokeColor:"red", strokeWeight:1, strokeOpacity:0.5,strokeStyle:"dashed"});  //创建多边形
							map.addOverlay(polygon);
							
							var cp=polygon.getBounds();
							var pt=cp.getCenter();
							
							
							var point = new BMap.Point(pt.lng,pt.lat);
							//map.centerAndZoom(point, 15);
							var opts = {
							  position : point,    // 指定文本标注所在的地理位置
							  offset   : new BMap.Size(-15, -10)    //设置文本偏移量
							}
							var label = new BMap.Label(node.unitName, opts);  // 创建文本标注对象
							label.setStyle({
								 color : "#666",
								 fontSize : "12px",
								 height : "20px",
								 lineHeight : "20px",
								 fontFamily:"微软雅黑",
								 backgroundColor:"#F2F8FF",
								 borderColor:"#999"
							 });
							map.addOverlay(label); 
							
						}
						res.tree.push(zNodes);
						orgTree = $.fn.zTree.init($("#treeDemo"), setting, res.tree);
						orgTree.expandAll(true);
						//$scope.loadUsers(res.tree[0].unitCode, 1);
						$scope.selectedUnit=res.tree[0];
						
					//	alert("selPolygon"+selPolygon)
						if(selPolygon){
							var selcp=selPolygon.getBounds();
							map.setViewport(selcp);
						}
						
						
						//var centpoint = new BMap.Point(centerx,centery);
						//map.centerAndZoom(centpoint, 15);
						
					}
				}
			});
			
		};
		$scope.loadTree();
		
		
		
		/* 删除部门信息 */
		$scope.doDelete=function(){
			var selectedNodes = orgTree.getSelectedNodes();
			if(!selectedNodes || selectedNodes.length != 1){
				new ShowDlog().prompt({
					msg:"请选择要编辑的部门！",
					done:function(){},
					t:1500
				});
				return;
			}
			// have user?
			$scope.httpGet({
				url:"eap/pmsServices/sys/orgEmployee/employee/list",
				data:{"unitCode":$scope.selectedUnit.unitCode},
				success:function(res){
					if(res.list && res.list.length>0){
						new ShowDlog().prompt({
							icon:"error",
							msg:"请确保部门下无人员信息！",
							done:function(){},
							t:2800
						});
					}else{
						new ShowDlog().confirm({
							msg:"确定删除部门（"+$scope.selectedUnit.unitName+"）？",
							ok:function(){
								$scope.httpPost({
									url:"eap/pmsServices/sys/orgEmployee/org/delete",
									data:{"unitCode":$scope.selectedUnit.unitCode},
									success:function(res){
										location.reload();
									}
								});
							}
						});
					}
				}
			});
		};
	}
});

function save(){
	if(unitCode==""){
		new ShowDlog().prompt({
			icon:"success",
			msg:"请您选择区域！",
			done:function(){
				
			},
			t:1500
		});
	}else{
		
		if(__xs!=""){
			baocun(__xs,__ys);
		}else if(selPolygon){
			var obj=selPolygon.getPath();
			var tempxs="";
			var tempys="";
			for(var i=0;i<obj.length;i++){
				tempxs+=obj[i].lng+",";
				tempys+=obj[i].lat+",";
			}
			tempxs=tempxs.substring(0,tempxs.length-1);
			tempys=tempys.substring(0,tempys.length-1);
			selPolygon.disableEditing();
			baocun(tempxs,tempys);
		}
		
		
	}
}

function  deleteArea(){
	if(unitCode==""){
		new ShowDlog().prompt({
			icon:"success",
			msg:"请您选择区域！",
			done:function(){
				
			},
			t:1500
		});
	}else{
		new ShowDlog().confirm({
			msg:"确定删除"+unitName+"区域范围吗？",
			ok:function(){
				
				$.ajax({
					url:serviceBasePath+"eap/pmsServices/sys/orgEmployee/org/deleteArea?unitCode="+unitCode,
					cache:false,
					method:"POST",
					success:function(res){
						new ShowDlog().prompt({
							icon:"success",
							msg:"删除成功！",
							done:function(){
								unitCode="";
								unitName="";
								$("#currentUnit").html("");
								ngScope.loadTree();
								$(".btnsave").hide();
								$(".btnback").hide();
								$(".btndelete").hide();
								$(".btnedit").hide();
							},
							t:1500
						});

					},
					error:function(){
						new ShowDlog().prompt({
							icon:"warning",
							msg:"删除失败！",
							done:function(){
								
							},
							t:1500
						});

					}
				});
				
			}
		});
	}
	

	
}

function baocun(savex,savey){
	
	var zhouchang=BMapLib.GeoUtils.getCircumference(selPolygon);
	var mianji=BMapLib.GeoUtils.getPolygonArea(selPolygon);
	
	
	$.ajax({
		url:serviceBasePath+"eap/pmsServices/sys/orgEmployee/org/updateArea?unitCode="+unitCode+"&ys="+savey+"&xs="+savex+"&perimeter="+zhouchang+"&area="+mianji,
		cache:false,
		method:"POST",
		success:function(res){
			new ShowDlog().prompt({
				icon:"success",
				msg:"保存成功！",
				done:function(){
					unitCode="";
					$("#currentUnit").html("");
					ngScope.loadTree();
					$(".btnsave").hide();
					$(".btnback").hide();
					$(".btndelete").hide();
					$(".btnedit").hide();
				},
				t:1500
			});

		},
		error:function(){
			new ShowDlog().prompt({
				icon:"warning",
				msg:"保存失败！",
				done:function(){
					
				},
				t:1500
			});

		}
	});
	

}

function btncancel(){
	
	$(".btnsave").hide();
	$(".btnback").hide();
	$(".btndelete").hide();
	$(".btnedit").hide();
	
	unitCode="";
	$("#currentUnit").html("");
	ngScope.loadTree();
}

function editArea(){
	
	$(".btnsave").show();
	$(".btnback").show();
	
	if(unitCode==""){
		new ShowDlog().prompt({
			icon:"success",
			msg:"请您选择区域！",
			done:function(){
				
			},
			t:1500
		});
	}else{
		selPolygon.enableEditing();
	}
	
}
</script>

<script>
//百度地图API功能
var map = new BMap.Map("allmap", {enableMapClick:false});    // 创建Map实例
//map.addControl(new BMap.MapTypeControl());   //添加地图类型控件
map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
var markergg = null;

map.centerAndZoom(new BMap.Point(118.817849,32.049143), 12);  // 初始化地图,设置中心点坐标和地图级别
//map.centerAndZoom(new BMap.Point(116.404, 39.915), 15);

var __mode="",__r="",__x="",__y="",__xs="",__ys="";
var viewPortPoints=[];
var overlays = [];
var overlaycomplete = function(e){
	
	map.removeOverlay(selPolygon);
	polygon = new BMap.Polygon([], {strokeColor:"blue", strokeWeight:2, strokeOpacity:0.5});  //创建多边形
	// 清除
	for(var i = 0; i < overlays.length; i++){
        map.removeOverlay(overlays[i]);
    }
    overlays.length = 0;
    // 增加
	var overlay = e.overlay;
    overlays.push(e.overlay);
    __mode=e.drawingMode;
    if(e.drawingMode=="circle"){
    	__r = overlay.getRadius();
    	var center = overlay.getCenter();
    	__x =center.lng;
    	__y =center.lat;
    	
    	var bounds = overlay.getBounds();
    	var minPoint = bounds.getSouthWest();
    	var maxPoint = bounds.getNorthEast();
    	viewPortPoints=[];
    	viewPortPoints.push(minPoint);
    	viewPortPoints.push(maxPoint);
    	__xs=minPoint.lng+","+maxPoint.lng;
    	__ys=minPoint.lat+","+maxPoint.lat;
    	// 查询
    	//ngScope.toQuery();
    }else if(e.drawingMode=="polygon" || e.drawingMode=="rectangle"){
    	var points = overlay.getPath();
    	viewPortPoints=points;
    	__xs="",__ys="";
    	for(var i=0; i<points.length; i++){
    		var p = points[i];
    		if(__xs.length>0){
    			__xs+=",";
    		}
    		if(__ys.length>0){
    			__ys+=",";
    		}
    		__xs+=p.lng;
    		__ys+=p.lat;
    	}
		//alert(1);
		
		selPolygon=new BMap.Polygon(points, {strokeColor:"red", strokeWeight:1, strokeOpacity:0.5,strokeStyle:"dashed"});  //创建多边形
    	// 查询
    	//ngScope.toQuery();
    }else{
    	
    }
    
   

    $(".btnsave").show();
    $(".btnback").show();
    
     console.log(__ys)
     console.log(__xs)
   
    //$("a[drawingtype=hander]").click();
    drawingManager.setDrawingMode("hander");
};
var styleOptions = {
    strokeColor:"red",    //边线颜色。
    fillColor:"red",      //填充颜色。当参数为空时，圆形将没有填充效果。
    strokeWeight: 3,       //边线的宽度，以像素为单位。
    strokeOpacity: 0.2,	   //边线透明度，取值范围0 - 1。
    fillOpacity: 0.1,      //填充的透明度，取值范围0 - 1。
    strokeStyle: 'solid' //边线的样式，solid或dashed。
}
//实例化鼠标绘制工具
var drawingManager = new BMapLib.DrawingManager(map, {
    isOpen: false, //是否开启绘制模式
    enableDrawingTool: true, //是否显示工具栏
    drawingToolOptions: {
        anchor: BMAP_ANCHOR_TOP_RIGHT, //位置
        offset: new BMap.Size(5, 5), //偏离值
        drawingModes: [BMAP_DRAWING_RECTANGLE,BMAP_DRAWING_POLYGON]
        
/* BMAP_DRAWING_MARKER="marker",
BMAP_DRAWING_POLYLINE="polyline",
BMAP_DRAWING_CIRCLE="circle",
BMAP_DRAWING_RECTANGLE="rectangle",
BMAP_DRAWING_POLYGON="polygon"; */
    },
    circleOptions: styleOptions, //圆的样式
    polylineOptions: styleOptions, //线的样式
    polygonOptions: styleOptions, //多边形的样式
    rectangleOptions: styleOptions //矩形的样式
});  
 //添加鼠标绘制工具监听事件，用于获取绘制结果
drawingManager.addEventListener('overlaycomplete', overlaycomplete);

$(".BMapLib_Drawing_panel").prepend("<label class=\"BMapLib_box2 BMapLib_clear\" drawingtype=\"clear\" href=\"javascript:void(0)\" title=\"清除\" onfocus=\"this.blur()\"></label>");
$("label[drawingtype=clear]").click(function(){
	for(var i = 0; i < overlays.length; i++){
        map.removeOverlay(overlays[i]);
    }
    overlays.length = 0;
    __mode="";__r="";__x="";__y="";__xs="";__ys="";
}); 


function setViewPort(points){
	var minLng=999,minLat=999,maxLng=0,maxLat=0;
	for (var i = 0; i < points.length; i++) {
		
		var p = points[i];
		var lng = p.lng;
		var lat = p.lat;
		if(lng<minLng){
			minLng=lng;
		}
		if(lat<minLat){
			minLat=lat;
		}
		if(lng>maxLng){
			maxLng=lng;
		}
		if(lat>maxLat){
			maxLat=lat;
		}
	}
	var pts = [new BMap.Point(minLng,minLat),new BMap.Point(maxLng,minLat),new BMap.Point(maxLng,maxLat),new BMap.Point(minLng,maxLat)];
	map.setViewport(pts);
}

/* 自定义图标 */
function CustomMarker(point, markerIdx){
	this._div;
	this._point = point;
	this.markerIndex=1;
	this.clickListener;
	if(markerIdx)
		this.markerIndex=markerIdx;
};
CustomMarker.prototype = new BMap.Overlay();
CustomMarker.prototype.initialize = function(map){
    this._map = map;
    var _self = this;
    var div = this._div = document.createElement("div");
    div.style.position = "absolute";
    div.style.zIndex = BMap.Overlay.getZIndex(this._point.lat);
    var span = this._span = document.createElement("span");
    span.className="marker cmkr"+this.markerIndex;
    div.appendChild(span);
    var that = this;

    div.onmouseover = function(){
    };

    div.onmouseout = function(){
    };
	span.onclick=function() {
		
		if (_self.clickListener) {
			
			_self.clickListener(_self._point);
		}
	};
    map.getPanes().labelPane.appendChild(div);
    return div;
  };
CustomMarker.prototype.addClickListener=function(fn){
	this.clickListener=fn;
};  
CustomMarker.prototype.draw = function(){
  var map = this._map;
  var pixel = map.pointToOverlayPixel(this._point);
  this._div.style.left = pixel.x - 12 + "px";
  this._div.style.top  = pixel.y - 25 + "px";
}

</script>
</body>
</html>
