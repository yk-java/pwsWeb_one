<!DOCTYPE HTML>
<html>
<head>
<title> 设备管理 </title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<script type="text/javascript" src="../../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script></head>
<script type="text/javascript" src="../../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../../js/PageBar.js"></script>
<script type="text/javascript" src="../../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../js/DropDownList-1.2/DropDownList.css"/>
<script type="text/javascript" src="../../../../js/Calendar.js"></script>
<script type="text/javascript" src="../../../../js/config.js"></script>
<script type="text/javascript" src="../../../../js/util.js"></script>
<script type="text/javascript" src="../../../../js/ng-base.js"></script>

<script type="text/javascript" src="../../../../js/eapJs/core/eap.core.js" ></script>
<script type="text/javascript" src="../../../../js/eapJs/plugins/eap.tip.js" ></script>
<script type="text/javascript" src="../../../../js/eapJs/plugins/eap.validate.js"></script>
<script type="text/javascript" src="../../../../js/eapJs/local/eap.lang-zh_CN.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../css/validate.css"/>
<link rel="stylesheet" type="text/css" href="../../../../css/edit.css"/>

<script type="text/javascript" src="../../../../js/showDlog/showDlog.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../js/showDlog/showDlog-blue.css" />
<script src="../../../../js/jquery-photo-gallery/jquery.photo.gallery.js"></script>
<style type="text/css">
	.chooseUser{width:1000px;height:500px;}
</style>
<style type="text/css">
ul,li{margin:0;padding:0;}

	.detail_box{width:100%;}
	.detail_box td{border:solid 0px red;padding:6px;}
	.detail_box .pic_box{width:180px;height:560px;overflow-y:auto;overflow-x:hidden; background:#fafafa}

	.detail_box .info_title{margin:0;background:#297BE6;color:#fff;height:40px;}
	.detail_box .info_title h2{margin:0;color:#fff;line-height:40px;display:inline-block;height:40px;float:left;margin:0 0 0 10px;font-weight:normal;font-size:14px;}
	.detail_box .info_title a{display:inline-block;width:60px;height:30px;line-height:30px;color:#fff;font-size:14px;text-align:center;border:solid 1px #fff;float:right;margin:5px 6px 0 0;}
	
	.detail_box .info_detail{background:#3285FF;color:#fff;padding:10px;}
	.detail_box .info_detail>div{padding:4px;}
	.detail_box .info_detail>div .dev_status{background:#EB7502;color:#fff;padding:2px 4px 2px 4px;border-radius:4px;}
	
	.detail_box .info_detail_ext{padding:10px;border-left:solid 1px #f5f5f5;border-bottom:solid 1px #eee;border-right:solid 1px #eee;}
	.detail_box .info_detail_ext>div{padding:4px;color:#888;}
	
	.detail_box .sub_table_title{margin:0;background:#EDF4FF;color:#2F82F7;height:40px;}
	.detail_box .sub_table_title h2{margin:0;color:#2F82F7;line-height:40px;display:inline-block;height:40px;float:left;margin:0 0 0 10px;font-weight:normal;font-size:14px;}
	
	.detail_box .sub_table_body{}
	.detail_box .sub_table_body .sub_table{width:100%;}
	.detail_box .sub_table_body .sub_table th{color:#2F82F7;padding:6px;border-bottom:solid 1px #f4f4f4;}
	.detail_box .sub_table_body .sub_table td{text-align:center;color:#666;padding:6px;border-bottom:solid 1px #f4f4f4;}
	
    .titil_top{width:100%;height:25px;padding-top:5px;text-align:center;background:#3285FF;color:#fff;margin-top:0px;}
</style>
</head>

<body ng-app="moduleName" ng-controller="controllerName">



<table class="detail_box">
	<tr>
		<td width="190" valign="top">
			<div class="pic_box gallerys">
			   <p class="titil_top">
			   	  设备图片
			   </p>
				<img ng-repeat="item in imgList" title="点击放大" onerror="javascript:this.src='../../../../img/defaultImg.png';"  src="{{item.url}}" class="gallery-pic imgs" style="border:1px #e5f0ff solid;cursor:url(../../../../img/big.png), pointer;margin:5px 0 0 12px;" width="153" height="148" id="pic_{{$index}}" 
				ng-click="showdiv($index,item.picTitle)" />
				
				<img id="defaultImg"   src="../../../../img/defaultImg.png"  style="border:1px #ccc solid;;margin:5px 0 0 12px; display: none" width="153" height="148" />
				
			</div>
		</td>
		<td valign="top">
			<div class="info_title">
				<h2>{{data.deviceObjName}}</h2>
<!-- 				<a href="javascript:">返回</a> -->
			</div>
			<div class="info_detail">
				<div><span class="dev_status">{{data.healthName}}</span></div>
				<div>设备编号：{{data.deviceObjCode}}</div>
				<div>{{data.addressDesc}}</div>
			</div>
			
			<div ng-repeat="tr in deviceAttrTrs" class="info_detail_ext">
				<table width="100%">
					<tr>
						<td width="50%" ng-repeat="item in tr">
							<span ng-if="item.cname">
							<b>{{item.cname}}：</b>{{data[item.ename]}}
							</span>
						</td>
					</tr>
				</table>
			</div>
		</td>
	</tr>
	<tr ng-repeat-start="objAttr in objAttrs" ng-if="objAttr.dtype==6">
		<td colspan="2">
			<div class="sub_table_title">
				<h2>{{objAttr.cname}}</h2>
			</div>
			<div class="sub_table_body">
				<table class="sub_table">
					<tr ng-repeat="tr in objAttr.deviceAttrTrs">
						<td width="50%" ng-repeat="f in tr" style="text-align:left;">
							<span ng-if="f.cname" style="padding-left:20px;">
							<b style="color:#2F82F7;">{{f.cname}}：</b>{{data[objAttr.ename][f.ename]}}
							</span>
						</td>
					</tr>
				</table>
			</div>
		</td>
	</tr>
	<tr ng-repeat-end ng-if="objAttr.dtype==8">
		<td colspan="2">
			<div class="sub_table_title">
				<h2>{{objAttr.cname}}</h2>
			</div>
			<div class="sub_table_body">
				<table class="sub_table">
					<tr>
						<th>序号</th>
						<th ng-repeat="f in objAttr.deviceAttrList">{{f.cname}}</th>
					</tr>
					<tr ng-repeat="item in data[objAttr.ename]">
						<td>{{$index+1}}</td>
						<td ng-repeat="f in objAttr.deviceAttrList">{{item[f.ename]}}</td>
					</tr>
				</table>
			</div>
		</td>
	</tr>
</table>
<div>&nbsp;</div>
<div>&nbsp;</div>
<script type="text/javascript">
simpleController({
	init:function($scope, $http){
		var urlParams = getUrlParams();
		
		$scope.data={};
		$scope.deviceAttrList=[];
		$scope.deviceAttrTrs=[];
		$scope.objAttrs=[];
		$scope.imgList=[];
		
		$scope.loadDeviceInfo=function(deviceObjCode){
			$scope.httpGet({
				url:"eap/pmsServices/om/deviceMgr/device/getMctDevice?companyCode="+$scope.userData.companyCode,
				data:{"deviceObjCode":deviceObjCode},
				success:function(response){
					$scope.data = response.data;
					$scope.loadAttrs(response.data.mctCode);
					
					var mctCode=response.data.mctCode;
					var companyCode=response.data.companyCode;
					var proNo=response.data.proNo;
					var deviceObjCode=response.data.deviceObjCode;
					
					$scope.loadimgList(mctCode,companyCode,proNo,deviceObjCode); 
				}
			});
		};
		$scope.loadDeviceInfo(urlParams.deviceObjCode);
		
		

		$scope.loadimgList=function(mctCode,companyCode,proNo,deviceObjCode){
			//alert(mctCode+" "+companyCode+" "+proNo+" "+deviceObjCode)
			$http.get(serviceBasePath+"eap/pmsServices/om/deviceMgr/images/getList?mctCode="
				+mctCode+"&deviceObjCode="+deviceObjCode+"&proNo="+proNo+"&companyCode="+companyCode).success(function(response){
				if(response.statusCode==401){
					alert("用户凭据过期！请重新登录！");
					window.top.location.href="../../../login.html";
					return;
				}
				
				for(var i=0;i<response.list.length;i++){
					var st=filePath+"?fileCode="+response.list[i].picVisitid+"&attachment=0"
							
				    response.list[i].url=st;			
				} 
				
				if(response.list.length>0){
					$("#defaultImg").hide();
				}else{
					$("#defaultImg").show();
				}
				$scope.imgList = response.list;
			});
			
		};
		
		/* 加载属性信息 */
		$scope.loadAttrs=function(mctCode){
			$scope.httpGet({
				url:"eap/pmsServices/om/deviceMgr/device/mctAttr?companyCode="+$scope.userData.companyCode,
				data:{"mctCode":mctCode},
				success:function(response){
					$scope.deviceAttrList = response.list;
					$scope.deviceAttrTrs=$scope.splitToTr($scope.deviceAttrList);
				}
			});
		};
		
		$scope.loadSubAttrs=function(field){
			$scope.httpGet({
				url:"eap/pmsServices/om/deviceMgr/device/mctAttr?companyCode="+$scope.userData.companyCode,
				data:{"deviceTypeCode":field.enumValue},
				success:function(response){
					field.deviceAttrList = response.list;
					field.deviceAttrTrs=$scope.splitToTr(field.deviceAttrList);
				}
			});
		};
		
		/* 组织tr数据 */
		$scope.splitToTr=function(arr){
			var trs=[];
			for(var i=0; i<arr.length; i++){
				var attr = arr[i];
				if(attr.dtype==6 || attr.dtype==8){
					$scope.loadSubAttrs(attr);
					$scope.objAttrs.push(attr);
					continue;
				}
				if(i!=0 && i%2==0){
					trs.push([]);
				}
				if(trs.length==0){
					trs.push([]);
				}
				var tr=trs[trs.length-1];
				tr.push(attr);
			}
			var lastTr=trs[trs.length-1];
			if(lastTr.length<2){
				lastTr.push({});
			}
			return trs;
		};
		
		$scope.showdiv=function(index,title){
			
			var img1=$("#pic_"+index);
			$.openPhotoGallery(img1,"../../../../js/jquery-photo-gallery/gallery.html?picTitle="+title)
			
			
		}
	
	}
});
</script>
</body>
</html>
