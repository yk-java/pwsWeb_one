<!DOCTYPE HTML>
<html ng-app="realPosition">
<head>
<title> 实时监控 </title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<script type="text/javascript" src="../../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=PL4wfqVofjrMVz7FMaPs8Dts"></script>
<script type="text/javascript" src="../../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../../js/PageBar.js"></script>
<script type="text/javascript" src="../../../../js/util.js"></script>
<script type="text/javascript" src="../../../../js/config.js"></script>
<script type="text/javascript" src="../../../../js/ng-base.js"></script>
<script type="text/javascript" src="../../../../js/Calendar.js"></script>
<script type="text/javascript" src="../../../../js/ViewState.js"></script>
<script type="text/javascript" src="../../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../js/DropDownList-1.2/DropDownList.css" />

<script type="text/javascript" src="../../../../js/showDlog/showDlog.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../js/showDlog/showDlog-blue.css" />
<link rel="stylesheet" type="text/css" href="../../../../css/common.css" />
<link rel="stylesheet" type="text/css" href="../../../../css/list.css" />
<script type="text/javascript" src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
<link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />

<style type="text/css">
	body{
		margin:0px;
		padding:0px;
		font-size:12px;
		font-family:"微软雅黑";
	}
	a{color:#4D4D4D;text-decoration: none;}

	.list{position: absolute;left:13px;right:13px;top:13px;bottom:10px;border:solid 0px;}
	.list .list_left{position: absolute;left:10px;top:0px;bottom:0px;width:390px;}
	.list .list_left .left_title{width:100%;height:160px;background:#297BE6;border:solid 1px #297BE6;}
	.list .list_left .left_title>div{margin:10px 10px;}
	.list .list_left .left_title>div>input{margin:6px 6px;}
	.list .list_left .left_title>div>a{margin:6px 6px;}
	.list .list_left .left_title .search_div{width:60px;height:38px;background:#1A4F93;color:#fff;line-height:40px;text-align:center;float:left;margin-left:10px;margin-top:20px;font-size:14px;font-weight: bold;}
	.list .list_left .left_content{position: absolute;left:0px;right:0px;top:170px;bottom:0px;border-bottom:solid 1px #B2D1FF;z-index:1;}
	.list .list_left .left_content .content_table{width:100%;top:0px;bottom:45px;}
	.list .map_div{position: absolute;left:410px;top:0px;bottom:0px;right:0px;border:solid 1px #cccccc;}

	.table,.table td,.table th{border:1px solid #EDEDED;border-collapse:collapse;}
	.tr1{height:40px;background:#D9E9FF;font-family: 微软雅黑;color:#4D4D4D;font-size:12px;font-weight:normal;}
	.tr2{height:40px;background:#fff;font-family: 微软雅黑;color:#4D4D4D;font-size:12px;}
	.tr2:hover{background:#F5F5F5;}
	.tr3{height:40px;background:#F5F5F5;font-family: 微软雅黑;color:#4D4D4D;font-size:12px;}
	.tr3:hover{background:#F5F5F5;}
	.tr4{height:40px;background:#EFD397;font-family: 微软雅黑;color:#4D4D4D;font-size:12px;}
	.operationImg{cursor: pointer;}

	.paging_div{bottom:10px;width:390px;height:22px;;margin:0 auto;border:solid 0px;color:#4D4D4D;text-align:center;margin-top:10px;}
	.dropDownList{background-image:url(../../../../img/drop_down_list.png);background-repeat: no-repeat;background-position:right;cursor:pointer;}

#page_bar .page_btn_prev{display:inline-black;border:solid 1px #3385FF;background:#3385FF;color:#fff;margin:0 4px;padding:2px 5px 2px 5px;}
#page_bar .page_btn_next{display:inline-black;border:solid 1px #3385FF;background:#3385FF;color:#fff;margin:0 4px;padding:2px 5px 2px 5px;}
#page_bar .page_btn{display:inline-black;border:solid 1px #3385FF;margin:0 4px;padding:2px 5px 2px 5px;}
#page_bar .selected{font-weight:bold;border:solid 1px #666;background:#666;color:#fff;}


	
	.table td{cursor:pointer;}
	
	.marker{display:inline-block;width:22px;height:25px;background:url(../../../../img/markers.png) -22px -275px no-repeat;padding:0;margin:0;}
	.mkr_s{background:url(../../../../img/markers.png) 0px -275px no-repeat;}
	.mkr1{background:url(../../../../img/markers.png) -22px 0px no-repeat;}
	.mkr_s1{background:url(../../../../img/markers.png) 0px 0px no-repeat;}
	.mkr2{background:url(../../../../img/markers.png) -22px -25px no-repeat;}
	.mkr_s2{background:url(../../../../img/markers.png) 0px -25px no-repeat;}
	.mkr3{background:url(../../../../img/markers.png) -22px -50px no-repeat;}
	.mkr_s3{background:url(../../../../img/markers.png) 0px -50px no-repeat;}
	.mkr4{background:url(../../../../img/markers.png) -22px -75px no-repeat;}
	.mkr_s4{background:url(../../../../img/markers.png) 0px -75px no-repeat;}
	.mkr5{background:url(../../../../img/markers.png) -22px -100px no-repeat;}
	.mkr_s5{background:url(../../../../img/markers.png) 0px -100px no-repeat;}
	.mkr6{background:url(../../../../img/markers.png) -22px -125px no-repeat;}
	.mkr_s6{background:url(../../../../img/markers.png) 0px -125px no-repeat;}
	.mkr7{background:url(../../../../img/markers.png) -22px -150px no-repeat;}
	.mkr_s7{background:url(../../../../img/markers.png) 0px -150px no-repeat;}
	.mkr8{background:url(../../../../img/markers.png) -22px -175px no-repeat;}
	.mkr_s8{background:url(../../../../img/markers.png) 0px -175px no-repeat;}
	.mkr9{background:url(../../../../img/markers.png) -22px -200px no-repeat;}
	.mkr_s9{background:url(../../../../img/markers.png) 0px -200px no-repeat;}
	.mkr10{background:url(../../../../img/markers.png) -22px -225px no-repeat;}
	.mkr_s10{background:url(../../../../img/markers.png) 0px -225px no-repeat;}
	.marker:hover{cursor:pointer;}
	.title{font-size:14px;color:#0066FF;}
	.table_item{border:0;margin-top:10px;margin-bottom:10px;}
	.table_item td{border:0;}	
	
	
.info_win{width:380px;}
.info_win table td{font-size:12px;padding:6px;}

.info_win .tiBar{height:30px;}
.info_win .title{float:left;font-size:14px;color:#0066ff;font-weight:bold;}
.info_win .dev_status{float:right;display:inline-block;padding:2px 4px 2px 4px;background:#ff7700;color:#fff;border-radius:5px;}
.info_win .foBar{border-top:solid 1px #ccc;padding:10px 10px 10px 10px;}
.info_win .foBar a{font-size:12px;color:#0066ff;}

.device_detail{width:1000px;height:500px;}
.cond_layer{position:absolute;display:none;width:388px;border:solid 1px #297BE6;border-radius:4px;margin:10px 0 0 0;z-index:99;background:rgba(41,123,230,0.9);}
.cond_layer ul, cond_layer li{margin:0;padding:0;list-style-type:none;}
.cond_layer ul{margin:20px 0 20px 0;}
.cond_layer li{margin:4px 4px 4px 4px;}
.cond_layer li>input{height:32px;border:solid 1px #ccc;margin-left:10px;color:#888;border-radius:3px;padding-left:2px;font-family:"微软雅黑";}
.cond_layer .close_btn{position:absolute;bottom:4px;right:4px;font-size:18px;color:#fff;padding:4px;}

.left_title .line{margin:10px auto;border-bottom:solid 1px #66A8FF;}

.left_title .btn{display:inline-block;height:30px;vertical-align:middle;line-height:30px;margin:0 4px;padding:0 10px 0 10px;background:#f4f4f4;color:#666;font-weight:bold;cursor:pointer;border:solid 1px #89C6FF; border-radius:4px;}
.left_title .blue{background:#3385FF;color:#fff;}
.left_title .blue:hover{background:#186CE7;}
/*border-radius:3px;vertical-align:middle;display:inline-block;width:50px;font-size:14px;font-weight:bold;
						line-height:36px;text-align:center;height:36px;background:#f4f4f4;color:#666;border:solid 1px #89C6FF;*/

.advanced-search{display:inline-block;height:30px;line-height:30px;vertical-align:middle;font-weight:bold;cursor:pointer;border:solid 1px #89C6FF;padding:0 26px 0 6px;color:#fff;background-color:#3385FF;background-image: url(../../../../img/drop_down_list2.png);
background-repeat: no-repeat;background-position: right;border-radius:4px;}
#advanced-search-layer{display:none;position:absolute;width:320px;max-height:400px;border:solid 1px #ccc;z-index:2;background:#fff;}
#advanced-search-layer .btn-close{display:inline-block;padding:2px 4px;font-size:16px;border:solid 0px #ccc;position:absolute;top:4px;right:4px;color:#333;}
#advanced-search-layer .btn-close:hover{color:#FF3300;}
#advanced-search-layer li{margin:4px 4px;list-style-type:none;}
#advanced-search-layer li input{display:inline-block;vertical-align:middle;}
#advanced-search-layer li label{display:inline-block;margin:6px 0 4px 0;color:#3385FF;vertical-align:middle;}
#advanced-search-layer li.btns{text-align:right;padding:4px 32px;}
#advanced-search-layer input{border:solid 1px #ccc;}
						
</style>
</head>

<body ng-controller="realPositionCtrl">
	
	<div class="list">
		<div class="list_left">
			<div class="left_title">
				<div>
					<input type="text" id="category" name="categoryName" viewstate="categoryName" class="txt dropDownList" style="width:180px;" placeholder="请选择项目分类"/>
					<input type="hidden" name="categoryCode" viewstate="categoryCode"/>
					
					<input type="text" id="proName" name="proName" viewstate="proName" class="txt dropDownList" style="width:150px;" placeholder="请选择项目"/>
					<input type="hidden" name="proNo" viewstate="proNo"/>
					
					<input type="text" id="mct" name="mctName" viewstate="mctName" class="txt dropDownList" style="width:180px;" placeholder="请选择总控表"/>
					<input type="hidden" name="mctCode" viewstate="mctCode"/>
					<input type="text" name="searchName" viewstate="searchName" style="width:150px;" class="txt" placeholder="关键字搜索"/>
					
					<a href="javascript:" class="advanced-search"> 高级搜索 </a>
					<div id="advanced-search-layer">
						<ul>
							<li><label>采集时间</label></li>
							<li>
								<input type="text" name="startTime" viewstate="startTime" class="txt dateComponent" onclick='new Calendar().show(this)' style="width:110px;" placeholder="采集时间起"/>
								<input type="text" name="endTime" viewstate="endTime" class="txt dateComponent" onclick='new Calendar().show(this)' style="width:110px;" placeholder="采集时间止"/>
							</li>
							<li><label>质量审核情况</label></li>
							<li>
	<!-- 							<input type="text" name="QUALITY_AUDIT_NAME" viewstate="QUALITY_AUDIT_NAME" class="dropDownList" style="width:220px;" placeholder="质量审核"/> -->
	<!-- 							<input type="hidden" name="QUALITY_AUDIT" viewstate="QUALITY_AUDIT"/> -->
								<label style="color:#666;"><input type="radio" name="QUALITY_AUDIT" viewstate="QUALITY_AUDIT" value="" checked="checked"/>全部</label>
								<label style="color:#666;"><input type="radio" name="QUALITY_AUDIT" viewstate="QUALITY_AUDIT" value="1"/>合格</label>
								<label style="color:#666;"><input type="radio" name="QUALITY_AUDIT" viewstate="QUALITY_AUDIT" value="2"/>不合格</label>
							</li>
							<li><label>是否有照片</label></li>
							<li>
								<label style="color:#666;"><input type="radio" name="hasPic" viewstate="hasPic" value="" checked="checked"/>全部</label>
								<label style="color:#666;"><input type="radio" name="hasPic" viewstate="hasPic" value="0"/>无照片</label>
								<label style="color:#666;"><input type="radio" name="hasPic" viewstate="hasPic" value="1"/>有照片</label>
							</li>
							<li><label>是否有坐标</label></li>
							<li>
								<label style="color:#666;"><input type="radio" name="hasPosition" viewstate="hasPosition" value="" checked="checked"/>全部</label>
								<label style="color:#666;"><input type="radio" name="hasPosition" viewstate="hasPosition" value="0"/>无坐标</label>
								<label style="color:#666;"><input type="radio" name="hasPosition" viewstate="hasPosition" value="1"/>有坐标</label>
							</li>
							<li class="btns">
								<div class="btn" ng-click="reset_handler()">重置</div>&nbsp;&nbsp;
								<div class="btn blue" ng-click="ok_handler()">确定</div>
							</li>
						</ul>
						<a href="javascript:" class="btn-close">×</a>
					</div>
					
					<div class="btn blue" ng-click="doQuery()">
						查询
					</div>
				</div>
			</div>
			<div class="left_content">
				
				<div class="content_table" style="overflow:auto;">
					<table width="100%" border="0" cellspacing="0" cellpadding="0" class="table">
					  <tr class="tr2" ng-repeat="item in dataList" >
						<td>
							<table width="100%" class="table_item">
								<tr>
									<td width="40" align="center">
										<span class="marker mkr{{$index+1}}"></span>
									</td>
									<td>
										<div class="title">{{item.deviceObjName}}</div>
<!-- 										<div>设备编号：{{item.deviceObjCode}}</div> -->
										<div ng-if="featureField && featureField.ename">{{featureField.cname}}：{{item[featureField.ename]}}</div>
										<div>{{item.addressDesc}}</div>
									</td>
									<td align="right" style="padding-right:10px;">
										<div ng-if="!item.editMode && item.x && item.x!=0">
											<a href="javascript:" style="color:#0066ff;{{item.deviceObjCode==selectedItem.deviceObjCode?'color:#ff6600;':''}}" ng-click="locationTo(item)" >定位</a>&nbsp;
											<a href="javascript:" style="color:#0066ff;" ng-click="setLocation(item)" >编辑</a>
										</div>
										<div ng-if="!item.editMode && !item.x"><a href="javascript:" style="color:#0066ff;" ng-click="setLocation(item)" >标点</a></div>
										<div ng-if="item.editMode && !item.x">
											<a href="javascript:" style="color:#0066ff;" ng-click="cancelLocation(item)" >取消</a>
										</div>
										<div ng-if="item.editMode && item.x">
											<a href="javascript:" style="color:#ff6600;font-weight:bold;" ng-click="saveLocation(item)" >保存</a>&nbsp;
											<a href="javascript:" style="color:#0066ff;" ng-click="cancelLocation(item)" >取消</a>
										</div>
									</td>
								</tr>
							</table>
						</td>
					  </tr>
					  <tr ng-if="!dataList || dataList.length==0">
					  	<td>
					  		<div style="line-height:35px;padding:4px;"><span style="color:#ff6600;">请依次选择条件进行查询（项目、总控表）</span></div>
					  	</td>
					  </tr>
					 </table>
				</div>

				<div id="page_bar" class="paging_div">
				</div>
			</div>
		</div>
		<div class="map_div" id="allmap">
		</div>
	</div>
<script type="text/javascript">
	// 百度地图API功能
	var map = new BMap.Map("allmap",{enableMapClick:false});    // 创建Map实例
	map.addControl(new BMap.MapTypeControl());   //添加地图类型控件
	map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
	var markergg = null;
    
	
    var userData, ticket;
    $(document).ready(function(){
    	var userDataStr = $.cookie("pmsWeb_user_data");
		if(!userDataStr){
			
			noLogin(location.href);
			return;
		}
		userData = jQuery.parseJSON(userDataStr);
		ticket = $.cookie("pmsWeb_ticket");
		
		map.centerAndZoom(new BMap.Point(userData.x, userData.y), 12);  // 初始化地图,设置中心点坐标和地图级别
    });
    $(document).ready(function(){
		var h = $(document).height();
		$(".content_table").css("max-height", h-230);
		$(window).resize(function(){
			var h = $(document).height();
			$(".content_table").css("max-height", h-230);
		});
	});

    function setViewPort(points){
		var minLng=999,minLat=999,maxLng=0,maxLat=0;
		for (var i = 0; i < points.length; i++) {
			var p = points[i];
			var lng = p.lng;
			var lat = p.lat;
			if(lng<minLng){
				minLng=lng;
			}
			if(lat<minLat){
				minLat=lat;
			}
			if(lng>maxLng){
				maxLng=lng;
			}
			if(lat>maxLat){
				maxLat=lat;
			}
		}
		var pts = [new BMap.Point(minLng,minLat),new BMap.Point(maxLng,minLat),new BMap.Point(maxLng,maxLat),new BMap.Point(minLng,maxLat)];
		map.setViewport(pts);
	}
    
    /* 自定义图标 */
	function CustomMarker(point, markerIdx){
    	this._div;
    	this.dataInfo;
		this._point = point;
    	this.markerIndex=1;
    	this.clickListener;
		if(markerIdx)
			this.markerIndex=markerIdx;
	};
    CustomMarker.prototype = new BMap.Overlay();
    CustomMarker.prototype.initialize = function(map){
        this._map = map;
        var _self = this;
        var div = this._div = document.createElement("div");
        div.style.position = "absolute";
        div.style.zIndex = BMap.Overlay.getZIndex(this._point.lat);
//         div.style.borderStyle="solid";
//         div.style.borderWidth=1;
//         div.style.backgroundColor="#fff";
        
        var span = this._span = document.createElement("span");
        span.className="marker mkr_s"+this.markerIndex;
        div.appendChild(span);
        //span.appendChild(document.createTextNode(this._text));      
        var that = this;

        div.onmouseover = function(){
//         	e = e || window.event;
//         	if (window.event) {
//         	e.cancelBubble = true;
//         	} else {
//         	e.stopPropagation();
//         	}
        };

        div.onmouseout = function(){
        };
		span.onclick=function() {
			
			if (_self.clickListener) {
				
				_self.clickListener(_self._point,_self.dataInfo);
			}
		};
        map.getPanes().labelPane.appendChild(div);
        return div;
      };
    CustomMarker.prototype.addClickListener=function(fn){
    	this.clickListener=fn;
    };  
    CustomMarker.prototype.draw = function(){
      var map = this._map;
      var pixel = map.pointToOverlayPixel(this._point);
      this._div.style.left = pixel.x - 12 + "px";
      this._div.style.top  = pixel.y - 25 + "px";
    }
   
    var drawingManager = new BMapLib.DrawingManager(map, {
        isOpen: false, //是否开启绘制模式
        enableDrawingTool: true, //是否显示工具栏
        drawingToolOptions: {
            anchor: BMAP_ANCHOR_TOP_LEFT, //位置
            offset: new BMap.Size(5, 5), //偏离值
           drawingModes: [BMAP_DRAWING_MARKER]
        }
    });
    // ================================================================================== //
    
var cond_categoryCode="", cond_proNo="",cond_searchName="";
var cond_mct="", cond_condStr="";

// var ngScope;
simpleController({
	moduleName:"realPosition",
	controllerName:"realPositionCtrl",
	init:function($scope, $http){

		$scope.theadData=[];
		$scope.dataList=[];
		$scope.featureField={};
		var viewState = new ViewState();
		
		var getAbsPoint = function (e){
			var x = e.offsetLeft;
			var y = e.offsetTop;
			while(e = e.offsetParent){
				if($(e).css("position") == "absolute" || $(e).css("position") == "relative"){
					return {"x": x, "y": y};
				}else{
					x += e.offsetLeft;
					y += e.offsetTop;
				}
			}
			return {"x": x, "y": y};
		};
		
		$(".advanced-search").each(function(){
			var h = $(this).outerHeight();
			var offset = getAbsPoint($(this)[0]);
			$(this).next().offset({"left":offset.x, "top":offset.y+h});
			var $host =$(this); 
			$(this).next().find(".btn-close").click(function(){
				$host.next().hide();
				$host.attr("layer-open", "0");
			});
			$(this).click(function(){
				var layerOpen = $(this).attr("layer-open");
				if(layerOpen=="1"){
					$(this).next().hide();
					$(this).attr("layer-open", "0");
				}else{
					$(this).next().show();
					$(this).attr("layer-open", "1");
				}
			});
		});
		$scope.reset_handler=function(){
			$("input[name=startTime]").val("");
			$("input[name=endTime]").val("");
			$("input[name=QUALITY_AUDIT_NAME]").val("");
			$("input[name=QUALITY_AUDIT]").val("");
		};
		$scope.ok_handler=function(){
			$(".advanced-search:eq(0)").click();
			$scope.doQuery();
		};

		/* 项目分类 */
		new DropDownList().init({
			mode:"page",
			renderTo:"#category",
			url:"../../../component/projectType.html?ticket="+$scope.ticket,
			height:"200px",
			onSelected:function(result){
				$scope.cond_category=result.categoryCode;
				$("#category").val(result.categoryName);
				$("input[name=categoryCode]").val(result.categoryCode);
				$scope.cond_categoryName=result.categoryName;
				proNameList.setConfig("url", "../../../component/projectList.html?categoryCode="+result.categoryCode+"&ticket="+$scope.ticket);
			}
		});
		/* 项目列表 */
		var proNameList = new DropDownList();
		proNameList.init({
			mode:"page",
			renderTo:"#proName",
			url:"../../../component/projectList.html?categoryCode="+viewState.get("categoryCode")+"&ticket="+$scope.ticket,
			height:"200px",
			onSelected:function(result){
				$scope.cond_proNo=result.proNo;
				$("#proName").val(result.proName);
				$("input[name=proNo]").val(result.proNo);
				$scope.cond_proName=result.proName;
				mctList.setConfig("url", "../../../component/mctType.html?proNo="+$scope.cond_proNo);
			}
		});
		
		/* 项目总控表*/
		var mctList = new DropDownList();
		mctList.init({
			renderTo:"#mct",
			url:"../../../component/mctType.html?proNo="+viewState.get("proNo"),
			onSelected:function(item){
				$scope.cond_mct=item.mctCode;
				$("#mct").val(item.mctName);
				$("input[name=mctCode]").val(item.mctCode);
				$scope.cond_mctName=item.mctName;
				//if($scope.cond_mct!=null && $scope.cond_mct.length>0){
					$scope.loadTheader($scope.cond_mct);
					$scope.doQuery();
				//}else{
				//	callNgFn({ctrlEl:$("body")[0], ngFn:function(scope){
				//		scope.theadData.searchFields = [];
				//	}});
				//}
			}
		});
		
		
		/* 质量审核 */
		new DropDownList().init({
			renderTo:"input[name=QUALITY_AUDIT_NAME]",
			data:[{code:"", name:"(全部)"}, {code:1, name:"合格"}, {code:2, name:"不合格"}],
			textField:"name",
			onSelected:function(item){
				if(item.code==""){
					$("input[name=QUALITY_AUDIT_NAME]").val("");
					$("input[name=QUALITY_AUDIT]").val("");
					return;
				}
				$("input[name=QUALITY_AUDIT_NAME]").val(item.name);
				$("input[name=QUALITY_AUDIT]").val(item.code);
			}
		});
		/* 加载属性信息 */
		$scope.loadAttrs=function(paramsData){
			$scope.httpGet({
				url:"eap/pmsServices/om/deviceMgr/device/mctAttr?companyCode="+$scope.userData.companyCode,
				data:paramsData,
				success:function(response){
					var i=0;
					for(; i<response.list.length; i++){
						var attr = response.list[i];
						if(attr.isFeature=="1"){
							$scope.featureField = attr;
							return;
						}
					};
				}
			});
		};
		/* 加载条件和表头信息 */
		$scope.loadTheader=function(mctCode){
			var paramsData={};
			if(mctCode){
				paramsData["mctCode"]=mctCode;
			}else{
				return;
				//paramsData["deviceTypeCode"]="01";
			}
			$scope.loadAttrs(paramsData);
			$scope.httpGet({
				url:"eap/pmsServices/om/deviceMgr/device/mctListAttr?companyCode="+$scope.userData.companyCode,
				data:paramsData,
				success:function(response){
					$scope.theadData = response.data;
					/* 初始化搜索条件 */
					lazyCall('t1',function(){
						if($scope.theadData && $scope.theadData.searchFields){
							for(var i=0; i<$scope.theadData.searchFields.length; i++){
								(function(){
									var searchField = $scope.theadData.searchFields[i];
									if(searchField.dtype==4){
										/* 搜索条件*/ 
										searchField.enumValue.unshift("(清空)");
										new DropDownList().init({
											renderTo:"#"+searchField.ename,
											data:searchField.enumValue,
											onSelected:function(result){
												if(result=="(清空)"){
													$("#"+searchField.ename).val("");
												}else{
													$("#"+searchField.ename).val(result);
												}
											}
										});
									}
								})();
							}
						}
					}, 100);
				}
			});
		};
		
		/* 数据加载 */
		$scope.loadData=function(mctCode, condStr, searchName, startTime, endTime, qualityAudit, hasPic, hasPosition){
			var paramsData={"companyCode":$scope.userData.companyCode, 
					"proNo":$scope.cond_proNo,
					"attrJson":condStr, "searchName":searchName, "startTime":startTime, "endTime":endTime, 
					"QUALITY_AUDIT":qualityAudit, "hasPic":hasPic, "hasPosition":hasPosition};
			if(mctCode){
				paramsData["mctCode"]=mctCode;
			}else{
				$scope.dataList = [];
				return;
				//paramsData["deviceTypeCode"]="01";
			}
			$scope.httpExecute({
				method:"post",
				url:"eap/pmsServices/om/deviceMgr/device/mctDeviceList",
				data:paramsData,
				success:function(response){
					if(response.statusCode==200){
						$scope.dataList = response.list;
						$scope.showAll($scope.dataList);
					}else{
						$scope.dataList = [];
					}
				},
				showPageInfo:true,
				btnCount:2,
				pageChange:function(pageNum){
					$scope.doQuery();
				}
			});
		};
		/* 查询 */
		$scope.doQuery=function(mode){
			var cond={};
			$("input[group=cond]").each(function(){
				var $cond = $(this);
				var key = $cond.attr("id");
				var val = $cond.val();
				cond[key]=val;
			});
			$scope.cond_condStr=JSON.stringify(cond);
			$scope.cond_searchName=$("input[name=searchName]").val();
			if($scope.theadData && $scope.theadData.searchFields){
				var vars="";
				for(var i=0; i<$scope.theadData.searchFields.length; i++){
					var searchField = $scope.theadData.searchFields[i];
					if(searchField.dtype==1){
						if(vars && vars.length>0){
							vars+=",";
						}
						vars+=searchField.ename;
					}
				}
				$scope.cond_searchName=vars+";"+$scope.cond_searchName;
			}else{
				$scope.cond_searchName=";"+$scope.cond_searchName;
			}
			
			
			viewState.collect();
			if(viewState.get("mctCode") && viewState.get("mctCode").length>0){
				if(mode && mode=="export"){
					$scope.exportData(viewState.get("mctCode"), $scope.cond_condStr, $scope.cond_searchName, viewState.get("startTime"), viewState.get("endTime"), 
							viewState.get("QUALITY_AUDIT"),viewState.get("hasPic"), viewState.get("hasPosition"));
				}else{
					$scope.loadData(viewState.get("mctCode"), $scope.cond_condStr, $scope.cond_searchName, viewState.get("startTime"), viewState.get("endTime"), 
							viewState.get("QUALITY_AUDIT"),viewState.get("hasPic"), viewState.get("hasPosition"));
				}
			}
		};

		window.onkeyup=function(e){
			if(e.keyCode==13){
				$scope.toQuery();
			}
		};
		$scope.strCut=function(str, len){
			if(str.length>len){
				str = str.substring(0, len);
				str+="...";
			}
			return str;
		};
		$scope.selectedObj=function(item){
			if(item.x && item.y){
				map.setCenter(new BMap.Point(item.x, item.y));  // 初始化地图,设置中心点坐标和地图级别
				if(markergg != null){
					map.removeOverlay(markergg);
				}
				markergg = new BMap.Marker(new BMap.Point(item.x, item.y));
			    map.addOverlay(markergg);
			}
		};
		$scope.showAll=function(itemList){
			map.clearOverlays();
			var pts=[];
			for(var i=0;i<itemList.length;i++){
				var item=itemList[i];
				if(item.x && item.y){
					(function(){
						//map.setCenter(new BMap.Point(item.x, item.y));  // 初始化地图,设置中心点坐标和地图级别
						var p=new BMap.Point(item.x, item.y);
						pts.push(p);
						markergg = new CustomMarker(p, pts.length);
						markergg.dataInfo=item;
						//markergg = new BMap.Marker(p);
					    // infoWindow
					    var infoWinContent = "<div class=\"info_win\">"
							+"	<table width=\"100%\">"
							+"		<tr>"
							+"			<td align=\"center\" width=\"100\">"
							+"				<img id=\"infoimg_"+item.deviceObjCode+"\" src=\"../../../../img/img_danaut.png\" style='width:100px;height:80px'/>"
							+"			</td>"
							+"			<td>"
							+"				<div class=\"tiBar\">"
							+"					<label class=\"title\">"+item.deviceObjName+"</label>"
							+"					<span class=\"dev_status\">"+item.healthName+"</span>"
							+"				</div>"
							+"				<div>"
// 							+"					设备编号："+item.deviceObjCode
							+($scope.featureField && $scope.featureField.ename?"					"+$scope.featureField.cname+"："+item[$scope.featureField.ename]:"")
							+"				</div>"
							+"				<div>"
							+"					"+(item.addressDesc?item.addressDesc:'')
							+"				</div>"
							+"			</td>"
							+"		</tr>"
							+"	</table>"
							+"	<div class=\"foBar\">"
							+"		<a href=\"javascript:openDetail('"+item.deviceObjCode+"')\">台帐&gt;&gt;</a>"
							+"	</div>"
							+"</div>";
						var infoWindow = new BMap.InfoWindow(infoWinContent);  // 创建信息窗口对象
						markergg.addClickListener(function(point,dataInfo){  
							
							var mctCode=dataInfo.mctCode;
							var companyCode=dataInfo.companyCode;
							var proNo=dataInfo.proNo;
							var deviceObjCode=dataInfo.deviceObjCode;
							
							//mctCode,companyCode,proNo,deviceObjCode
							 var imgUrl="";
							$http.get(serviceBasePath+"eap/pmsServices/om/deviceMgr/images/getList?mctCode="
								+mctCode+"&deviceObjCode="+deviceObjCode+"&proNo="+proNo+"&companyCode="+companyCode).success(function(response){
								if(response.statusCode==401){
									alert("用户凭据过期！请重新登录！");
									window.top.location.href="../../../login.html";
									return;
								}
								
								for(var i=0;i<response.list.length;i++){
									var st=filePath+"?fileCode="+response.list[i].picVisitid+"&attachment=0"
											
								    response.list[i].url=st;			
								} 
								
								if(response.list.length>0){
									imgUrl = response.list[0].url;
									//alert(imgUrl)
									$("#infoimg_"+deviceObjCode).attr("src",imgUrl);
									
								}
								
							}); 
							
							
								map.openInfoWindow(infoWindow, point);
								//this.openInfoWindow(infoWindow);
							   //图片加载完毕重绘infowindow
							   //document.getElementById('infoImg').onload = function (){
								//   infoWindow.redraw();   //防止在网速较慢，图片未加载时，生成的信息框高度比图片的总高度小，导致图片部分被隐藏
							   //}
							});
						/*markergg.addEventListener("click",function(){   
							   this.openInfoWindow(infoWindow);
							   //图片加载完毕重绘infowindow
							   document.getElementById('infoImg').onload = function (){
								   infoWindow.redraw();   //防止在网速较慢，图片未加载时，生成的信息框高度比图片的总高度小，导致图片部分被隐藏
							   }
							});*/
					    map.addOverlay(markergg);
					    //
					    var opts = {position : p,
					    		  offset   : new BMap.Size(10, -28)
					    		};
					    var featureFieldVal="";
					    if($scope.featureField && $scope.featureField.ename){
					    	featureFieldVal = item[$scope.featureField.ename];
					    }
			    		var label = new BMap.Label(item.deviceObjName+" "+featureFieldVal, opts);  // 创建文本标注对象
			    			label.setStyle({
			    				 color : "#000",
			    				 fontSize : "12px",
			    				 height : "24px",
			    				 lineHeight : "24px",
								 backgroundColor:"#f4f4f4",
								 borderRadius:"5px",
								 boxShadow:"2px 3px 5px #666",
								 borderColor:"#0066cc",
			    				 fontFamily:"微软雅黑"
			    			 });
			    		map.addOverlay(label); 
					})();
				}
			}
			if(pts.length>0){
				setViewPort(pts);
			}
		};
		$scope.locationTo=function(item){
			if($scope.selectedItem){
				if($scope.selectedItem.editMode && !$scope.selectedItem.x){
					$scope.selectedItem.editMode=false;
				}else if($scope.selectedItem.editMode && $scope.selectedItem.x){
					new ShowDlog().confirm({
						msg:"请先保存当前已标注的位置！",
						ok:function(){
							// save
							$scope.saveLocation();
							callNgFn({ctrlEl:$("body")[0], ngFn:function(){
								$scope.selectedItem.editMode=false;
								$scope.selectedItem=item;
								drawPoint(item.x, item.y, "readonly");
							}});
						},
						cancel:function(){
							callNgFn({ctrlEl:$("body")[0], ngFn:function(){
								$scope.selectedItem.editMode=false;
								$scope.selectedItem=item;
								drawPoint(item.x, item.y, "readonly");
							}});
						}
					});
					return;
				}
			}
			$scope.selectedItem=item;
			if(item.x && item.y){
				drawPoint(item.x, item.y, "readonly");
			}else{
				map.clearOverlays();
			}
		};
		$scope.cancelLocation=function(item){
			$scope.selectedItem.editMode=false;
			$scope.selectedItem.x=$scope.cache_x;
			$scope.selectedItem.y=$scope.cache_y;
			$scope.selectedItem.rx=$scope.cache_rx;
			$scope.selectedItem.ry=$scope.cache_ry;
			drawingManager.close();
			$scope.locationTo($scope.selectedItem);
		};
		$scope.selectedItem;
		$scope.setLocation=function(item){
			if($scope.selectedItem){
				if($scope.selectedItem.editMode && !$scope.selectedItem.x){
					$scope.selectedItem.editMode=false;
				}else if($scope.selectedItem.editMode && $scope.selectedItem.x){
					new ShowDlog().confirm({
						msg:"请先保存当前已标注的位置！",
						ok:function(){
							// save
							$scope.saveLocation();
							callNgFn({ctrlEl:$("body")[0], ngFn:function(){
								$scope.selectedItem.editMode=false;
								$scope.setEditMode(item);
							}});
						},
						cancel:function(){
							callNgFn({ctrlEl:$("body")[0], ngFn:function(){
								$scope.cancelLocation();
								$scope.setEditMode(item);
							}});
						}
					});
					return;
				}
			}
			$scope.setEditMode(item);
		};
		$scope.cache_x=null;
		$scope.cache_y=null;
		$scope.cache_rx=null;
		$scope.cache_ry=null;
		$scope.setEditMode=function(item){
			$scope.selectedItem=item;
			item.editMode=true;
			$scope.cache_x=item.x;
			$scope.cache_y=item.y;
			$scope.cache_rx=item.rx;
			$scope.cache_ry=item.ry;
			if(item.x && item.y){
				drawPoint(item.x, item.y);
			}else{
				map.clearOverlays();
				drawingManager.close();
				$("a[drawingtype=marker]").parent().click();
		        drawingManager.setDrawingMode("marker");
			}
		};
		$scope.saveLocation=function(item){
			$scope.selectedItem.editMode=false;
			//save
			this.httpPost({
				url:"eap/pmsServices/om/deviceMgr/device/updateDeviceLoc",
				data:$scope.selectedItem,
				success:function(response){
					new ShowDlog().prompt({
						icon:"success",
						msg:"保存成功！",
						done:function(){
						},
						t:1500
					});
					
				}
			});
		}
		
		
		function drawPointHandler(event) {
			var p = event.overlay;
			if (p) {
				var lnglat = p.getPosition();
				map.clearOverlays();
				drawPoint(lnglat.lng, lnglat.lat);
				callNgFn({ctrlEl:$("body")[0],ngFn:function(scope){
					scope.selectedItem.x=lnglat.lng;
					scope.selectedItem.y=lnglat.lat;
				}});
				//
				$.ajax({
					url:serviceBasePath+"eap/pmsServices/om/deviceMgr/device/coordsBD09ToWGS84?x="+lnglat.lng+"&y="+lnglat.lat,
					data:{},
					success:function(response){
						if(response.statusCode==200){
							var rx = response.data.x;
							var ry = response.data.y;
							callNgFn({ctrlEl:$("body")[0],ngFn:function(scope){
								$scope.selectedItem.rx=decim(rx, 6);
								$scope.selectedItem.ry=decim(ry, 6);
							}});
							
						}else{
							new ShowDlog().prompt({
								msg:"获取失败！",
								done:function(){
									
								},
								t:1500
							});
						}
					}
				});
			}
			drawingManager.close();
		}
		
		function drawPoint(x, y, mode) {
			var point = new BMap.Point(Number(x), Number(y));
			map.centerAndZoom(point, 20);
			map.setCenter(x, y);
			map.clearOverlays();
			
			var marker = new BMap.Marker(point);  // 创建标注
			map.addOverlay(marker);              // 将标注添加到地图中
			var deviceObjName = $scope.selectedItem.deviceObjName;
			var address="";
			if($scope.selectedItem.AMUL_BOX_ADDR){
				address = $scope.selectedItem.AMUL_BOX_ADDR;
			}
			var infoWindow = new BMap.InfoWindow("<div style='font-weight:bold;font-size:16px;'>"+deviceObjName+"</div><div style='color:#555;'>"+address+"</div>", {offset:new BMap.Size(0, -20)});
			map.openInfoWindow(infoWindow, point);
			if(mode!="readonly"){
				marker.enableDragging();
			}
			marker.addEventListener("dragend",function(e){
				returnx=e.point.lng;
				returny=e.point.lat;
				callNgFn({ctrlEl:$("body")[0],ngFn:function(scope){
					$scope.selectedItem.x=e.point.lng;
					$scope.selectedItem.y=e.point.lat;
				}});
				//
				$.ajax({
					url:serviceBasePath+"eap/pmsServices/om/deviceMgr/device/coordsBD09ToWGS84?x="+e.point.lng+"&y="+e.point.lat,
					data:{},
					success:function(response){
						if(response.statusCode==200){
							var rx = response.data.x;
							var ry = response.data.y;
							drawPoint(e.point.lng, e.point.lat);
							callNgFn({ctrlEl:$("body")[0],ngFn:function(scope){
								$scope.selectedItem.rx=decim(rx, 6);
								$scope.selectedItem.ry=decim(ry, 6);
							}});
							
						}else{
							new ShowDlog().prompt({
								msg:"获取失败！",
								done:function(){
									
								},
								t:1500
							});
						}
					}
				});
				
			});
			returnx=Number(x);
			returny=Number(y);
		}

	    drawingManager.addEventListener('overlaycomplete', drawPointHandler);
	}
});
</script>
</body>
</html>
