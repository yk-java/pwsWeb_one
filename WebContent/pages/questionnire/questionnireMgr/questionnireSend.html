<!DOCTYPE html>
<html ng-app="moduleName">
<head>
<meta charset="UTF-8">
<title> 问卷下发 </title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<script type="text/javascript" src="../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script></head>
<script type="text/javascript" src="../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../js/PageBar.js"></script>
<script type="text/javascript" src="../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../../js/DropDownList-1.2/DropDownList.css"/>
<script type="text/javascript" src="../../../js/Calendar.js"></script>
<script type="text/javascript" src="../../../js/config.js"></script>
<script type="text/javascript" src="../../../js/ViewState.js"></script>
<script type="text/javascript" src="../../../js/util.js"></script>
<script type="text/javascript" src="../../../js/ng-base.js"></script>

<script type="text/javascript" src="../../../js/eapJs/core/eap.core.js" ></script>
<script type="text/javascript" src="../../../js/eapJs/plugins/eap.tip.js" ></script>
<script type="text/javascript" src="../../../js/eapJs/plugins/eap.validate.js"></script>
<script type="text/javascript" src="../../../js/eapJs/local/eap.lang-zh_CN.js"></script>
<link rel="stylesheet" type="text/css" href="../../../css/common.css"/>
<link rel="stylesheet" type="text/css" href="../../../css/validate.css"/>
<link rel="stylesheet" type="text/css" href="../../../css/edit.css"/>

<link rel="stylesheet" type="text/css" href="../../../js/showDlog/showDlog-blue.css" />
<script type="text/javascript" src="../../../js/showDlog/showDlog.js"></script>

<link rel="stylesheet" href="../../../css/zTreeStyle/zTreeStyle.css" type="text/css">
<script type="text/javascript" src="../../../js/ztree/js/jquery.ztree.core-3.5.js"></script>
<script type="text/javascript" src="../../../js/ztree/js/jquery.ztree.excheck-3.5.js"></script>

<style type="text/css">
ul,li{margin:0;padding:0;list-style-type:none;}
.dialog-images{width:1000px;height:600px;}
.dialog-update{width:800px;height:400px;}
.dialog-coodimap{width:800px;height:330px;}
.dialog-coodimap2{width:600px;height:350px;}
.dialog_scheme_check{width:800px;height:620px;}

.title_save{display:inline-block;width:70px;height:28px;background: url(../../../img/btn_save.png) no-repeat 0 0;line-height:28px;text-align:center;margin-left:10px;margin-top:5px;color:#fff;cursor: pointer;}
.title_save:hover{background: url(../../../img/btn_save.png) no-repeat 0 -29px;}
.title_cancel{display:inline-block;width:70px;height:28px;background: url(../../../img/btn_cancel.png) no-repeat 0 0;line-height:28px;text-align:center;margin-left:10px;margin-top:5px;color:#666;cursor: pointer;}
.title_cancel:hover{background: url(../../../img/btn_cancel.png) no-repeat 0 -29px;}

.form_div .l_part{float:left;width:65%;border:solid 0px;}
.form_div .l_part ul li{margin:4px 0;}
.form_div .l_part ul li input{width:100%;}
.form_div .l_part ul li textarea{width:99%;height:310px;}
.form_div .r_part{float:right;width:33%;height:400px;border:solid 1px #89C6FF;border-radius:5px;}
.form_div .r_part .search{float:left;width:100%;height:45px;border-bottom:solid 1px #89C6FF;background:#4CA9FF;}
.form_div .r_part .search .con{float:left;width:100%;margin:5px;}
.form_div .r_part .search .con .search_txt{float:left;width:100px;border-top-right-radius:0;border-bottom-right-radius:0;}
.form_div .r_part .search .con .search_btn{float:left;display:inline-block;height:36px;line-height:36px;margin-right:10px;padding:0 10px;vertical-align:middle;background:rgba(0,0,0,0.15);border-top-right-radius:5px;border-bottom-right-radius:5px;}
.form_div .r_part .search .con .search_btn img{margin-top:8px;}
.form_div .r_part .search .con .sw_btn{display:inline-block;width:40px;margin:4px 1px;line-height:28px;background:rgba(0,0,0,0.15);border-radius:6px;text-align:center;vertical-align:middle;color:#fff;}
.form_div .r_part .search .con a:hover{background:rgba(0,0,0,0.2);}
.form_div .r_part #tree{height:340px;overflow-y:auto;}
</style>

</head>
<body ng-controller="controllerName" storagekey="questionnire.questionnireMgr.questionnireSend">
<div class="list">
	<div class="list_content">
		<div class="title_div">
			<div class="title_left">
				<label class="title">问卷下发</label>
			</div>
			<img src="../../../img/list_Header2-.png">
			&nbsp;&nbsp;
			
		</div>
		
		<form id="saveForm" class="required-validate">
		<div class="form_div" id="lay1">
			<div class="l_part">
				<ul>
					<li>
						<input type="text" ng-model="employeenames" name="employees" class="required txt readonly" readonly="readonly" placeholder="选择人员"/>
					</li>
					<li>
						<input type="text" ng-model="questionnireSend.title" name="title" class="required txt" placeholder="请输入消息标题"/>
					</li>
					<li>
						<textarea ng-model="questionnireSend.message" name="message" class="required txt" placeholder="请输入消息内容"></textarea>
					</li>
					<li>
						<a href="javascript:" ng-click="onSave()" class="title_save">
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;发送
						</a>
						<a href="javascript:" ng-click="onCancel()" class="title_cancel">
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;取消
						</a>
					</li>
				</ul>
			</div>
			<div class="r_part">
				<div class="search">
					<div class="con">
						<input type="text" class="txt search_txt" placeholder="搜索"/>
						<a href="javascript:" class="search_btn" ng-click="doSearch()">
							<img src="../../../img/search_btn.png"/>
						</a>
						<a href="javascript:" class="sw_btn selected" ng-click="loadData('BY_UNIT')">部门</a>
						<a href="javascript:" class="sw_btn" ng-click="loadData('BY_JOB')">职位</a>
						<a href="javascript:" class="sw_btn" ng-click="loadData('BY_PRO')">项目</a>
						
					</div>
				</div>
				<div id="tree" class="ztree"></div>
			</div>
		</div>
		</form>

	</div>
</div>
<script type="text/javascript">
function getFontCss(treeId, treeNode) {
	return (treeNode.highlight) ? {color:"#A60000", "font-weight":"bold"} : {color:"#333", "font-weight":"normal"};
}
simpleController({
	init:function($scope, $http){
		$scope.employeeListByPro=[];
		$scope.employeeListByUnit=[];
		$scope.questionnireSend={};

		$scope.employeeList=[];
		$scope.employeenames="";
		$scope.questionnireSend.employeecodes="";
		
		var urlParams = getUrlParams();
		$scope.questionnireSend.title=urlParams.title;
		$scope.questionnireSend.questionnireCode=urlParams.questionnireCode;
		$scope.questionnireSend.source=$scope.userData.employeeName;
		var viewState = new ViewState();
		var tree;
		var setting = {
				check:{
					enable:true
				},
				data:{
					key:{
						name:"NAME",
						title:"JOB_NO"
					},
					simpleData:{
						enable:true,
						idKey:"CODE",
						pIdKey:"PCODE",
						rootPid:0
					}
				},
				view: {
					fontCss: getFontCss
				},
				callback:{
					onCheck:function(){
						var selectedNodes = tree.getCheckedNodes(true);
						callNgFn({ctrlEl:$("body")[0], ngFn:function(scope){
							scope.empSelected(selectedNodes);
						}});
					}
				}
			};
		
		$scope.type="BY_UNIT";
		/* 初始（查询） */
		$scope.doQuery=function(){
			$scope.loadData($scope.type);
		};
		/* 加载数据 */
		$scope.loadData=function(type){
			$scope.type=type;
			viewState.collect();
			new ShowDlog().prompt({
				icon:"waitting",
				msg:"正在查询...",
				done:function(){},
				t:20*60*1000
			});
			$scope.employeeList=[];
			$scope.employeenames="";
			$scope.questionnireSend.employeecodes="";
			if(type && type=="BY_PRO"){
				$scope.httpExecute({
					url:"eap/pmsServices/pwsCommon/employeeTreeByPro",
					method:"GET",
					data:{companyCode:$scope.userData.companyCode},
					success:function(res){
						$dlog.close();
						if(res.statusCode==200){
							$scope.employeeListByPro = res.list;
							tree = $.fn.zTree.init($("#tree"), setting, $scope.employeeListByPro);
						}
					},
					error:function(){
						$dlog.close();
						new ShowDlog().prompt({
							msg:"网络异常！",
							done:function(){},
							t:1500
						});
					}
				});
			}else if(type && type=="BY_JOB"){
				$scope.httpExecute({
					url:"eap/pmsServices/pwsCommon/selectEmployeeByJob",
					method:"GET",
					data:{companyCode:$scope.userData.companyCode},
					success:function(res){
						$dlog.close();
						if(res.statusCode==200){
							tree = $.fn.zTree.init($("#tree"), setting, res.list);
						}
					},
					error:function(){
						$dlog.close();
						new ShowDlog().prompt({
							msg:"网络异常！",
							done:function(){},
							t:1500
						});
					}
				});
			}else{
				$scope.httpExecute({
					url:"eap/pmsServices/pwsCommon/employeeTreeByUnit",
					method:"GET",
					data:{companyCode:$scope.userData.companyCode},
					success:function(res){
						$dlog.close();
						if(res.statusCode==200){
							$scope.employeeListByUnit = res.list;
							tree = $.fn.zTree.init($("#tree"), setting, $scope.employeeListByUnit);
						}
					},
					error:function(){
						$dlog.close();
						new ShowDlog().prompt({
							msg:"网络异常！",
							done:function(){},
							t:1500
						});
					}
				});
			}
		};
		/* 选择联系人 */
		$scope.empSelected=function(arr){
			$scope.employeeList=[];
			$scope.employeenames="";
			$scope.questionnireSend.employeecodes="";
			for(var i=0; i<arr.length; i++){
				var node = arr[i];
				if(node.ITEM_TYPE=="EMP"){
					$scope.employeeList.push(node);
					if($scope.employeenames!=""){
						$scope.employeenames+=";";
					}
					if($scope.questionnireSend.employeecodes!=""){
						$scope.questionnireSend.employeecodes+=",";
					}
					$scope.employeenames+=node.NAME;
					var CODE = node.CODE.replace(/EMP_/g,"");
					$scope.questionnireSend.employeecodes+=CODE;
				}
			}
			if($scope.employeeList.length>0){
				$scope.employeenames="（共"+$scope.employeeList.length+"人）"+$scope.employeenames;
			}else{
				$scope.employeenames="";
			}
		};
		/* 搜索节点 */
		var searchResultNodes=[];
		$scope.searchName="";
		$scope.searchCnt=0;
		$scope.doSearch=function(){
			$scope.updateNodes(false);
			var searchName = $(".search_txt").val();
			if(searchName.length==0)
				return;
			if($scope.searchName == searchName){
				$scope.searchCnt++;
			}else{
				$scope.searchCnt=0;
				$scope.searchName = searchName;
			}
			searchResultNodes = tree.getNodesByParamFuzzy("NAME", searchName, null);
			$scope.updateNodes(true);
		};
		/* 更改节点样式 */
		$scope.updateNodes=function(highlight){
			for(var i=0; i<searchResultNodes.length; i++){
				var node=searchResultNodes[i];
				node.highlight=highlight;
				tree.updateNode(node);
			}
			if(highlight){
				if($scope.searchCnt<searchResultNodes.length){
					tree.selectNode(searchResultNodes[$scope.searchCnt]);
				}else{
					$scope.searchCnt=0;
					tree.selectNode(searchResultNodes[$scope.searchCnt]);
				}
			}
		};
		/* 搜索联系人 */
		window.onkeyup=function(e){
			if(e.keyCode==13){
				$scope.doSearch();
			}
		};
		
		/* 表单验证 */
		validator = $("#saveForm").validate({
			onsubmit: false,
			focusInvalid: false,
			focusCleanup: true,
			errorElement: "span",
			ignore:".ignore",
			invalidHandler: function(form, validator) {
				var errors = validator.numberOfInvalids();
				if (errors) {
					
				} 
			}
		});
		/* 发送 */
		$scope.onSave=function(){
			var dataStr = JSON.stringify($scope.questionnireSend);
			if($("#saveForm").valid()){
				new ShowDlog().prompt({
					icon:"waitting",
					msg:"正在发送...",
					done:function(){
					},
					t:1000*60*2
				});
				$scope.httpExecute({
					method:"post",
					url:"eap/pmsServices/questionnireSend/send",
					data:{"questionnireSend":dataStr},
					success:function(result){
						$dlog.close();
						if(result.statusCode==200){
							new ShowDlog().prompt({
								icon:"success",
								msg:"发送成功！",
								done:function(){
									parent.$dlog.data="SUCCESS";
									parent.$dlog.close();
								},
								t:1500
							});
						}
					},
					error:function(){
						$dlog.close();
						new ShowDlog().prompt({
							icon:"error",
							msg:"网络异常！",
							done:function(){},
							t:1500
						});
					}
				});
			}
		};
		/* 取消 */
		$scope.onCancel=function(){
			parent.$dlog.data="CANCEL";
			parent.$dlog.close();
		};
		
		$scope.doQuery();
	}
});
</script>
</body>
</html>