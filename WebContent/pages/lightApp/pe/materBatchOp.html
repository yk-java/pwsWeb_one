<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Document</title>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	<script src="js/jquery-1.9.1.min.js"></script>
	<link rel="stylesheet" type="text/css" href="css/bxyw.css"/>
	<script src="js/jquery.cookie.js"></script>
	<script src="js/angular.min.js"></script>
	<script src="js/util.js"></script>
	<script src="js/ng-base.js"></script>
	<script type="text/javascript" src="js/jquery.form.js"></script>
	<script type="text/javascript" src="js/showDlog/showDlog.js"></script>
	<link rel="stylesheet" type="text/css" href="js/showDlog/showDlog-blue.css" />

	<script type="text/javascript" src="js/eapJs/core/eap.core.js" ></script>
	<script type="text/javascript" src="js/eapJs/plugins/eap.tip.js" ></script>
	<script type="text/javascript" src="js/eapJs/plugins/eap.validate.js"></script>
	<script type="text/javascript" src="js/eapJs/local/eap.lang-zh_CN.js"></script>
	<link rel="stylesheet" type="text/css" href="css/validate.css"/>
</head>
<body ng-app="moduleName" ng-controller="controllerName">
	<header>
		<div class="return"><img src="images/return.png"/></div>
		批量处理{{taskCount}}个
	</header>
	<section class="tast_warp" style="bottom:0px;">
	<form id="saveForm">
		<input type="hidden" name="taskCodes" value="{{taskCodes}}"/>
			<div class="gz_con">
				<div class="sel_gz">
					<span class="frist">
						<select name="deviceFaultType" onchange="gzTypeChange()" class="required">
							<option>请选择</option>
						</select>
					</span>
					<span>
						<select name="deviceFaultDetail" class="required">
							<option>请选择</option>
						</select>
					</span>
				</div>
				<div class="gz_decon">
					<textarea placeholder="请输入故障现象" class="required" name="faultDesc"></textarea>
					<textarea placeholder="请输入现场状况" class="required" name="sceneDesc"></textarea>
					
					
					<div class="sel_gz bor_top">
						<span class="gz_rusert">
							<select name="taskResultFlag" class="required">
								<option value="">故障处理 </option>
								<option value="1">处理成功</option>
								<option value="0">处理失败</option>
							</select>
						</span>
						<p style="width: 95%;margin: 10px auto 0;">故障照片</p>
						<div class="update_ing">
							<img src="images/add_pic_icon.png" id="img1" onclick="getPicture(this, 'img1')"/>
							<input type="hidden" name="img1"/>
							<img src="images/add_pic_icon.png" id="img2" onclick="getPicture(this, 'img2')"/>
							<input type="hidden" name="img2"/>
							<img src="images/add_pic_icon.png" id="img3" onclick="getPicture(this, 'img3')"/>
							<input type="hidden" name="img3"/>
						</div>
					</div>
					<!--当选择终端更换的时候显示-->
					<!--<div class="sel_gz bor_top">
						<span class="gz_rusert zdh_inp">
							<label class="fl">终端号:</label><input class="fl" type="text" placeholder="请输入终端号" />	
						</span>
					</div>-->
				</div>
			</div>		
		<div class="up_load" ng-click="doSubmit()"><a>提交</a></div>
		</form>
	</section>
	<script>	
		$(".return").click(function(){
			top.viewBack();
		})
		function getPicture(img, inputName){
			top.nativeLib.getPicture({
				action:"takePicture",
				callback:function(data){
					img.src="data:image/jpeg;base64,"+data.base64Img;
					img.style.height=img.offsetWidth+"px";
					$("input[name="+inputName+"]").val(data.base64Img);
				}
			});
		}
		function gzTypeChange(){
			ngScope.gzTypeChange();
		}
		var ngScope;
		simpleController({
			init:function($scope, $http){
				ngScope=$scope;
				$scope.gzList=[];
				$scope.data=[];
				$scope.taskCodes="";
				$scope.taskCount=0;

				var urlParams = getUrlParams();
				$scope.taskCodes=urlParams.taskCodes;
				$scope.taskCount=urlParams.taskCount;

				/* 表单验证 */
				validator = $("#saveForm").validate({
					onsubmit: false,
					focusInvalid: false,
					focusCleanup: true,
					errorElement: "span",
					ignore:".ignore",
					invalidHandler: function(form, validator) {
						var errors = validator.numberOfInvalids();
						if (errors) {
							
						} 
					}
				});
				$scope.loadGzList=function(){
					$scope.httpGet({
						url:"eap/pmsServices/om/deviceMgr/device/mctAttr1",
						data:{"companyCode":$scope.userData.companyCode, "deviceTypeCode":"P02", "t":new Date().getTime()},
						success:function(res){
							var lst = res.list;
							for(var i=0; i<lst.length; i++){
								var attr = lst[i];
								if(attr.ename=="DBGZ"){
									var dataStr = attr.enumValue;
									dataStr = dataStr.replace(/\n/g, "");
									dataStr = dataStr.replace(/，/g, ",");
									var data;
									try{
										data=eval("["+dataStr+"]");
									}catch(e){}//alert(dataStr);alert(data);
									$scope.gzList=data[0][urlParams.faultType];
									$scope.initGzType();
								}
							}
						}
					});
				};

				$scope.initGzType=function(){
					var $gzType = $("select[name=deviceFaultType]");
					$gzType.empty();
					for(var i=0; i<$scope.gzList.length; i++){
						var item = $scope.gzList[i];
						var opt = $("<option value='"+item.label+"'>"+item.label+"</option>");
						$gzType.append(opt);
					}
				};
				
				$scope.gzTypeChange=function(){//alert();
					var $gzType = $("select[name=deviceFaultType]");
					$scope.initGzDetail($gzType.val());
				};

				$scope.initGzDetail=function(gzTypeValue){//alert(gzTypeValue);
					var $gzDetail = $("select[name=deviceFaultDetail]");
					$gzDetail.empty();
					for(var i=0; i<$scope.gzList.length; i++){
						var item = $scope.gzList[i];
						if(item.label==gzTypeValue){
							for(var j=0; j<item.children.length; j++){
								var subItem = item.children[j];
								var opt = $("<option value='"+subItem.label+"'>"+subItem.label+"</option>");
								$gzDetail.append(opt);
							}
						}
					}
				};
				var waittingDlog = new ShowDlog();
				$scope.doSubmit=function(){
					if($("#saveForm").valid()){
						var taskResultFlag = $("select[name=taskResultFlag]").val();
						var pic1 = $("input[name=img1]").val();
						var pic2 = $("input[name=img2]").val();
						var pic3 = $("input[name=img3]").val();
						if(taskResultFlag==0 && pic1.length==0 && pic2.length==0 && pic3.length==0){
							new ShowDlog().prompt({
								msg:"请上传照片！",
								done:function(){
									
								},
								t:1500
							});
							return;
						}
						
						waittingDlog.prompt({
							icon:"waitting",
							msg:"正提交请稍等",
							done:function(){
								
							},
							t:360000
						});
						var params = serializeArrayToMap($("#saveForm").serializeArray());
// 						$scope.httpPost({
// 							url:"eap/pmsServices/pm/taskMgr/task/batSaveTaskOpInfo",
// 							data:params,
// 							success:function(res){
// 								if(res.statusCode==200){
// 									new ShowDlog().prompt({
// 										icon:"success",
// 										msg:"保存成功！",
// 										done:function(){
// 											window.history.go(-1);
// 										},
// 										t:1500
// 									});
// 								}
// 							}
// 						});
						/* $("#saveForm").ajaxSubmit({
							url:sessionStorage.serviceBasePath+"eap/pmsServices/pm/taskMgr/task/batSaveTaskOpInfo",
							type: "post",
							dataType: "json",
							clearForm: false,
							success:function(res){
								waittingDlog.close();
								if(res.statusCode==200){
									new ShowDlog().prompt({
										icon:"success",
										msg:"保存成功！",
										done:function(){
											window.history.back();
										},
										t:1500
									});
								}
							},
							error: function(xhr, status, error) {
								console.log(error);
							}
						}); */
						
						var url="eap/pmsServices/pm/taskMgr/task/batSaveTaskOpInfo";
						
						$scope.onSubmitClickHandler(url,params);
						
						
					}
				};
				
				
				$scope.onSubmitClickHandler=function(url,params) {
			     	$scope.httpPost({
			     		url:url,
			     		data:params,
			     		success:function(responseData) {
			            	    waittingDlog.close();
								if(responseData.statusCode==200){
									new ShowDlog().prompt({
										icon:"success",
										msg:"保存成功！",
										done:function(){
											window.history.back();
										},
										t:1500
									});
								}
			            	 
			                 
			             }
			             
			     	});
				 };
				 
				$scope.loadGzList();
			}
		});
		
	</script>
</body>
</html>