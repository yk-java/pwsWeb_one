<!doctype html>
<html lang="en" ng-app="realPosition">
<head>
	<title>Document</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" >
	
	
	<meta charset="UTF-8" />
	
	<script src="js/jquery-1.9.1.min.js"></script>
	<script src="js/jquery.cookie.js"></script>
	<script src="js/angular.min.js"></script>
	<script src="js/util.js"></script>
	<script src="js/ng-base.js"></script>
	<script type="text/javascript" src="js/jquery.form.js"></script>

	<script type="text/javascript" src="js/showDlog/showDlog.js"></script>
	<link rel="stylesheet" type="text/css" href="js/showDlog/showDlog-blue.css" />
	<link rel="stylesheet" type="text/css" href="css/bxyw1.css"/>
	<script type="text/javascript" src="js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="js/DropDownList-1.2/DropDownList.css" />
	<link rel="stylesheet" type="text/css" href="css/edit.css"/>
	<style>
		.pic{width:84px;height:84px;}
		#showdiv{display: none}
		.isnumber{display: none}
		input{list-style: none ;outline: none;}
	</style>
</head>
<body ng-controller="realPositionCtrl">
	<form id="saveForm" class="required-validate" action="" enctype="multipart/form-data" method="post"  name="saveForm">
	<header>
		<div class="return"><img src="img/deviceAdd/return.png"/></div>
		{{deviceObjName}}
	</header>
	<section id="bxys_details">
		<div class="tast_nav">
			<ul class="ov">
				<li class="fl active">表箱信息</li>
				<li class="fl">改造材料</li>
				<li class="fl">图片资料</li>
				<li class="fl">营配信息</li>
			</ul>
		</div>
		<!--表箱信息-->
		<div class="bxys_no1">
	
			<div class="bxys_wma2 ov" >

				
				<div class="fl" style="width:100%" class="bxys_wma1">
					<span style="float:left;width:90px;margin-left:10px;">设备编号：</span>{{deviceInfo.deviceObjCode}}
				</div>
			<!-- 	<div class="fl" style="width:100%" class="bxys_wma1">
					<span style="float:left;width:90px;margin-left:10px;">健康状况：</span>{{deviceInfo.healthName}}
				</div> -->
				
				<div ng-repeat="tr in deviceAttrTrs">
					<div style="width:100%;float:left;margin:0px;"  ng-repeat="item in tr" ng-if="item.cname!=''" class="bxys_wma1">
						
							<span style="float:left;width:90px;margin-left:10px;padding-top:12px;">{{item.cname}}：</span>
						
							<div ng-if="item.dtype==1" style="margin-top:5px;">
							<input ng-if="item" type="text" style="height:30px;width:170px;" class="txt"  name="{{item.ename}}" group="cond"  value="{{deviceInfo[item.ename]}}"  placeholder="请输入内容" />
							</div>
							<div ng-if="item.dtype==2" style="margin-top:5px;">
							<input ng-if="item" type="text" style="height:30px;width:170px;" class="txt number"  name="{{item.ename}}" group="cond"  value="{{deviceInfo[item.ename]}}" placeholder="请输入内容"  />
							</div>
							<div ng-if="item.dtype==3" style="margin-top:5px;">
							<input ng-if="item" type="text" style="height:30px;width:170px;" class="txt date dateComponent" name="{{item.ename}}" group="cond"   value="{{deviceInfo[item.ename]}}"  placeholder="请选择" onclick="new Calendar().show(this)"  />
							</div>
							<div ng-if="item.dtype==4" style="margin-top:5px;">
							<input  type="text" readonly="readonly" class="dropDownList" style="height:30px;width:170px;" name="{{item.ename}}" group="cond"   value="{{deviceInfo[item.ename]}}"  placeholder="请选择{{item.cname}}" />
							</div>
						
					</div>
				</div>
				
				
				
				
				
			</div>                                                                                                                                                                      
		</div>
		<!--改造材料-->
		<div class="bxys_no1" id="gzcl" style="display: none;">
			<div class="bxys_wma1" style="margin-top:0px;">
				<span class="mesadd" style="width:22%" >材料名称</span>
				
				<span class="mesadd" style="width:35%">材料数量</span>
			</div>
			<div  ng-repeat="item in deviceAttrList" ng-if="item.dimPeBsMaterial==1" class="bxys_wma1">
				<span class="mesadd">{{item.cname}}：</span>
				
				<input  name="{{item.ename}}" type="text" prop="number" class="txt validNum"  placeholder="请输入数量" onblur="inpblur(this)" flag=false group="cond" style="width:180px;" />
				<span  style="color:red;" class="isnumber">(整数)</span>
				<input name="price1" type="hidden" value="{{item.amount/item.needCount}}" flag=false />
			
			</div>
		</div>
		
		<!--现场照片-->
		<div class="bxys_no1" style="display: none;">
			<div class="update_ing">
				<p class="mesadd">改造前照片：</p>
				<img src="img/deviceAdd/add_pic_icon.png"  class="pic" id="reserveB1Img" onclick="reserveB1Img1()" />
				<input type="hidden" name="reserveB1Img" value="" />
				<img src="img/deviceAdd/add_pic_icon.png" class="pic" id="reserveB2Img" onclick="reserveB2Img1()" />
				<input type="hidden" name="reserveB2Img" value="" />
			</div>
			<div class="update_ing">
				<p class="mesadd">改造后照片：</p>
				<img src="img/deviceAdd/add_pic_icon.png" class="pic" id="reserveA1Img" onclick="reserveA1Img1()"/>
				<input type="hidden" name="reserveA1Img" value="" />
				<img src="img/deviceAdd/add_pic_icon.png" class="pic" id="reserveA2Img" onclick="reserveA2Img1()"/>
				<input type="hidden" name="reserveA2Img" value="" />
			</div>
			<div class="update_ing">
				<p class="mesadd">工作票：</p>
				<img src="img/deviceAdd/add_pic_icon.png" class="pic" onclick="reserveOpImg1()" id="reserveOpImg"/>
				<input type="hidden" name="reserveOpImg" value="" />
			</div>
			<div class="update_ing">
				<p class="mesadd">户表关系核查：</p>
				<img src="img/deviceAdd/add_pic_icon.png" class="pic" id="reserveSignImg" onclick="reserveSignImg1()" />
				<input type="hidden" name="reserveSignImg" value="" />
			</div>
			<div class="update_ing">
				<p class="mesadd">停电通知书：</p>
				<img src="img/deviceAdd/add_pic_icon.png" class="pic" id="reservePcutImg" onclick="reservePcutImg1()" />
				<input type="hidden" name="reservePcutImg" value="" />
			</div>
		</div>
		
		<!--户表关系-->
		<div class="bxys_no1" id="hbgx" style="display: none;">
			<div class="bxys_wma1"><span class="mesadd">台区名称：</span><input type="text" class="txt" name="deviceByqName" placeholder="请输入内容"  /></div>
			<div class="bxys_wma1"><span class="mesadd">线路名称：</span><input type="text" class="txt"  name="deviceLineName" placeholder="请输入内容"  /></div>
			<div class="bxys_wma1"><span class="mesadd">表箱编号：</span><input type="text" class="txt" onblur="inpblur(this)" name="deviceBxId" placeholder="请输入内容" flag=false   /><img flag=false src="img/deviceAdd/task_list_selete_icon.png" class="yes disn"/><img src="img/deviceAdd/task_time_icon.png" onclick="scan()" /></div>
			
			<div class="uder_line"></div>			
			<div id="bnum">
				<div class="bxys_wma1">
					<span class="mesadd">表号：</span>
					<input type="text" name="bxid" onblur="inpblur(this)" placeholder="请输入内容" flag=false  class="txt" style="margin-left:-4px;"  /><img src="img/deviceAdd/task_time_icon.png" onclick="scan1(this)" />
					<input  type="hidden" name="deviceBhIds" />
					<input  type="hidden" name="attrJson" />
					<input  type="hidden" name="proNo" />
					<input  type="hidden" name="mctCode" />
					<input  type="hidden" name="deviceObjCode" />
					<input  type="hidden" name="reserveProNo" />
					<input  type="hidden" name="companyCode" />
					
					<input type="hidden" name="price"  />
					<img src="img/deviceAdd/task_list_selete_icon.png" class="yes disn" style="margin-left:-1px;"/>
					<img src="img/deviceAdd/add.png" onclick="add()" class="add" style="margin-left:-1px" />
				</div>
			</div>
		</div>
		
		<div id="showdiv" style="z-index: 9999;background:rgba(0,0,0,0.5);position:fixed ;bottom:0px;right:0px;left:0px; height:220px;">
			 <div class="up_load" onclick="takePhoto()"><a>拍照</a></div>
			 <div class="up_load" onclick="selectPhoto()"><a>从相册选择</a></div>
			 <div class="up_load" onclick="hidDiv()"><a>取消</a></div>
		</div>
		
	</section>
	<footer>
		<div class="up_load" ng-click="doUpdate()"><a>提交</a></div>
	</footer>
	</form>
	
	<script>
	var currentId="";
	//扫码
	function scan(){
		window.top.nativeLib.scanCode({callback:function(data){
			//alert(data)
			
			var result=data;
			//alert(result)
			if(result.length>10){//ABCDEFGHIJKLMN    DEFGHIJKLM
				result=result.substr(result.length-11,10);
			}
			
			$("input[name=deviceBxId]").val(result);
			$("input[name=deviceBxId]").focus();
		}});
		
	}
	
	//表号
	function scan1(obj){
		window.top.nativeLib.scanCode({callback:function(data){
			//alert(data)
			
			var result=data;
			//alert(result)
			if(result.length>10){//ABCDEFGHIJKLMN    DEFGHIJKLM
				result=result.substr(result.length-11,10);
			}
			
			$(obj).prev().val(result);
			$(obj).prev().focus();
		}});
		
	}
	
	
	
	function checkType(){
		$("#showdiv").slideToggle("slow");
	}
	
	function hidDiv(){
		$("#showdiv").slideToggle("slow");
	}
	//拍照
	function takePhoto(){
		
		window.top.nativeLib.getPicture({
			action:"takePicture",
			callback:function(data){
				var image = document.getElementById(currentId);
				image.src = "data:image/jpeg;base64," + data.base64Img;
				$("input[name="+currentId+"]").val(data.base64Img);	
				hidDiv();
			}
		});
		
	}
	//选择
	function selectPhoto(){
		
		window.top.nativeLib.getPicture({
			action:"picPicture",
			callback:function(data){
				var image = document.getElementById(currentId);
				image.src = "data:image/jpeg;base64," + data.base64Img;
				$("input[name="+currentId+"]").val(data.base64Img);	
				hidDiv();
			}
		});
		
	}
	
	//改造前1
	function reserveB1Img1() {
		currentId="reserveB1Img";
		checkType();
    }
	  //改造前2
	function reserveB2Img1() {
		currentId="reserveB2Img";
		checkType();
		
    }
	
	//改造后1
	function reserveA1Img1() {
		
		
		
		window.top.nativeLib.getPicture({
			action:"takePicture",
			callback:function(data){
				var image = document.getElementById("reserveA1Img");
				image.src = "data:image/jpeg;base64," + data.base64Img;
				$("input[name=reserveA1Img]").val(data.base64Img);	
				//hidDiv();
			}
		});
		
    }
	
	//改造后2
	function reserveA2Img1() {
		window.top.nativeLib.getPicture({
			action:"takePicture",
			callback:function(data){
				var image = document.getElementById("reserveA2Img");
				image.src = "data:image/jpeg;base64," + data.base64Img;
				$("input[name=reserveA2Img]").val(data.base64Img);	
				//hidDiv();
			}
		});
		
    }
	
	//工作票
	function reserveOpImg1() {
		currentId="reserveOpImg";
		checkType();
    	
    }
	
	//户表关系核查
	function reserveSignImg1() {
		currentId="reserveSignImg";
		checkType();
    	
    }
	
	//停电通知书
	function reservePcutImg1() {
		currentId="reservePcutImg";
		checkType();
    	
    } 
	
	
	function add(){
		var bminp = $("<div class='bxys_wma1'>"
				+"<span class='mesadd'>表号：</span>"
				+"<input name='bxid' type='text' onblur='inpblur(this)' placeholder='请输入内容' flag=false class='txt' />"
				+"<img src='img/deviceAdd/task_time_icon.png' onclick='scan1(this)'/>"
				+"<img src='img/deviceAdd/task_list_selete_icon.png' class='yes disn'/>"
				+"<img src='img/deviceAdd/del.png' onclick='del(this)' class='del'/>"
				+"</div>");
		bminp.appendTo($("#bnum"));
	}
	function del(obj){
		$(obj).parent(".bxys_wma1").remove();
	}
	 	
	 //deviceObjCode
		$(".tast_nav li").each(function(){
			$(this).click(function(){
				
				$(this).addClass("active").siblings().removeClass("active");
				var n=$(this).index();
				$(".bxys_no1").eq(n).show().siblings(".bxys_no1").hide();
				if(n==0||n==2||n==3){
					$("#gzcl input:text").each(function(){
						if($(this).attr("flag") == "false"){
							
							
							$(".tast_nav li").eq(1).addClass("cha");
							return false;

						}else if($(this).attr("flag") == "true"){
							
							
							$(".tast_nav li").eq(1).removeClass("cha");
						

						}
					})
					
				};
				if(n==0||n==2||n==1){
					$("#hbgx input:text").each(function(){
						if($(this).attr("flag") == "false"){
							$(".tast_nav li").eq(3).addClass("cha");
							return false;
						}else if($(this).attr("flag") == "true"){
							$(".tast_nav li").eq(3).removeClass("cha");
						}
					})
					
				}
			})
		});
		

		var result3=0;
		function inpblur(obj){
			result3=0;
			$(".isnumber").hide();
			var re = /^\d+$/;
			$("input[prop='number']").each(function(){
			   
		
			   
			    if($(this).val()!=""){
			    
			    	
			    	//验证
			    	if (re.test($(this).val()))
			    	{
			    	    
			    	}else{
			    		
			    		$(this).next().show();
			    		result3=1;
			    		//return false;
			    	}
			    }
			});
			
			if ($(obj).val() !='' && re.test($(obj).val()) ) {
	         //  $(obj).siblings(".yes").show();
	            $(obj).attr("flag","true")
	        }else{
	          //  $(obj).siblings(".yes").hide();
	            $(obj).attr("flag","false")
	        }
	        
	        
		}
	
		
		$(".return").click(function(){
			//window.history.back();
			top.viewBack();
		})
		
		var params=getUrlParams();
		
		var proNo=params.proNo;
		var mctCode=params.mctCode;
		var deviceObjCode=params.deviceObjCode;
		var reserveProNo=params.reserveProNo;
		
		var deviceObjName=params.deviceObjName;
		
		$("input[name=proNo]").val(proNo);
		$("input[name=mctCode]").val(mctCode);
		$("input[name=deviceObjCode]").val(deviceObjCode);
		$("input[name=reserveProNo]").val(reserveProNo);
		//alert(proNo+" "+mctCode+" "+deviceObjCode+" "+reserveProNo)
		
		
		simpleController({
			moduleName:"realPosition",
			controllerName:"realPositionCtrl",
			init:function($scope, $http){
	
				$scope.deviceInfo=[];
				$scope.materialListTrs=[];

				$scope.deviceObjName=deviceObjName;
				
				
				$scope.loadMaterialList=function(){
					$scope.httpExecute({
						method:"get",
						url:"eap/pmsServices/pe/baseMgr/remouldBatch/getProDevice1",
						data:{"companyCode":$scope.userData.companyCode, "reserveProNo":params.reserveProNo, "deviceObjCode":params.deviceObjCode, "ticket":$scope.ticket},
						success:function(resp){
							$scope.deviceInfo=resp.data;
							$scope.loadAttrs($scope.deviceInfo.mctCode);
							/* $("#showimages").attr("src", "../../component/showimags.html?mctCode="+$scope.deviceInfo.mctCode+"&companyCode="+$scope.deviceInfo.companyCode+
									"&proNo="+$scope.deviceInfo.proNo+"&deviceObjCode="+$scope.deviceInfo.deviceObjCode); */
						}
					});
					
				};
				
				$scope.deviceAttrList=[];
				$scope.deviceAttrTrs=[];
				/* 加载属性信息 */
				$scope.loadAttrs=function(mctCode){
					$scope.httpGet({
						url:"eap/pmsServices/om/deviceMgr/device/mctAttr?companyCode="+$scope.userData.companyCode,
						data:{"mctCode":mctCode, "ticket":$scope.ticket},
						success:function(response){
							$scope.deviceAttrList = response.list;
							$scope.deviceAttrTrs=$scope.splitToTr($scope.deviceAttrList);
						
							lazyCall('t1',function(){
								for(var i=0; i<$scope.deviceAttrList.length; i++){
									(function(){
										var searchField = $scope.deviceAttrList[i];
										if(searchField.dtype==4){
											/* 搜索条件*/ 
											//alert(searchField.ename)
											/* var tempstr=searchField.enumValue+"";
											var arry=tempstr.split(","); */
											
											new DropDownList().init({
												renderTo:"input[name="+searchField.ename+"]",
												data:searchField.enumValue,
												onSelected:function(result){
													$("input[name="+searchField.ename+"]").val(result);
												}
											});
										}
									})();
								}
							}, 100);
							
						}
					});
				};
				
				/* 组织tr数据 */
				$scope.splitToTr=function(arr){
					var trs=[];
					for(var i=0; i<arr.length; i++){
						if(arr[i].dimPeBsMaterial==1){
							continue;
						}
						
						var attr = arr[i];
						if(i!=0 && i%2==0){
							trs.push([]);
						}
						if(trs.length==0){
							trs.push([]);
						}
						var tr=trs[trs.length-1];
						tr.push(attr);
					}
					var lastTr=trs[trs.length-1];
					if(lastTr.length<2){
						//lastTr.push({});
					}
					return trs;
				};
				
				
				
				$scope.onSubmitClickHandler=function(url,params) {
			     	//var url = "http://192.168.1.226:8080/pmsWeb/eap/pmsServices/om/deviceMgr/device/test";
			     	
			     	var method = "POST";
			     	//var img = $("#imgBase64").val();
			     	//var params = {companyCode:"002",mctCode:"235235215325325",img:img};
			     	
			     	$scope.httpPost({
			     		url:url,
			     		data:params,
			     		success:function(responseData) {
			            	 waittingDlog.close();
			            	 if(responseData.statusCode=="200"){
									//var dialog1=;
									waittingDlog.prompt({
										icon:"success",
										msg:"提交成功！",
										done:function(){
											location.href="deviceList.html?ticket=" + $scope.ticket;
											//$scope.loadProject(addr,estaeName,proNo);
										},
										t:2000
									}); 
								}else{
									waittingDlog.prompt({
										icon:"error",
										msg:"提交失败！",
										done:function(){
											
											//location.href="deviceList.html";
											//$scope.loadProject(addr,estaeName,proNo);
										},
										t:2000
									});
								}
			            	 
			                 
			             }
			             
			     	});
				 };
				
				var relaute = 0;
				var waittingDlog = new ShowDlog();
				
				$scope.doUpdate=function(){
					
					$("#gzcl input:text").each(function(){
						if($(this).attr("flag") == "false"){
							
							
							$(".tast_nav li").eq(1).addClass("cha");
							return false;

						}else if($(this).attr("flag") == "true"){
							
							
							$(".tast_nav li").eq(1).removeClass("cha");
						

						}
					});
					
					$("#hbgx input:text").each(function(){
						if($(this).attr("flag") == "false"){
							$(".tast_nav li").eq(3).addClass("cha");
							return false;
						}else if($(this).attr("flag") == "true"){
							$(".tast_nav li").eq(3).removeClass("cha");
						}
					});
					
					if(result3==1){
						
						$(".tast_nav li").eq(1).addClass("cha");
						return false;
					}else{
						
						$(".tast_nav li").eq(1).removeClass("cha");
					}
					
				
					
					
					
					$(".validNum").each(function(){
						if($(this).val()==''){
							relaute =0;
							$(".tast_nav li").eq(1).addClass("cha");
							return false;
							
						}else{
							relaute =1;
						}
						
					});
					var li4=0;
					$("#hbgx input:text").each(function(){
						if($(this).val()==''){
							$(".tast_nav li").eq(3).addClass("cha");
							li4 =0;
						}else{
							$(".tast_nav li").eq(3).removeClass("cha");
							li4 =1;
						}
					})
					
					
					
					
					
					
					if(relaute ==1 && li4==1){
						var cond={};
						//item in deviceInfo.materiaList" class="bxys_wma1"><span class="mesadd">{{item.materialTypeName}}
						
						
						
						 var cond={};
						$("input[group=cond]").each(function(){
							var $cond = $(this);
							var key = $cond.attr("name");
							var val = $cond.val();
							cond[key]=val;
						});
						
						var condStr=JSON.stringify(cond);
						
						$("input[name=attrJson]").val(condStr);
						var deviceBhIds="";
						$("input[name=bxid]").each(function(){
							var $cond = $(this);
							
							var val = $cond.val();
							deviceBhIds+=val+",";
						});
						deviceBhIds=deviceBhIds.substring(0,deviceBhIds.length-1);
						
						//alert(deviceBhIds)
						$("input[name=deviceBhIds]").val(deviceBhIds);
						
						
						var price="";
						$("input[name=price1]").each(function(){
							var $cond = $(this);
							
							var val = $cond.val();
							price+=val+",";
						});
						price=price.substring(0,price.length-1);
						$("input[name=price]").val(price);
						
						$("input[name=companyCode]").val($scope.userData.companyCode);
						
						//var waittingDlog = new ShowDlog();
						waittingDlog.prompt({
							icon:"waitting",
							msg:"正提交请稍等",
							done:function(){
								
							},
							t:360000
						});
						
						var filepath=sessionStorage.serviceBasePath;
						//alert(filepath)
						/* $("#saveForm").attr("action",filepath+"eap/pmsServices/pe/baseMgr/remouldBatch/updateDevice");
						$("#saveForm").submit().success(function(){
							alert(1)
							
						}); */
						
						/* var options = {
								success: function(responseText, statusText) {
									waittingDlog.close();
									if(responseText.statusCode=="200"){
										//var dialog1=;
										new ShowDlog().prompt({
											icon:"success",
											msg:"提交成功！",
											done:function(){
												
												location.href="deviceList.html";
												//$scope.loadProject(addr,estaeName,proNo);
											},
											t:2000
										}); 
										
										
									}else{
										new ShowDlog().prompt({
											icon:"error",
											msg:"提交失败！",
											done:function(){
												
												//location.href="deviceList.html";
												//$scope.loadProject(addr,estaeName,proNo);
											},
											t:2000
										});
									}
								},      //提交后的回调函数   
								type: "post",               //默认是form的method（get or post），如果申明，则会覆盖  
								dataType: "json",           //html(默认), xml, script, json...接受服务端返回的类型  
								clearForm: false,          //成功提交后，清除所有表单元素的值
								url:filepath+"eap/pmsServices/pe/baseMgr/remouldBatch/updateDevice",
								error: function(xhr, status, error) {
									console.log(error);
								}
							};
							$("#saveForm").ajaxSubmit(options); */
							
							var params = serializeArrayToMap($("#saveForm").serializeArray());
							params.ticket=$scope.ticket;
					
							var url="eap/pmsServices/pe/baseMgr/remouldBatch/updateDevice";
							
							$scope.onSubmitClickHandler(url,params);

					}
					
				};
				$scope.loadMaterialList();
			}
		});
		
		
	</script>
</body>
</html>