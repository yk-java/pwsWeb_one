<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Document</title>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	<script src="js/jquery-1.9.1.min.js"></script>
	<link rel="stylesheet" type="text/css" href="css/bxyw.css"/>
	<script src="js/jquery.cookie.js"></script>
	<script src="js/angular.min.js"></script>
	<script src="js/util.js"></script>
	<script src="js/ng-base.js"></script>
	<script type="text/javascript" src="js/jquery.form.js"></script>
	<script type="text/javascript" src="js/showDlog/showDlog.js"></script>
	<link rel="stylesheet" type="text/css" href="js/showDlog/showDlog-blue.css" />

	<script type="text/javascript" src="js/eapJs/core/eap.core.js" ></script>
	<script type="text/javascript" src="js/eapJs/plugins/eap.tip.js" ></script>
	<script type="text/javascript" src="js/eapJs/plugins/eap.validate.js"></script>
	<script type="text/javascript" src="js/eapJs/local/eap.lang-zh_CN.js"></script>
	<link rel="stylesheet" type="text/css" href="css/validate.css"/>
	<style type="text/css">
		header{position:absolute;top:0;right:0;left:0;height:60px;}
		section{position:absolute;top:60px;right:0;bottom:0px;left:0;overflow:auto;}
	</style>
</head>
<body ng-app="moduleName" ng-controller="controllerName">
	<header>
		<div class="return"><img src="images/return.png"/></div>
		{{data.taskName}}
	</header>
	<section class="tast_warp">
	<form id="saveForm">
		<input type="hidden" name="taskCode" value="{{data.taskCode}}"/>
		<div class="title_con">		
			<div class="b_bline">
				<p class="titlep">基本信息</p>
			</div>
			<div class="base_msg">
				
				<div class="ov">
					<!--<p class="fl"><span></span>终端厂家:<a>南京新联</a></p>
					<p class="fr"><span></span>终端型号:<a>DC-OL-13</a></p>-->
					
					<p><span></span>户名：{{data.HOUSEHOLD_NAME}}</p>
					<p><span></span>户号：{{data.HOUSEHOLD_NO}}</p>
					<p><span></span>用户地址：{{data.HOUSEHOLD_ADDR}}</p>
				

					<p><span></span>终端编号：{{data.TERMINAL_ID}}</p>
					<p><span></span>终端型号：{{data.TERMINAL_MODEL}}</p>
					<p><span></span>终端厂家：{{data.TERMINAL_MAKER}}</p>
					<p><span></span>终端地址：{{data.TERMINAL_LOC}}</p>
				</div>
			</div>
		</div>

			<div class="gz_con">
				<div class="sel_gz">
					<span class="frist">
						<select name="deviceFaultType" onchange="gzTypeChange()" class="required">
							<option>请选择</option>
						</select>
					</span>
					<span>
						<select name="deviceFaultDetail" class="required">
							<option>请选择</option>
						</select>
					</span>
				</div>
				<div class="gz_decon">
					<textarea placeholder="请输入故障现象" class="required" name="faultDesc">{{data.faultDesc}}</textarea>
					<textarea placeholder="请输入现场状况" class="required" name="sceneDesc">{{data.sceneDesc}}</textarea>
					
					
					<div class="sel_gz bor_top">
						<span class="gz_rusert">
							<select name="taskResultFlag" class="required">
								<option value="">请选择故障处理结果 </option>
								<option value="1">处理成功</option>
								<option value="0">处理失败</option>
							</select>
						</span>
						<p style="width: 95%;margin: 10px auto 0;">故障照片</p>
						<div class="update_ing">
							<img src="images/add_pic_icon.png" id="img1" onclick="getPicture(this, 'img1')"/>
							<input type="hidden" name="img1"/>
							<img src="images/add_pic_icon.png" id="img2" onclick="getPicture(this, 'img2')"/>
							<input type="hidden" name="img2"/>
							<img src="images/add_pic_icon.png" id="img3" onclick="getPicture(this, 'img3')"/>
							<input type="hidden" name="img3"/>
						</div>
					</div>
					<!--当选择终端更换的时候显示-->
					<!--<div class="sel_gz bor_top">
						<span class="gz_rusert zdh_inp">
							<label class="fl">终端号:</label><input class="fl" type="text" placeholder="请输入终端号" />	
						</span>
					</div>-->
				</div>
			</div>		
		<div class="up_load" ng-click="doSubmit()"><a>提交</a></div>
		</form>
	</section>
	<script>
		$(".return").click(function(){
			top.viewBack();
		})
		function getPicture(img, inputName){
			top.nativeLib.getPicture({
				action:"takePicture",
				callback:function(data){
					img.src="data:image/jpeg;base64,"+data.base64Img;
					img.style.height=img.offsetWidth+"px";
					$("input[name="+inputName+"]").val(data.base64Img);
				}
			});
		}
		function gzTypeChange(){
			ngScope.gzTypeChange();
		}
		var ngScope;
		simpleController({
			init:function($scope, $http){
				ngScope=$scope;
				$scope.data=[];
				$scope.gzList=[];
				var urlParams = getUrlParams();

				$scope.loadDataList=function(){
					$scope.httpGet({
						url:"eap/pmsServices/pm/taskMgr/task/userTaskDetailList",
						data:{"employeeCode":$scope.userData.employeeCode,
							"terminalId":urlParams.terminalId,
							"faultType":urlParams.faultType},
						success:function(res){
							if(res.list){
								$scope.data = res.list[0];
								// 回显处理结果
								$scope.taskResultFlag();
								$scope.loadGzList();
							}
						}
					});
				};
				$scope.taskResultFlag=function(){
					$("select[name=taskResultFlag]>option").each(function(){
						var val = $(this).val();
						if($scope.data.taskResultFlag==val){
							$(this).attr("selected", "selected");
						}
					});
				};
				$scope.loadGzList=function(){
					$scope.httpGet({
						url:"eap/pmsServices/om/deviceMgr/device/mctAttr1",
						data:{"companyCode":$scope.userData.companyCode, "deviceTypeCode":"P02", "t":new Date().getTime()},
						success:function(res){
							var lst = res.list;
							for(var i=0; i<lst.length; i++){
								var attr = lst[i];
								if(attr.ename=="DBGZ"){
									var dataStr = attr.enumValue;
									dataStr = dataStr.replace(/\n/g, "");
									dataStr = dataStr.replace(/，/g, ",");
									var data;
									try{
										data=eval("["+dataStr+"]");
									}catch(e){}//alert(dataStr);alert(data);
									$scope.gzList=data[0][$scope.data.FAULT_TYPE];
									$scope.initGzType();
								}
							}
						}
					});
				};
				
				$scope.initGzType=function(){
					var $gzType = $("select[name=deviceFaultType]");
					$gzType.empty();
					for(var i=0; i<$scope.gzList.length; i++){
						var item = $scope.gzList[i];
						// 回显故障类型
						var checked="";
						if(item.label==$scope.data.deviceFaultType){
							checked="selected='selected'";
						}
						var opt = $("<option value='"+item.label+"' "+checked+">"+item.label+"</option>");
						$gzType.append(opt);
					}
					$scope.initGzDetail($scope.data.deviceFaultType);
				};
				
				$scope.gzTypeChange=function(){//alert();
					var $gzType = $("select[name=deviceFaultType]");
					$scope.initGzDetail($gzType.val());
				};

				$scope.initGzDetail=function(gzTypeValue){//alert(gzTypeValue);
					var $gzDetail = $("select[name=deviceFaultDetail]");
					$gzDetail.empty();
					for(var i=0; i<$scope.gzList.length; i++){
						var item = $scope.gzList[i];
						if(item.label==gzTypeValue){
							for(var j=0; j<item.children.length; j++){
								var subItem = item.children[j];
								// 回显故障子类型
								var checked="";
								if(subItem.label==$scope.data.deviceFaultDetail){
									checked="selected='selected'";
								}
								var opt = $("<option value='"+subItem.label+"'"+checked+">"+subItem.label+"</option>");
								$gzDetail.append(opt);
							}
						}
					}
				};

				/* 表单验证 */
				validator = $("#saveForm").validate({
					onsubmit: false,
					focusInvalid: false,
					focusCleanup: true,
					errorElement: "span",
					ignore:".ignore",
					invalidHandler: function(form, validator) {
						var errors = validator.numberOfInvalids();
						if (errors) {
							
						} 
					}
				});
				var waittingDlog = new ShowDlog();
				$scope.doSubmit=function(){
					if($("#saveForm").valid()){
						var taskResultFlag = $("select[name=taskResultFlag]").val();
						var pic1 = $("input[name=img1]").val();
						var pic2 = $("input[name=img2]").val();
						var pic3 = $("input[name=img3]").val();
						if(taskResultFlag==0 && pic1.length==0 && pic2.length==0 && pic3.length==0){
							new ShowDlog().prompt({
								msg:"请上传照片！",
								done:function(){
									
								},
								t:1500
							});
							return;
						}
						
						waittingDlog.prompt({
							icon:"waitting",
							msg:"正提交请稍等",
							done:function(){
								
							},
							t:360000
						});
						var params = serializeArrayToMap($("#saveForm").serializeArray());
// 						$scope.httpPost({
// 							url:"eap/pmsServices/pm/taskMgr/task/saveTaskOpInfo",
// 							data:params,
// 							success:function(res){
// 								if(res.statusCode==200){
// 									new ShowDlog().prompt({
// 										icon:"success",
// 										msg:"保存成功！",
// 										done:function(){
// 											window.history.back();
// 										},
// 										t:1500
// 									});
// 								}
// 							}
// 						});

						/* $("#saveForm").ajaxSubmit({
							url:sessionStorage.serviceBasePath+"eap/pmsServices/pm/taskMgr/task/saveTaskOpInfo",
							type: "post",
							dataType: "json",
							clearForm: false,
							success:function(res){
								waittingDlog.close();
								if(res.statusCode==200){
									new ShowDlog().prompt({
										icon:"success",
										msg:"保存成功！",
										done:function(){
											window.history.back();
										},
										t:1500
									});
								}
							},
							error: function(xhr, status, error) {
								console.log(error);
							}
						}); */
						var url="eap/pmsServices/pm/taskMgr/task/saveTaskOpInfo";
						$scope.onSubmitClickHandler(url,params);
						
						
						
					}
				};
				
				
				$scope.onSubmitClickHandler=function(url,params) {
			     	$scope.httpPost({
			     		url:url, 
			     		data:params, 
			     		success:function(responseData){
			            	
		            	    waittingDlog.close();
							if(responseData.statusCode==200){
								new ShowDlog().prompt({
									icon:"success",
									msg:"保存成功！",
									done:function(){
										top.viewBack();
									},
									t:1500
								});
							}
				     	}, 
				     	error:function(){}
				     });
				 };
				
				$scope.loadDataList();
			}
		});
	</script>
</body>
</html>