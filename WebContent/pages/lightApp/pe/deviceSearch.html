<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>表箱查询</title>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	<script src="js/jquery-1.9.1.min.js"></script>
	<script src="js/jquery.cookie.js"></script>
	<script src="js/angular.min.js"></script>
	<script src="js/util.js"></script>
	<script src="js/ng-base.js"></script>
	<script type="text/javascript" src="js/jquery.form.js"></script>
	<script type="text/javascript" src="js/showDlog/showDlog.js"></script>
	<link rel="stylesheet" type="text/css" href="js/showDlog/showDlog-blue.css" />
	<script type="text/javascript" src="js/DropDownList-1.2/DropDownList-v1.2.js"></script>
	<link rel="stylesheet" type="text/css" href="js/DropDownList-1.2/DropDownList.css"/>
	<script type="text/javascript" src="js/showDlog/showDlog.js"></script>
	<link rel="stylesheet" type="text/css" href="js/showDlog/showDlog-blue.css" />
	<link rel="stylesheet" type="text/css" href="css/bxyw.css"/>
</head>
<body ng-app="userMgr" ng-controller="userMgrCtrl">
	<header>
		<div class="return"><img src="images/return.png"/></div>
		表箱查询
	</header>
	<section>
		<ul class="cz_selpx ov" >
			<li class="fl">筛选<img src="images/down_icon.png"/></li>
			<li class="fr">排序<img src="images/down_icon.png"/></li>
		</ul>
		<div class="filter_sort">
			<ul class="filter"  style="display: none;padding:0 0 40px 0">
				<li class="ov">
					<div class="filter_con">
						<div class="filter_search">
							<div class="search_int">
								<input type="text" name="search" id="search" placeholder="请输入你要搜索的内容"/>
								<a class="clear_search">x</a>
							</div>
							<span ng-click="doQuery()">搜索</span>
						</div>
					</div>
				</li>
				<li ng-repeat="item in mctlistArr.searchFields" ng-if="item.dtype==4">
					<div class="filter_con">
						<div group="cond" id="{{item.ename}}">{{item.cname}}</div>
					    <div>
							<div onclick="filter2(this)" ng-click="filter(item.ename, '')" class="fl ov filter_no"><img src="images/task_selete_icon.png" class="fl"/><div class="fl">全部</div></div>
							<div onclick="filter2(this)" ng-click="filter(item.ename, item1)" ng-repeat="item1 in item.enumValue" ng-if="item1.length>5" class="fl ov filter_no" style="width:100%;overflow:hidden"><img src="images/task_nonselete_icon.png" class="fl"/><div class="fl">{{item1}}</div></div>
							<div onclick="filter2(this)" ng-click="filter(item.ename, item1)" ng-repeat="item1 in item.enumValue" ng-if="item1.length<5" class="fl ov filter_no"><img src="images/task_nonselete_icon.png" class="fl"/><div class="fl">{{item1}}</div></div>
							<div style="clear:both"></div>
						</div>
					</div>
				</li>
				<li class="ov">
					<a href="javascript:" class="filterbtn fl" ng-click="filterdoQuery()" >确定</a>
					<a href="javascript:" class="filterclose fr" ng-click="quxido()">重置</a>
				</li>
			</ul>
			<ul class="sort" style="display: none;">
				<li><div class="sort_no">表箱地址排序<img src="images/task_list_selete_icon.png" class="fr"/></div></li>
				<li><div class="sort_no">地址位置远近<img src="images/task_list_selete_icon.png" class="fr" style="display: none;"/></div></li>
			</ul>
		</div>
		
		<div class="con_list" ng-repeat="datacx in datalist1">
			<a href="javascript:" ng-click="toDetail(datacx)">
				<p class="title">{{datacx.deviceObjName}}</p>	
			</a>		
		</div>
	</section>
	<footer>
		<p>
<!-- 			<img src="images/task_light_left.png" class="fl"/> -->
				共查询到表箱&nbsp;&nbsp;<span>{{datalist1?datalist1.length:0}}</span>&nbsp;&nbsp;项
<!-- 			<img src="images/task_light_right.png" class="fr"/> -->
		</p>
	</footer>
	<script type="text/javascript">
		var urlParams = getUrlParams();
		$(".clear_search").click(function(){
			
			$(".search_int input").val("");
		})
		
	
		
		$(".sort li").each(function(){
			$(this).click(function(){
				$(this).find("img").show();
				$(this).siblings().find("img").hide();
			})
		});
		
		var fsper = "true";
		$(".cz_selpx li").click(function(){
			if(fsper == "true"){
				var n = $(this).index();
				$(".filter_sort ul").eq(n).show().siblings().hide();
				$(".con_list").hide();
				fsper = "false";
			}else{
				var n = $(this).index();
				$(".filter_sort ul").eq(n).hide();
				$(".con_list").show();
				fsper = "true";
			}
		});
		
		$(".return").click(function(){
			if(urlParams.web==1){
				top.history.back();
			}else{
				top.nativeLib.exitApp();
			}
		})
		simpleController({
			moduleName:"userMgr",
			controllerName:"userMgrCtrl",
			init:function($scope, $http){
				/* init */
				ngScope = $scope;
				$scope.curUnit={};
				$scope.projectList=[];
				$scope.mctlistArr ="";
				var userDataStr = $.cookie("pmsWeb_user_data");
				if(!userDataStr){
					noLogin(location.href);
					return;
				}
				var userData = jQuery.parseJSON(userDataStr);
				ticket = $.cookie("pmsWeb_ticket");
				var proNo = userData.proNo;
				var companyCode=userData.companyCode;
				var searchName="";
				var serviceBasePath=sessionStorage.serviceBasePath;
				var mctCode="";
				var ename="";
				var enamearr=[];
				var mctName="";
				var attrJson="";
			 	$scope.loadList=function(){		
			 		
			 		/* 获取总控表 */
			 		$http.get(serviceBasePath+"eap/pmsServices/taskMgr/mctList/listAll?companyCode="+companyCode+"&proNo="+proNo+"&ticket="+ticket).success(function(res){
						if(res.statusCode==200){
							$scope.zkbList =res.list;
							if($scope.zkbList && $scope.zkbList.length>0){
								mctCode=$scope.zkbList[0].mctCode;
								mctName=$scope.zkbList[0].mctName;
								$scope.loadAttr(mctCode)
							}
						}else if(res.statusCode==401){
							window.parent.location.href="../login.html";
						}else{
							alert("服务器访问出错！");
						}
					});		 		
				};
			
				$scope.loadAttr=function(mctCode){
					/* 获取查询条件 */
					$http.get(serviceBasePath+"eap/pmsServices/om/deviceMgr/device/mctListAttr?companyCode="+companyCode+"&mctCode="+mctCode+"&ticket="+ticket).success(function(res){
						if(res.statusCode==200){
							$scope.mctlistArr = res.data;
							
							$scope.loadData("",companyCode,mctCode,proNo,searchName);
							
							
						}else if(res.statusCode==401){
							window.parent.location.href="../login.html";
						}else{
							alert("服务器访问出错！");
						}
					});
					
				};
	
				
				$scope.loadList();
				$scope.attrJson={};
				$scope.filter=function(key,item){
					$scope.attrJson[key]=item;	
				}
			
			
				$scope.doQuery=function(){
					searchname=$("#search").val();
					$(".con_list").show();
					enamearr =[];
					for(var i=0;i<$scope.mctlistArr.searchFields.length;i++){
						if($scope.mctlistArr.searchFields[i].dtype ==1){						
							enamearr.push($scope.mctlistArr.searchFields[i].ename);
						}
					}
					searchName =enamearr+";"+searchname;				
					attrJson = JSON.stringify($scope.attrJson);
					$scope.loadData(attrJson,companyCode,mctCode,proNo,searchName);
					$(".filter").hide();
					new ShowDlog().prompt({
							icon:"waitting",
							msg:"正在加载...",
							done:function(){},
							t:600000
						}); 	
				};
				$scope.filterdoQuery=function(){
					$(".con_list").show();
					attrJson = JSON.stringify($scope.attrJson);
					$scope.loadData(attrJson,companyCode,mctCode,proNo,searchName);
					$(".filter").hide();
				}
				$scope.quxido=function(){
					window.location.reload();
				}
				/* 数据加载 */
			 	$scope.loadData=function(attrJson,companyCode,mctCode,proNo,searchName){
				
					var paramsData={"companyCode":companyCode, 
							"proNo":proNo,
							"attrJson":attrJson, "searchName":searchName};
					if(mctCode){
						paramsData["mctCode"]=mctCode;
					}else{
						paramsData["deviceTypeCode"]="01";
					}
									
					$http.get(serviceBasePath+"eap/pmsServices/om/deviceMgr/device/phoneMctDeviceList?attrJson="+attrJson+"&companyCode="+companyCode+"&proNo="+proNo+"&searchName="+searchName+"&mctCode="+mctCode+"&ticket="+ticket).success(function(res){
						if(res.statusCode==200){
							$scope.datalist1 = res.list;
							$scope.datalist1.mctName=mctName;
							$dlog.close();
							//alert($scope.datalist1.mctName)
						}else if(res.statusCode==401){
							window.parent.location.href="../login.html";
						}else{
							alert("服务器访问出错！");
						}
					}).error(function(response){
						$dlog.close();
						new ShowDlog().confirm({
							icon:"error",
							msg:"网络连接失败！",
							ok:function(){
							}
						});
					});
				}; 
				
				$scope.toDetail=function(datacx){
					top.viewTo("pe/diveceSearchDetail.html?deviceObjCode="+datacx.deviceObjCode+"&deviceObjName="+datacx.deviceObjName+
							"&mctCode="+datacx.mctCode+"&companyCode="+datacx.companyCode+"&proName="+datacx.proName+"&mctName="+datacx.mctName);
				};
				
				
			}
		});
		function filter2(obj){
			$(obj).find("img").attr("src","images/task_selete_icon.png");
			$(obj).siblings().find("img").attr("src","images/task_nonselete_icon.png");
		}
		
	</script>
</body>
</html>