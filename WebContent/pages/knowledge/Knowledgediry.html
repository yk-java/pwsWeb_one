<!DOCTYPE HTML>
<html ng-app="orgMgr">
<head>
<title> 组织架构管理</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">

<link rel="stylesheet" type="text/css" href="../../bootstrap-3.3.5-dist/css/bootstrap.min.css"/>

<link rel="stylesheet" href="../../css/zTreeStyle/zTreeStyle.css" type="text/css">
<script type="text/javascript" src="../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../js/jquery.ztree.core-3.5.js"></script>
<script type="text/javascript" src="../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script></head>
<script type="text/javascript" src="../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../js/PageBar.js"></script>
<script type="text/javascript" src="../../js/config.js"></script>
<script type="text/javascript" src="../../js/util.js"></script>
<script type="text/javascript" src="../../js/ng-base.js"></script>

<script type="text/javascript" src="../../js/showDlog/showDlog.js"></script>
<link rel="stylesheet" type="text/css" href="../../js/showDlog/showDlog-blue.css" />

<link rel="stylesheet" type="text/css" href="../../css/list.css"/>
<style type="text/css">

	.list .list_left{position: absolute;left:0px;top:0px;bottom:0px;width:220px;background:#E5F0FF;}
	.list .list_left .left_title{width:100%;height:30px;background:#3385FF;line-height:30px;color:#fff;border-bottom:solid 1px #4CA9FF;}
	.list .list_left .left_operation{width:100%;height:30px;background:#3385FF;line-height:30px;color:#fff;}
	.list .list_left .left_operation .operation1{height:30px;width:72px;border-right:solid 1px #4CA9FF;line-height:28px;text-align: center;color:#fff;float:left;cursor: pointer;}
	.list .list_left .left_operation .operation1 > a{color:#fff;vertical-align: middle;}
	.list .list_left .left_operation .operation2{height:30px;width:72px;line-height:28px;text-align: center;color:#fff;float:left;cursor: pointer;}
	.list .list_left .left_operation .operation2 > a{color:#fff;vertical-align: middle;}
	.list .list_left .left_tree{position: absolute;left:0px;right:0px;bottom:0px;top:60px;border:solid 0px;overflow: auto;}
	.list .list_content{position: absolute;left:230px;right:0px;top:0px;bottom:0px;border:solid 0px;}
	.list .list_content .title_div{width:100%;height:39px;border-bottom:solid 3px #3385FF;}
	.list .list_content .title_div .title_left{min-width:250px;height:39px;background:#3385FF;line-height:42px;color:#fff;font-size:14px;font-weight: bold;float:left;}
	.list .list_content .title_div > img{float:left;margin-top:1px;}
	.list .list_content .title_div .title_add{float:left;width:70px;height:28px;background: url(../../img/bnt_newly-added.png) repeat;line-height:28px;text-align:center;margin-left:30px;margin-top:5px;color:#fff;cursor: pointer;}
	.list .list_content .table_div{left:0px;right:0px;bottom:32px;top:42px;border:solid 0px;}

	.ztree span{font-family:微软雅黑;}

.edit-deptment{width:800px;height:450px;}
</style>

<body ng-controller="orgMgr">

<div class="list">
	<div class="list_left">
		<div class="left_title">
			&nbsp;&nbsp;知识目录架构树
		</div>
		<div class="left_operation">
			<div class="operation1">
				<a href="javascript:" ng-click="toAddDept()"><span class="glyphicon glyphicon-plus-sign"></span>&nbsp;添加</a>
			</div>
			<div class="operation1">
				<a href="javascript:" ng-click="toEditDept()"><span class="glyphicon glyphicon-ok-sign"></span>&nbsp;修改</a>
			</div>
			<div class="operation2">
				<a href="javascript:" ng-click="doDelete()"><span class="glyphicon glyphicon-remove-sign"></span>&nbsp;删除</a>
			</div>
		</div>
		<div class="left_tree">
			<ul id="treeDemo" class="ztree">
					
			</ul>
		</div>
	</div>
	<div class="list_content">
		<div class="title_div">
			<div class="title_left">
				&nbsp;&nbsp;&nbsp;&nbsp;{{name}}
			</div>
			<img src="../../img/list_Header-.png">
<!-- 			<div class="title_add"> -->
<!-- 				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;新增 -->
<!-- 			</div> -->
		</div>
		
		<div class="table_div">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="table">
			   <tr class="tr1">
				<th width="5%"><div align="center">序号</div></th>
				<th width="8%"><div align="center">类别</div></th>
				<th width="10%"><div align="center">数量</div></th>
				<th width="10%"><div align="center">操作</div></th>
			  </tr>
			  <tr class="tr2" ng-repeat="item in dataList">
				<td><div align="center">{{$index+1}}</div></td>
				<td><div align="center">{{item.catalogName}}</div></td>
				<td><div align="center">{{item.num}}</div></td>
				<td>
					<div align="center">
						<img class="operationImg" ng-click="toEdit(item)" src="../../img/list_item_modify-icon.png">
						<img class="operationImg" ng-click="doDel(item)" src="../../img/list_delete-icon.png">
		    		</div>
		    	</td>
			  </tr>
			</table>
		</div>

		<div id="page_bar" class="list_bottom" align="center">
		</div>

	</div>
</div>

<script type="text/javascript">

function createPageBar(totalPage, curPage,totalRecord){
	new PageBar().init({
		renderTo:"#page_bar",
		totalPage:totalPage,
		curPage:curPage,
		totalRecord: totalRecord,
		showPageInfo:true,
		prevPageText:"上一页",
		nextPageText:"下一页",
		onPage:function(pageNum){
			_currentPage=pageNum;
			ngScope.getList(parentCatalogCode,_currentPage);
		}
	});
}

var ngScope;
var _currentPage=1;
var parentCatalogCode="";
var app = simpleController({
	moduleName:"orgMgr",
	controllerName:"orgMgr",
	init:function($scope, $http){
		ngScope = $scope;
		var orgTree;
		
		$scope.name="知识目录管理";
		
		$scope.dataList=[];
		var setting = {
			data: {
				simpleData: {
					enable: true
				}
			},
			callback:{
				onClick:function(){
					var selectedNodes = orgTree.getSelectedNodes();
					//alert(selectedNodes)
					var name=selectedNodes[0].name;
					$scope.name=name;
					parentCatalogCode=selectedNodes[0].id;
					$scope.getList(parentCatalogCode);
					
				}
			}

		};
		$scope.getTree=function(){
			$scope.httpGet({
				url:"eap/pmsServices/km/catalog/catalog/getTreeList",
				data:{"companyCode":$scope.userData.companyCode},
				success:function(res){
					zNodes = res.list;
					orgTree=$.fn.zTree.init($("#treeDemo"), setting, zNodes);
					//$scope.userList = res.list;
					$scope.getList("",_currentPage);
				}
			});
		};
		$scope.getTree();
		
		$scope.getList=function(parentCode,currentPage){
			$scope.httpGet({
				url:"eap/pmsServices/km/catalog/catalog/list",
				data:{"companyCode":$scope.userData.companyCode,"parentCatalogCode":parentCode,"currentPage":currentPage},
				success:function(res){
					//zNodes = res.list;
					//orgTree=$.fn.zTree.init($("#treeDemo"), setting, zNodes);
					//$scope.userList = res.list;
					//console.log($scope.userList);
					$scope.dataList=res.list;
					createPageBar(res.totalPage, res.currentPage,res.totalRecord);
					//alert(res.list.length)
				}
			});
			
		};
		
		
		
		
		
		
		/* 添加目录 */
		 $scope.toAddDept=function(){
			var selectedNodes = orgTree.getSelectedNodes();
			if(!selectedNodes || selectedNodes.length != 1){
				var pname="全部";
				var pid ="";
			}else{
				var pname="";
				var pid = selectedNodes[0].pId;
				if(pid ==-1||pid==null){
					pname="";
				}else{
					var node = orgTree.getNodeByParam("id", selectedNodes[0].pId, null);
					if(node !=null){
						pname=node.name;
					}
				}
			}
			
			
			new ShowDlog().showFrame(
				"knowlistAdd.html?catalogCode="+parentCatalogCode+"&pname="+pname,
				"添加目录",
				function(data){
					if(data=="success"){
						$scope.getTree();
					}
				},
				"edit-deptment"
			);
		}; 
		
		
		
		/* 编辑目录信息 */
		$scope.toEditDept=function(){
			var selectedNodes = orgTree.getSelectedNodes();
			if(!selectedNodes || selectedNodes.length != 1){
				new ShowDlog().prompt({
					msg:"请选择要编辑的目录！",
					done:function(){},
					t:1500
				});
				return;
			}
			//alert(selectedNodes[0].pId)
			var pname="";
			var pid = selectedNodes[0].pId;
			if(pid ==-1||pid==null){
				pname="";
			}else{
				var node = orgTree.getNodeByParam("id", selectedNodes[0].pId, null);
				if(node !=null){
					pname=node.name;
				}
			}
			
			new ShowDlog().showFrame(
				"knowlistEdit.html?catalogCode="+parentCatalogCode+"&pname="+pname,
				"修改目录信息",
				function(data){
					if(data=="success"){
						$scope.getTree();
					}
				},
				"edit-deptment"
			);
		}; 
		/* 删除目录信息 */
		 $scope.doDelete=function(){
			var selectedNodes = orgTree.getSelectedNodes();
			if(!selectedNodes || selectedNodes.length != 1){
				new ShowDlog().prompt({
					msg:"请选择要编辑的目录！",
					done:function(){},
					t:1500
				});
				return;
			}
			// have user?
		/* 			alert(parentCatalogCode) */
			$scope.httpGet({
				url:"eap/pmsServices/km/catalog/catalog/list",
				data:{"parentCatalogCode":parentCatalogCode,"companyCode":$scope.userData.companyCode},
				success:function(res){
					
					if(res.list && res.list.length>0){
						new ShowDlog().prompt({
							icon:"error",
							msg:"请确保目录下无相关信息！",
							done:function(){
								
								
							},
							t:2800
						});
					}else{
						new ShowDlog().confirm({
							msg:"确定删除部门（"+selectedNodes[0].name+"）？",
							ok:function(){
								$scope.httpPost({
									url:"eap/pmsServices/km/catalog/catalog/delete",
									data:{companyCode:$scope.userData.companyCode,catalogCode:parentCatalogCode},
									success:function(res){
										$scope.getTree();
									}
								});
							}
						});
					}
				}
			});
		}; 
		
		
		
		/*table删除目录信息 */
		 $scope.doDel=function(obj){
			$scope.httpGet({
				url:"eap/pmsServices/km/catalog/catalog/list",
				data:{"parentCatalogCode":obj.catalogCode,"companyCode":$scope.userData.companyCode},
				success:function(res){
					
					if(res.list && res.list.length>0){
						new ShowDlog().prompt({
							icon:"error",
							msg:"请确保目录下无相关信息！",
							done:function(){
								
								
							},
							t:2800
						});
					}else{
						new ShowDlog().confirm({
							msg:"确定删除目录（"+obj.catalogName+"）？",
							ok:function(){
								$scope.httpPost({
									url:"eap/pmsServices/km/catalog/catalog/delete",
									data:{companyCode:$scope.userData.companyCode,catalogCode:obj.catalogCode},
									success:function(res){
										location.reload();
									}
								});
							}
						});
					}
				}
			});
		}; 
		
		/* table编辑目录信息 */
		$scope.toEdit=function(obj){			
			//var pname=obj.catalogName;
			var pname="";
			var pid = obj.parentCatalogCode;
			if(pid ==-1||pid==null){
				pname="";
			}else{
				var node = orgTree.getNodeByParam("id", obj.parentCatalogCode, null);
				if(node!=null){
					pname=node.name;
				}
			}
			
			
			
			//alert(pname)
			
			new ShowDlog().showFrame(
				"knowlistEdit.html?catalogCode="+obj.catalogCode+"&pname="+pname+"&catalogName="+obj.catalogName,
				"修改目录信息",
				function(data){
					if(data=="success"){
						location.reload();
					}
				},
				"edit-deptment"
			);
		}; 
		
		
	}
});
</script> 
</body>
</html>
