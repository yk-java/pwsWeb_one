<!DOCTYPE HTML>
<html ng-app="orgMgr">
<head>
<title> 组织架构管理</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">

<link rel="stylesheet" type="text/css" href="../../bootstrap-3.3.5-dist/css/bootstrap.min.css"/>

<link rel="stylesheet" href="../../css/zTreeStyle/zTreeStyle.css" type="text/css">
<script type="text/javascript" src="../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../js/jquery.ztree.core-3.5.js"></script>
<script type="text/javascript" src="../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script></head>
<script type="text/javascript" src="../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../js/PageBar.js"></script>
<script type="text/javascript" src="../../js/config.js"></script>
<script type="text/javascript" src="../../js/util.js"></script>
<script type="text/javascript" src="../../js/ng-base.js"></script>

<script type="text/javascript" src="../../js/showDlog/showDlog.js"></script>
<link rel="stylesheet" type="text/css" href="../../js/showDlog/showDlog-blue.css" />

<link rel="stylesheet" type="text/css" href="../../css/list.css"/>
<style type="text/css">

	.list .list_left{position: absolute;left:0px;top:0px;bottom:0px;width:220px;background:#E5F0FF;}
	.list .list_left .left_title{width:100%;height:30px;background:#3385FF;line-height:30px;color:#fff;border-bottom:solid 1px #4CA9FF;}
	.list .list_left .left_operation{width:100%;height:30px;background:#3385FF;line-height:30px;color:#fff;}
	.list .list_left .left_operation .operation1{height:30px;width:72px;border-right:solid 1px #4CA9FF;line-height:28px;text-align: center;color:#fff;float:left;cursor: pointer;}
	.list .list_left .left_operation .operation1 > a{color:#fff;vertical-align: middle;}
	.list .list_left .left_operation .operation2{height:30px;width:72px;line-height:28px;text-align: center;color:#fff;float:left;cursor: pointer;}
	.list .list_left .left_operation .operation2 > a{color:#fff;vertical-align: middle;}
	.list .list_left .left_tree{position: absolute;left:0px;right:0px;bottom:0px;top:60px;border:solid 0px;overflow: auto;}
	.list .list_content{position: absolute;left:230px;right:0px;top:0px;bottom:0px;border:solid 0px;}
	.list .list_content .title_div{width:100%;height:39px;border-bottom:solid 3px #3385FF;}
	.list .list_content .title_div .title_left{min-width:250px;height:39px;background:#3385FF;line-height:42px;color:#fff;font-size:14px;font-weight: bold;float:left;}
	.list .list_content .title_div > img{float:left;margin-top:1px;}
	.list .list_content .title_div .title_add{float:left;width:70px;height:28px;background: url(../../img/bnt_newly-added.png) repeat;line-height:28px;text-align:center;margin-left:30px;margin-top:5px;color:#fff;cursor: pointer;}
	.list .list_content .table_div{left:0px;right:0px;bottom:32px;top:42px;border:solid 0px;}

	.ztree span{font-family:微软雅黑;}

.edit-deptment{width:800px;height:450px;}
</style>

<body ng-controller="orgMgr">

<div class="list">
	<div class="list_left">
		<div class="left_title">
			&nbsp;&nbsp;组织架构树
		</div>
		<div class="left_operation">
			<div class="operation1">
				<a href="javascript:" ng-click="toAddDept()"><span class="glyphicon glyphicon-plus-sign"></span>&nbsp;添加</a>
			</div>
			<div class="operation1">
				<a href="javascript:" ng-click="toEditDept()"><span class="glyphicon glyphicon-ok-sign"></span>&nbsp;修改</a>
			</div>
			<div class="operation2">
				<a href="javascript:" ng-click="doDelete()"><span class="glyphicon glyphicon-remove-sign"></span>&nbsp;删除</a>
			</div>
		</div>
		<div class="left_tree">
				<ul id="treeDemo" class="ztree"></ul>
		</div>
	</div>
	<div class="list_content">
		<div class="title_div">
			<div class="title_left">
				&nbsp;&nbsp;&nbsp;&nbsp;{{selectedUnit.unitName}}员工管理
			</div>
			<img src="../../img/list_Header-.png">
<!-- 			<div class="title_add"> -->
<!-- 				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;新增 -->
<!-- 			</div> -->
		</div>
		
		<div class="table_div">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="table">
			   <tr class="tr1">
				<th width="5%"><div align="center">序号</div></th>
				<th width="8%"><div align="center">员工姓名</div></th>
				<th width="10%"><div align="center">员工工号</div></th>
				<th width="10%"><div align="center">员工部门</div></th>
			  </tr>
			  <tr ng-repeat="item in userList" class="tr2">
				<td><div align="center">{{$index+1}}</div></td>
				<td><div align="center">{{item.employeename}}</div></td>
				<td><div align="center">{{item.jobNo}}</div></td>
				<td><div align="center">{{item.unitName}}</div></td>
			  </tr>
			</table>
		</div>

		<div id="page_bar" class="list_bottom" align="center">
		</div>

	</div>
</div>

<script type="text/javascript">
var app = simpleController({
	moduleName:"orgMgr",
	controllerName:"orgMgr",
	init:function($scope, $http){
	
		var setting = {
			data:{
				key:{
					name:"unitName"
				},
				simpleData:{
					enable:true,
					idKey:"unitCode",
					pIdKey:"parentUnit",
					rootPid:-1
				}
			},
			callback:{
				onClick:function(){
					var selectedNodes = orgTree.getSelectedNodes();
					var unitCode = selectedNodes[0].unitCode;
					app.ngScope.selectedUnit=selectedNodes[0];
					app.ngScope.loadUsers(unitCode, 1);
				}
			}
		};
		var zNodes ={};
		var orgTree={};

		$scope.selectedUnit={};
		
		/* 查询部门数据 */
		$scope.httpGet({
			url:"eap/pmsServices/sys/orgEmployee/org/orgTree",
			data:{"companyCode":$scope.userData.companyCode},
			success:function(res){
				if(res.statusCode==200){//alert(res.tree);
					zNodes.unitName=$scope.userData.companyName;
					zNodes.unitCode="0";
					zNodes.parentUnit="-1";
// 					zNodes.children=res.tree;
					zNodes.open=true;
					zNodes.icon="../../img/comp.png";
					for(var i in res.tree){
						var node = res.tree[i];
						node.icon="../../img/dept.png";
					}
					res.tree.push(zNodes);
					orgTree = $.fn.zTree.init($("#treeDemo"), setting, res.tree);
					$scope.loadUsers(res.tree[0].unitCode, 1);
					$scope.selectedUnit=res.tree[0];
				}
			}
		});
		/* 查询部门下人员 */
		$scope.loadUsers=function(unitCode, currentPage){//alert(unitCode);
			$scope.httpGet({
				url:"eap/pmsServices/sys/orgEmployee/employee/list",
				data:{"companyCode":$scope.userData.companyCode,"unitCode":unitCode,"workStatus":1},
				success:function(response){
					$scope.userList = response.list;
				},
				pageChange:function(pageNum){
					$scope.loadUsers($scope.selectedUnit.unitCode, pageNum);
				}
			});
		};
		/* 添加部门 */
		$scope.toAddDept=function(){
			new ShowDlog().showFrame(
				"deptmentAdd.html",
				"添加部门",
				function(data){
					if(data=="success"){
						location.reload();
					}
				},
				"edit-deptment"
			);
		};
		/* 编辑部门信息 */
		$scope.toEditDept=function(){
			var selectedNodes = orgTree.getSelectedNodes();
			if(!selectedNodes || selectedNodes.length != 1){
				new ShowDlog().prompt({
					msg:"请选择要编辑的部门！",
					done:function(){},
					t:1500
				});
				return;
			}
			new ShowDlog().showFrame(
				"deptmentEdit.html?unitCode="+$scope.selectedUnit.unitCode,
				"修改部门信息",
				function(data){
					if(data=="success"){
						location.reload();
					}
				},
				"edit-deptment"
			);
		};
		/* 删除部门信息 */
		$scope.doDelete=function(){
			var selectedNodes = orgTree.getSelectedNodes();
			if(!selectedNodes || selectedNodes.length != 1){
				new ShowDlog().prompt({
					msg:"请选择要编辑的部门！",
					done:function(){},
					t:1500
				});
				return;
			}
			// have user?
			$scope.httpGet({
				url:"eap/pmsServices/sys/orgEmployee/employee/list",
				data:{
					"unitCode":$scope.selectedUnit.unitCode,
					"companyCode":$scope.userData.companyCode
					},
				success:function(res){
					if(res.list && res.list.length>0){
						new ShowDlog().prompt({
							icon:"error",
							msg:"请确保部门下无人员信息！",
							done:function(){},
							t:2800
						});
					}else{
						new ShowDlog().confirm({
							msg:"确定删除部门（"+$scope.selectedUnit.unitName+"）？",
							ok:function(){
								$scope.httpPost({
									url:"eap/pmsServices/sys/orgEmployee/org/delete",
									data:{"unitCode":$scope.selectedUnit.unitCode},
									success:function(res){
										location.reload();
									}
								});
							}
						});
					}
				}
			});
		};
	}
});
</script>
</body>
</html>
