<!DOCTYPE HTML>
<html ng-app="orgMgr">
<head>
<title> 组织架构管理</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<link rel="stylesheet" href="../../../css/zTreeStyle/zTreeStyle.css" type="text/css">
<script type="text/javascript" src="../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../js/jquery.ztree.core-3.5.js"></script>
<script type="text/javascript" src="../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../js/PageBar.js"></script>
<script type="text/javascript" src="../../../js/config.js"></script>
<script type="text/javascript" src="../../../js/util.js"></script>
<script type="text/javascript" src="../../../js/ng-base.js"></script>

<script type="text/javascript" src="../../../js/showDlog/showDlog.js"></script>
<link rel="stylesheet" type="text/css" href="../../../js/showDlog/showDlog-blue.css" />

<link rel="stylesheet" type="text/css" href="../../../css/list.css"/>
<style type="text/css">
	ul,li{padding:0;margin:0;list-style:none;outline:none}
	.list .list_left{position: absolute;left:0px;top:0px;bottom:0px;width:220px;background:#f2f8ff;}
	.list .list_left .left_title,.list_content .left_title{width:100%;height:30px;background:#3385FF;line-height:30px;color:#fff;border-bottom:solid 1px #4CA9FF;}
	.list_content .left_title{width:220px}
	.list .list_left .left_operation{width:100%;height:30px;background:#3385FF;line-height:30px;color:#fff;}
	.list .list_left .left_operation .operation1{height:30px;width:72px;border-right:solid 1px #4CA9FF;line-height:28px;text-align: center;color:#fff;float:left;cursor: pointer;}
	.list .list_left .left_operation .operation1 > a{color:#fff;vertical-align: middle;}
	.list .list_left .left_operation .operation2{height:30px;width:72px;line-height:28px;text-align: center;color:#fff;float:left;cursor: pointer;}
	.list .list_left .left_operation .operation2 > a{color:#fff;vertical-align: middle;}
	.list .list_left .left_tree{position: absolute;left:0px;right:0px;bottom:0px;top:35px;border:solid 0px;overflow: auto;}
	.list .list_content{position: absolute;left:230px;right:0px;top:0px;bottom:0px;border:solid 0px;}
	.list .list_content .title_div{width:100%;height:39px;border-bottom:solid 3px #3385FF;}
	.list .list_content .title_div .title_left{min-width:250px;height:39px;background:#3385FF;line-height:42px;color:#fff;font-size:14px;font-weight: bold;float:left;}
	.list .list_content .title_div > img{float:left;margin-top:1px;}
	.list .list_content .title_div .title_add{float:left;width:70px;height:28px;background: url(../../../img/bnt_newly-added.png) repeat;line-height:28px;text-align:center;margin-left:30px;margin-top:5px;color:#fff;cursor: pointer;}
	.list .list_content .table_div{left:0px;right:0px;bottom:32px;top:42px;border:solid 0px;}

	.ztree span{font-family:微软雅黑;}
	.peoListCZ{float: right;margin-right: 10px;}
	.peoListCZ span{color:#2470dd;background:#fff;padding:3px 8px;cursor:pointer}
	.peoList{position: absolute;left: 0px;right: 0px;bottom: 0px;top: 35px;border: solid 0px;overflow: auto;width:220px;background:#f2f8ff}
	.peoList ul li{line-height:40px;border:1px solid #f2f2f2;text-indent:15px;background:#f7f7f7;color:#333}
	.peoList ul li:hover{background:#fff}
	.userList{position: absolute;width: 220px;top: 0;bottom: 0;}
	.userLevelTable{ position:absolute;left: 234px;right: 0;top: 0;bottom: 0;}
	.edit-deptment{width:800px;height:450px;}
	.dlog-edit{width:500px;height:300px;}
	.dlog-edit2{width:500px;height:350px;}
	.dlog-edit1{width:400px;height:300px;}
</style>

<body ng-controller="orgMgr">

<div class="list">
	<div class="list_left">
		<div class="left_title">
			&nbsp;&nbsp;组织架构树
		</div>
		<div class="left_tree">
			<ul id="treeDemo" class="ztree"></ul>
		</div>
	</div>
	<div class="list_content">
		<div class="userList">
			<div class="left_title">
				&nbsp;&nbsp;人员名单
				<div class="peoListCZ">
					<span style="margin-right:10px" ng-click="falit()">筛选</span>
					<span ng-click="macth()">匹配</span>
				</div>
			</div>
			<div class="peoList">
				<ul id="peoListUl">
					<li ng-repeat="jobName in unitInComeJobName" ng-if="jobName.jobName" >
						{{jobName.jobName}}&nbsp;&nbsp;[{{jobName.jobNum}}]
						<img ng-click="getUnitName(jobName,$index)" style="float:right;margin: 9px 0px 0 0;padding: 10px;cursor:pointer" src="../../../img/open--icon.png">
						<div class="item" id="unitNameDiv_{{$index}}" style="display: none">
							<div   ng-repeat="item in userList" style="position:relative;">
							<a ng-if="item.salaryGrade || (item.isYearlySalary==1 && item.realSalary>0)" style="display:block" href="#" title="薪酬等级：{{salaryGradeNamePrefix}}{{item.salaryGrade}}    薪酬档次：{{item.salaryLevel}}档">
								
								<span>
									<img src="../../../img/haveDo.png" style="margin: 0 4px;"/>
								</span>
								{{item.employeeName}}&nbsp;&nbsp;[{{item.jobNo}}]
							</a>
							<a ng-if="(!item.salaryGrade && item.isYearlySalary==1 && item.realSalary==0) || (!item.salaryGrade && item.isYearlySalary==0)" style="display:block" href="#">
								<span>
									<input ng-click="getPeople(item,$index)" type="checkbox" ng-if="item.isCheck==1" checked="checked">
									<input ng-click="getPeople(item,$index)" type="checkbox" ng-if="item.isCheck!=1 || !item.isChecked">
								</span>
								
								{{item.employeeName}}&nbsp;&nbsp;[{{item.jobNo}}]
							</a>
						</div>
						</div>
					</li>
				</ul>
			</div>
		</div>
		<div class="userLevelTable" >
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="table" id="dataTable">
				<tr class="tr1">
					<td width="100px"><div align="center">薪酬等级  \ 档次</div></td>
					<td ng-repeat="item in salaryLevelArr">
						<div align="center" >{{$index+1}}档</div>
					</td>
				</tr>
				<tr class="tr2" ng-repeat="obj in salaryGradeArr">
					<td><div align="center">{{obj}}</div></td>
					<td ng-repeat="it in salaryLevelArr" align="center" style="position:relative">
						{{unitInComeLevelSet[obj][it].length}}
						<div ng-if="unitInComeLevelSet[obj][it].length>0" style="position:absolute;right:-3px;bottom:-3px;">
							<img src="../../../img/arrow2.png" alt="点击查看" ng-click="showPeople(obj,it)" title="点击查看" style="width:70%;cursor:pointer"/>
						</div>
					</td>
				</tr>
			</table>
		</div>
	</div>
</div>

<script type="text/javascript">

var proNo="";
var employeeName="";
var salaryGradeConfigStatus="";

var app = simpleController({
	moduleName:"orgMgr",
	controllerName:"orgMgr",
	init:function($scope, $http){
	
		var setting = {
			data:{
				key:{
					name:"unitName"
				},
				simpleData:{
					enable:true,
					idKey:"unitCode",
					pIdKey:"parentUnit",
					rootPid:-1
				}
			},
			callback:{
				onClick:function(){
					var selectedNodes = orgTree.getSelectedNodes();
					var unitCode = selectedNodes[0].unitCode;
					app.ngScope.selectedUnit=selectedNodes[0];
					proNo="";
					employeeName="";
					salaryGradeConfigStatus="";
					
					app.ngScope.getUnitInComeJobName(unitCode,proNo,employeeName,salaryGradeConfigStatus)
					app.ngScope.getUnitInCome(unitCode);
					unitCodeforMacth=unitCode;
					
					
				}
			}
		};
		var zNodes ={};
		var orgTree={};
		var unitCodeforMacth={}
		$scope.selectedUnit={};
		
		
		
		/* 查询部门数据 */
		$scope.httpGet({
			url:"eap/pmsServices/sys/orgEmployee/org/orgTree",
			data:{"companyCode":$scope.userData.companyCode},
			success:function(res){
				if(res.statusCode==200){//alert(res.tree);
					zNodes.unitName=$scope.userData.companyName;
					zNodes.unitCode="0";
					zNodes.parentUnit="-1";
// 					zNodes.children=res.tree;
					zNodes.open=true;
					zNodes.icon="../../../img/comp.png";
					for(var i in res.tree){
						var node = res.tree[i];
						node.icon="../../../img/dept.png";
					}
					res.tree.push(zNodes);
					orgTree = $.fn.zTree.init($("#treeDemo"), setting, res.tree);
					
					$scope.getUnitInCome(res.tree[0].unitCode);
					$scope.selectedUnit=res.tree[0];
					$scope.getUnitInComeJobName(res.tree[0].unitCode,proNo,employeeName,salaryGradeConfigStatus);
					unitCodeforMacth=res.tree[0].unitCode;
					var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
					var node = treeObj.getNodeByParam("rowid", res.tree[0].unitCode, null);
					treeObj.selectNode(node);
				}
			}
		});
		/* 获取部门薪酬体系信息 */
		$scope.unitInComeList={};
		var frameworkCode="";
		var salaryGradeNamePrefix="";
		$scope.salaryGradeArr=[];
		$scope.salaryLevelArr=[];
		$scope.getUnitInCome=function(unitCode){
			$scope.httpGet({
				url:"eap/pmsServices/hrm/salMgr/salaryFramwork/unitEnableSalaryFramwork",
				data:{"companyCode":$scope.userData.companyCode,"unitCode":unitCode},
				success:function(res){
					if(res.statusCode==200){
						$("#dataTable").show();
						$scope.unitInComeList=res.data;
						frameworkCode=$scope.unitInComeList.frameworkCode;
						salaryGradeNamePrefix=$scope.unitInComeList.salaryGradeNamePrefix;
						$scope.salaryGradeNamePrefix=salaryGradeNamePrefix;
						$scope.getUnitInComeLevelSet(unitCode,frameworkCode,salaryGradeNamePrefix);
						for(var i=$scope.unitInComeList.salaryGrade;i>=$scope.unitInComeList.salaryGradeStart;i--){
							$scope.salaryGradeArr.push($scope.unitInComeList.salaryGradeNamePrefix+i);
						}
						for(var i=1;i<=$scope.unitInComeList.salaryLevel;i++){
							$scope.salaryLevelArr.push("D"+i);
						}
					}
					else{
						$("#dataTable").hide();
					}
				}
			});
		};
		/* 获取部门薪酬等级设置 */
		$scope.unitInComeLevelSet={};
		$scope.getUnitInComeLevelSet=function(unitCode,frameworkCode,salaryGradeNamePrefix){
			$scope.httpGet({
				url:"eap/pmsServices/hrm/salMgr/salaryFramwork/unitSalarySetting",
				data:{"companyCode":$scope.userData.companyCode,"unitCode":unitCode,"frameworkCode":frameworkCode,"salaryGradeNamePrefix":salaryGradeNamePrefix},
				success:function(res){
					if(res.statusCode==200){
						$scope.unitInComeLevelSet=res.data;
					}
				}
			});
		};
		
		/* 获取岗位名称 */
		$scope.getUnitInComeJobName=function(unitCode,proNo,employeeName,salaryGradeConfigStatus){
			
			
			$scope.httpGet({
				url:"eap/pmsServices/hrm/salMgr/salaryFramwork/getJobNums",
				data:{"companyCode":$scope.userData.companyCode,"unitCode":unitCode,"proNo":proNo,"employeeName":employeeName,"salaryGradeConfigStatus":salaryGradeConfigStatus},
				success:function(res){
					if(res.statusCode==200){
						$scope.unitInComeJobName=res.list;
					}
				}
			});
		};
		var clickIndex="";
		var clickobj={};
		var ulHeight;
		$scope.getUnitName=function(obj,index){
			clickIndex=index;
			clickobj.jobCode=obj.jobCode;
			ulHeight = document.getElementById("peoListUl").scrollHeight;
			$(".item").hide();
			//if(!$("#unitNameDiv_"+index).attr("flag")){
				
				$scope.loadUsers(unitCodeforMacth,proNo,employeeName,salaryGradeConfigStatus,obj.jobCode);
				$("#unitNameDiv_"+index).show();	
				
				 //document.getElementById('peoListUl').scrollTop=ulHeight+"px";
			/* }else{
				$("#unitNameDiv_"+index).hide();	
				$("#unitNameDiv_"+index).attr("flag",2);
			} */
		};
		
		
		
		
		/* 查询部门下人员 */
		$scope.userList={};
		$scope.loadUsers=function(unitCode,proNo,employeeName,salaryGradeConfigStatus,jobCode){
			new ShowDlog().prompt({
				icon:"waitting",
				msg:"正在查询...",
				done:function(){},
				t:60*1000
			});
			$scope.httpGet({
				url:"eap/pmsServices/hrm/salMgr/salaryFramwork/unitEmloyeeList",
				data:{"companyCode":$scope.userData.companyCode,"unitCode":unitCode,"proNo":proNo,"employeeName":employeeName,"salaryGradeConfigStatus":salaryGradeConfigStatus,"jobCode":jobCode},
				success:function(response){
					$dlog.close();
					$scope.userList = response.list;
					$('.peoList').scrollTop(ulHeight);
				}
			});
		};
		/* 管理角色匹配 */
		$scope.macth=function(){
			var peopleCode="";
			var peopleName="";
			for(var i=0;i<$scope.userList.length;i++){
				if($scope.userList[i].isChecked==1){
					if(peopleCode.length>0){
						peopleCode+=","
					}
					peopleCode+=$scope.userList[i].employeeCode;
					if(peopleName.length>0){
						peopleName+=","
					}
					peopleName+=$scope.userList[i].employeeName;
				}
			}
			if(peopleCode){
				new ShowDlog().showFrame("orgIncomeSet.html?peopleCode="+peopleCode+"&unitCodeforMacth="+unitCodeforMacth, "管理角色匹配-"+peopleName, function(res){
					if("SUCCESS"==res){
						//$scope.getUnitInComeJobName(unitCodeforMacth,proNo,employeeName,salaryGradeConfigStatus);
						$scope.getUnitName(clickobj,clickIndex);
						$scope.getUnitInComeLevelSet(unitCodeforMacth,frameworkCode,salaryGradeNamePrefix)
					}
				}, "dlog-edit");
			}else{
				new ShowDlog().prompt({
					icon:"warning",
					msg:"请选择人员",
					done:function(){
						hrefTo({
						});
					},
					t:1500
				});

			}
		};
		/* 选择人员 */
		$scope.getPeople=function(item,index){
			if($scope.userList[index].isChecked!=1 || !$scope.userList[index].isChecked){
				$scope.userList[index].isChecked=1;
			}else{
				$scope.userList[index].isChecked=2;
			}
		};
		$scope.falit=function(){
			new ShowDlog().showFrame("orgIncomeSetFalit.html", "人员筛选", function(res){
				if("SUCCESS"==res.resultCode){
					callNgFn({
						ctrlEl:$("body")[0],
						ngFn:function(scope){
							
							//alert(res.formData.proNo +"|" +res.formData.userName+"|"+res.formData.salaryGradeConfigStatus)
							
							 proNo=res.formData.proNo;
							 employeeName=res.formData.userName;
							 salaryGradeConfigStatus=res.formData.salaryGradeConfigStatus;
							
							 scope.getUnitInComeJobName(unitCodeforMacth,proNo,employeeName,salaryGradeConfigStatus);
							 
							 scope.loadUsers(unitCodeforMacth,proNo,employeeName,salaryGradeConfigStatus,null)
						}
					});
				}
			}, "dlog-edit2");
		};
		
		/* 点击查看该档次人员 */
		$scope.showPeople=function(obj,it){
			
			new ShowDlog().showFrame("showSetPeople.html?frameworkCode="+frameworkCode+"&unitCodeforMacth="+unitCodeforMacth+"&salaryGradeNamePrefix="+salaryGradeNamePrefix+"&obj="+obj+"&it="+it, "阶段人员查看", function(res){
				if("SUCCESS"==res){
					
					$scope.getUnitInComeLevelSet(unitCodeforMacth,frameworkCode,salaryGradeNamePrefix);
					$scope.loadUsers(unitCodeforMacth,proNo,employeeName,salaryGradeConfigStatus,null);
				}
			}, "dlog-edit1");
		}
	}
});
</script>
</body>
</html>
