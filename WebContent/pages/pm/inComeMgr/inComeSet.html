<!DOCTYPE HTML>
<html>
<head>
<title>薪酬管理</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<script type="text/javascript" src="../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../js/PageBar.js"></script>
<script type="text/javascript" src="../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../../js/DropDownList-1.2/DropDownList.css" />
<script type="text/javascript" src="../../../js/config.js"></script>
<script type="text/javascript" src="../../../js/util.js"></script>
<script type="text/javascript" src="../../../js/Calendar.js"></script>
<script type="text/javascript" src="../../../js/showDlog/showDlog.js"></script>
<link rel="stylesheet" type="text/css" href="../../../js/showDlog/showDlog-blue.css" />
<link rel="stylesheet" type="text/css" href="../../../css/list.css" />
<link rel="stylesheet" type="text/css" href="../../../css/validate.css"/>
<script type="text/javascript" src="../../../js/eapJs/plugins/eap.validate.js"></script>
<script type="text/javascript" src="../../../js/eapJs/core/eap.core.js" ></script>
<script type="text/javascript" src="../../../js/eapJs/plugins/eap.tip.js" ></script>
<script type="text/javascript" src="../../../js/eapJs/plugins/eap.validate.js"></script>
<script type="text/javascript" src="../../../js/eapJs/local/eap.lang-zh_CN.js"></script>
<style type="text/css">
	.title_tabs{list-style-type:none;padding:0;margin:0;height:39px;}
	.title_tabs li{position:relative;padding:0;margin:0;border:solid 0px;float:left;height:39px;background:#E1E1E1;}
	.title_tabs li>a{display:block;line-height:39px;border:solid 0px;padding:0 70px 0 50px;margin-right:-14px;
		background:url(../../../img/list_Header2-gray.png) right no-repeat;color:#666;font-size:14px;font-weight:bold;}
	.title_tabs li.selected{background:#4CA9FF;z-index:9;}
	.title_tabs li.selected>a{background:url(../../../img/list_Header2-.png) right no-repeat;color:#fff;font-size:14px;font-weight:bold;}
	.dlog-edit{width:500px;height:420px;}
	.list .list_content .title_div{border-bottom: solid 3px #4CA9FF;}
	.list .list_content .title_div .title_left{background:none;color:#333;}
	.list .list_content .title_div span{color:#333;float:left}
	.excSave{float:right !important;border:1px solid #ed7798;color:#ed7798 !important;border-radius:15px;padding:5px 20px;cursor:pointer;line-height:normal;margin-top: 5px;}
	.excSave:hover{background:#f7bacb;color:#fff}
</style>
</head>

<body ng-app="userMgr" ng-controller="userMgrCtrl">
<div class="list">
	<div class="list_content">
	
	
		<div class="title_div" style="background:#f4f4f4">
			<div class="title_left">
				<div style="line-height:40px;">
					<span style="text-indent:15px">部门：{{unitName}}</span><span style="margin-left:100px">标题：{{title}}</span>
				</div>
			</div>
		
			<span class="title_back" style="float:right;margin-right:30px" ng-click="goBack()">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;返回
			</span>
			<span ng-click="saveDo()" class="excSave" >保存</span>
		</div>
		<div class="table_div">
			<form id="saveForm">
				<table width="100%" border="0" cellspacing="0" cellpadding="0" class="table" id="dataTable">
				  <tr class="tr1">
					<td width="100px"><div align="center">薪酬等级  \ 档次</div></td>
					<td ng-repeat="item in salaryLevelArr">
						<div align="center" >{{$index+1}}档</div>
					</td>
				  </tr>
				  <tr class="tr2" ng-repeat="obj in salaryGradeArr">
					<td><div align="center">{{obj}}</div></td>
					<td ng-repeat="it in salaryLevelArr"><div align="center">
						 <input style="width:100px;border:1px dashed #ddd;line-height:25px;text-align:center" type="text" class="required number" name="{{obj}}_{{it}}" ng-model="salarySetting[obj][it]"></div>
					</td>
				  </tr>
				</table>
			</form>
		</div>
	</div>
</div>
</body>
<script type="text/javascript">
var ngScope;
var app = angular.module("userMgr", []);
app.controller("userMgrCtrl", function($scope, $http){
	/* init */
	ngScope = $scope;
	var userDataStr = $.cookie("pmsWeb_user_data");
	if(!userDataStr){
		window.noLogin(location.href);
		return;
	}
	var userData = jQuery.parseJSON(userDataStr);
	var companyCode=userData.companyCode;
	
	ticket = $.cookie("pmsWeb_ticket");
	var urlParams = getUrlParams();
	$scope.title=urlParams.title;
	$scope.unitName=urlParams.unitName;
	var salaryGradeNamePrefix="";
	var salaryGradeStart="";
	var salaryGrade="";
	var salaryLevel="";
	$scope.salaryGradeArr=[];
	$scope.salaryLevelArr=[];
	var salarySetting={};
	$scope.salarySetting={};
	$scope.getData=function(){
		$http.get(serviceBasePath+"eap/pmsServices/hrm/salMgr/salaryFramwork/salaryFramworkDetail?companyCode="+companyCode+"&unitCode="+urlParams.unitCode+"&frameworkCode="+urlParams.frameworkCode).success(function(response){
			if(response.statusCode==200){
				$scope.userList=response.data;
				salarySetting=$scope.userList.salarySetting;
				$scope.salarySetting=salarySetting;
				salaryGradeNamePrefix=$scope.userList.salaryGradeNamePrefix;
				salaryGradeStart=$scope.userList.salaryGradeStart;
				salaryGrade=$scope.userList.salaryGrade;
				salaryLevel=$scope.userList.salaryLevel;
				for(var i=salaryGrade;i>=salaryGradeStart;i--){
					$scope.salaryGradeArr.push(salaryGradeNamePrefix+i);
				}
				for(var i=1;i<=salaryLevel;i++){
					$scope.salaryLevelArr.push("D"+i);
				}
			}
		});
	};
	$scope.getData();
	$scope.goBack=function(){
		new ShowDlog().confirm({
			msg:"确定放弃本次编辑？",
			ok:function(){
				window.history.back();
			}
		});

		
	};
	var item="";
	var it="";
	var salarys ="";
	
	/* 表单验证 */
	validator = $("#saveForm").validate({
		onsubmit: false,
		focusInvalid: false,
		focusCleanup: true,
		errorElement: "span",
		ignore:".ignore",
		invalidHandler: function(form, validator) {
			var errors = validator.numberOfInvalids();
			if (errors) {
				
			} 
		}
	});

	
	$scope.saveDo=function(){
		if($("#saveForm").valid()){
			for(var i=0;i<$scope.salaryGradeArr.length;i++){
				item=$scope.salaryGradeArr[i];
				for(var j=0;j<$scope.salaryLevelArr.length;j++){
					it=$scope.salaryLevelArr[j];
					if(salarys.length>0){
						salarys+=";";
					}
					var str="";
					if(salarySetting[item]){
						if(salarySetting[item][it]){
							str=salarySetting[item][it];
						}else{
							str="0";
						}
					}
					salarys+=item+","+it+","+str;
					
				}
			}
			$http.post(serviceBasePath+"eap/pmsServices/hrm/salMgr/salaryFramwork/insertFrameworkSetting?companyCode="+companyCode+"&unitCode="+urlParams.unitCode+"&frameworkCode="+urlParams.frameworkCode+"&salarys="+salarys).success(function(response){
				if(response.statusCode=="200"){
					new ShowDlog().prompt({
						icon:"success",
						msg:"保存成功！",
						done:function(){
							$scope.getData();
						},
						t:1500
					});
				}
			});		
		}
	}
});
</script>
</html>
