<!DOCTYPE HTML>
<html>
<head>
<title> 类型管理</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<script type="text/javascript" src="../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script></head>
<script type="text/javascript" src="../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../js/PageBar.js"></script>
<script type="text/javascript" src="../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../../js/DropDownList-1.2/DropDownList.css" />
<script type="text/javascript" src="../../../js/Calendar.js"></script>
<script type="text/javascript" src="../../../js/config.js"></script>
<script type="text/javascript" src="../../../js/eapJs/core/eap.core.js" ></script>
<script type="text/javascript" src="../../../js/eapJs/plugins/eap.tip.js" ></script>
<script type="text/javascript" src="../../../js/eapJs/plugins/eap.validate.js"></script>
<script type="text/javascript" src="../../../js/eapJs/local/eap.lang-zh_CN.js"></script>
<link rel="stylesheet" type="text/css" href="../../../css/validate.css"/>
<link rel="stylesheet" type="text/css" href="../../../css/edit.css"/>
<script type="text/javascript" src="../../../js/util.js"></script>
<script type="text/javascript" src="../../../js/time.js"></script>
<script type="text/javascript" src="../../../js/showDlog/showDlog.js"></script>
<script type="text/javascript" src="../../../js/jquery.form.js"></script>
<link rel="stylesheet" type="text/css" href="../../../js/showDlog/showDlog-blue.css" />

<style type="text/css">
	.table1{display: none}
	.sel{width:204px;height:26px;font-family: '微软雅黑';line-height:24px;font-size:12px;}
	.loading{position: absolute;top:0px; right:0px; left:0px;right:0px;bottom:0px;background:red;z-index: 9999;
	
	background-color:#333;
filter:alpha(opacity=50); 
-moz-opacity:0.5; 
opacity:0.5;
text-align: center;
display: none
	}
	.loadingimg{margin-top:20%;width:90px;height:90px;}
</style>
</head>

<body ng-app="userMgr" ng-controller="userMgrCtrl">

<div class="list">

	
	<div class="list_content">
		<div class="title_div">
			<div class="title_left">
				<label class="title">创建文件</label>
			</div>
			<img src="../../../img/list_Header2-.png">
		</div>
		<div class="tabs">
			<a href="#lay1" class="tab selected">文件属性</a>
			
		</div>
		<form id="saveForm" class="required-validate">
		<div class="form_div" id="lay1">
			<table>
				<tr>
					<th >文件名称</th>
					<td>
						<input type="text" name="title" class="readonly" readonly="readonly" />
						<input type="hidden" name="companyCode"  />
						
					</td>
					<th >材料日期</th>
					<td>
						
						<input type="text" name="uploadDate" class="required dateComponent required" onclick="new Calendar().show(this)" placeholder="请选择上传日期" onchange="loadFilename()" />
					</td>
				</tr>
				<tr>
					<th >项目类别</th>
					<td>
						<input type="text" name="assetClassName" class="proType dropDownList" placeholder="请选择"/>
					</td>
					<th style="width:100px">项目</th>
					<td>
						<input type="text" name="proNoName"  class="dropDownTree dropDownList required" placeholder="请选择"/>
						<input type="hidden" name="proNo"/>
					</td>
				</tr>
				
				<tr>
					<th>文档类型</th>
					<td>
						<input type="text" name="docTypelibName" class="fileType dropDownList required" placeholder="请选择" />
						<input type="hidden" name="docTypelibCode"/>
					</td>
					<th>选择文件</th>
					<td><input type="file" class="customvalid" customvalid="onCustomvalid" customMessage="{customvalid:'只支持word、ppt、excel、pdf的文件'}"  name="projDoc" onchange="loadFilename()" /></td>
					
				</tr>
				<tr>
					<th >备注</th>
					<td colspan="3">
						
						<textarea rows="4" cols="83" name="remarks"></textarea>
						
					</td>
					
				</tr>
			</table>
			
		

		<div class="form_bottom">
			<a href="javascript:" ng-click="onSave()" class="title_save">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;保存
			</a>
			<a href="javascript:" ng-click="onCancel()" class="title_cancel">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;取消
			</a>
		</div>
		</form>
	</div>
</div>
<script type="text/javascript">

var validator;
var ngScope;
var userData;
var isSave=false;
function loadFilename(){
	
	
	var uploadDate=$("input[name=uploadDate]").val();
	if(uploadDate==""){
		return false;
	}
	uploadDate=uploadDate.replace(/-/g, "/");
	
	var proNoName=$("input[name=proNoName]").val();
	if(proNoName==""){
		return false;
	}
	var docTypelibName=$("input[name=docTypelibName]").val();
	if(docTypelibName==""){
		return false;
	}
	//alert(filename1);
	var str=proNoName.split(",");
	var title="";
	for(var i=0;i<str.length;i++){
		title+=uploadDate+"_"+str[i]+"_"+docTypelibName+",";
	}
	title=title.substring(0,title.length-1);
	
	$("input[name=title]").val(title);
}


	function onCustomvalid(value) {
		
		
		var type=value.substring(value.lastIndexOf("."));
		
		type=type.toLocaleLowerCase();
		
		
		 var strRegex = "(.pdf|.doc|.docx|.ppt|.xls|.xlsx|.pptx)$"; 
		  var re=new RegExp(strRegex);
		  if (re.test(type)){
		    return true;
		  } else{
		    //salert("文件名不合法"); 
		    return false;
		  }
  
		
	}
	


var cond_categoryCode="";

var docClass="";

var app = angular.module("userMgr", []);
app.controller("userMgrCtrl", function($scope, $http){
	/* init */
	ngScope = $scope;
	$scope.curUnit={};
	$scope.userList=[];
	
	var mydate = new Date();
	//alert(mydate.getFullYear()+"-"+(mydate.getMonth()+1)+"-"+mydate.getDate());
	
	$("input[name=datePurchase]").val(mydate.getFullYear()+"-"+(mydate.getMonth()+1)+"-"+mydate.getDate());
	$("input[name=dateStorage]").val(mydate.getFullYear()+"-"+(mydate.getMonth()+1)+"-"+mydate.getDate());
	
	
	$("input[name=uploadDate]").val(getCurrentDate());
	
	var userDataStr = $.cookie("pmsWeb_user_data");
	if(!userDataStr){
		
		noLogin(location.href);
		return;
	}
	userData = jQuery.parseJSON(userDataStr);
	ticket = $.cookie("pmsWeb_ticket");
	
	/* 视图渲染 */
	$(".tabs>a").each(function(){
		var layId = $(this).attr("href");
		var idx = $(".tabs>a").index($(this));
		if(idx!=0){
			$(layId).hide();
			$(layId).attr("data-show", "0");
		}else{
			$(layId).attr("data-show", "1");
		}
		$(this).click(function(){
			$(".tabs>.selected").removeClass("selected");
			$(this).addClass("selected");
			var layId = $(this).attr("href");
			$("div[data-show=1]").hide();
			$("div[data-show=1]").attr("data-show", "0");
			$(layId).show();
			$(layId).attr("data-show", "1");
			
		});
	});
	
	var params = getUrlParams();
	
	docClass=params.docClass;
	
	
	
	
	/* 表单验证 */
	validator = $("#saveForm").validate({
		onsubmit: false,
		focusInvalid: false,
		focusCleanup: true,
		errorElement: "span",
		ignore:".ignore",
		invalidHandler: function(form, validator) {
			var errors = validator.numberOfInvalids();
			if (errors) {
				
			} 
		}
	});
	
	var proUrl="../../component/projectListCheck.html";
	if(docClass==2 || docClass=='2'){
		proUrl="../../component/allCheckProjectList.html";
	}
	
	/* 项目类型 */
	new DropDownList().init({
		renderTo:".proType",
		url:"../../component/projectType.html?required=false&ticket="+ticket,
		height:"200px",
		onSelected:function(result){
			$(".proType").val(result.categoryName);
			cond_categoryCode = result.categoryCode;
			//var dpdlst_project = new DropDownList();
			projectListCheckList.setConfig("url", proUrl+"?categoryCode="+cond_categoryCode);
		}
	});
	
	
	//projectListCheck  allProjectList
	
	
	/* 项目列表 */
		var projectListCheckList = new DropDownList();
		projectListCheckList.init({
				renderTo:".dropDownTree",
				url:proUrl+"?categoryCode="+cond_categoryCode,
				height:"200px",
				onSelected:function(results){
					var proNos=[];
					var proNames=[];
					for(var i=0; i<results.length; i++){
						var item = results[i];
						proNos.push(item.proNo);
						proNames.push(item.proName);
					}
					//$("#projectList").val(arrToStr(proNames));
					//cond_proNos=arrToStr(proNos);
				
					$("input[name=proNoName]").val(arrToStr(proNames));
					$("input[name=proNo]").val(arrToStr(proNos));
					
					loadFilename();
				}
			});
	
	/* 项目文档类型 */
	new DropDownList().init({
		renderTo:".fileType",
		url:"../../component/fileType.html?required=false&docClass="+docClass,
		height:"200px",
		onSelected:function(result){
			//$(".fileType").val(result.name);
			
			$("input[name=docTypelibName]").val(result.name);
			$("input[name=docTypelibCode]").val(result.code);
			
			loadFilename();
			//fileNo=result.code;
		}
	});
	
	
	/* 保存 */
	$scope.onSave = function(){
			//	$("input[name=companyCode]").val();
				$("input[name=companyCode]").val(userData.companyCode);
				//var formData = $("#saveForm").serialize();
				if($("#saveForm").valid()){
					if(!isSave){
						isSave=true;
					}else{
						new ShowDlog().prompt({
							msg:"不能重复提交",
							done:function(){},
							t:1500
						});
						return;
					}
						var dialog=new ShowDlog();
						dialog.prompt({
							icon:"waitting",
							msg:"文件正在上传及转码...",
							done:function(){},
							t:600000
						});
						
						var options = {
							success: function(responseText, statusText) {
								
								//alert(responseText)
								//alert(responseText.statusCode)
								
								dialog.close();
								if(responseText.statusCode=="200"){
									//var dialog1=;
									new ShowDlog().prompt({
										icon:"success",
										msg:"文件上传成功！",
										done:function(){
											location.href="projectFile.html?docClass="+docClass;
										},
										t:1500
									});
								}else{
									new ShowDlog().prompt({
										icon:"error",
										msg:"文件上传失败！",
										done:function(){
											//location.href="projectFile.html?docClass="+docClass;
											isSave=false;
										},
										t:1500
									});
								}
								
								
								//dialog1.close();
								//$(".loading").hide();
							},      //提交后的回调函数   
							type: "post",               //默认是form的method（get or post），如果申明，则会覆盖  
							dataType: "json",           //html(默认), xml, script, json...接受服务端返回的类型  
							clearForm: false,          //成功提交后，清除所有表单元素的值
							url:serviceBasePath+"eap/pmsServices/pm/projDoc/add",
							error: function(xhr, status, error) {
								console.log(error);
							}
						};
						$("#saveForm").ajaxSubmit(options);

				}
	};
	

	/* 取消 */
	$scope.onCancel = function(){
		
		//location.href="projectFile.html?docClass="+docClass;
		

		hrefTo({
			url:"projectFile.html",
			data:getUrlParams()
		});
		
	};
	
});
</script>
</body>
</html>
