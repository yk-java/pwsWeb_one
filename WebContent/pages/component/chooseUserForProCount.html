<!DOCTYPE HTML>
<html ng-app="orgMgr">
<head>
<title> 人员选择 </title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">

<link rel="stylesheet" type="text/css" href="../../bootstrap-3.3.5-dist/css/bootstrap.min.css"/>

<link rel="stylesheet" href="../../css/zTreeStyle/zTreeStyle.css" type="text/css">
<script type="text/javascript" src="../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../js/jquery.ztree.core-3.5.js"></script>
<script type="text/javascript" src="../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script></head>
<script type="text/javascript" src="../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../js/PageBar.js"></script>
<script type="text/javascript" src="../../js/config.js"></script>
<script type="text/javascript" src="../../js/util.js"></script>
<link rel="stylesheet" type="text/css" href="../../css/list.css"/>
<script type="text/javascript" src="../../js/showDlog/showDlog.js"></script>
<link rel="stylesheet" type="text/css" href="../../js/showDlog/showDlog-blue.css" />

<style type="text/css">

	.list{position: absolute;left:13px;right:13px;top:13px;bottom:10px;border:solid 0px;}
	.list .list_left{position: absolute;left:0px;top:0px;bottom:0px;width:240px;background:#E5F0FF;}
	.list .list_left .left_title{width:100%;height:42px;background:#3385FF;line-height:30px;color:#fff;border-bottom:solid 1px #4CA9FF;}
	.list .list_left .left_title label{display:inline-block;margin-top:5px;}
	.list .list_left .left_tree{position: absolute;left:0px;right:0px;bottom:0px;top:40px;border:solid 0px;overflow: auto;}
	.list .list_content{position: absolute;left:250px;right:0px;top:0px;bottom:0px;border:solid 0px;}
	.list .list_content .title_div{width:100%;height:42px;border-bottom:solid 3px #3385FF;}
	.list .list_content .title_div .title_left{min-width:250px;height:42px;background:#3385FF;line-height:42px;color:#fff;font-size:14px;font-weight: bold;float:left;}
	.list .list_content .title_div > img{float:left;margin-top:1px;}
	.list .list_content .title_div .title_add{float:left;width:70px;height:28px;background: url(../../img/bnt_newly-added.png) repeat;line-height:28px;text-align:center;margin-left:30px;margin-top:5px;color:#fff;cursor: pointer;}
	.list .list_content .table_div{left:0px;right:0px;bottom:32px;top:42px;border:solid 0px;}
	.owWordLoad {text-decoration: underline;color: #0099ff;}
	.owWordload-detail{border:solid 1px #666;background:#ffee99;color:#666;padding:4px 6px 4px 6px;position:absolute;display:none;}
	.left_title{font-family:微软雅黑;font-size:14px;font-weight:bold;}
	.ztree li span{font-family:微软雅黑;}
	.ztree{overflow-x:hidden;}
</style>

<body ng-controller="orgMgr">

<div class="list">
	<div class="list_left">
		<div class="left_title">
			<label>&nbsp;&nbsp;组织架构</label>
		</div>
		<div class="left_tree">
				<ul id="treeDemo" class="ztree"></ul>
		</div>
	</div>
	<div class="list_content">
		<div class="title_div">
			<div class="title_left">
				<label style="float:left;">&nbsp;&nbsp;&nbsp;&nbsp;{{curUnit.unitName}}员工</label>
				<input type="text" name="searchName" style="font-weight:normal;" placeholder="请输入姓名搜索"/>
				<div class="query_div" style="background:#0C64E7;" ng-click="doQuery()">
					查询
				</div>
			</div>
			<img src="../../img/list_Header-.png">
			<div class="title_add" ng-click="ok()">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;确定
			</div>
		</div>
		
		<div class="table_div">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="table">
			   <tr class="tr1">
			   	<th width="2%"><input type="checkbox" name="employeeAll" ng-click="chooseUserAll()"/></th>
				<th width="2%"><div align="center">序号</div></th>
				<th width="5%"><div align="center">员工姓名</div></th>
				<th width="6%"><div align="center">性别</div></th>
				<th width="8%"><div align="center">员工工号</div></th>
				<th width="8%"><div align="center">部门</div></th>
				<th width="20%"><div align="center">参与项目</div></th>
				<th width="5%"><div align="center">操作</div></th>
			  </tr>
			  <tr ng-repeat="item in userList" class="tr2">
			  	<td><input type="checkbox" name="employee" value="{{item.employeecode}}" unitCode="{{item.unitCode}}"  unitName="{{item.unitName}}"  
			  	dataname="{{item.employeename}}" contractPropertyCode ="{{item.contractPropertyCode}}" 
			  	jobCode="{{item.jobCode}}" jobName="{{item.jobName}}" salaryGrade="{{item.salaryGrade}}" salaryLevel="{{item.salaryLevel}}" prefix="{{item.prefix}}" propertyName="{{item.propertyName}}" ng-click="chooseUser(item)"/></td>
				<td><div align="center">{{$index+1}}</div></td>
				<td><div align="center">{{item.employeename}}</div></td>
				<td>
					<div ng-if="item.sex!=0 && item.sex!=1" align="center">-</div>
					<div ng-if="item.sex==0" align="center">男</div>
					<div ng-if="item.sex==1" align="center">女</div>
				</td>
				<td><div align="center">{{item.jobNo}}</div></td>
				<td><div align="center">{{item.unitName}}</div></td>
				<td>
					<span ng-repeat="pro in top2(toArr(item.aboutProName))" align="left" style="margin-left:10px;">{{pro}}</span>
					<div ng-if="toArr(item.aboutProName).length>2" style="display:inline-block;">
						<a href="javascript:" onmouseover="$(this).next().show();" onmouseout="$(this).next().hide();" class="owWordLoad">[查看更多]</a>
						<div class="owWordload-detail">
							<div ng-repeat="pro in after2(toArr(item.aboutProName)) track by $index">{{pro}}</div>
						</div>
					</div>
				</td>
				<th><div align="center"><img ng-click="memberMap(item)" src="../../img/memberMap.png" title="人员地图"></div></th>
			  </tr>
			</table>
		</div>

		<div id="page_bar" class="list_bottom" align="center">
		</div>

	</div>
</div>

<script type="text/javascript">
var setting = {
	data:{
		key:{
			name:"unitName"
		},
		simpleData:{
			enable:true,
			idKey:"unitCode",
			pIdKey:"parentUnit",
			rootPid:-1
		}
	},
	callback:{
		onClick:function(){
			var selectedNodes = orgTree.getSelectedNodes();
			
			//var unitCode = selectedNodes[0].unitCode;
			selectedUnit=selectedNodes[0];
			
			ngScope.loadUsers(selectedNodes[0].unitCode, 1, "");
		}
	}
};
var zNodes ={};
var orgTree={};
var ticket="";
var selectedUnit={};
var searchName="";

function createPageBar(totalPage, curPage){
	new PageBar().init({
		renderTo:"#page_bar",
		totalPage:totalPage,
		curPage:curPage,
		btnCount:10,
		prevPageText:"上一页",
		nextPageText:"下一页",
		onPage:function(pageNum){
			var unitCode = selectedUnit.unitCode;
			var searchName = $("input[name=searchName]").val();
			ngScope.loadUsers(unitCode, pageNum, searchName);
			//$("#currPage").html(pageNum);
		}
	});
}

var ngScope;
var app = angular.module("orgMgr", []);
app.controller("orgMgr", function($scope, $http){
	/* init */
	ngScope = $scope;
	$scope.curUnit={};
	$scope.userList=[];
	
	var urlParams = getUrlParams();
	var params_unitCode = urlParams.unitCode;
	var params_unitName = urlParams.unitName;
	
	var userDataStr = $.cookie("pmsWeb_user_data");
	if(!userDataStr){
		
		noLogin(location.href);
		return;
	}
	var userData = jQuery.parseJSON(userDataStr);
	ticket = $.cookie("pmsWeb_ticket");
	
	$.ajax({
		url:serviceBasePath+"eap/pmsServices/sys/orgEmployee/org/partOrgTree",
		method:"GET",
		cache:false,
		data:{"companyCode":userData.companyCode, "ticket":ticket},
		success:function(res){
			
			if(res.statusCode==200){
				var treeData = res.tree;
				zNodes.unitName="南京量为石信息科技有限公司";
				zNodes.unitCode="0";
				zNodes.parentUnit="-1";
// 				zNodes.children=treeData;
				zNodes.open=true;
				zNodes.icon="../../img/comp.png";
				for(var i in res.tree){
					var node = res.tree[i];
					node.icon="../../img/dept.png";
				}
				treeData.push(zNodes);
				orgTree = $.fn.zTree.init($("#treeDemo"), setting, treeData);
				//var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
				var node = orgTree.getNodeByParam("unitCode",'0', null);
				orgTree.selectNode(node);
				/* if(params_unitCode && params_unitCode.length>0){
					ngScope.loadUsers(res.tree[0].unitCode, 1, "");
					selectedUnit={unitName:params_unitName, unitCode:params_unitCode};
				}else{
					ngScope.loadUsers(res.tree[0].unitCode, 1, "");
					selectedUnit=zNodes;
				} */
				ngScope.loadUsers('0', 1, "");
				selectedUnit=node;
			}else if(res.statusCode==401){
				window.parent.location.href="../login.html";
			}else{
				alert("服务器访问出错！");
			}
		},
		error:function(){
			alert("服务器访问失败！");
		}
	});
	
	$scope.loadUsers=function(unitCode, currentPage, searchName){//alert(unitCode);
		if(unitCode==0){
			unitCode="";
		}
		$http.get(serviceBasePath+"eap/pmsServices/sys/orgEmployee/employee/list?companyCode="+userData.companyCode+"&unitCode="
			+unitCode+"&currentPage="+currentPage+"&searchName="+searchName+"&workStatus=1&ticket="+ticket).success(function(response){
			if(response.statusCode!=200){
				alert("请求服务器失败！");
				return;
			}
			$scope.userList = response.list;
			selectedUser=[];
			$scope.curUnit = selectedUnit;
			createPageBar(response.totalPage, response.currentPage);
		});
	};
	var selectedUser=[];
	
	$scope.chooseUserAll=function(){
		$("input[type=checkbox][name=employee]").click();
	};
	
	/* 选择用户 */
	$scope.chooseUser=function(item){
// 		var chk=$("input[type=checkbox][value="+item.employeecode+"]")[0];
// 		if(chk.checked)
// 			selectedUser.push(item);
// 		else
// 			arrRemove(selectedUser, item);
	};
	

	
	$scope.ok=function(){
		selectedUser=[];
		$("input[type=checkbox][name=employee]").each(function(){
			if($(this)[0].checked){
				var employeecode = $(this).val();
				var employeename = $(this).attr("dataname");
				var unitCode=$(this).attr("unitCode");
				var unitName=$(this).attr("unitName");
				var jobCode=$(this).attr("jobCode");
				var jobName=$(this).attr("jobName");
				var salaryGrade=$(this).attr("salaryGrade");
				var salaryLevel=$(this).attr("salaryLevel");
				var prefix=$(this).attr("prefix");
				var propertyName=$(this).attr("propertyName");
				var contractPropertyCode=$(this).attr("contractPropertyCode");
				var item={};
				item.employeecode = employeecode;
				item.employeename = employeename;
				item.unitName=unitName;
				item.unitCode=unitCode;
				item.jobCode=jobCode;
				item.jobName=jobName;
				item.salaryGrade=salaryGrade;
				item.salaryLevel=salaryLevel;
				item.prefix=prefix;
				item.contractPropertyCode=contractPropertyCode;
				item.propertyName=propertyName;
				selectedUser.push(item);
			}
		});
		parent.$dlog.data=selectedUser;
		parent.$dlog.close();
	};
	
	$scope.doQuery=function(){
		var searchName = $("input[name=searchName]").val();
		this.loadUsers(selectedUnit.unitCode, 1, searchName);
	};
	$scope.toArr=function(pros){
		if(!pros)return;
		var arr = pros.split(",");//alert(arr);
		return arr;
	};
	
	$scope.top2=function(arr){
		var arrN=[];
		if(!arr)return arrN;
		for(var i=0;i<arr.length;i++){
			if(i>1){
				break;
			}
			arrN.push(arr[i]);
		}
		return arrN;
	};
	
	$scope.after2=function(arr){
		var arrN=[];
		for(var i=2;i<arr.length;i++){
			arrN.push(arr[i]);
		}//alert(arrN.length);
		return arrN;
	};
	$scope.memberMap=function(obj){
		//alert(obj.employeecode)
		
		$http.get(serviceBasePath+"eap/pmsServices/memberMove/isManager?employeeCode="+obj.employeecode+"&ticket="+ticket).success(function(response){
				if(response.statusCode!=200){
					alert("请求服务器失败！");
					return;
				}
				if(response.list.length>0){
					//alert("项目负责人")
					/* 生命周期 */	
					new ShowDlog().showFrameFull("../orgEmployee/managerMap1.html?employeeCode="+obj.employeecode, function(){
							
					},"dialog-viewcyle");
				}else{
					//alert("非项目负责人")
					new ShowDlog().showFrameFull("../orgEmployee/employeeMap1.html?employeeCode="+obj.employeecode,  function(){
						
					},"dialog-viewcyle");
				}
				
		});
		
		
	};

	
	
});

window.onkeyup=function(e){
	if(e.keyCode==13){
		ngScope.doQuery();
	}
};
</script>
</body>
</html>
