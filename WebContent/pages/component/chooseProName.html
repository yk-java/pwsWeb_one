<!DOCTYPE HTML>
<html ng-app="orgMgr">
<head>
<title> 项目选择 </title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">

<link rel="stylesheet" type="text/css" href="../../bootstrap-3.3.5-dist/css/bootstrap.min.css"/>

<link rel="stylesheet" href="../../css/zTreeStyle/zTreeStyle.css" type="text/css">
<script type="text/javascript" src="../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../js/jquery.ztree.core-3.5.js"></script>
<script type="text/javascript" src="../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script></head>
<script type="text/javascript" src="../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../js/DropDownList-1.2/DropDownList.css" />
<script type="text/javascript" src="../../js/PageBar.js"></script>
<script type="text/javascript" src="../../js/config.js"></script>
<script type="text/javascript" src="../../js/util.js"></script>
<link rel="stylesheet" type="text/css" href="../../css/list.css"/>
<style type="text/css">

	.list{position: absolute;left:13px;right:13px;top:13px;bottom:10px;border:solid 0px;}
	.list .list_content{position: absolute;left:0;right:0px;top:0px;bottom:0px;border:solid 0px;}
	.list .list_content .title_div{width:100%;height:42px;border-bottom:solid 3px #3385FF;}
	.list .list_content .title_div .title_left{min-width:250px;height:42px;background:#3385FF;line-height:42px;color:#fff;font-size:14px;font-weight: bold;float:left;}
	.list .list_content .title_div > img{float:left;margin-top:1px;}
	.list .list_content .title_div .title_add{float:left;width:70px;height:28px;background: url(../../img/bnt_newly-added.png) repeat;line-height:28px;text-align:center;margin-left:30px;margin-top:5px;color:#fff;cursor: pointer;}
	.list .list_content .table_div{left:0px;right:0px;bottom:32px;top:42px;border:solid 0px;}

	
	.left_title{font-family:微软雅黑;font-size:14px;font-weight:bold;}
	.ztree li span{font-family:微软雅黑;}
	.ztree{overflow-x:hidden;}
</style>

<body ng-controller="orgMgr">

<div class="list">
	<div class="list_content">
		<div class="title_div">
			<div class="title_left">
				<input type="text" id="category" class="dropDownList" placeholder="请选择项目类别"/>
				<input type="text" name="searchName" style="font-weight:normal;" placeholder="请输入关键字搜索"/>
				<div class="query_div" style="background:#0C64E7;" ng-click="doQuery()">
					查询
				</div>
			</div>
			<img src="../../img/list_Header-.png">
			<div class="title_add" ng-click="ok()">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;确定
			</div>
		</div>
		
		<div class="table_div">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="table">
			   <tr class="tr1">
			   	<th width="2%"></th>
				<th width="2%"><div align="center">序号</div></th>
				<th width="5%"><div align="center">地区</div></th>
				<th width="6%"><div align="center">县级市</div></th>
				<th width="8%"><div align="center">项目名称</div></th>
				<th width="8%"><div align="center">项目编号</div></th>
				<th width="8%"><div align="center">负责人</div></th>
				<th width="8%"><div align="center">年份</div></th>
			  </tr>
			  <tr ng-repeat="item in userList" class="tr2">
			  	<td style="vertical-align: middle;"  align="center"><input type="radio" name="employee" value="{{item.proName}}" proCode="{{item.proCode}}" ng-click="chooseUser(item)"/></td>
				<td><div align="center">{{$index+1}}</div></td>
				<td><div align="center">{{item.CITY}}</div></td>
				<td><div align="center">{{item.DISTRICT}}</div></td>
				<td><div align="center">{{item.proName}}</div></td>
				<td><div align="center">{{item.proCode}}</div></td>
				<td><div align="center">{{item.proManager}}</div></td>
				<td><div align="center">{{item.proYear}}</div></td>
			  </tr>
			</table>
		</div>

		<div id="page_bar" class="list_bottom" align="center">
		</div>

	</div>
</div>

<script type="text/javascript">
var ticket="";
var searchName="";
var categoryCode="";
function createPageBar(totalPage, curPage){
	new PageBar().init({
		renderTo:"#page_bar",
		totalPage:totalPage,
		curPage:curPage,
		btnCount:10,
		prevPageText:"上一页",
		nextPageText:"下一页",
		onPage:function(pageNum){
			ngScope.loadUsers(categoryCode,searchName,pageNum);
		}
	});
}

var ngScope;
var app = angular.module("orgMgr", []);
app.controller("orgMgr", function($scope, $http){
	/* init */
	ngScope = $scope;
	$scope.curUnit={};
	$scope.userList=[];
	
	var urlParams = getUrlParams();
	
	var userDataStr = $.cookie("pmsWeb_user_data");
	if(!userDataStr){
		
		noLogin(location.href);
		return;
	}
	var userData = jQuery.parseJSON(userDataStr);
	ticket = $.cookie("pmsWeb_ticket");
	
	 /* 项目分类 */
	new DropDownList().init({
		mode:"page",
		renderTo:"#category",
		url:"projectType.html?ticket="+$scope.ticket,
		height:"200px",
		onSelected:function(result){
			categoryCode=result.categoryCode;
			$("#category").val(result.categoryName);
			$scope.loadUsers(categoryCode,searchName,1);
			//proNameList.setConfig("url", "../../component/projectList.html?categoryCode="+result.categoryCode+"&ticket="+$scope.ticket);
		}
	});
	
	
	$scope.loadUsers=function(categoryCode,searchName,currentPage){//alert(unitCode);
		$http.get(serviceBasePath+"eap/pmsServices/pm/baseMgr/pmBase/getDialogPros?companyCode="+userData.companyCode+"&categoryCode="
			+categoryCode+"&currentPage="+currentPage+"&searchName="+searchName+"&perpage=8&ticket="+ticket).success(function(response){
			if(response.statusCode!=200){
				alert("请求服务器失败！");
				return;
			}
			$scope.userList = response.list;
			createPageBar(response.totalPage, response.currentPage);
		});
	};
	var selectedUser=[];
	$scope.loadUsers(categoryCode,searchName,1);
	$scope.chooseUserAll=function(){
		$("input[type=radio][name=employee]").click();
	};
	
	
	$scope.ok=function(){
		selectedUser=[];
		$("input[type=radio][name=employee]").each(function(){
			if($(this)[0].checked){
				var proName = $(this).val();
				var proCode = $(this).attr("proCode");
				var item={};
				item.proName = proName;
				item.proCode = proCode;
				selectedUser.push(item);
			}
		});
		parent.$dlog.data=selectedUser;
		parent.$dlog.close();
	};
	
	$scope.doQuery=function(){
		searchName = $("input[name=searchName]").val();
		$scope.loadUsers(categoryCode,searchName,1);
	};
});

window.onkeyup=function(e){
	if(e.keyCode==13){
		ngScope.doQuery();
	}
};
</script>
</body>
</html>
