<!DOCTYPE HTML>
<html ng-app="realPosition">
<head>
<title> 实时监控 </title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<script type="text/javascript" src="../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=PL4wfqVofjrMVz7FMaPs8Dts"></script>
<script type="text/javascript" src="../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../../js/DropDownList-1.2/DropDownList.css" />
<script type="text/javascript" src="../../../js/PageBar.js"></script>
<script type="text/javascript" src="../../../js/config.js"></script>
<script type="text/javascript" src="../../../js/SimpleDateFormat.js"></script>
<script type="text/javascript" src="../../../js/ViewState.js"></script>
<script type="text/javascript" src="../../../js/showDlog/showDlog.js"></script>
<link rel="stylesheet" type="text/css" href="../../../js/showDlog/showDlog-blue.css" />
<link rel="stylesheet" type="text/css" href="../../../css/common.css" />
<style type="text/css">
	body{
		margin:0px;
		padding:0px;
		font-size:12px;
		font-family:"微软雅黑";
	}
	a{color:#4D4D4D;text-decoration: none;}

	.list{position: absolute;left:13px;right:13px;top:13px;bottom:10px;border:solid 0px;}
	.list .list_left{position: absolute;left:10px;top:0px;bottom:0px;width:390px;}
	.list .list_left .left_title{width:100%;height:130px;background:#297BE6;}
	.list .list_left .left_title > input{margin:20px 6px 0 6px;}
	.list .list_left .left_title .search_div{width:60px;height:38px;background:#1A4F93;color:#fff;line-height:40px;text-align:center;float:left;margin-left:10px;margin-top:20px;font-size:14px;font-weight: bold;}
	.list .list_left .left_content{position: absolute;left:0px;right:0px;top:130px;bottom:0px;border-bottom:solid 1px #B2D1FF;}
	.list .list_left .left_content .content_table{width:100%;top:0px;bottom:45px;}
	.list .map_div{position: absolute;left:410px;top:0px;bottom:0px;right:0px;border:solid 1px #cccccc;}

	.table,.table td,.table th{border:1px solid #EDEDED;border-collapse:collapse;}
	.tr1{height:40px;background:#D9E9FF;font-family: 微软雅黑;color:#4D4D4D;font-size:12px;font-weight:normal;}
	.tr2{height:40px;background:#fff;font-family: 微软雅黑;color:#4D4D4D;font-size:12px;}
	.tr2:hover{background:#F5F5F5;}
	.tr3{height:40px;background:#F5F5F5;font-family: 微软雅黑;color:#4D4D4D;font-size:12px;}
	.tr3:hover{background:#F5F5F5;}
	.tr4{height:40px;background:#EFD397;font-family: 微软雅黑;color:#4D4D4D;font-size:12px;}
	.operationImg{cursor: pointer;}

	.paging_div{bottom:10px;width:390px;height:22px;;margin:0 auto;border:solid 0px;color:#4D4D4D;text-align:center;margin-top:10px;}
	.dropDownList{background-image:url(../../../img/drop_down_list.png);background-repeat: no-repeat;background-position:right;cursor:pointer;}

#page_bar .page_btn_prev{display:inline-black;border:solid 1px #3385FF;background:#3385FF;color:#fff;margin:0 4px;padding:2px 5px 2px 5px;}
#page_bar .page_btn_next{display:inline-black;border:solid 1px #3385FF;background:#3385FF;color:#fff;margin:0 4px;padding:2px 5px 2px 5px;}
#page_bar .page_btn{display:inline-black;border:solid 1px #3385FF;margin:0 4px;padding:2px 5px 2px 5px;}
#page_bar .selected{font-weight:bold;border:solid 1px #666;background:#666;color:#fff;}

.dlog-showPic{width:1000px;height:500px;}
	
	.table td{cursor:pointer;}
</style>
</head>

<body ng-controller="realPositionCtrl" storagekey="realPosition">
	
	<div class="list">
		<div class="list_left">
			<div class="left_title">
				<input type="text" id="projectList" style="width:180px;" viewstate="proName" class="txt dropDownList" placeholder="请选择项目"/>
				<input type="hidden" viewstate="proNo"/>
				<input type="text" style="width:150px;" name="jobName" viewstate="jobName" class="txt dropDownList" placeholder="请选择职务"/>
				<input type="hidden" name="jobCode" viewstate="jobCode"/>
				<input type="text" name="searchName" style="width:180px;" viewstate="searchName" class="txt" placeholder="姓名搜索"/>
				<input type="button" class="btn" value="查询" ng-click="doQuery()">
			</div>
			<div class="left_content">
				
				<div class="content_table">
					<table width="100%" border="0" cellspacing="0" cellpadding="0" class="table">
					   <tr class="tr1">
						<th><div align="center">序号</div></th>
						<th><div align="center">员工姓名</div></th>
<!-- 						<th><div align="center">员工工号</div></th> -->
						<th><div align="center">组织/部门</div></th>
						<th><div align="center">状态</div></th>
						<th><div align="center">签到</div></th>
						<th><div align="center">签退</div></th>
						<th><div align="center">照片</div></th>
					  </tr>
					  <tr class="tr2" ng-repeat="item in userList" >
						<td><div align="center">{{$index+1}}</div></th>
						<td><div align="center">{{item.employeeName}}</div></td>
<!-- 						<td><div align="center">{{item.jobNo}}</div></td> -->
						<td><div align="center" title="{{item.proName}}">{{strCut(item.proName, 8)}}</div></td>
						<td><div align="center" >{{item.online}}</div></td>
						<td>
							<div ng-if="item.checkinStatus==1" align="center">
								<img class="operationImg" src="../../../img/list_items-sign.png">
							</div>
							<div ng-if="item.checkinStatus==0" align="center">
								-
							</div>
						</td>
						<td>
							<div ng-if="item.checkoutStatus==1" align="center">
								<img class="operationImg" src="../../../img/list_items-sign.png">
							</div>
							<div ng-if="item.checkoutStatus==0" align="center">
								-
							</div>
						</td>
						<td align="center">
							<div ng-if="item.isPciture==1" align="center">
								<img class="operationImg" src="../../../img/viewimg.png" ng-click="showPic(item)" title="查看图片 "/>
							</div>
							<div ng-if="item.isPciture==0" align="center">
								-
							</div>
							
						</td>
					  </tr>
					  
					 </table>
				</div>

				<div id="page_bar" class="paging_div">
				</div>
			</div>
		</div>
		<div class="map_div" id="allmap">
			
		</div>
	</div>
<script type="text/javascript">
	// 百度地图API功能
	var map = new BMap.Map("allmap");    // 创建Map实例
	map.addControl(new BMap.MapTypeControl());   //添加地图类型控件
	map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
	var markergg = null;
    
	
    var userData, ticket;
    $(document).ready(function(){
    	var userDataStr = $.cookie("pmsWeb_user_data");
		if(!userDataStr){
			
			noLogin(location.href);
			return;
		}
		userData = jQuery.parseJSON(userDataStr);
		ticket = $.cookie("pmsWeb_ticket");
    });
    
    
    function refreshPosition(accountCode){
	    $.ajax({
	    	url:serviceBasePath+"eap/pmsServices/commuteMgr/monitor/rtMonitor"+
	    		"?accountCode="+accountCode+"&ticket="+ticket,
	    	cache:false,
	    	method:"GET",
	    	success:function(res){
	    		if(res.statusCode!=200){
					alert("请求服务器失败！");
					return;
				}
				if(res.data){
					// 标点
					var marker = new BMap.Marker(new BMap.Point(res.data.x, res.data.y));
	    			map.addOverlay(marker);
	    		} 
	    	},
	    	error:function(){
	    		alert("请求服务器失败！");
	    	}
	    });
    }
 
    function setViewPort(points){
		var minLng=999,minLat=999,maxLng=0,maxLat=0;
		for (var i = 0; i < points.length; i++) {
			var p = points[i];
			var lng = p.lng;
			var lat = p.lat;
			if(lng<minLng){
				minLng=lng;
			}
			if(lat<minLat){
				minLat=lat;
			}
			if(lng>maxLng){
				maxLng=lng;
			}
			if(lat>maxLat){
				maxLat=lat;
			}
		}
		var pts = [new BMap.Point(minLng,minLat),new BMap.Point(maxLng,minLat),new BMap.Point(maxLng,maxLat),new BMap.Point(minLng,maxLat)];
		map.setViewport(pts);
	}

   
var cond_categoryCode="", cond_proNo="",cond_searchName="";
var ngScope;
var app = angular.module("realPosition", []);
app.controller("realPositionCtrl", function($scope, $http){
	/* init */
	ngScope = $scope;
	$scope.userList=[];
	
	var userDataStr = $.cookie("pmsWeb_user_data");
	if(!userDataStr){
		
		noLogin(location.href);
		return;
	}
	userData = jQuery.parseJSON(userDataStr);
	ticket = $.cookie("pmsWeb_ticket");
	
	map.centerAndZoom(new BMap.Point(userData.x, userData.y),12); // 初始化地图,设置中心点坐标和地图级别
	
	var viewstate = new ViewState();
// 	new DropDownList().init({
// 		renderTo:"#projectType",
// 		url:"../../component/projectType.html?ticket="+ticket,
// 		height:"200px",
// 		onSelected:function(result){
// 			cond_categoryCode=result.categoryCode;
// 			$("#projectType").val(result.categoryName);
// 			new DropDownList().init({
// 				renderTo:"#projectList",
// 				url:"../../component/projectList.html?categoryCode="+cond_categoryCode+"&ticket="+ticket,
// 				height:"200px",
// 				onSelected:function(result){
// 					cond_proNo=result.proNo;
// 					$("#projectList").val(result.proName);
// 					ngScope.loadUsers(cond_proNo, 1);
// 				}
// 			});
// 		}
// 	});
	
	new DropDownList().init({
		renderTo:"input[name=jobName]",
		data:[{code:"",name:"全部"},
		      {code:"1",name:"内业组员"},
		      {code:"2",name:"内业班长"},
		      {code:"3",name:"外业主管"},
		      {code:"4",name:"外业班长"},
		      {code:"5",name:"外业组员"},
		      {code:"7",name:"内业主管"},
		      {code:"8",name:"项目经理"},
		      {code:"9",name:"项目主管"},
		      {code:"26",name:"项目班长"}],
		textField:"name",
		onSelected:function(result){
			$("input[name=jobCode]").val(result.code);
			$("input[name=jobName]").val(result.name);
		}
	});
	
	new DropDownList().init({
		renderTo:"#projectList",
		url:"../../component/projectList.html?ticket="+ticket,
		height:"200px",
		onSelected:function(result){
			$("input[viewstate=proNo]").val(result.proNo);
			$("#projectList").val(result.proName);
			viewstate.collect();
			ngScope.loadUsers(1);
		}
	});
	
	$scope.loadUsers=function(currentPage){//alert(unitCode);
		$http.get(serviceBasePath+"eap/pmsServices/commuteMgr/monitor/rtMonitor?companyCode="
			+userData.companyCode+"&proNo="+viewstate.get("proNo")+"&currentPage="+currentPage+"&employeeName="+viewstate.get("searchName")+"&jobCode="+viewstate.get("jobCode")+"&ticket="+ticket).success(function(response){
			if(response.statusCode==200){
				$scope.userList = response.list;
				$scope.createPageBar(response.totalPage, response.currentPage,response.totalRecord);
				$scope.showAll($scope.userList);
			}else{
				$scope.userList = [];
				$scope.createPageBar(1, 1);
			}
		});
	};
	$scope.loadUsers(1);
	$scope.createPageBar=function(totalPage, curPage,totalRecord){
		new PageBar().init({
			renderTo:"#page_bar",
			totalPage:totalPage,
			curPage:curPage,
			totalRecord: totalRecord,
			btnCount:2,
			showPageInfo:true,
			prevPageText:"上一页",
			nextPageText:"下一页",
			onPage:function(pageNum){
				$scope.loadUsers(pageNum);
			}
		});
	};
	$scope.strCut=function(str, len){
		if(str.length>len){
			str = str.substring(0, len);
			str+="...";
		}
		return str;
	};
	$scope.selectedUser=function(item){
		if(item.x && item.y){
			map.setCenter(new BMap.Point(item.x, item.y));  // 初始化地图,设置中心点坐标和地图级别
			if(markergg != null){
				map.removeOverlay(markergg);
			}
			markergg = new BMap.Marker(new BMap.Point(item.x, item.y));
		    map.addOverlay(markergg);
		}
	};
	$scope.showAll=function(users){
		map.clearOverlays();
		var pts=[];
		for(var i=0;i<users.length;i++){
			var item=users[i];
			if(item.x && item.y){
				//map.setCenter(new BMap.Point(item.x, item.y));  // 初始化地图,设置中心点坐标和地图级别
				var p=new BMap.Point(item.x, item.y);
				pts.push(p);
				markergg = new BMap.Marker(p);
			    map.addOverlay(markergg);
			    var opts = {position : p,
			    		  offset   : new BMap.Size(10, -36)
			    		};
	    		var label = new BMap.Label(item.employeeName+"<br/>"+item.rpTimeStr, opts);  // 创建文本标注对象
	    			label.setStyle({
	    				 color : "#000",
	    				 fontSize : "12px",
	    				 height : "44px",
	    				 lineHeight : "20px",
						 backgroundColor:"#ffffcc",
	    				 fontFamily:"微软雅黑"
	    			 });
	    		map.addOverlay(label); 
			}
		}
		if(pts.length>0){
			setViewPort(pts);
		}
	};
	$scope.showPic=function(item){
		var date=new SimpleDateFormat({formatString:"yyyy-MM-dd"}).format(new Date());
		new ShowDlog().showFrame("../performance/imags.html?accountCode="+item.accountCode+"&date="+date, "查看图片", function(){}, "dlog-showPic");
	};
	
	window.onkeyup=function(e){
		if(e.keyCode==13){
			$scope.doQuery();
		}
	};
	
	$scope.doQuery=function(){
// 		cond_searchName=$("input[name=searchName]").val();
		viewstate.collect();
		$scope.loadUsers(1);
	};
	
});
</script>
</body>
</html>
