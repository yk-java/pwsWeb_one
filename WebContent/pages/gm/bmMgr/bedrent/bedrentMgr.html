<!DOCTYPE HTML>
<html>
<head>
<title> 床位租用</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
 <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=SSNeoF1lhE4QGx0oThlKXnEG"></script>
<script type="text/javascript" src="../../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../../js/PageBar.js"></script>
<script type="text/javascript" src="../../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../js/DropDownList-1.2/DropDownList.css" />
<script type="text/javascript" src="../../../../js/config.js"></script>

<script type="text/javascript" src="../../../../js/showDlog/showDlog.js"></script>
<script type="text/javascript" src="../../../../js/map.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../js/showDlog/showDlog-blue.css" />
<link rel="stylesheet" type="text/css" href="../../../../css/list.css" />

 
    
<style type="text/css">
	.dropDownArea{background-image:url(../../../../img/flag.png);background-repeat: no-repeat;background-position:right;background-position:185px;cursor:pointer;}
	
	.btn{display:inline-block;padding:1px 4px;border:solid 1px #f4f4f4; border-radius:4px;}
	.btn.toactive{color:#fff;background:green;}
	.btn.toclose{color:#fff;background:#ED7798;}
	.content{height:96%;width:100%;}
	.st{float:left;margin-left:8px;font-family: '微软雅黑'}
	.st input{float:left;margin-top:15px;}
	.st span{float:left}
	.left{width:20%;height:100%;float:left;background:#E6E6E6;overflow: auto;}
	.right{width:79.5%;height:100%;background:#666;float:right}
	.title{margin-bottom:5px;
	border-bottom:1px #ccc solid;
	height:35px;width:100%;
	
	font-family: '微软雅黑';
	font-size:16px;
	
	
	background-image: url("../../../../img/bedrent/renttop.png");
	background-repeat: no-repeat;
	margin-top:0px;
	border-bottom:1px #3385FF  solid;
	background-color:#fff
	}
	.title_txt{color:#fff;margin-left:35px;padding-top:8px;font-size:15px;}
	.items {width:98%;background-color: #fff;margin-left:1%;margin-top:4px;padding-bottom:5px;}
	.ittop{padding-top:15px;color:#3385FF}
	.ittop img{float:left;margin-top:0px;margin-left:5px;}
	.span1{font-size:14px;font-weight:700;margin-top:5px;margin-left:8px;}.
	.bot{width:100%;height:80px;background:red}
	.viewposition{float:left}
	.viewperson{float:left}
	
	.dialog-viewMember{width:900px;height:500px;}
</style>
</head>

<body ng-app="userMgr" ng-controller="userMgrCtrl">

<div class="list">
	<div class="list_content">
		<div class="title_div">
			<div class="title_left">
				
				<input type="text" class="dropDownProjectType" style="width:175px;" placeholder="请选择区域"/>
				<input type="text" id="searchName" placeholder="请输入宿舍名称"/>
				<div class="query_div" ng-click="doQuery()">
					查询
				</div>
				<div class="st"><input ng-click="search(0)" type="radio" name="status" value="" checked="checked"  /><span>全部</span></div>
				<div class="st"><input ng-click="search(1)" type="radio" name="status" value="1"  /><span>闲置</span></div>
				<div class="st"><input ng-click="search(2)" type="radio" name="status" value="2"  /><span>在租</span></div>
				<div class="st"><input ng-click="search(3)" type="radio" name="status" value="3"   /><span>快到期</span></div>
				
				&nbsp;&nbsp;
			</div>
			<img src="../../../../img/list_Header2-.png">
			
		</div>
		
		<div class="content">
			<div class="left">
				<div class="title">
					<div class="title_txt">宿舍列表(0)</div>
				</div>
				
				
				<div class="items" ng-repeat="item in projectList">
					<div class="ittop">
						<img ng-if="item.dormStatus==1" src="../../../../img/bedrent/bedrent1.png" />
						<img ng-if="item.dormStatus==2" src="../../../../img/bedrent/bedrent.png" />
						<span class="span1">宿舍名称:</span>
						{{item.dormName}}
					</div>
					<table style="width:100%;text-align:center;margin-top:15px;">
						<tr>
							
							<td width="30%">{{item.curBeds}}/{{item.maxBeds}}</td>
							<td width="30%">{{(item.curBeds/item.maxBeds*100).toFixed(2)}}%</td>
							<td ng-if="item.expire==1" style="color:red">{{item.erentDate}}</td>
							<td ng-if="item.expire==0" >{{item.erentDate}}</td>
						</tr>
						<tr>
							<td>床位</td>
							<td>租用率</td>
							<td>到期时间</td>
						</tr>
					</table>
					<table style="width:100%;text-align:center;border-top:1px #eee solid;margin-top:6px;color:#3385FF">
						<tr>
							<td width="50%" style="padding-top:6px;cursor: pointer;color:#3385FF" ng-click="position(item.x,item.y)">
								<img src="../../../../img/bedrent/positon.png" style="" />&nbsp;查看位置
							</td>
							<td width="50%" ng-if="item.dormStatus==1" style="padding-top:6px;cursor: pointer;color:#3385FF" >
								
							</td>
							
							<td width="50%" ng-if="item.dormStatus!=1" style="border-left:1px #eee solid;padding-top:6px;cursor: pointer;color:#3385FF" ng-click="viewMember(item.dormCode)">
								<img src="../../../../img/bedrent/viewperson.png" />&nbsp;查看成员
							</td>
							
							
						</tr>
						
					</table>
					
				</div>
			</div>
			<div class="right" id="iCenter">
				
			</div>
		</div>

	

	</div>
</div>
<script type="text/javascript">
function createPageBar(totalPage, curPage){
	new PageBar().init({
		renderTo:"#page_bar",
		totalPage:totalPage,
		curPage:curPage,
		prevPageText:"上一页",
		nextPageText:"下一页",
		onPage:function(pageNum){
			_currentPage=pageNum;
			ngScope.loadProjects(areaName, dormName,dormStatus,expire, pageNum);
		}
	});
}

var areaName="";
var dormName="";
var dormStatus=0;
var expire=0;
var _currentPage=1;
var totalNumber=0;

var ngScope;
var app = angular.module("userMgr", []);
app.controller("userMgrCtrl", function($scope, $http){
	/* init */
	ngScope = $scope;
	$scope.curUnit={};
	$scope.projectList=[];
	
	var userDataStr = $.cookie("pmsWeb_user_data");
	if(!userDataStr){
		
		noLogin(location.href);
		return;
	}
	var userData = jQuery.parseJSON(userDataStr);
	ticket = $.cookie("pmsWeb_ticket");
	
	/* 区域 */
	new DropDownList().init({
		renderTo:".dropDownProjectType",
		url:"../../../component/areaList.html?ticket="+ticket,
		height:"200px",
		onSelected:function(result){
			$(".dropDownProjectType").val(result.name);
			areaName=result.name;
			
			ngScope.loadProjects(areaName, dormName,dormStatus,expire,1);
		}
	});
	
	/* 加载数据 */
	$scope.loadProjects=function(areaName, dormName,dormStatus,expire,currentPage){//alert(unitCode);
		//alert(areaName+","+dormName+","+dormStatus+","+expire+","+currentPage)
		$http.get(serviceBasePath+"eap/pmsServices/materielMg/dormMg/dorm/rentDorm?areaName="
			+areaName+"&dormName="+dormName+"&dormStatus="+dormStatus+"&expire="+expire+"&currentPage="+currentPage+"&ticket="+ticket).success(function(response){
			if(response.statusCode==401){
				alert("用户凭据过期！请重新登录！");
				window.top.location.href="../../login.html";
				return;
			}
			mapProxy.clearOverlays();
			
			var minX="";
			var minY="";
			var maxX="";
			var maxY="";
			
			$scope.projectList = response.list;
			totalNumber=response.list.length;
			$(".title_txt").html("宿舍列表("+totalNumber+")");
			for(var i=0;i<response.list.length;i++){
				drawPoint(response.list[i].x,response.list[i].y, response.list[i].dormName,response.list[i].dormStatus);
				if(i==0){
					minX=response.list[i].x;
					minY=response.list[i].y;
					maxX=response.list[i].x;
					maxY=response.list[i].y;
				}
				if(response.list[i].x>maxX){
					maxX=response.list[i].x;
				}
				if(response.list[i].x<minX){
					minX=response.list[i].x;
				}
				if(response.list[i].y>maxY){
					maxY=response.list[i].y;
				}
				if(response.list[i].y<minY){
					minY=response.list[i].y;
				}
				
			}
			
			
			if(response.list.length==1){
				var poi = new BMap.Point(response.list[0].x,response.list[0].y);
				mapProxy.centerAndZoom(poi, 16);
			}else if(response.list.length<=0){
				mapProxy.centerAndZoom("中国",5);
			}else{
				//alert(minX)
				var p1 = new BMap.Point(minX, minY);  
				var p2 = new BMap.Point(maxX, minY); 
				var p3 = new BMap.Point(maxX, maxY);
				var p4 = new BMap.Point(minX, maxY); 
				var ps = [p1,p2,p3,p4];
				mapProxy.setViewport(ps);
			}
			createPageBar(response.totalPage, response.currentPage);
		});
	};
	/* 查询 */
	$scope.doQuery=function(){
		dormName = $("#searchName").val();
		
		if(expire==0){
			$scope.loadProjects(areaName, dormName,dormStatus,0,1);
		}else{
			$scope.loadProjects(areaName, dormName,0,1,1);
		}
		
	};
	
	$scope.search=function(status){
		//dormName = $("#searchName").val();
		//expire=status;//alert(status)
		if(status==3){
			expire=3;
			$scope.loadProjects(areaName, dormName,0,1,1);
		}else{
			expire=0;
			dormStatus=status;
			$scope.loadProjects(areaName, dormName,dormStatus,0,1);
		}
		
	};
	
	//定位
	$scope.position=function(x,y){
		
				var poi = new BMap.Point(x,y);
				mapProxy.centerAndZoom(poi, 16);
	};
	
	
	//查看成员
	$scope.viewMember=function(dormCode){
		//alert(dormCode);
		new ShowDlog().showFrame("../../../component/viewMember.html?dormCode="+dormCode, "查看成员", function(){
						// 
		},"dialog-viewMember");		
	};
	
	
});

window.onload = function() {

	initMap();
	
	/* 初始查询 */
	ngScope.loadProjects(areaName, dormName,dormStatus,expire,1);
};
</script>
</body>
</html>
