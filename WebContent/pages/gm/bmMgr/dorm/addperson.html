<!DOCTYPE HTML>
<html>
<head>
<title> 类型管理</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<script type="text/javascript" src="../../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../../js/eapJs/core/eap.core.js" ></script>
<script type="text/javascript" src="../../../../js/eapJs/plugins/eap.tip.js" ></script>
<script type="text/javascript" src="../../../../js/eapJs/plugins/eap.validate.js"></script>
<script type="text/javascript" src="../../../../js/eapJs/local/eap.lang-zh_CN.js"></script>
<script type="text/javascript" src="../../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../../js/util.js"></script>
<script type="text/javascript" src="../../../../js/config.js"></script>
<script type="text/javascript" src="../../../../js/Calendar.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../css/validate.css"/>
<link rel="stylesheet" type="text/css" href="../../../../css/edit.css"/>
<script type="text/javascript" src="../../../../js/time.js"></script>
<script type="text/javascript" src="../../../../js/showDlog/showDlog.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../js/showDlog/showDlog-blue.css" />
<script type="text/javascript" src="../../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../js/DropDownList-1.2/DropDownList.css" />

<style type="text/css">
	.all{width:100%;height:100%;}
	.d1{padding-left:40px; font-family: '微软雅黑';height:30px; padding-top:20px;}
	.d1 input{width:200px; border:1px #ccc solid;font-family: '微软雅黑';height:20px;}
	.d2{padding-left:40px; font-family: '微软雅黑';height:25px; padding-top:20px;}
	.d2 input{width:200px; border:1px #ccc solid;font-family: '微软雅黑';height:20px;}
	
	.tabs{border-bottom:solid 1px #e6e6e6;}
	.tab{display:inline-block;margin:0 10px;line-height:36px;font-size:14px;}
	.tab.selected{color:#3385FF;border-bottom:solid 3px #3385FF;}
	.prolist{ margin-top:15px;border:1px #eee solid;min-height:100px;width:95%; overflow: auto;}
	.viewlist{margin-top:15px;border:1px #eee solid;min-height:60px;width:95%;overflow: auto;}
	.cominput{width:200px; border:1px #ccc solid;font-family: '微软雅黑';height:20px;}
	
	
.title_save{float:left;width:70px;height:28px;background: url(../../../../img/btn_save.png) no-repeat 0 0;line-height:28px;text-align:center;margin-left:30px;margin-top:5px;color:#fff;cursor: pointer;}
.title_save:hover{background: url(../../../../img/btn_save.png) no-repeat 0 -29px;}
.title_cancel{float:left;width:70px;height:28px;background: url(../../../../img/btn_cancel.png) no-repeat 0 0;line-height:28px;text-align:center;margin-left:30px;margin-top:5px;color:#666;cursor: pointer;}
.title_cancel:hover{background: url(../../../../img/btn_cancel.png) no-repeat 0 -29px;}


.items{border:1px #ccc solid;margin-top:8px;margin-left:5px;width:60px;text-align: center;padding:10px;float:left}

.its{height:40px;}
</style>

</head>

<body ng-app="projectType" ng-controller="userMgrCtrl">
<form id="saveForm" class="required-validate">

<div class="tabs">
			<a href="#lay1" class="tab selected">项目人员添加</a>
			<a href="#lay2" class="tab">人员快速添加</a>
</div>



<div class="all" id="lay1">
	<!-- <div class="d1">退租时间 <input type="text" id="times" name="dateDump" class="required date dateComponent" placeholder="请选择" onclick="new Calendar().show(this)"/></div> --> 
	<div class="d2">项目类型 <input type="text" id="projectType"  class="dropDownList" placeholder="请项目类型" /></div> 
	<div class="d2">选择项目 
		<input type="text" id="projectList"  name="proName"  name="proName" class="dropDownList required" placeholder="请选择项目"/> 
		<input type="hidden" id="projectListCode" name="proNo"  />
	</div> 
	<div class="d2">项目人员
		<input type="text"  id="employee"  name="employeeName" class="dropDownList" placeholder="请选择人员"/>		
		<input type="hidden" id="employeeCode" name="employeeCode" />
	</div> 
	<div class="d2">租用日期 <input type="text" name="rentDate"  class="required date dateComponent inp" placeholder="请选择调用日期" onclick="new Calendar().show(this)" /></div> 
	<div class="d2">归还日期 <input type="text" name="returnDate" class="required date dateComponent inp" placeholder="请选择归还日期" onclick="new Calendar().show(this)" /></div> 
	<div class="d2">备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注 <input type="text" name="remarks"  /></div> 
	<div class="form_bottom" style="padding-left:15px;margin-top:10px;">
			<a href="javascript:" ng-click="onSave()" class="title_save">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;确认
			</a>
			<a href="javascript:" ng-click="onCancel()" class="title_cancel">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;取消
			</a>
	</div>
</div>

<div id="lay2">
	<div style="padding-left:40px; font-family: '微软雅黑';height:25px; padding-top:20px;">
		<div class="its">
				人员姓名 <input type="text"  id="epName"  name="epName" class="cominput dropDownList" placeholder="请选择人员"/>		
		        <input type="hidden" id="epCode" name="epCode" />
		</div>
		<div class="its">
				租用日期 <input type="text" name="rentDate1"  class="cominput required date dateComponent inp" placeholder="请选择调用日期" onclick="new Calendar().show(this)" />
		</div>
		<div class="its">
				归还日期 <input type="text" name="returnDate1" class="cominput required date dateComponent inp" placeholder="请选择归还日期" onclick="new Calendar().show(this)" />
		</div>
		<p style="width:100%">项目列表:</p>
		<div class="prolist" >
			<p ng-repeat="item in proList" style="width:210px;float:left;margin:0px;padding:0px;line-height:24px;">
			<input type="radio" value="{{item.proNo}}" prop="{{item.proName}}" name="ps" />{{item.proName}} </p>
		</div>
		
		<input type="button" value="添加" style="float: right;margin-top:-30px;margin-right:40px;" ng-click="addtolist()" /> 
		<p style="width:100%">待添加人员列表:</p>
		<div class="viewlist" >
			<div class="items" ng-repeat="item in viewList">
			<img src="../../../../img/deleteP.png" style="width:14px;height:14px;cursor: pointer;float:right" title="移除" alt="移除"  ng-click="removeP(item)"  />
				{{item.epName}}
			</div>
		</div>
		
			<a href="javascript:" ng-click="onSave1()" class="title_save">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;确认
			</a>
			<a href="javascript:" ng-click="onCancel()" class="title_cancel">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;取消
			</a>
	  
	</div> 
</div>


</form>


<script type="text/javascript">
	var ngScope;
	var cond_categoryCode="";
	var proNo="";
	var proName="";
	var employeeCode="";
	var employeeName="";
	var app = angular.module("projectType", []);
	app.controller("userMgrCtrl", function($scope, $http){
		/* init */
		ngScope = $scope;
		
		$scope.viewList=[];
		$scope.lefObj={}; //左侧数据
		var currentDate=getCurrentDate();
		var nextyear=getNextYearCurrentDate();
		$("input[name=rentDate]").val(currentDate);
		$("input[name=returnDate]").val(nextyear);
		$("input[name=rentDate1]").val(currentDate);
		$("input[name=returnDate1]").val(nextyear);
		
		var mydate = new Date();
		$("#times").val(mydate.getFullYear()+"-"+(mydate.getMonth()+1)+"-"+mydate.getDate());
		
		var userDataStr = $.cookie("pmsWeb_user_data");
		if(!userDataStr){
			
			noLogin(location.href);
			return;
		}
		$scope.userData = jQuery.parseJSON(userDataStr);
		var ticket = $.cookie("pmsWeb_ticket");
		
		var params = getUrlParams();
		$scope.required = params.required;
		
		
		var dormCode = "";
		if(params.dormCode){
			dormCode = params.dormCode; 
			
		}
		
		/* 表单验证 */
	validator = $("#saveForm").validate({
		onsubmit: false,
		focusInvalid: false,
		focusCleanup: true,
		errorElement: "span",
		ignore:".ignore",
		invalidHandler: function(form, validator) {
			var errors = validator.numberOfInvalids();
			if (errors) {
				
			} 
		}
	});
		
	/* 视图渲染 */
	$(".tabs>a").each(function(){
		var layId = $(this).attr("href");
		var idx = $(".tabs>a").index($(this));
		if(idx!=0){
			$(layId).hide();
			$(layId).attr("data-show", "0");
		}else{
			$(layId).attr("data-show", "1");
		}
		$(this).click(function(){
			$(".tabs>.selected").removeClass("selected");
			$(this).addClass("selected");
			var layId = $(this).attr("href");
			$("div[data-show=1]").hide();
			$("div[data-show=1]").attr("data-show", "0");
			$(layId).show();
			$(layId).attr("data-show", "1");
			
		});
	});


		
	/* 项目类型 */
	new DropDownList().init({
		renderTo:"#projectType",
		url:"../../../component/projectType.html?ticket="+ticket,
		height:"200px",
		onSelected:function(result){
			$("#projectType").val(result.categoryName);
			cond_categoryCode = result.categoryCode;
			/* 联动 */
			projectList.setConfig("url", "../../../component/projectList.html?categoryCode="+cond_categoryCode+"&ticket="+ticket);
		}
	});
	
	/* 项目列表 */
	var projectList=new DropDownList();
	projectList.init({
		renderTo:"#projectList",
		url:"../../../component/projectList.html?categoryCode="+cond_categoryCode+"&ticket="+ticket,
		height:"200px",
		onSelected:function(result){
			$("#projectList").val(result.proName);
			//proName=result.proNo;
			proNo=result.proNo;
			
			$("input[name=proNo]").val(proNo);
			proName=result.proName;
// 			$scope.loadDoneList(cond_viewtype2, cond_proNo);
			chooseEmployeeInProject.setConfig("url", "../../../component/chooseEmployeeInProject.html?proNo="+proNo+"&ticket="+ticket);
		}
	});
	
	//选择人员  
	new DropDownList().init({
		renderTo:"#epName",
		url:"../../../component/allEmployees.html?ticket="+ticket,
		height:"200px",
		onSelected:function(result){
			$("#epName").val(result.employeeName);
			$("#epCode").val(result.employeeCode);
			
			$scope.loadPros(result.employeeCode);
		}
	});
	
	
	$scope.loadPros=function(code){
		
		   $http.get(serviceBasePath+"eap/pmsServices/pwsCommon/getPros?employeecode="
				+code+"&ticket="+ticket).success(function(response){
				if(response.statusCode==401){
					alert("用户凭据过期！请重新登录！");
					window.top.location.href="../../../login.html";
					return;
				}
				$scope.proList = response.list;
			
			});
	};
	
	
	$scope.addtolist=function(){
		
		var epName=$("#epName").val();
		var epCode=$("#epCode").val();
		var rentDate=$("input[name=rentDate1]").val();
		var returnDate=$("input[name=returnDate1]").val();
		
		var proNo=$("input[name='ps']:checked").val();
		var proName=$("input[name='ps']:checked").attr("prop");
		
		
		if(!proNo){
			var waittingDlog = new ShowDlog();

			waittingDlog.prompt({
									icon:"warning",
									msg:"请您选择项目",
									done:function(){
										
									},
									t:2000
			});
			return false;
		}
		
		for(var i=0;i<$scope.viewList.length;i++){
			var code=$scope.viewList[i].epCode;
			if(code==epCode){
				return false;
			}
		}
		
		var tempObj={};
		tempObj.epName=epName;
		tempObj.epCode=epCode;
		tempObj.proNo=proNo;
		tempObj.proName=proName;
		tempObj.rentDate=rentDate;
		tempObj.returnDate=returnDate;
		
		$scope.viewList.push(tempObj);
		
	};
	
	$scope.removeP=function(item){
		for(var i=0;i<$scope.viewList.length;i++){
			var code=$scope.viewList[i].epCode;
			var tempobj=$scope.viewList[i];
			if(code==item.epCode){
				 $scope.viewList.splice(i,1)
			}
		}
	};

	var chooseEmployeeInProject = new DropDownList();
	chooseEmployeeInProject.init({
						renderTo:"#employee",
						url:"../../../component/chooseEmployeeInProject.html?proNo="+proNo+"&ticket="+ticket,
						height:"200px",
						onSelected:function(result){
						/* 	$("#employee").val(result.employeeName);
							$("#employeeCode").val(result.employeeCode);
							employeeCode=result.employeeCode;
							employeeName=result.employeeName;
							//proNo1=result.proNo; */
							var codes="";
							var names="";
							for(var i=0;i<result.length;i++){
								codes=codes+result[i].employeeCode+",";
								names=names+result[i].employeeName+",";
							}
							
							if(codes!=""){
								codes=codes.substring(0,codes.length-1);
							    names=names.substring(0,names.length-1);
							}
							
							$("#employee").val(names);
							$("#employeeCode").val(codes);
							employeeCode=codes;
							employeeName=names;
							
							
		 					
						}
					});


		
		
		/* 保存 */
		$scope.onSave = function(){
		
			//$("input[name=companyCode]").val(userData.companyCode);
			var formData = $("#saveForm").serialize();
			var dialog=new ShowDlog();

			if($("#saveForm").valid()){
			
				
						
						/* $http.post(serviceBasePath+"eap/pmsServices/materielMg/assetMg/asset/assetScrap").success(function(response){
							alert(1)
							//$scope.loadProjects(assetTypeCode, assetClassCode,status, _currentPage);
						}); */
						
						$.ajax({
							url:serviceBasePath+"eap/pmsServices/materielMg/dormMg/dorm/addPerson?dormCode="+dormCode,
							cache:false,
							method:"POST",
							data:formData,
							success:function(res){
								
								if(res.statusCode=="100"){//有在租的宿舍
									dialog.prompt({
										icon:"warning",
										msg:res.resultMsg,
										done:function(){
											
										},
										t:2000
									});
								}else if(res.statusCode=="101"){//床位已满
									dialog.prompt({
										icon:"warning",
										msg:"此宿舍床位已满！",
										done:function(){
											
										},
										t:2000
									});

								}else{
									dialog.prompt({
										icon:"success",
										msg:"添加成功！",
										done:function(){
											parent.$dlog.close();
										},
										t:2000
									});
								}
							},
							error:function(){
								
							}
						});
				
			}else{
				//alert("表单填写异常，请检查修正后再提交");
			}
		};
		
		
		/* 快速添加人员保存保存 */
		$scope.onSave1 = function(){
		
			//$("input[name=companyCode]").val(userData.companyCode);
			//var formData = $("#saveForm").serialize();
			    var dialog=new ShowDlog();
			    
			    if($scope.viewList.length==0){
			    	dialog.prompt({
						icon:"warning",
						msg:"请您添加人员",
						done:function(){
							
						},
						t:2000
					});
			    }else{
			    	
			    	var codes="";
			    	var names="";
			    	var pronos="";
			    	var pronames="";
			    	var rentDate="";
			    	var returnDate="";
			    	
			    	
			    	
			    	for(var i=0;i<$scope.viewList.length;i++){
			    		codes=codes+$scope.viewList[i].epCode+",";
			    		names=names+$scope.viewList[i].epName+",";
			    		pronos=pronos+$scope.viewList[i].proNo+",";
			    		pronames=pronames+$scope.viewList[i].proName+",";
			    		rentDate=rentDate+$scope.viewList[i].rentDate+",";
			    		returnDate=returnDate+$scope.viewList[i].returnDate+",";
					}
			    	
			    	codes=codes.substring(0,codes.length-1);
			    	names=names.substring(0,names.length-1);
			    	pronames=pronames.substring(0,pronames.length-1);
			    	pronos=pronos.substring(0,pronos.length-1);
			    	
			    	rentDate=rentDate.substring(0,rentDate.length-1);
			    	returnDate=returnDate.substring(0,returnDate.length-1);
			    	
			    	
			    	var formData={employeeCode:codes,employeeName:names,proNo:pronos,proName:pronames,rentDate:rentDate,returnDate:returnDate};
			    	//return false;
			    	
			    	$.ajax({
						url:serviceBasePath+"eap/pmsServices/materielMg/dormMg/dorm/fastAddPerson?dormCode="+dormCode,
						cache:false,
						method:"POST",
						data:formData,
						success:function(res){
							
							if(res.statusCode=="100"){//有在租的宿舍
								dialog.prompt({
									icon:"warning",
									msg:res.resultMsg,
									done:function(){
										
									},
									t:2000
								});
							}else if(res.statusCode=="101"){//床位已满
								dialog.prompt({
									icon:"warning",
									msg:"此宿舍床位已满！",
									done:function(){
										
									},
									t:2000
								});

							}else{
								dialog.prompt({
									icon:"success",
									msg:"添加成功！",
									done:function(){
										parent.$dlog.close();
									},
									t:2000
								});
							}
						},
						error:function(){
							
						}
					});
			    	
			    }
			   

				
				
			
		};
		
		
		
		$scope.onCancel=function(){
			parent.$dlog.close();
			
		};
		
	});
	
	
	</script>
</body>
</html>
