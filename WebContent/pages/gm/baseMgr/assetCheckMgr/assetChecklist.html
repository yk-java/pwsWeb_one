<!DOCTYPE HTML>
<html>
<head>
<title>资产盘点</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<link rel="stylesheet" type="text/css" href="../../../../css/list.css" />
<link rel="stylesheet" type="text/css" href="../../../../js/showDlog/showDlog-blue.css" />

<script type="text/javascript" src="../../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../../js/PageBar.js"></script>
<script type="text/javascript" src="../../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../js/DropDownList-1.2/DropDownList.css" />
<script type="text/javascript" src="../../../../js/config.js"></script>
<script type="text/javascript" src="../../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<script type="text/javascript" src="../../../../js/showDlog/showDlog.js"></script>
<script type="text/javascript" src="../../../../js/util.js"></script>
<script type="text/javascript" src="../../../../js/Calendar.js"></script>
<script type="text/javascript" src="../../../../js/SimpleDateFormat.js"></script>


<script type="text/javascript" src="../../../../js/eapJs/core/eap.core.js" ></script>
<script type="text/javascript" src="../../../../js/eapJs/plugins/eap.tip.js" ></script>
<script type="text/javascript" src="../../../../js/eapJs/plugins/eap.validate.js"></script>
<script type="text/javascript" src="../../../../js/eapJs/local/eap.lang-zh_CN.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../css/validate.css"/>
<script type="text/javascript" src="../../../../js/showDlog/showDlog.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../js/showDlog/showDlog-blue.css" />
<style type="text/css">
	.dropDownArea{background-image:url(../../../../img/flag.png);background-repeat: no-repeat;background-position:right;background-position:185px;cursor:pointer;}
	.btn{display:inline-block;padding:1px 4px;border:solid 1px #f4f4f4; border-radius:4px;}
	.btn.toactive{color:#fff;background:green;}
	.btn.toclose{color:#fff;background:#ED7798;}
	.ck{border:1px #fff solid;background:#fff;margin-top:5px}
	.cks{float:left;height:20px;}
	.cks .ck{float:left;margin-top:15px;margin-left:10px;}
	.cks span{float:left;margin-top:5px;}
    .dialog-viewcode{width:500px;height:400px;}
    .dialog-viewcyle{width:900px;height:500px;}
    .dialog-scrap{width:480px;height:320px;}
    .dialog-scrap1{width:480px;height:300px;}
    .dialog-asset{height:600px;width:500px;}
    
    .title_div2{border:solid 0px red;background:#4CA9FF;padding:8px 6px 8px 6px;}
	.title_div2 .condLayer1{display:block;border:solid 0px;margin:6px;}
	.title_div2 .condLayer2{border:solid 0px green;margin:6px;}
	.title_div2 .condLayer1 input{height:28px;line-height:28px;border:solid 1px #f4f4f4;color:#666;margin:0 4px;padding:0 4px;font-family:微软雅黑;}
	.title_div2 .condLayer2 input{height:28px;line-height:28px;border:solid 1px #f4f4f4;color:#666;margin:0 4px;padding:0 4px;background-color:#DAEDFF;font-family:微软雅黑;}
	.title_div2 .btn{display:inline-block;height:30px;line-height:30px;margin:0 4px;padding:0 15px 0 15px;background:#f4f4f4;color:#666;font-weight:bold;cursor:pointer;border:solid 1px #89C6FF; border-radius:4px;}
	.title_div2 .blue{background:#3385FF;color:#fff;}
	.title_div2 .blue:hover{background:#186CE7;}
	.title_div2 .pink{background:#ED7798;color:#fff;}
	.title_div2 .pink:hover{background:#E54673;}
    .qiehuan {
    line-height: 25px;
    border-radius: 20px;
    border: 1px solid white;
    margin-top: 16px;
    overflow: hidden;
    margin-left: 16px;
    margin-right: 16px;
    width:150px;
    height:25px;
    float:right;
    margin-top:0px;
    margin-right:-2px;
   
}

.qiehuan .tong_zhi, .qiehuan .fang_an, .qiehuan .zhi_nan {
    float: left;
    width: 32.7%;
    text-align: center;
}
.tong_zhi {
    font-size:12px;
    color: #288df5;
    background-color: white;
     border-right: 1px solid white;
}
.fang_an {
    font-size:12px;
    color: white;
    border-right: 1px solid white;
    
}
.zhi_nan {
   font-size:12px;
    color: white;
}
a{
    text-decoration: none;
    cursor: pointer;
}

.proType{
	display: none
}
.proNameD{
	display: none
}
.unitcode{
display: none
}

.more{position:absolute; margin-top:8px;}
.operates{
	position: absolute;
	z-index: 9999;
	height:165px;
	width:95px;
	background-image: url(../../../../img/asset/round.png);
	text-align: left;
	padding-top:12px;
	margin-left:45px;
	display: none
}
.operates p{margin:0px;padding-left:8px;height:23px;padding-top:3px;cursor: pointer;}
.operates p:HOVER{background:#d3dff1;}
.operates p img{float:left;margin-top:1px;}
.bor{border-bottom:1px solid #eee}
.btnmore{position: absolute;margin-top:2px;}
.detailDialog{width:900px;height:500px;}
</style>
</head>

<body ng-app="userMgr" ng-controller="userMgrCtrl">
<form id="saveForm" class="required-validate">
<div class="list">
	<div class="list_content">
		<div class="title_div2">
			<div class="condLayer1">
				<input type="text" style="width:110px" id="dropDownProjectType" class="dropDownList" placeholder="请选择资产分类"/>
				<input type="text" style="width:110px" id="dropDownProjectType1" class="dropDownList" placeholder="请选择资产类型"/>
				<input type="text" style="width:110px" class="proType dropDownList" placeholder="请选择项目类别"/>
				<input type="text"  class="proNameD dropDownList" placeholder="请选择项目"/>
			    <input type="text" name="loanUnitName" class="unitcode dropDownList" placeholder="请选择部门" style="width:200px;"/>
			    <input type="text" style="width:120px"  name="searchName" placeholder="请输入查询条件"/>
				<input type="text" id="fromDate" name="fromDate" class="select_2 dropDownList dateComponent" onclick="new Calendar().show(this)" placeholder="起始时间"/>
				<input type="text" style="width:110px" id="dropDownIsUse" class="dropDownList" placeholder="当日是否使用"  readonly="readonly"/>
				
				<input type="text" style="width:110px" id="dropDownPeriod" class="dropDownList" placeholder="盘点周期" readonly="readonly"/>
				&nbsp;&nbsp;
				
				<div class="btn blue" ng-click="doQuery()">
					查询
				</div>
				<div class="btn blue" ng-click="doExport()">
				   	导出
				</div>
				
				<div class="qiehuan"> 
					<a class="tong_zhi" id="allbar" onclick="searchAll()">全部</a> 
					<a class="fang_an"  id="probar" onclick="searchPro()">项目</a> 
					<a class="zhi_nan"  id="unitbar" onclick="searchUnit()">部门</a> 
				</div>
			</div>
			
		</div>
		
		<div class="table_div">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="table">
			   <tr class="tr1">
				<th><div align="center">序号</div></th>
				<th><div align="center">查询日期</div></th>
				<th width="10%"><div align="center">所属部门/项目</div></th>
				<th><div align="center">资产编号</div></th>
				<th><div align="center">资产名称</div></th>
				<th><div align="center">资产分类</div></th>
				<th><div align="center">资产内容</div></th>
				<th><div align="center">盘点周期</div></th>
				<th><div align="center">当日是否投入使用</div></th>
				<th width="120"><div align="center">操作</div></th>
			  </tr>
			  <tr class="tr2" ng-repeat="item in projectList">
				<td><div align="center">{{$index+1}}</div></td>
				<td><div align="center">{{item.QUERY_DATE}}</div></td>
				<td ng-if="item.STATUS==1" style="background:#FF9B7E">
					<div  align="center">闲置</div>
				</td>
				<td ng-if="item.STATUS==2">					
					<div  align="center">{{item.LOAN_UNIT_NAME}}</div>
				</td>
				<td ng-if="item.STATUS==3">					
					<div  align="center">{{item.LOAN_PRO_NAME}}</div>
				</td>
				<td ng-if="item.STATUS==4" style="background:#7FBDFF">					
					<div  align="center">项目维修</div>
				</td>
				<td ng-if="item.STATUS==5" style="background:#7FBDFF">					
					<div  align="center">维修</div>
				</td>
				<td ng-if="item.STATUS==6" style="background:#FF7EA5">					
					<div  align="center">待报废</div>
				</td>
				<td ng-if="item.STATUS==7" style="background:#e5e5e5">					
					<div  align="center">已报废</div>
				</td>
				<td ng-if="item.STATUS==8" style="background:#00CC33">
					<div  align="center">总部仓库闲置</div>
				</td>
				<td><div align="center">{{item.ASSET_CODE}}</div></td>
				<td><div align="center">{{item.ASSET_NAME}}</div></td>
				<td><div align="center">{{item.ASSET_CLASS_NAME}}</div></td>
				<td><div align="center">{{item.FORMS}}</div></td>
				<td><div align="center">{{item.STOCK_PERIOD_NAME}}</div></td>
				<td>
					<div align="center" ng-if="item.STATUS==8">在库</div>
					<div align="center" ng-if="item.STATUS!=8">{{item.DAYSTATUS}}</div>
					
				</td>
				<td>
		    		<div align="center">
			    		<img class="operationImg" ng-click="doShow(item)" src="../../../../img/list_see-icon.png" title="查看 ">
		    		</div>
				</td>
			  </tr>
			</table>
		</div>

		<div id="page_bar" class="list_bottom" align="center">
		</div>

	</div>
</div>
</form>
<script type="text/javascript">
function shownext(obj){
	//alert($(obj).next()[0].style.display)
	if($(obj).next()[0].style.display=="none"||$(obj).next()[0].style.display==""){
		$(obj).next().show();
		$(obj).focus();
	    $(obj).focusout(function(){
			
		   /*lazyCall('t1',function(){
				$(obj).next().hide();	
			}, 300); */
			
			var st=setTimeout(function(){
				$(obj).next().hide();	
			}, 300);
			
			
		}); 
	}else{
			$(obj).next().hide();	
		
	}
}



function searchAll(){
	$("#allbar").css("background","#fff");
	$("#allbar").css("color","#3385ff");
	
	$("#probar").css("background","#4CA9FF");
	$("#probar").css("color","#fff");
	
	$("#unitbar").css("background","#4CA9FF");
	$("#unitbar").css("color","#fff");
	
	
	loanUnitCode="";
	loanUnitName="";
	proNo="";
	proName="";
	category_Code = "";
	category_Name="";
	
	$(".proType").hide();
	$(".proNameD").hide();
	$(".unitcode").hide();
	
	$(".proType").val("");
	$(".proNameD").val("");
	$(".unitcode").val("");
	
	ngScope.loadProjects(searchName,assetTypeCode, assetClassCode,1,proNo,loanUnitCode,fromDate,isUse,isPeriod);
	
	
}
function searchPro(){
	
	$("#allbar").css("background","#4CA9FF");
	$("#allbar").css("color","#fff");
	$("#probar").css("background","#fff");
	$("#probar").css("color","#3385ff");
	$("#unitbar").css("background","#4CA9FF");
	$("#unitbar").css("color","#fff");
	
	loanUnitCode="";
	loanUnitName="";
	
	$(".proType").show();
	$(".proNameD").show();
	$(".unitcode").hide();
	
	$(".unitcode").val("");
	ngScope.loadProjects(searchName,assetTypeCode, assetClassCode,1,proNo,loanUnitCode,fromDate,isUse,isPeriod);
	
}
function searchUnit(){
	
	$("#allbar").css("background","#4CA9FF");
	$("#allbar").css("color","#fff");
	
	$("#probar").css("background","#4CA9FF");
	$("#probar").css("color","#fff");
	
	$("#unitbar").css("background","#fff");
	$("#unitbar").css("color","#3385ff");
	
	
	//loanUnitCode="";
	//loanUnitName="";
	proNo="";
	proName="";
	category_Code = "";
	category_Name="";
	
	$(".proType").hide();
	$(".proNameD").hide();
	$(".unitcode").show();
	$(".proType").val("");
	$(".proNameD").val("");
	ngScope.loadProjects(searchName,assetTypeCode, assetClassCode,1,proNo,loanUnitCode,fromDate,isUse,isPeriod);
	
}


function getUrlParams(){
	var params={};
	var url = location.href;
	var start = url.indexOf("?", 0)+1;
	var paramsStr = url.substring(start, url.length);
	var paramsArr = paramsStr.split("&");
	for(var i=0;i<paramsArr.length;i++){
		var kv = paramsArr[i].split("=");
		var k = kv[0];
		var v = kv[1];
		params[k]=v;
	}
	return params;
}


function createPageBar(totalPage, curPage,totalRecord){
	new PageBar().init({
		renderTo:"#page_bar",
		totalPage:totalPage,
		curPage:curPage,
		totalRecord:totalRecord,
		prevPageText:"上一页",
		nextPageText:"下一页",
		showPageInfo:true,
		onPage:function(pageNum){
			_currentPage=pageNum;
			ngScope.loadProjects(searchName,assetTypeCode, assetClassCode,pageNum,proNo,loanUnitCode,fromDate,isUse,isPeriod);
		}
	});
}
var searchName="";
var assetTypeCode="";
var assetTypeName="";
var assetClassCode="";
var assetClassName="";
var proNo="";
var proName="";
var _currentPage=1;
var category_Code="";
var category_Name="";
var proTypes;
var ngScope;
var droptype;
var price1="";
var price2="";
var fromDate="";
var validator;

var loanUnitCode="";
var loanUnitName="";
var isUse=0;
var isPeriod=1;


var app = angular.module("userMgr", []);
app.controller("userMgrCtrl", function($scope, $http){
	/* init */
	ngScope = $scope;
	$scope.curUnit={};
	$scope.projectList=[];
	
	var userDataStr = $.cookie("pmsWeb_user_data");
	if(!userDataStr){
		
		noLogin(location.href);
		return;
	}
	var userData = jQuery.parseJSON(userDataStr);
	ticket = $.cookie("pmsWeb_ticket");
	
	var params = getUrlParams();
	
	var  mydate = new Date();
	var  day1= new SimpleDateFormat({formatString:"yyyy-MM-dd"}).format(mydate);
	fromDate=day1;
	$("input[name=fromDate]").val(fromDate);
	
	if(params){
		if(params.assetClassCode){
			assetClassCode=params.assetClassCode;
		}
		if(params.assetClassName){
			assetClassName=decodeURIComponent(params.assetClassName);
			$("#dropDownProjectType").val(assetClassName);
		}
		if(params.assetTypeName){
			assetTypeName=decodeURIComponent(params.assetTypeName);
			$("#dropDownProjectType1").val(assetTypeName)
		}
		if(params.assetTypeCode){
			assetTypeCode=params.assetTypeCode;
		}
		if(params.proNo){
			proNo=params.proNo;
		}
		if(params.proName){
			proName=decodeURIComponent(params.proName);
			$(".proNameD").val(proName);
		}
		if(params.category_Name){
			category_Name=decodeURIComponent(params.category_Name);
			$(".proType").val(category_Name);
		}
		if(params.category_Code){
			category_Code=params.category_Code;
		}
		if(params.searchName){
			searchName=decodeURIComponent(params.searchName);
			$("input[name=searchName]").val(searchName)			
		}
		
		if(params.price1){
			price1=params.price1;
			$("input[name=price1]").val(price1);
		}
		
		if(params.price2){
			price2=params.price2;
			$("input[name=price2]").val(price2);
		}
		
		if(params.fromDate){
			fromDate=params.fromDate;
			$("input[name=fromDate]").val(fromDate);
		}
		
		
		if(params.currentPage){
			_currentPage=params.currentPage;
		}
		
		if(params.status){
			status=params.status;
		}
		
	}

	
	/* 表单验证 */
	validator = $("#saveForm").validate({
		onsubmit: false,
		focusInvalid: false,
		focusCleanup: true,
		errorElement: "span",
		ignore:".ignore",
		invalidHandler: function(form, validator) {
			var errors = validator.numberOfInvalids();
			if (errors) {
				
			} 
		}
	});
	
	
	/* 资产分类*/
	new DropDownList().init({
		renderTo:"#dropDownProjectType",
		url:"../../../component/assetType.html?ticket="+ticket,
		height:"200px",
		onSelected:function(result){
			//assetClassName
			$("#dropDownProjectType").val(result.assetClassName);
			assetClassCode = result.assetClassCode;
			assetClassName = result.assetClassName;
			ngScope.loadProjects(searchName,assetTypeCode, assetClassCode,status, 1,proNo,loanUnitCode,fromDate,isUse,isPeriod);
					
			var url="../../../component/assetLeixing.html?&assetClassCode="+assetClassCode;
			droptype.setConfig("url", url);
		}
	});
	
	droptype=new DropDownList();
	//资产类型
	droptype.init({
		renderTo:"#dropDownProjectType1",
		url:"../../../component/assetLeixing.html?ticket="+ticket+"&assetClassCode="+assetClassCode,
		height:"200px",
		onSelected:function(result){
			$("#dropDownProjectType1").val(result.assetTypeName);
			assetTypeCode = result.assetTypeCode;  
			assetTypeName = result.assetTypeName;
			ngScope.loadProjects(searchName,assetTypeCode, assetClassCode, 1,proNo,loanUnitCode,fromDate,isUse,isPeriod);
		}
	});
	
	/* 项目类型 */
	new DropDownList().init({
		renderTo:".proType",
		url:"../../../component/projectType.html?required=false&ticket="+ticket,
		height:"200px",
		onSelected:function(result){
			$(".proType").val(result.categoryName);
			category_Code = result.categoryCode;
			category_Name=result.categoryName;
			var url = "../../../component/projectList.html?categoryCode="+category_Code+"&required=false&ticket="+ticket;
			proTypes.setConfig("url", url);
			
		}
	});
	/* 项目列表 */
	proTypes=new DropDownList();
	proTypes.init({
		renderTo:".proNameD",
		url:"../../../component/projectList.html?categoryCode="+category_Code+"&required=false&ticket="+ticket,
		height:"200px",
		onSelected:function(result){
			$(".proNameD").val(result.proName);
			proNo=result.proNo;
			proName=result.proName;
			$scope.loadProjects(searchName,assetTypeCode, assetClassCode, 1,proNo,loanUnitCode,fromDate,isUse,isPeriod);
		}
	});
	
	/* 部门列表 */
	new DropDownList().init({
		renderTo:"input[name=loanUnitName]",
		url:"../../../component/orgTree.html?required=true",
		height:"200px",
		onSelected:function(result){
			$("input[name=loanUnitName]").val(result.unitName);
			
			loanUnitName=result.unitName;
			loanUnitCode=result.unitCode;
			$scope.loadProjects(searchName,assetTypeCode, assetClassCode, 1,proNo,loanUnitCode,fromDate,isUse,isPeriod);
			
		}
	});


	//当日是否使用
	new DropDownList().init({
			renderTo:"#dropDownIsUse",
			mode:"list",
			data:[{id:0, name:"全部"},{id:1, name:"是"},{id:2, name:"否"},{id:3, name:"未扫码"},{id:4, name:"未盘点先使用"},{id:5, name:"在库"}],
			textField:"name",
			onSelected:function(item){
				$("#dropDownIsUse").val(item.name);
				isUse=item.id;
			}
	});
	
	
	//盘点周期
	new DropDownList().init({
			renderTo:"#dropDownPeriod",
			mode:"list",
			data:[{id:0, name:"全部"},{id:1, name:"日"},{id:2, name:"周"},{id:3, name:"月"}],
			textField:"name",
			onSelected:function(item){
				$("#dropDownPeriod").val(item.name);
				isPeriod=item.id;
			}
	});
	
	
	
	/* 加载数据 */
	$scope.loadProjects=function(searchName,assetTypeCode, assetClassCode,currentPage,proNo,loanUnitCode,fromDate,isUse,isPeriod){
	
	    if(loanUnitCode=="0"){
	    	
	    	loanUnitCode="";
	    }
		if($("#saveForm").valid()){
		
			$http.get(serviceBasePath+"eap/pmsServices/materielMg/assetMg/assetCheck/list?assetTypeCode="
			+assetTypeCode+"&assetClassCode="+assetClassCode+
			"&currentPage="+currentPage+"&ticket="+ticket+"&loanProNo="+proNo+"&searchName="+searchName+"&loanUnitCode="+loanUnitCode+"&fromDate="+fromDate+"&isUse="+isUse+"&isPeriod="+isPeriod).success(function(response){
			if(response.statusCode==401){
				alert("用户凭据过期！请重新登录！");
				window.top.location.href="../../login.html";
				return;
			}
			console.log(response.list);
			$scope.projectList = response.list;
			createPageBar(response.totalPage, response.currentPage,response.totalRecord);
			});
		}
	};
	/* 查询 */
	$scope.doQuery=function(){
			fromDate=$("input[name=fromDate]").val();
			searchName = $("input[name=searchName]").val();
			
		    $scope.loadProjects(searchName,assetTypeCode, assetClassCode,1,proNo,loanUnitCode,fromDate,isUse,isPeriod);
	};
	
	
	$scope.doExport=function(){
		location.href=serviceBasePath+"eap/pmsServices/materielMg/assetMg/assetCheck/export?assetTypeCode="
			+assetTypeCode+"&assetClassCode="+assetClassCode+"&ticket="+ticket+"&loanProNo="+proNo+"&searchName="+searchName+"&loanUnitCode="+loanUnitCode+"&fromDate="+fromDate+"&isUse="+isUse+"&isPeriod="+isPeriod;
	};
	
	/* 显示 */
	$scope.doShow=function(item){
		
	 new ShowDlog().showFrame("assetsUseList.html?assetCode="+item.ASSET_CODE+"&fromDate="+fromDate+"&assetName="+encodeURIComponent(item.ASSET_NAME), "查看详细", function(){
		}, "detailDialog");	
	};
	
	/*盘点图片查看*/
	$scope.viewCheckPic=function(item)
	{
		console.log(item);
	}
	
	/* 初始查询 */
	$scope.loadProjects(searchName,assetTypeCode, assetClassCode, _currentPage,proNo,loanUnitCode,fromDate,isUse,isPeriod);
});
</script>
</body>
</html>
