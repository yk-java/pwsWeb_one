<!DOCTYPE HTML>
<html>
<head>
<title>物资入库新增</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<script type="text/javascript" src="../../../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script></head>
<script type="text/javascript" src="../../../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../../../js/PageBar.js"></script>
<script type="text/javascript" src="../../../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../../js/DropDownList-1.2/DropDownList.css" />
<script type="text/javascript" src="../../../../../js/Calendar.js"></script>
<script type="text/javascript" src="../../../../../js/config.js"></script>
<script type="text/javascript" src="../../../../../js/SimpleDateFormat.js"></script>

<script type="text/javascript" src="../../../../../js/util.js"></script>
<script type="text/javascript" src="../../../../../js/eapJs/core/eap.core.js" ></script>
<script type="text/javascript" src="../../../../../js/eapJs/plugins/eap.tip.js" ></script>
<script type="text/javascript" src="../../../../../js/eapJs/plugins/eap.validate.js"></script>
<script type="text/javascript" src="../../../../../js/eapJs/local/eap.lang-zh_CN.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../../css/validate.css"/>
<link rel="stylesheet" type="text/css" href="../../../../../css/edit.css"/>
<script type="text/javascript" src="../../../../../js/jquery.form.js"></script>

<script type="text/javascript" src="../../../../../js/showDlog/showDlog.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../../js/showDlog/showDlog-blue.css" />

<script type="text/javascript" src="../../../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../../../../js/DropDownList-1.2/DropDownList.css" />

<style type="text/css">
	#saveForm{color:#999}
	.addBtn{padding:3px 8px;border-radius:5px;border:1px solid #797979;color:#797979;cursor:pointer;}
	.addBtn:hover{background:#eee}
	.dlog-edit2{width:500px;height:350px;}
	.addDataList_tr{height: 40px;line-height: 40px;border-bottom:1px solid #ccc}
	.addDataList_tr.th{font-weight: bold;}
</style>
</head>

<body ng-app="userMgr" ng-controller="userMgrCtrl">

<div class="list">
	<div class="list_content">
		<div class="title_div">
			<div class="title_left">
				<label class="title">废料出入库修改</label>
			</div>
			<img src="../../../../../img/list_Header2-.png">
		</div>
		<div class="tabs">
			<a href="#lay1" class="tab selected">基本信息</a>
		</div>
		<form id="saveForm" class="required-validate">
		<div class="form_div" id="lay1">
			<table>
				<tr>
					<th>标题</th>
					<td><input type="text" name="processTitle" id="processTitle" class="required" value="{{getItemData.PROCESS_TITLE}}"/></td>
					<th>项目类别</th>
					<td>
						<input type="text" class="dropDownProjectType required" value="{{getItemData.CATEGORY_NAME}}" style="width:180px;" placeholder="项目类别"/>
						<input type="hidden" name="processCode">
						<input type="hidden" name="processStatus" value="1">
						<input type="hidden" name="sponsor" value="{{getItemData.SPONSOR}}">
						<input type="hidden" name="startDesc" value="{{getItemData.START_DESC}}">
					</td>	
				</tr>
				<tr>
					<th>项目名称</th>
					<td>
						<input type="text"  class="dropDownTree dropDownList required" value="{{getItemData.PRO_NAME}}" style="width:180px;" placeholder="请选择项目"/>
						<input type="hidden" name="proNo" value="{{getItemData.PRO_CODE}}">
						<input type="hidden" name="attrJson">
					</td>
					<th>流程类型</th>
					<td>
						<input type="text" name="processTypeName" value="{{getItemData.PROCESS_TYPE_Name}}" id="processTypeName" class="dropDownList required" style="width:180px;" placeholder="请选择流程类型"/>
						<input type="hidden" name="processType" value="{{getItemData.PROCESS_TYPE}}">
						<input type="hidden" name="outAmount" id="outAmount">
					</td>
				</tr>
				<tr ng-if="getItemData.PROCESS_STATUS==4||getItemData.PROCESS_STATUS==5">
					<th>审核时间</th>
					<td colspan="3">
						<input type="text" value="{{getItemData.STOREMAN_AUDIT_TIME}}"  class="readonly" readonly="readonly">
					</td>
				</tr>
				<tr ng-if="getItemData.PROCESS_STATUS==6||getItemData.PROCESS_STATUS==7">
					<th>审核时间</th>
					<td colspan="3">
						<input type="text" value="{{getItemData.FINANCE_AUDIT_TIME}}"  class="readonly" readonly="readonly">
					</td>
				</tr>
				<tr ng-if="getItemData.PROCESS_TYPE==1 && getItemData.PROCESS_STATUS==4||getItemData.PROCESS_STATUS==5">
					<th>审核描述</th>
					<td colspan="3">
						<textarea style="width:100%;height:80px"  class="readonly" readonly="readonly">{{getItemData.STOREMAN_AUDIT_DESC}}</textarea>
					</td>
				</tr>
				<tr ng-if="getItemData.PROCESS_TYPE==2 && getItemData.PROCESS_STATUS==6||getItemData.PROCESS_STATUS==7">
					<th>审核描述</th>
					<td colspan="3">
						<textarea style="width:100%;height:80px"  class="readonly" readonly="readonly">{{getItemData.FINANCE_AUDIT_DESC}}</textarea>
					</td>
				</tr>
			</table>
		</div>
		<div class="tabs">
			<a href="#lay1" class="tab selected">物资列表</a>
			<span class="addBtn" ng-click="addMaterials()">新增</span>
		</div>
		<div class="form_div" id="lay12">
			<table width="600px" class="table1">
				<tr class="addDataList_tr th">
					<td align="center"><div class="table_title">名称</div></td>
					<td align="center"><div class="table_title">数量</div></td>
					<td align="center" ng-if="processType==2"><div class="table_title">价格</div></td>
					<td align="center"><div class="table_title">仓库</div></td>
					<td align="center"><div class="table_title">操作</div></td>
				</tr>
				<tr ng-repeat="item in addDataList" class="addDataList_tr">
					<td align="center"><div>{{item.categoryName}}</div></td>
					<td align="center"><div>{{item.num}}</div></td>
					<td align="center" ng-if="processType==2"><div>{{item.price}}</div></td>
					<td align="center"><div>{{item.storeName}}</div></td>
					<td align="center">
						<div>
							<img src="../../../../../img/materialsAddEdit.png" ng-click="EditMaterials(item,$index)" style="margin-right:10px;cursor:pointer"/>
							<img src="../../../../../img/materialsAddDelete.png" ng-click="delAddList($index)" style="cursor:pointer"/>
						</div>
					</td>
				</tr>
			</table>
		</div>
		</form>
		<div class="form_bottom">
			<a href="javascript:" ng-click="onSave()" class="title_save">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;保存
			</a>
			<a href="javascript:" ng-click="onCancel()" class="title_cancel">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;取消
			</a>
		</div>
		
	</div>
</div>
<script type="text/javascript">
var proNo="";//项目
var proName="";
var cond_categoryCode="";
var cond_categoryName="";
var cond_proStatus="2";
var validator;
var ngScope;
var userData;
var app = angular.module("userMgr", []);
app.controller("userMgrCtrl", function($scope, $http){
	/* init */
	ngScope = $scope;
	$scope.curUnit={};
	$scope.userList=[];
	
	var userDataStr = $.cookie("pmsWeb_user_data");
	if(!userDataStr){
		
		noLogin(location.href);
		return;
	}
	userData = jQuery.parseJSON(userDataStr);
	ticket = $.cookie("pmsWeb_ticket");
	$scope.urlParams = getUrlParams();
	var processCode=$scope.urlParams.processCode;
	var processType="";
	$scope.processType="";
	$("input[name=processCode]").val(processCode);
	$http.get(serviceBasePath+"eap/pmsServices/goods/getWasteProcessDetail?processCode="+processCode).success(function(response){
		if(response.statusCode==401){
			alert("用户凭据过期！请重新登录！");
			window.top.location.href="../../login.html";
			return;
		}
		$scope.getItemData=response.data.goodObj;
		if($scope.getItemData.PROCESS_TYPE==1){
			$scope.getItemData.PROCESS_TYPE_Name="废料入库"
		}else if($scope.getItemData.PROCESS_TYPE==2){
			$scope.getItemData.PROCESS_TYPE_Name="废料出库"
		}
		processType=$scope.getItemData.PROCESS_TYPE;
		$scope.processType=$scope.getItemData.PROCESS_TYPE;
		$scope.addDataList=response.data.goodslist;
		if($scope.getItemData.PIC1&&$scope.getItemData.PIC1!=''){
			$scope.st=filePath+"?fileCode="+$scope.getItemData.PIC1+"&attachment=0";
			$("#lldImg").attr("src",$scope.st);
		}
	});
	
	/* 
	$("input[name=sponsor]").val(userData.employeeCode);
	var today = new SimpleDateFormat({formatString:"yyyy-MM-dd"}).format(new Date());
	$("#processTitle").val("退料入库_"+today); */
	new DropDownList().init({
		renderTo:"#processTypeName",
		mode:"list",
		data:[{id:1, name:"废料入库"},{id:2, name:"废料出库"}],
		textField:"name",
		onSelected:function(item){
			$("#processTypeName").val(item.name);
			$("input[name=processType]").val(item.id);
			processType=item.id;
			$scope.processType=processType;
			$scope.addDataList=[];
			$scope.$apply();
		}
	});
	
	/* 表单验证 */
	validator = $("#saveForm").validate({
		onsubmit: false,
		focusInvalid: false,
		focusCleanup: true,
		errorElement: "span",
		ignore:".ignore",
		invalidHandler: function(form, validator) {
			var errors = validator.numberOfInvalids();
			if (errors) {
				
			} 
		}
	});
	
	var proUrl="../../../../component/allProjectList.html";
	/* 项目类型 */
	new DropDownList().init({
		renderTo:".dropDownProjectType",
		url:"../../../../component/projectType.html?required=false&ticket="+ticket,
		height:"200px",
		onSelected:function(result){
			$(".dropDownProjectType").val(result.categoryName);
			cond_categoryCode = result.categoryCode;
			cond_categoryName =result.categoryName ;
			/* 联动 */
			projectList.setConfig("url", proUrl+"?categoryCode="+cond_categoryCode+"&proStatus="+cond_proStatus+"&required=false&ticket="+ticket);
		}
	});

	/* 项目列表 */
	var projectList = new DropDownList();
	projectList.init({
		renderTo:".dropDownTree",
		url:proUrl+"?categoryCode="+cond_categoryCode+"&proStatus="+cond_proStatus+"&required=false&ticket="+ticket,
		height:"200px",
		onSelected:function(result){
			$(".dropDownTree").val(result.proName);
			$("input[name=proNo]").val(result.proNo);
		}
	});

	$scope.addDataList=[];
	$scope.addMaterials=function(){
		new ShowDlog().showFrame("materialsAdd.html?processType="+processType, "新增物资", function(res){
			if("SUCCESS"==res.resultCode){
				$scope.addDataList.push(res.formData);
				$scope.$apply();
			}
		}, "dlog-edit2");
	};
	$scope.EditMaterials=function(item,index){
		new ShowDlog().showFrame("materialsEdit.html?categoryCode="+item.categoryCode+"&categoryName="+item.categoryName
				+"&num="+item.num+"&storeCode="+item.storeCode+"&storeName="+item.storeName+"&storeNo="+item.storeNo+"&processType="+processType+"&price="+item.price, "修改物资", function(res){
			if("SUCCESS"==res.resultCode){
				$scope.addDataList[index]=res.formData;
				$scope.$apply();
			}
		}, "dlog-edit2");
	};
	
	$scope.delAddList=function(index){
		new ShowDlog().confirm({
			msg:"确定删除吗？",
			ok:function(){
				$scope.addDataList.splice(index,1);
				$scope.$apply();
			},
			cancel:function(){}
		});

	};
	
	/* 保存 */
	$scope.onSave = function(){
		var attrJson=JSON.stringify($scope.addDataList);
		$("input[name=attrJson]").val(attrJson);
		if($("#saveForm").valid()){
			var params = serializeArrayToMap($("#saveForm").serializeArray());
			if($("#saveForm").valid()){
				new ShowDlog().prompt({
					icon:"waitting",
					msg:"正在保存...",
					done:function(){},
					t:60*1000
				});
				var options = {
						success: function(responseText, statusText) {
							if(responseText.statusCode=="200"){
								$dlog.close();
								new ShowDlog().prompt({
									icon:"success",
									msg:"保存成功！",
									done:function(){
										location.href="wasteStorageList.html";
									},
									t:1500
								});
							}
						},      //提交后的回调函数   
						type: "post",               //默认是form的method（get or post），如果申明，则会覆盖  
						dataType: "json",           //html(默认), xml, script, json...接受服务端返回的类型  
						clearForm: false,          //成功提交后，清除所有表单元素的值
						url:serviceBasePath+"eap/pmsServices/goods/updateWasteProcess",
						error: function(xhr, status, error) {
							console.log(error);
						}
					};
				$("#saveForm").ajaxSubmit(options);
			}
		}
	};
	
	/* 取消 */
	$scope.onCancel = function(){
		location.href="wasteStorageList.html";
	};
	
	

});
var img1="";
function loadfileName(obj){
	var filePath=$(obj).val();
	console.log(filePath);
	img1=filePath;
	var f = document.getElementById('photo').files[0];
	var src = window.URL.createObjectURL(f);
	$(obj).siblings("img").attr("src",src);
}
</script>
</body>
</html>
