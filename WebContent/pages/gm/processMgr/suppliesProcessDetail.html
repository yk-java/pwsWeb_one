<!DOCTYPE HTML>
<html>
<head>
<title>耗材申请流程处理</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<script type="text/javascript" src="../../../js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../js/jquery.cookie.js"></script>
<script type="text/javascript" src="../../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script></head>
<script type="text/javascript" src="../../../angular-1.4.6/angular.min.js"></script>
<script type="text/javascript" src="../../../js/PageBar.js"></script>
<script type="text/javascript" src="../../../js/DropDownList-1.2/DropDownList-v1.2.js"></script>
<link rel="stylesheet" type="text/css" href="../../../js/DropDownList-1.2/DropDownList.css" />
<script type="text/javascript" src="../../../js/Calendar.js"></script>
<script type="text/javascript" src="../../../js/config.js"></script>
<script type="text/javascript" src="../../../js/util.js"></script>
<script type="text/javascript" src="../../../js/ng-base.js"></script>
<script type="text/javascript" src="../../../js/SimpleDateFormat.js"></script>
<script type="text/javascript" src="../../../js/eapJs/core/eap.core.js" ></script>
<script type="text/javascript" src="../../../js/eapJs/plugins/eap.tip.js" ></script>
<script type="text/javascript" src="../../../js/eapJs/plugins/eap.validate.js"></script>
<script type="text/javascript" src="../../../js/eapJs/local/eap.lang-zh_CN.js"></script>
<link rel="stylesheet" type="text/css" href="../../../css/validate.css"/>
<link rel="stylesheet" type="text/css" href="../../../css/edit.css"/>
<script type="text/javascript" src="../../../js/showDlog/showDlog.js"></script>
<link rel="stylesheet" type="text/css" href="../../../js/showDlog/showDlog-blue.css" />
</head>
<style>
	.table1 *{color:#999}
	.table_list{background:#f2f2f2;padding:20px;width:700px;color:#999}
	.table{border:1px solid #eee;}
	.table_title{font-weight:bold;text-align:center}
	.table .table_title{background:#d4d4d4}
	.table *{color:#999}
	.num{width:80px;min-width:80px !important;text-align:center}
	.table td,.table th{height:30px;line-height:30px;padding:10px;border:1px solid #ccc}
	.table1 tr{border-bottom:1px dashed #ccc}
	.table1 tr{height:40px;line-height:40px}
</style>
<body ng-app="userMgr" ng-controller="userMgrCtrl">

<div class="list">
	<div class="list_content">
		<div class="title_div">
			<div class="title_left">
				<label class="title">耗材流程处理</label> 
			</div>
			<img src="../../../img/list_Header2-.png">
		</div>
		<form id="saveForm" class="required-validate">
		<div class="form_div" id="lay1">
			<div class="table_list">
				<table width="100%" class="table">
					<tr>
						<td style="width:70px"  class="table_title">物品名称</td>
						<td colspan="3">{{doneList.materialName}}</td>
					</tr>
					<tr>
						<td class="table_title">类型</td>
						<td>{{doneList.assetClassName}}</td>
						<td class="table_title">数量</td>
						<td>{{doneList.useCount}}</td>
					</tr>
					<tr>
						<td class="table_title">分类</td>
						<td>{{doneList.assetTypeName}}</td>
						<td class="table_title">项目组</td>
						<td>{{doneList.loanProName}}</td>
					</tr>
					<tr>
						<td class="table_title">使用人</td>
						<td>{{doneList.loanEmployeeName}}</td>
						<td class="table_title">领用时间</td>
						<td>{{doneList.useDate}}</td>
					</tr>
					<tr>
						<td class="table_title">发放人</td>
						<td>{{doneList.grantManName}}</td>
						<td class="table_title">归还人</td>
						<td>{{doneList.receiveManName}}</td>
					</tr>
					<tr>
						<td class="table_title">用途</td>
						<td colspan="3">{{doneList.useDesc}}</td>
					</tr>
				</table>
			</div>
		</div>
		<div class="form_bottom" style="margin-top:50px">
			<a href="javascript:" ng-click="onCancel()" class="title_cancel">
 				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;取消
 			</a>
		</div>
		</form>
	</div>
</div>
<script type="text/javascript">

var validator;
var ngScope;
var userData;
var app = angular.module("userMgr", []);
app.controller("userMgrCtrl", function($scope, $http){
	/* init */
	ngScope = $scope;
	var userDataStr = $.cookie("pmsWeb_user_data");
	if(!userDataStr){
		window.noLogin(location.href);
		return;
	}
	userData = jQuery.parseJSON(userDataStr);
	ticket = $.cookie("pmsWeb_ticket");
	var urlParams = getUrlParams();
	/* 表单验证 */
	validator = $("#saveForm").validate({
		onsubmit: false,
		focusInvalid: false,
		focusCleanup: true,
		errorElement: "span",
		ignore:".ignore",
		invalidHandler: function(form, validator) {
			var errors = validator.numberOfInvalids();
			if (errors) {
			} 
		}
	});
	$scope.dataList={};
	$http.get(serviceBasePath+"eap/pmsServices/materielMg/assetMg/material/materialFlow?flowCode="+urlParams.flowCode).success(function(response){
		if(response.statusCode==200){
			$scope.doneList = response.data;
		}
	});
	$http.get(serviceBasePath+"eap/pmsServices/materielMg/assetMg/material/listAll?assetTypeCode="+urlParams.assetTypeCode).success(function(response){
		if(response.statusCode==200){
			$scope.dataList = response.list;
		}
	});
	/* 比较 库存 */
	var error1="";
	$scope.checkNum=function(item){
		if(item.checkNu>item.curcountStorage){
			new ShowDlog().prompt({
				icon:"error",
				msg:"库存不足！",
				done:function(){
					error1=1;
				},
				t:1500
			});		
		}
	};
	
	var auditContent="";
	var remarks="";
	var formData={};
	/* 保存 */
	$scope.onSave = function(){
		remarks=$("#remarks").val()
		var arr=[];
		$(".num").each(function(){
			arr.push($(this).val());
		});
		var item;
		for(var i=0;i<$scope.dataList.length;i++){
			item = $scope.dataList[i];
		}
		var it;
		for(var j=0;j<arr.length;j++){
			it =arr[j];
			auditContent+=item.materialBatchno+","+it+";";
		}
		formData.remarks=remarks;
		formData.auditContent=auditContent;
		formData.flowCode=urlParams.flowCode;
		formData.rentStatus=1;
		formData.flowStatus=2;
		formData.grantMan=userData.employeeCode;
		if(error1==1){
			new ShowDlog().prompt({
				icon:"error",
				msg:"库存不足，请检查后提交！",
				done:function(){
					error1=1;
				},
				t:1500
			});		
		}
		if($("#saveForm").valid() && error1!=1){
			new ShowDlog().prompt({
				icon:"waitting",
				msg:"正在提交...",
				done:function(){},
				t:60*1000
			});
			$http.post(serviceBasePath+"eap/pmsServices/materielMg/assetMg/material/auditBorrowMaterial", 
					formData, 
					{
						headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},
						transformRequest:function(data){
							return $.param(data);
						}
					}).success(function(res){
					if(res.statusCode==200){
						$dlog.close();
						new ShowDlog().prompt({
							icon:"success",
							msg:"提交成功！",
							done:function(){
								location.href="suppliesProcessMgr.html"
							},
							t:1500
						});		
					}
				});
		}
	};
	$scope.bohuie = function(){
		remarks=$("#remarks").val()
		formData.remarks=remarks;
		formData.flowCode=urlParams.flowCode;
		formData.rentStatus=0;
		formData.flowStatus=3;
		formData.grantMan=userData.employeeCode;
		new ShowDlog().prompt({
			icon:"waitting",
			msg:"正在提交...",
			done:function(){},
			t:60*1000
		});
		$http.post(serviceBasePath+"eap/pmsServices/materielMg/assetMg/material/auditBorrowMaterial", 
				formData, 
				{
					headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},
					transformRequest:function(data){
						return $.param(data);
					}
				}).success(function(res){
				if(res.statusCode==200){
					$dlog.close();
					new ShowDlog().prompt({
						icon:"success",
						msg:"提交成功！",
						done:function(){
							location.href="suppliesProcessMgr.html"
						},
						t:1500
					});		
				}
			}
		);
	};
	
	
	$scope.onCancel=function(){
		window.history.back();
	};
});
</script>
</body>
</html>
