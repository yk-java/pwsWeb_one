<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.glens.pwCloudOs.pe.baseMgr.materialUse.dao.MaterialUseVoMapper" >
  <resultMap id="BaseResultMap" type="com.glens.pwCloudOs.pe.baseMgr.materialUse.vo.MaterialUseVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="rowid" property="rowid" jdbcType="BIGINT" />
    <result column="MATERIAL_BATCHNO" property="materialBatchno" jdbcType="VARCHAR" />
    <result column="MATERIAL_NAME" property="materialName" jdbcType="VARCHAR" />
    <result column="RESERVE_PRO_NO" property="reserveProno" jdbcType="VARCHAR" />
    <result column="REMOULD_BATCH_CODE" property="remouldBatchcode" jdbcType="VARCHAR" />
    <result column="RESERVE_ORGCODE" property="reserveOrgcode" jdbcType="REAL" />
    <result column="USE_PERSON" property="usePerson" jdbcType="VARCHAR" />
    <result column="USE_COUNT" property="useCount"  />
    <result column="USE_DATE" property="useDate" jdbcType="VARCHAR" />
    <result column="USE_DESC" property="useDesc" jdbcType="VARCHAR" />
    <result column="FLOW_STATUS" property="flowStatus" jdbcType="VARCHAR" />
    <result column="REMARKS" property="remarks" jdbcType="VARCHAR" />
  </resultMap>
  
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
  u.MATERIAL_BATCHNO,b.MATERIAL_NAME,u.RESERVE_PRO_NO,u.REMOULD_BATCH_CODE,u.RESERVE_ORGCODE,u.USE_PERSON,u.USE_COUNT,u.USE_DATE,USE_DESC,u.FLOW_STATUS,u.REMARKS
  </sql>
  
  <select id="queryForCount" parameterType="java.util.HashMap" resultType="int">
  	select count(*)
  	from pe_bs_rp_material_use 
  	where 1=1 and FLOW_STATUS=4
  	<if test="searchName != null and searchName != ''">
		and (REMOULD_BATCH_CODE like "%"#{searchName}"%" or RESERVE_ORGCODE like "%"#{searchName}"%"  or USE_PERSON like "%"#{searchName}"%" )
    </if>
    <if test="reserveProno != null and reserveProno != ''">
		and RESERVE_PRO_NO=#{reserveProno}
    </if>
    <if test="materialBatchno != null and materialBatchno != ''">
		and MATERIAL_BATCHNO=#{materialBatchno}
    </if>
  </select>
  
  <select id="queryForPage" parameterType="java.util.HashMap" resultMap="BaseResultMap">
  	select 
    <include refid="Base_Column_List" />
    FROM pe_bs_rp_material_use u
    left join pe_bs_rp_material_base b on b.MATERIAL_BATCHNO=u.MATERIAL_BATCHNO
    where 1=1 and u.FLOW_STATUS=4
  	<if test="searchName != null and searchName != ''">
		and (u.REMOULD_BATCH_CODE like "%"#{searchName}"%" or u.RESERVE_ORGCODE like "%"#{searchName}"%"  or u.USE_PERSON like "%"#{searchName}"%" )
    </if>
     <if test="reserveProno != null and reserveProno != ''">
		and u.RESERVE_PRO_NO=#{reserveProno}
    </if>
    <if test="materialBatchno != null and materialBatchno != ''">
		and u.MATERIAL_BATCHNO=#{materialBatchno}
    </if>
  	limit #{firstResult},#{maxResult}
  </select>
  
  <select id="findById" resultMap="BaseResultMap" parameterType="com.glens.pwCloudOs.pe.baseMgr.materialUse.vo.MaterialUseVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    FROM pe_bs_rp_material_use u
    left join pe_bs_rp_material_base b on b.MATERIAL_BATCHNO=u.MATERIAL_BATCHNO
     where u.rowid=#{rowid}
  </select>
  <delete id="delete" parameterType="com.glens.pwCloudOs.pe.baseMgr.materialUse.vo.MaterialUseVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from pe_bs_rp_material_use
    where rowid = #{rowid}
  </delete>
  <insert id="insert" parameterType="com.glens.pwCloudOs.pe.baseMgr.materialUse.vo.MaterialUseVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    INSERT INTO pe_bs_rp_material_use(MATERIAL_BATCHNO,RESERVE_PRO_NO,REMOULD_BATCH_CODE,RESERVE_ORGCODE,
    USE_PERSON,USE_COUNT,USE_DATE,USE_DESC,FLOW_STATUS,SYS_CREATE_TIME,SYS_PROCESS_FLAG,REMARKS)
VALUES(#{materialBatchno},#{reserveProno},#{remouldBatchcode},#{reserveOrgcode},#{usePerson},#{useCount},#{useDate},#{useDesc},4,now(),'1',#{remarks})


  </insert>
  
  <update id="updateMaterialCount" parameterType="map">
  	   update pe_bs_rp_material_base set CURCOUNT_STORAGE=CURCOUNT_STORAGE-#{curcountStorage}
		where MATERIAL_BATCHNO=#{materialBatchno}
  </update>
  
  <update id="update" parameterType="com.glens.pwCloudOs.pe.baseMgr.materialUse.vo.MaterialUseVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update pe_bs_rp_material_use
    <set >
      <if test="materialBatchno != null" >
        MATERIAL_BATCHNO = #{materialBatchno,jdbcType=VARCHAR},
      </if>
      <if test="reserveProno != null and materialTypeCost !=''">
      RESERVE_PRO_NO = #{reserveProno},
      </if>
      <if test="remouldBatchcode != null" >
        REMOULD_BATCH_CODE = #{remouldBatchcode},
      </if>
      <if test="reserveOrgcode != null" >
        RESERVE_ORGCODE = #{reserveOrgcode,jdbcType=VARCHAR},
      </if>
      <if test="usePerson != null" >
        USE_PERSON = #{usePerson,jdbcType=VARCHAR},
      </if>
       <if test="useCount != null" >
        USE_COUNT = #{useCount,jdbcType=VARCHAR},
      </if>
      <if test="useDate != null" >
        USE_DATE = #{useDate,jdbcType=VARCHAR},
      </if>
      <if test="useDesc != null" >
        USE_DESC = #{useDesc,jdbcType=VARCHAR},
      </if>
       <if test="remarks != null" >
        REMARKS = #{remarks,jdbcType=VARCHAR},
      </if>
      SYS_UPDATE_TIME = now()
    </set>
    where rowid = #{rowid}
  </update>
  
  <select id="getMaterialType" parameterType="map">
  		select MATERIALTYPE_CODE typeCode,MATERIALTYPE_NAME typeName from PE_BS_RP_MATERIALTYPE
		where company_code=#{companyCode}
  </select>
  
  <select id="getMaterialBase" parameterType="map" resultType="map">
  		select  MATERIAL_NAME materialName,MATERIAL_BATCHNO materialNo from PE_BS_RP_MATERIAL_BASE
		where 1=1
		<if test="materialtypeCode != null and materialtypeCode != '' " >
        and MATERIALTYPE_CODE=#{materialtypeCode}
      </if>
		
  </select>
  
  <select id="getPros" parameterType="map"  resultType="map">
  		select RESERVE_PRO_NO proNo,RESERVE_PRO_NAME proName from PE_BS_RESERVE_PRO
		where company_code=#{companyCode}
  </select>
  
</mapper>