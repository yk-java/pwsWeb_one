<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.glens.pwCloudOs.materielMg.assetMg.materialBase.dao.MaterialBaseVoMapper" >
  <resultMap id="BaseResultMap" type="com.glens.pwCloudOs.materielMg.assetMg.materialBase.vo.MaterialBaseVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <result column="MATERIAL_BATCHNO" property="materialBatchno" jdbcType="VARCHAR" />
    <result column="MATERIAL_NAME" property="materialName" jdbcType="VARCHAR" />
    <result column="ASSET_CLASS_NAME" property="assetClassName" jdbcType="VARCHAR" />
    <result column="ASSET_TYPE_CODE" property="assetTypeCode" jdbcType="VARCHAR" />
    <result column="ASSET_TYPE_NAME" property="assetTypeName" jdbcType="VARCHAR" />
    <result column="BRAND" property="brand" jdbcType="VARCHAR" />
    <result column="MODEL_NO" property="modelNo" jdbcType="VARCHAR" />
    <result column="FORMS" property="forms" jdbcType="VARCHAR" />
    <result column="PRICE1" property="price1" jdbcType="REAL" />
    <result column="PRICE2" property="price2" jdbcType="REAL" />
    <result column="TOTAL1" property="total1" jdbcType="REAL" />
    <result column="TOTAL2" property="total2" jdbcType="REAL" />
    <result column="BILL" property="bill" jdbcType="VARCHAR" />
    <result column="DATE_PURCHASE" property="datePurchase" />
    <result column="DATE_STORAGE" property="dateStorage" />
    <result column="COUNT_STORAGE" property="countStorage" />
    <result column="CURCOUNT_STORAGE" property="curcountStorage" />
    <result column="REMARKS" property="remarks" jdbcType="VARCHAR" />
    <result column="INVOICE_TYPE" property="invoiceType" />
  </resultMap>
  <sql id="Base_Column_List" >
 
   	   a.MATERIAL_BATCHNO, a.MATERIAL_NAME, a.ASSET_TYPE_CODE, a.PRICE1, a.PRICE2,a.TOTAL1,a.TOTAL2, a.BILL, DATE_FORMAT(a.DATE_PURCHASE,'%Y-%m-%d') DATE_PURCHASE, 
       DATE_FORMAT(a.DATE_STORAGE,'%Y-%m-%d') DATE_STORAGE,a.COUNT_STORAGE,a.CURCOUNT_STORAGE,a.REMARKS, b.ASSET_TYPE_NAME, c.ASSET_CLASS_NAME, 
       a.BRAND,a.MODEL_NO,a.FORMS,a.INVOICE_TYPE
       
  </sql>
  
  <select id="queryForCount" parameterType="java.util.HashMap" resultType="int">
  	select count(*) from GM_MATERIAL_BASE a
  	join GM_ASSET_TYPE b on a.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE
  	join GM_ASSET_CLASS c on b.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE
  	where a.SYS_PROCESS_FLAG='1'
  	<if test="assetClassCode != null and assetClassCode !=''">
  	and b.ASSET_CLASS_CODE=#{assetClassCode}
  	</if>
  	<if test="assetTypeCode != null and assetTypeCode !=''">
  	and b.ASSET_TYPE_CODE=#{assetTypeCode}
  	</if>
  	<if test="materialName != null and materialName != ''">
  		and (a.MATERIAL_NAME like "%"#{materialName}"%" or a.BRAND like "%"#{materialName}"%" or a.MODEL_NO like "%"#{materialName}"%" )
  	</if>
  	
  	
  </select>
  
  <select id="queryForPage" parameterType="java.util.HashMap" resultMap="BaseResultMap">
  	select 
    <include refid="Base_Column_List" />
    from GM_MATERIAL_BASE a
    join GM_ASSET_TYPE b on a.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE
  	join GM_ASSET_CLASS c on b.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE
  	where a.SYS_PROCESS_FLAG='1'
  	<if test="assetClassCode != null and assetClassCode !=''">
  	and b.ASSET_CLASS_CODE=#{assetClassCode}
  	</if>
  	<if test="assetTypeCode != null and assetTypeCode !=''">
  	and b.ASSET_TYPE_CODE=#{assetTypeCode}
  	</if>
  	<if test="materialName != null and materialName != ''">
  		and (a.MATERIAL_NAME like "%"#{materialName}"%" or a.BRAND like "%"#{materialName}"%" or a.MODEL_NO like "%"#{materialName}"%" )
  	</if>
  	limit #{firstResult},#{maxResult}
  </select>
  
  <select id="getStaticsMaterial" parameterType="map" resultType="map">
  	select t.MATERIAL_NAME,t.ASSET_TYPE_NAME,t.ASSET_CLASS_NAME,t.BRAND,t.MODEL_NO,sum(t.COUNT_STORAGE) COUNT_STORAGE,sum(t.CURCOUNT_STORAGE) CURCOUNT_STORAGE  from (select 
  	 a.MATERIAL_BATCHNO, a.MATERIAL_NAME, a.ASSET_TYPE_CODE, a.PRICE1, a.PRICE2,a.TOTAL1,a.TOTAL2, a.BILL, DATE_FORMAT(a.DATE_PURCHASE,'%Y-%m-%d') DATE_PURCHASE, 
       DATE_FORMAT(a.DATE_STORAGE,'%Y-%m-%d') DATE_STORAGE,a.COUNT_STORAGE,a.CURCOUNT_STORAGE,a.REMARKS, b.ASSET_TYPE_NAME, c.ASSET_CLASS_NAME, 
       a.BRAND,a.MODEL_NO,a.FORMS,a.INVOICE_TYPE,b.ASSET_CLASS_CODE
    from GM_MATERIAL_BASE a
    join GM_ASSET_TYPE b on a.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE
  	join GM_ASSET_CLASS c on b.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE
  	where a.SYS_PROCESS_FLAG='1' 

	)  t
	where 1=1
	<if test="assetClassCode != null and assetClassCode !=''">
  	and t.ASSET_CLASS_CODE=#{assetClassCode}
  	</if>
  	<if test="assetTypeCode != null and assetTypeCode !=''">
  	and t.ASSET_TYPE_CODE=#{assetTypeCode}
  	</if>
  	<if test="materialName != null and materialName != ''">
  		and (t.MATERIAL_NAME like "%"#{materialName}"%" or t.BRAND like "%"#{materialName}"%" or t.MODEL_NO like "%"#{materialName}"%" )
  	</if>
  	
	GROUP BY  t.MATERIAL_NAME,t.MODEL_NO 
	limit #{firstResult},#{maxResult}
  </select>
  
   <select id="getStaticsMaterialCount" parameterType="java.util.HashMap" resultType="int">
   	select count(*) from(
   		select t.MATERIAL_NAME,t.ASSET_TYPE_NAME,t.ASSET_CLASS_NAME,t.BRAND,t.MODEL_NO,sum(t.COUNT_STORAGE) COUNT_STORAGE,sum(t.CURCOUNT_STORAGE) CURCOUNT_STORAGE  from (select 
  	 a.MATERIAL_BATCHNO, a.MATERIAL_NAME, a.ASSET_TYPE_CODE, a.PRICE1, a.PRICE2,a.TOTAL1,a.TOTAL2, a.BILL, DATE_FORMAT(a.DATE_PURCHASE,'%Y-%m-%d') DATE_PURCHASE, 
       DATE_FORMAT(a.DATE_STORAGE,'%Y-%m-%d') DATE_STORAGE,a.COUNT_STORAGE,a.CURCOUNT_STORAGE,a.REMARKS, b.ASSET_TYPE_NAME, c.ASSET_CLASS_NAME, 
       a.BRAND,a.MODEL_NO,a.FORMS,a.INVOICE_TYPE,b.ASSET_CLASS_CODE
    from GM_MATERIAL_BASE a
    join GM_ASSET_TYPE b on a.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE
  	join GM_ASSET_CLASS c on b.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE
  	where a.SYS_PROCESS_FLAG='1' 

	)  t
	where 1=1
	<if test="assetClassCode != null and assetClassCode !=''">
  	and t.ASSET_CLASS_CODE=#{assetClassCode}
  	</if>
  	<if test="assetTypeCode != null and assetTypeCode !=''">
  	and t.ASSET_TYPE_CODE=#{assetTypeCode}
  	</if>
  	<if test="materialName != null and materialName != ''">
  		and (t.MATERIAL_NAME like "%"#{materialName}"%" or t.BRAND like "%"#{materialName}"%" or t.MODEL_NO like "%"#{materialName}"%" )
  	</if>
  	
	GROUP BY  t.MATERIAL_NAME,t.MODEL_NO 
   	) tpa
   
   </select>
   
   <select id="getDetailMaterial" parameterType="map" resultType="map"> 
   		
   	
	select 
  		 a.MATERIAL_BATCHNO, a.MATERIAL_NAME, a.ASSET_TYPE_CODE, a.PRICE1, a.PRICE2,a.TOTAL1,a.TOTAL2, a.BILL, DATE_FORMAT(a.DATE_PURCHASE,'%Y-%m-%d') DATE_PURCHASE, 
       DATE_FORMAT(a.DATE_STORAGE,'%Y-%m-%d') DATE_STORAGE,a.COUNT_STORAGE,a.CURCOUNT_STORAGE,a.REMARKS, b.ASSET_TYPE_NAME, c.ASSET_CLASS_NAME, 
       a.BRAND,a.MODEL_NO,a.FORMS,a.INVOICE_TYPE
    from GM_MATERIAL_BASE a
    join GM_ASSET_TYPE b on a.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE
  	join GM_ASSET_CLASS c on b.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE
  	where a.SYS_PROCESS_FLAG='1' and a.MATERIAL_NAME=#{materialName} and a.MODEL_NO=#{modelNo}
   	
   </select>
  
  <select id="queryForList" parameterType="java.util.HashMap" resultMap="BaseResultMap">
  	select 
    <include refid="Base_Column_List" />
    from GM_MATERIAL_BASE a
    join GM_ASSET_TYPE b on a.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE
  	join GM_ASSET_CLASS c on b.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE
  	where a.SYS_PROCESS_FLAG='1' and CURCOUNT_STORAGE &gt;0
  	<if test="assetClassCode != null and assetClassCode !=''">
  	and b.ASSET_CLASS_CODE=#{assetClassCode}
  	</if>
  	<if test="assetTypeCode != null and assetTypeCode !=''">
  	and b.ASSET_TYPE_CODE=#{assetTypeCode}
  	</if>
  <if test="materialName != null and materialName != ''">
  		and (a.MATERIAL_NAME like "%"#{materialName}"%" or a.BRAND like "%"#{materialName}"%" or a.MODEL_NO like "%"#{materialName}"%" )
  	</if>
  </select>
  
  <select id="findById" resultMap="BaseResultMap" parameterType="com.glens.pwCloudOs.materielMg.assetMg.materialBase.vo.MaterialBaseVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from GM_MATERIAL_BASE a
    join GM_ASSET_TYPE b on a.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE
  	join GM_ASSET_CLASS c on b.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE
  	where a.SYS_PROCESS_FLAG='1'
    and  a.MATERIAL_BATCHNO = #{materialBatchno}
  </select>
  <delete id="delete" parameterType="com.glens.pwCloudOs.materielMg.assetMg.materialBase.vo.MaterialBaseVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from GM_MATERIAL_BASE
    where MATERIAL_BATCHNO = #{materialBatchno}
  </delete>
  <insert id="insert" parameterType="com.glens.pwCloudOs.materielMg.assetMg.materialBase.vo.MaterialBaseVo"  >
    
    insert into gm_material_base
	(MATERIAL_BATCHNO, MATERIAL_NAME, ASSET_TYPE_CODE, BRAND, MODEL_NO, FORMS, PRICE1, 
	PRICE2, TOTAL1, TOTAL2, BILL, DATE_PURCHASE, DATE_STORAGE, COUNT_STORAGE, CURCOUNT_STORAGE, 
	SYS_CREATE_TIME, SYS_PROCESS_FLAG, REMARKS,INVOICE_TYPE)
	values
	(#{materialBatchno},#{materialName}, #{assetTypeCode},#{brand}, #{modelNo},#{forms}, #{price1}, 
	#{price2},#{total1}, #{total2}, #{bill},#{datePurchase}, #{dateStorage}, #{countStorage},#{curcountStorage}, 
	now(), '1', #{remarks},#{invoiceType})
   
  </insert>
  
  <update id="update" parameterType="com.glens.pwCloudOs.materielMg.assetMg.materialBase.vo.MaterialBaseVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update gm_material_base
    <set >
      <if test="materialBatchno != null" >
        MATERIAL_BATCHNO = #{materialBatchno,jdbcType=VARCHAR},
      </if>
      <if test="materialName != null" >
        MATERIAL_NAME = #{materialName,jdbcType=VARCHAR},
      </if>
      <if test="assetTypeCode != null" >
        ASSET_TYPE_CODE = #{assetTypeCode,jdbcType=VARCHAR},
      </if>
      
      <if test="brand != null" >
        BRAND = #{brand,jdbcType=VARCHAR},
      </if>
      
      
      <if test="modelNo != null" >
        MODEL_NO = #{modelNo,jdbcType=VARCHAR},
      </if>
      
      
      <if test="forms != null" >
        FORMS = #{forms,jdbcType=VARCHAR},
      </if>
      
      
      <if test="price1 != null" >
        PRICE1 = #{price1,jdbcType=REAL},
      </if>
      <if test="invoiceType != null" >
        INVOICE_TYPE = #{invoiceType},
      </if>
      
      <if test="price2 != null" >
        PRICE2 = #{price2,jdbcType=REAL},
      </if>
      
      <if test="total1 != null " >
        TOTAL1 = #{total1,jdbcType=REAL},
      </if>
      
      <if test="total2 != null" >
        TOTAL2 = #{total2,jdbcType=REAL},
      </if>
      
      <if test="bill != null" >
        BILL = #{bill,jdbcType=VARCHAR},
      </if>

      <if test="datePurchase != null" >
        DATE_PURCHASE = #{datePurchase},
      </if>
      
      <if test="dateStorage != null" >
        DATE_STORAGE = #{dateStorage,jdbcType=VARCHAR},
      </if>
      
      
      <if test="countStorage != null" >
        COUNT_STORAGE = #{countStorage},
      </if>
      
      
      <if test="curcountStorage != null" >
        CURCOUNT_STORAGE = #{curcountStorage},
      </if>
      
      
      <if test="remarks != null" >
        REMARKS = #{remarks,jdbcType=VARCHAR},
      </if>
     
      SYS_UPDATE_TIME = now()
    </set>
    where MATERIAL_BATCHNO = #{materialBatchno}
  </update>
  
  <select id="ishave" parameterType="com.glens.pwCloudOs.materielMg.assetMg.materialBase.vo.MaterialBaseVo" resultType="map">
  	 
  	  select * from gm_material_base  where MATERIAL_BATCHNO = #{materialBatchno}
  	  
  </select>
  
  <insert id="addMaterial" parameterType="map">
  
	insert into GM_MATERIAL_USE(FLOW_CODE,MATERIAL_NAME,ASSET_CLASS_CODE,ASSET_TYPE_CODE,LOAN_EMPLOYEECODE,LOAN_EMPLOYEENAME,LOAN_UNIT_CODE,LOAN_UNIT_NAME,LOAN_PRO_NO,
	LOAN_PRO_NAME,USE_COUNT,USE_DATE,USE_DESC,FLOW_STATUS,ESTIMATE_RETURN_DATE,RETURN_DATE,RENT_STATUS,RETURN_MAN,
	RECEIVE_MAN,RECORD_TYPE,SYS_CREATE_TIME,SYS_PROCESS_FLAG,REMARKS)
	VALUES(#{flowCode},#{materialName},#{assetClassCode},#{assetTypeCode},
	#{loanEmployeeCode},#{loanEmployeeName},#{loanUnitCode},#{loanUnitName},
	#{loanProNo},#{loanProName},#{useCount},#{useDate},#{useDesc},1,#{estimateReturnDate},
	#{returnDate},0,#{returnMan},#{receiveMan},#{recordType},now(),'1',#{remarks})
  
  	
  </insert>
  
  
  
  
  <select id="getProList" parameterType="map" resultType="map">
  	select p.PRO_NAME,p.PRO_NO proNo,c.CATEGORY_NAME,p.COMPANY_CODE companyCode from pm_base p
	left join pm_category c on c.CATEGORY_CODE=p.CATEGORY_CODE
	where 1=1
	<if test="proNo!=null and proNo!=''">
		and p.PRO_NO=#{proNo}
	</if>
	<if test="categoryCode!=null and categoryCode!='' ">
		and p.CATEGORY_CODE=#{categoryCode}
	</if>
	
	 <if test="deptCode != null and deptCode != ''">
    and p.MANAGE_DEPT=#{deptCode}
    </if>
    <if test="districtManager != null and districtManager != ''">
	and p.DISTRICT_MANAGER=#{districtManager}
	</if>
	<if test="proManager != null and proManager != ''">
	and p.EMPLOYEECODE=#{proManager}
	</if>
	
	
  </select>
  
  
   <select id="getProMembers" parameterType="map" resultType="map">
   		
   		select p.employeecode employeeCode,m.employeename employeeName from pm_member  p
		left join md_employee m on m.employeecode=p.employeecode
		where p.pro_no=#{proNo} and p.WORK_statue=1
   
   </select>
  
  
  <select id="getLinyongNum" parameterType="map" resultType="map">

	
	select m.*,DATE_FORMAT(m.SYS_CREATE_TIME,'%Y-%m-%d') SYS_CREATE_TIME1,c.ASSET_CLASS_NAME,t.ASSET_TYPE_NAME from GM_MATERIAL_USE m
	left join gm_asset_class c on c.asset_class_code=m.asset_class_code
	LEFT join gm_asset_type t on t.ASSET_TYPE_CODE=m.ASSET_TYPE_CODE
	where m.LOAN_PRO_NO in(
	select p.PRO_NO proNo from pm_base p
	left join pm_category c on c.CATEGORY_CODE=p.CATEGORY_CODE
	where 1=1 
	
	<if test="proNo!=null and proNo!=''">
		and p.PRO_NO=#{proNo}
	</if>
	<if test="categoryCode!=null and categoryCode!='' ">
		and p.CATEGORY_CODE=#{categoryCode}
	</if>
	
	 <if test="deptCode != null and deptCode != ''">
    and p.MANAGE_DEPT=#{deptCode}
    </if>
    <if test="districtManager != null and districtManager != ''">
	and p.DISTRICT_MANAGER=#{districtManager}
	</if>
	<if test="proManager != null and proManager != ''">
	and p.EMPLOYEECODE=#{proManager}
	</if>
	) and m.RECORD_TYPE=1
	
	
	<if test="flowStatus!=null and flowStatus!=''">
		and m.FLOW_STATUS=#{flowStatus}
	</if>
	<if test="loanEmployeeCode!=null and loanEmployeeCode!=''">
		and m.LOAN_EMPLOYEECODE=#{loanEmployeeCode}
	</if>
	
	
  </select>
  
  <select id="getJieyongNum" parameterType="map" resultType="map">
  	select m.*,DATE_FORMAT(m.SYS_CREATE_TIME,'%Y-%m-%d') SYS_CREATE_TIME1,c.ASSET_CLASS_NAME,t.ASSET_TYPE_NAME from GM_MATERIAL_USE m
	left join gm_asset_class c on c.asset_class_code=m.asset_class_code
	LEFT join gm_asset_type t on t.ASSET_TYPE_CODE=m.ASSET_TYPE_CODE
	where m.LOAN_PRO_NO in(
	select p.PRO_NO proNo from pm_base p
	left join pm_category c on c.CATEGORY_CODE=p.CATEGORY_CODE
	where 1=1 
	<if test="proNo!=null and proNo!=''">
		and p.PRO_NO=#{proNo}
	</if>
	<if test="categoryCode!=null and categoryCode!='' ">
		and p.CATEGORY_CODE=#{categoryCode}
	</if>
	
	 <if test="deptCode != null and deptCode != ''">
    and p.MANAGE_DEPT=#{deptCode}
    </if>
    <if test="districtManager != null and districtManager != ''">
	and p.DISTRICT_MANAGER=#{districtManager}
	</if>
	<if test="proManager != null and proManager != ''">
	and p.EMPLOYEECODE=#{proManager}
	</if>
	) and m.RECORD_TYPE=2 
	
	<if test="rentStatus!=null and rentStatus!='' ">
		and m.RENT_STATUS = #{rentStatus}
	</if>
	<if test="loanEmployeeCode!=null and loanEmployeeCode!=''">
		and m.LOAN_EMPLOYEECODE=#{loanEmployeeCode}
	</if>
  </select>
  
  
  <select id="getDetail" parameterType="map" resultType="map">
  	select m.*,DATE_FORMAT(m.SYS_CREATE_TIME,'%Y-%m-%d') SYS_CREATE_TIME1,c.ASSET_CLASS_NAME,t.ASSET_TYPE_NAME from GM_MATERIAL_USE m
	left join gm_asset_class c on c.asset_class_code=m.asset_class_code
	LEFT join gm_asset_type t on t.ASSET_TYPE_CODE=m.ASSET_TYPE_CODE
	where m.LOAN_PRO_NO in(
	select p.PRO_NO proNo from pm_base p
	left join pm_category c on c.CATEGORY_CODE=p.CATEGORY_CODE
	where 1=1)
    and m.FLOW_CODE=#{flowCode}
  
  </select>
  
  <select id="getRentList" parameterType="map" resultType="map">
  		select m.*,DATE_FORMAT(m.SYS_CREATE_TIME,'%Y-%m-%d') SYS_CREATE_TIME1,c.ASSET_CLASS_NAME,t.ASSET_TYPE_NAME from GM_MATERIAL_USE m
		left join gm_asset_class c on c.asset_class_code=m.asset_class_code
		LEFT join gm_asset_type t on t.ASSET_TYPE_CODE=m.ASSET_TYPE_CODE
		where m.LOAN_PRO_NO in(
		select p.PRO_NO proNo from pm_base p
		left join pm_category c on c.CATEGORY_CODE=p.CATEGORY_CODE
		where 1=1 
		<if test="proNo!=null and proNo!=''">
			and p.PRO_NO=#{proNo}
		</if>
		<if test="categoryCode!=null and categoryCode!='' ">
			and p.CATEGORY_CODE=#{categoryCode}
		</if>
		
		 <if test="deptCode != null and deptCode != ''">
	  	  and p.MANAGE_DEPT=#{deptCode}
	    </if>
	    <if test="districtManager != null and districtManager != ''">
			and p.DISTRICT_MANAGER=#{districtManager}
		</if>
		<if test="proManager != null and proManager != ''">
			and p.EMPLOYEECODE=#{proManager}
		</if>
		) and m.RECORD_TYPE=2  and m.RENT_STATUS !=0 and m.RENT_STATUS !=3
		
		<if test="flowStatus!=null and flowStatus!='' ">
			and m.FLOW_STATUS=#{flowStatus}
		</if>
		<if test="loanEmployeeCode!=null and loanEmployeeCode!=''">
			and m.LOAN_EMPLOYEECODE=#{loanEmployeeCode}
		</if>
		
  </select>
  
  <select id="getTotalMaterialNum" parameterType="map" resultType="map">
  	select IFNULL(sum(CURCOUNT_STORAGE),0) totalNum from GM_MATERIAL_BASE where ASSET_TYPE_CODE=#{assetTypeCode}
  </select>
 
  <update id="returnMaterial" parameterType="map">
  	UPDATE GM_MATERIAL_USE SET FLOW_STATUS=4,RENT_STATUS=3,RETURN_MAN=#{returnMan},RETURN_DATE=curdate(),
  	RETURN_PIC=#{returnPic},SYS_UPDATE_TIME=now() WHERE FLOW_CODE=#{flowCode}
  </update>
  
  <update id="auditBorrowMaterial" parameterType="map">
  	update GM_MATERIAL_USE set FLOW_STATUS=#{flowStatus},RENT_STATUS=#{rentStatus},GRANT_MAN=#{grantMan},USE_COUNT=#{tolUseCount},
  	SYS_UPDATE_TIME=now(),remarks=#{remarks} where FLOW_CODE=#{flowCode}
  </update>
  
  <select id="selectApplyMaterialCount" parameterType="map" resultType="int">
  	select count(*) FROM GM_MATERIAL_USE a
	JOIN GM_ASSET_TYPE b ON a.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE
	JOIN GM_ASSET_CLASS c ON b.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE
	JOIN PM_BASE d ON a.LOAN_PRO_NO=d.PRO_NO
	LEFT JOIN MD_EMPLOYEE e ON a.RETURN_MAN=e.EMPLOYEECODE
	LEFT JOIN MD_EMPLOYEE f ON a.RECEIVE_MAN=f.EMPLOYEECODE
	where (a.FLOW_STATUS=1 or a.FLOW_STATUS=4)
	<if test="fromDate != null and fromDate != ''">
	and a.USE_DATE &gt;= #{fromDate}
	</if>
	<if test="toDate != null and toDate != ''">
	and a.USE_DATE &lt;= #{toDate}
	</if>
	<if test="recordType != null and recordType > 0">
	and a.RECORD_TYPE=#{recordType}
	</if>
	<if test="flowStatus != null and flow_status > 0">
	and a.FLOW_STATUS = #{flowStatus}
	</if>
	<if test="proCategory != null and proCategory != ''">
	and d.CATEGORY_CODE=#{proCategory}
	</if>
	<if test="proNo != null and proNo != ''">
	and a.LOAN_PRO_NO=#{proNo}
	</if>
	<if test="materialName != null and materialName != ''">
  		and (a.MATERIAL_NAME like "%"#{materialName}"%" or a.LOAN_EMPLOYEENAME like "%"#{materialName}"%" or a.LOAN_PRO_NAME like "%"#{materialName}"%" )
	</if>
  </select>
  
  <select id="selectApplyMaterialPage" parameterType="map" resultType="map">
  	SELECT a.FLOW_CODE flowCode,a.MATERIAL_NAME materialName,a.ASSET_CLASS_CODE assetClassCode,a.ASSET_TYPE_CODE assetTypeCode,
	a.LOAN_EMPLOYEECODE loanEmployeeCode,a.LOAN_EMPLOYEENAME loanEmployeeName,IFNULL(a.LOAN_UNIT_CODE,'') loanUnitCode,IFNULL(a.LOAN_UNIT_NAME,'') loanUnitName,
	IFNULL(a.LOAN_PRO_NO,'') loanProNo,IFNULL(a.LOAN_PRO_NAME,'') loanProName,a.USE_COUNT useCount,a.USE_DESC useDesc,IFNULL(DATE_FORMAT(a.USE_DATE,'%Y-%m-%d'),'') useDate,
	a.FLOW_STATUS flowStatus,IFNULL(DATE_FORMAT(a.ESTIMATE_RETURN_DATE,'%Y-%m-%d'),'') estimateReturnDate,IFNULL(DATE_FORMAT(a.RETURN_DATE,'%Y-%m-%d'),'') returnDate,
	a.RENT_STATUS rentStatus,IFNULL(a.RETURN_MAN,'') returnMan,IFNULL(a.RECEIVE_MAN,'') receiveMan,IFNULL(a.GRANT_MAN,'') grantMan,a.RECORD_TYPE recordType,IFNULL(a.RETURN_PIC,'') returnPic,
	b.ASSET_TYPE_NAME assetTypeName,c.ASSET_CLASS_NAME assetClassName,IFNULL(e.EMPLOYEENAME,'') returnManName,IFNULL(f.EMPLOYEENAME,'') receiveManName
	FROM GM_MATERIAL_USE a
	JOIN GM_ASSET_TYPE b ON a.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE
	JOIN GM_ASSET_CLASS c ON b.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE
	JOIN PM_BASE d ON a.LOAN_PRO_NO=d.PRO_NO
	LEFT JOIN MD_EMPLOYEE e ON a.RETURN_MAN=e.EMPLOYEECODE
	LEFT JOIN MD_EMPLOYEE f ON a.RECEIVE_MAN=f.EMPLOYEECODE
	where (a.FLOW_STATUS=1 or a.FLOW_STATUS=4)
	<if test="fromDate != null and fromDate != ''">
	and a.USE_DATE &gt;= #{fromDate}
	</if>
	<if test="toDate != null and toDate != ''">
	and a.USE_DATE &lt;= #{toDate}
	</if>
	<if test="recordType != null and recordType > 0">
	and a.RECORD_TYPE=#{recordType}
	</if>
	<if test="flowStatus != null and flow_status > 0">
	and a.FLOW_STATUS = #{flowStatus}
	</if>
	<if test="proCategory != null and proCategory != ''">
	and d.CATEGORY_CODE=#{proCategory}
	</if>
	<if test="proNo != null and proNo != ''">
	and a.LOAN_PRO_NO=#{proNo}
	</if>
	
	<if test="materialName != null and materialName != ''">
  		and (a.MATERIAL_NAME like "%"#{materialName}"%" or a.LOAN_EMPLOYEENAME like "%"#{materialName}"%" or a.LOAN_PRO_NAME like "%"#{materialName}"%" )
	</if>
	
	order by a.USE_DATE desc
	limit #{firstResult},#{maxResult}
  </select>
  
  <select id="selectProcessedMaterialCount" parameterType="map" resultType="int">
  	select count(*) FROM GM_MATERIAL_USE a
	JOIN GM_ASSET_TYPE b ON a.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE
	JOIN GM_ASSET_CLASS c ON b.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE
	JOIN PM_BASE d ON a.LOAN_PRO_NO=d.PRO_NO
	LEFT JOIN MD_EMPLOYEE e ON a.RETURN_MAN=e.EMPLOYEECODE
	LEFT JOIN MD_EMPLOYEE f ON a.RECEIVE_MAN=f.EMPLOYEECODE
	where (a.FLOW_STATUS=2 or a.FLOW_STATUS=3 or a.FLOW_STATUS=5)
	<if test="fromDate != null and fromDate != ''">
	and a.USE_DATE &gt;= #{fromDate}
	</if>
	<if test="toDate != null and toDate != ''">
	and a.USE_DATE &lt;= #{toDate}
	</if>
	<if test="recordType != null and recordType > 0">
	and a.RECORD_TYPE=#{recordType}
	</if>
	<if test="flowStatus != null and flowStatus != ''">
	and a.FLOW_STATUS = #{flowStatus}
	</if>
	<if test="proCategory != null and proCategory != ''">
	and d.CATEGORY_CODE=#{proCategory}
	</if>
	<if test="proNo != null and proNo != ''">
	and a.LOAN_PRO_NO=#{proNo}
	</if>
	<if test="materialName != null and materialName != ''">
  		and (a.MATERIAL_NAME like "%"#{materialName}"%" or a.LOAN_EMPLOYEENAME like "%"#{materialName}"%" or a.LOAN_PRO_NAME like "%"#{materialName}"%" )
	</if>
	
  </select>
  
  <select id="selectProcessedMaterialPage" parameterType="map" resultType="map">
  	SELECT a.FLOW_CODE flowCode,a.MATERIAL_NAME materialName,a.ASSET_CLASS_CODE assetClassCode,a.ASSET_TYPE_CODE assetTypeCode,
	a.LOAN_EMPLOYEECODE loanEmployeeCode,a.LOAN_EMPLOYEENAME loanEmployeeName,IFNULL(a.LOAN_UNIT_CODE,'') loanUnitCode,IFNULL(a.LOAN_UNIT_NAME,'') loanUnitName,
	IFNULL(a.LOAN_PRO_NO,'') loanProNo,IFNULL(a.LOAN_PRO_NAME,'') loanProName,a.USE_COUNT useCount,a.USE_DESC useDesc,IFNULL(DATE_FORMAT(a.USE_DATE,'%Y-%m-%d'),'') useDate,
	a.FLOW_STATUS flowStatus,IFNULL(DATE_FORMAT(a.ESTIMATE_RETURN_DATE,'%Y-%m-%d'),'') estimateReturnDate,IFNULL(DATE_FORMAT(a.RETURN_DATE,'%Y-%m-%d'),'') returnDate,
	a.RENT_STATUS rentStatus,IFNULL(a.RETURN_MAN,'') returnMan,IFNULL(a.RECEIVE_MAN,'') receiveMan,IFNULL(a.GRANT_MAN,'') grantMan,a.RECORD_TYPE recordType,IFNULL(a.RETURN_PIC,'') returnPic,
	b.ASSET_TYPE_NAME assetTypeName,c.ASSET_CLASS_NAME assetClassName,IFNULL(e.EMPLOYEENAME,'') returnManName,IFNULL(f.EMPLOYEENAME,'') receiveManName,a.SYS_UPDATE_TIME dealTime
	FROM GM_MATERIAL_USE a
	JOIN GM_ASSET_TYPE b ON a.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE
	JOIN GM_ASSET_CLASS c ON b.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE
	JOIN PM_BASE d ON a.LOAN_PRO_NO=d.PRO_NO
	LEFT JOIN MD_EMPLOYEE e ON a.RETURN_MAN=e.EMPLOYEECODE
	LEFT JOIN MD_EMPLOYEE f ON a.RECEIVE_MAN=f.EMPLOYEECODE
	where (a.FLOW_STATUS=2 or a.FLOW_STATUS=3 or a.FLOW_STATUS=5)
	<if test="fromDate != null and fromDate != ''">
	and a.USE_DATE &gt;= #{fromDate}
	</if>
	<if test="toDate != null and toDate != ''">
	and a.USE_DATE &lt;= #{toDate}
	</if>
	<if test="recordType != null and recordType > 0">
	and a.RECORD_TYPE=#{recordType}
	</if>
	<if test="flowStatus != null and flowStatus != ''">
	and a.FLOW_STATUS = #{flowStatus}
	</if>
	<if test="proCategory != null and proCategory != ''">
	and d.CATEGORY_CODE=#{proCategory}
	</if>
	<if test="proNo != null and proNo != ''">
	and a.LOAN_PRO_NO=#{proNo}
	</if>
	<if test="materialName != null and materialName != ''">
  		and (a.MATERIAL_NAME like "%"#{materialName}"%" or a.LOAN_EMPLOYEENAME like "%"#{materialName}"%" or a.LOAN_PRO_NAME like "%"#{materialName}"%" )
	</if>
	order by a.USE_DATE desc
	limit #{firstResult},#{maxResult}
  </select>
  
  <select id="selectMaterialFlow" parameterType="java.lang.String" resultType="map">
  	SELECT a.FLOW_CODE flowCode,a.MATERIAL_NAME materialName,a.ASSET_CLASS_CODE assetClassCode,a.ASSET_TYPE_CODE assetTypeCode,
	a.LOAN_EMPLOYEECODE loanEmployeeCode,a.LOAN_EMPLOYEENAME loanEmployeeName,IFNULL(a.LOAN_UNIT_CODE,'') loanUnitCode,IFNULL(a.LOAN_UNIT_NAME,'') loanUnitName,
	IFNULL(a.LOAN_PRO_NO,'') loanProNo,IFNULL(a.LOAN_PRO_NAME,'') loanProName,a.USE_COUNT useCount,a.USE_DESC useDesc,IFNULL(DATE_FORMAT(a.USE_DATE,'%Y-%m-%d'),'') useDate,
	a.FLOW_STATUS flowStatus,IFNULL(DATE_FORMAT(a.ESTIMATE_RETURN_DATE,'%Y-%m-%d'),'') estimateReturnDate,IFNULL(DATE_FORMAT(a.RETURN_DATE,'%Y-%m-%d'),'') returnDate,
	a.RENT_STATUS rentStatus,IFNULL(a.RETURN_MAN,'') returnMan,IFNULL(a.RECEIVE_MAN,'') receiveMan,IFNULL(a.GRANT_MAN,'') grantMan,a.RECORD_TYPE recordType,IFNULL(a.RETURN_PIC,'') returnPic,
	b.ASSET_TYPE_NAME assetTypeName,c.ASSET_CLASS_NAME assetClassName,IFNULL(e.EMPLOYEENAME,'') returnManName,IFNULL(f.EMPLOYEENAME,'') receiveManName,
	ifnull(a.REMARKS,'') remarks,IFNULL(g.EMPLOYEENAME,'') grantManName
	FROM GM_MATERIAL_USE a
	JOIN GM_ASSET_TYPE b ON a.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE
	JOIN GM_ASSET_CLASS c ON b.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE
	LEFT JOIN MD_EMPLOYEE e ON a.RETURN_MAN=e.EMPLOYEECODE
	LEFT JOIN MD_EMPLOYEE f ON a.RECEIVE_MAN=f.EMPLOYEECODE
	LEFT JOIN MD_EMPLOYEE g ON a.GRANT_MAN=g.EMPLOYEECODE
	where a.FLOW_CODE=#{flowCode}
  </select>
  
  <select id="selectApplyedMaterial" parameterType="java.lang.String" resultType="map">
  	SELECT a.MATERIAL_BATCHNO materialBatchno,a.USE_COUNT useCount,b.MATERIAL_NAME materialName,b.BRAND brand,b.MODEL_NO modelNo,
	IFNULL(DATE_FORMAT(b.DATE_STORAGE,'%Y-%m-%d'),'') dateStorage,b.CURCOUNT_STORAGE countStorage,
	c.ASSET_TYPE_NAME assetTypeName, d.ASSET_CLASS_NAME assetClassName
	FROM GM_MATERIAL_USE_RECORD a
	JOIN GM_MATERIAL_BASE b ON a.MATERIAL_BATCHNO=b.MATERIAL_BATCHNO
	join GM_ASSET_TYPE c on b.ASSET_TYPE_CODE=c.ASSET_TYPE_CODE
  	join GM_ASSET_CLASS d on c.ASSET_CLASS_CODE=d.ASSET_CLASS_CODE
	where a.FLOW_CODE=#{flowCode}
  </select>
  
  <!-- 插入申请流程记录 -->
  <insert id="insertMaterialUseRecord" parameterType="java.util.List">
  	insert into GM_MATERIAL_USE_RECORD(FLOW_CODE,MATERIAL_BATCHNO,USE_COUNT,SYS_CREATE_TIME,SYS_PROCESS_FLAG) VALUES
  	<foreach collection="list" item="p" index="i" separator=",">
  	(#{p.flowCode},#{p.materialBatchno},#{p.useCount},now(),'1')
  	</foreach>
  </insert>
  
  <!-- 更新库存 -->
  <update id="updateMaterialCurCount" parameterType="map">
  	update GM_MATERIAL_BASE set CURCOUNT_STORAGE=CURCOUNT_STORAGE+#{tolUseCount} where MATERIAL_BATCHNO=#{materialBatchno}
  </update>
  
  <!-- 审核归还申请 -->
  <update id="auditReturnMaterial" parameterType="map">
  	UPDATE GM_MATERIAL_USE SET FLOW_STATUS=5,RENT_STATUS=2,REURN_AUDIT_MAN=#{returnAuditMan},SYS_UPDATE_TIME=now() WHERE FLOW_CODE=#{flowCode}
  </update>
  
  <select id="exportTableList" resultType="map" parameterType="map">
  SELECT
	g1.FLOW_CODE,
	g1.MATERIAL_NAME,
	g4.MATERIAL_NAME name1,
	g1.LOAN_EMPLOYEECODE,
	g1.LOAN_EMPLOYEENAME,
	g1.LOAN_PRO_NO,
	g1.LOAN_PRO_NAME,
	g1.USE_COUNT,
	g1.USE_DATE,
	g3.MATERIAL_BATCHNO,
	g3.MATERIAL_NAME,
	g3.BRAND,
	g3.MODEL_NO,
	g3.FORMS,
	g3.PRICE1,
	g3.PRICE2,
	g3.PRICE1*g2.USE_COUNT total1,
  g3.PRICE2*g2.USE_COUNT total2,
	g1.REMARKS,
g2.USE_COUNT count1,
g1.SYS_UPDATE_TIME dealTime,
b.ASSET_TYPE_NAME,
c.ASSET_CLASS_NAME

FROM
	gm_material_use g1
LEFT JOIN gm_material_use_record g2 ON g1.FLOW_CODE = g2.FLOW_CODE
LEFT JOIN gm_material_base g3 ON g2.MATERIAL_BATCHNO = g3.MATERIAL_BATCHNO
left join gm_material_base g4 on g2.MATERIAL_BATCHNO=g4.MATERIAL_BATCHNO

JOIN GM_ASSET_TYPE b on g1.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE

JOIN GM_ASSET_CLASS c ON g1.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE

WHERE
	g1.FLOW_STATUS = '2'
order by g1.FLOW_CODE





  </select>
  
 
  <select id="exportMaterialUseBase" parameterType="map" resultType="map" >
  	select 
    <include refid="Base_Column_List" />
    from GM_MATERIAL_BASE a
    join GM_ASSET_TYPE b on a.ASSET_TYPE_CODE=b.ASSET_TYPE_CODE
  	join GM_ASSET_CLASS c on b.ASSET_CLASS_CODE=c.ASSET_CLASS_CODE
  	where a.SYS_PROCESS_FLAG='1'
  	<if test="assetClassCode != null and assetClassCode !=''">
  	and b.ASSET_CLASS_CODE=#{assetClassCode}
  	</if>
  	<if test="assetTypeCode != null and assetTypeCode !=''">
  	and b.ASSET_TYPE_CODE=#{assetTypeCode}
  	</if>
  	<if test="materialName != null and materialName != ''">
  		and (a.MATERIAL_NAME like "%"#{materialName}"%" or a.BRAND like "%"#{materialName}"%" or a.MODEL_NO like "%"#{materialName}"%" )
  	</if>
  	
  </select>
 
  
</mapper>